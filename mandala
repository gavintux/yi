<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mandala Garden</title>
    <link rel="icon" href="https://duk.tw/3eXGrY.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Utils -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #fcfaf9; height: 100dvh; width: 100vw; overflow: hidden; color: #44403c; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .grid-border { border-color: #d6d3d1; }
        .dash-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .dash-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(87, 105, 85, 0.1); }
        .garden-title { font-family: 'Noto Serif TC', serif; }
        
        .export-mode .export-hidden { display: none !important; }
        .export-mode .export-full-text { white-space: normal !important; overflow: visible !important; display: block !important; -webkit-line-clamp: unset !important; line-clamp: unset !important; height: auto !important; font-size: 0.7rem !important; line-height: 1.1 !important; }
        .export-mode .grid-cell-content { padding: 2px !important; }

        /* Navigation Styles */
        .nav-cell { cursor: pointer; position: relative; }
        .nav-cell:hover { background-color: rgba(16, 185, 129, 0.1) !important; }
        .nav-cell::after { content: "‚Üó"; position: absolute; top: 2px; left: 2px; font-size: 10px; color: #059669; opacity: 0.6; transition: all 0.2s; font-weight: bold; }
        .nav-cell.return-cell::after { content: "‚Ü©"; }
        .nav-cell:hover::after { transform: scale(1.2); opacity: 1; }
        
        .edit-btn-overlay { position: absolute; bottom: 3px; right: 3px; width: 20px; height: 20px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; cursor: pointer; z-index: 30; opacity: 0; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .group:hover .edit-btn-overlay { opacity: 1; }
        .edit-btn-overlay:hover { background: #10b981; color: white; border-color: #10b981; }

        .content-icon { width: 16px; height: 16px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; background: rgba(255,255,255,0.8); border: 1px solid #d1d5db; color: #4b5563; cursor: pointer; transition: all 0.2s; }
        .content-icon:hover { background: #10b981; color: white; border-color: #10b981; transform: scale(1.1); }

        .md-content a { color: #059669; text-decoration: underline; pointer-events: auto; }
        .md-content p { margin-bottom: 0.2em; }
        .md-content ul { padding-left: 1rem; list-style: disc; }
        .md-content ol { padding-left: 1rem; list-style: decimal; }
        
        /* Custom scrollbar for emoji list */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const USER_CONFIG = {
            seo: { title: "Mandala Garden", logoImage: "https://firebasestorage.googleapis.com/v0/b/linkcphoto.firebasestorage.app/o/photos%2Flinkc-w0.png?alt=media&token=63c9b589-aa78-480a-bed2-1c83634f4b9f", logoLink: "https://gavintux.github.io/yi/" },
            firebase: { apiKey: "AIzaSyAWY5zq9QQyO2LNveVtisgrin-ZoDGXmmo", authDomain: "linkc-mandala.firebaseapp.com", projectId: "linkc-mandala", storageBucket: "linkc-mandala.firebasestorage.app", messagingSenderId: "349060628914", appId: "1:349060628914:web:f093e6b30c5a6c79da24ab" },
            system: { collectionName: 'mandala_charts', defaultGridSize: 3, defaultViewStyle: 'standard' }
        };

        try { firebase.initializeApp(USER_CONFIG.firebase); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Utils
        const getTintedColor = (hex, factor = 0.4) => { 
            // Creates a pastel version of the color (mixed with white)
            // Factor: 0 = white, 1 = original color
            if (!hex || !hex.startsWith('#')) return '#ffffff';
            // Parse hex
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);
            
            // Mix with white (255)
            r = Math.round(r * factor + 255 * (1 - factor));
            g = Math.round(g * factor + 255 * (1 - factor));
            b = Math.round(b * factor + 255 * (1 - factor));
            
            return `rgb(${r}, ${g}, ${b})`;
        };

        const safeMarkdown = (text) => { try { return typeof marked !== 'undefined' ? marked.parse(text) : text; } catch { return text; } };
        const safeMarkdownInline = (text) => { try { return typeof marked !== 'undefined' ? marked.parseInline(text) : text; } catch { return text; } };
        const encodeShareData = (d) => btoa(unescape(encodeURIComponent(JSON.stringify(d))));
        const decodeShareData = (s) => JSON.parse(decodeURIComponent(escape(atob(s))));
        const compressImage = (file) => new Promise((res) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const w = 300; c.width=w; c.height=i.height*(w/i.width); c.getContext('2d').drawImage(i,0,0,w,c.height); res(c.toDataURL('image/jpeg', 0.7)); } } });
        const extractTags = (text) => (text?.match(/#[\w\u4e00-\u9fa5]+/g) || []).map(x => x.substring(1));
        const parseCategories = (s) => (!s ? ['Êú™ÂàÜÈ°û'] : s.split(/[,Ôºå\s]+/).filter(c=>c.trim().length>0));
        
        const EMOJI_LIST = [
            'üåø', 'üå∏', 'üåº', 'üçÑ', 'üå±', 'üçÉ', 'üåª', 'üåµ', 'üå∫', 'üçÇ', 'üåπ', 'üå∑', 'üíê', 'ü™¥', 'üå≤',
            'ü¶ã', 'üê¶', 'üêû', 'üêù', 'üêú', 'üêæ', 'üê∂', 'üê±', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å',
            '‚òÄÔ∏è', 'üíß', '‚òÅÔ∏è', 'üåà', '‚ö°', '‚ùÑÔ∏è', 'üåô', '‚≠ê', 'ü™ê', 'üåã', 'üåä', 'üî•', 'üí®', '‚òî', '‚òÉÔ∏è',
            'üè°', 'üìö', 'üé®', 'üçµ', 'üßò', '‚ú®', 'üí°', 'üéØ', 'üöÄ', 'üîÆ', 'üß©', 'üéÆ', 'üé∏', 'üé∫', 'üéª',
            '‚úÖ', '‚ùå', '‚ùì', '‚ùó', 'üí∞', 'üíé', 'üèÜ', 'ü•á', 'üéÅ', 'üéà', 'üéâ', 'üïØÔ∏è', 'üîë', 'üîì', 'üîí',
            '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', 'üíØ', 'üí¢', 'üí•', 'üí´', 'üí¨',
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç',
            'üìÖ', 'üìÜ', 'üï∞Ô∏è', '‚è∞', 'üì±', 'üíª', 'üì∑', 'üé•', 'üéß', 'üé§', 'üìû', 'üîã', 'üîå', 'üíæ', 'üíø',
            'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üöú', 'üö≤', 'üõµ'
        ];
        
        const Icons = {
            Folder: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>,
            Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path></svg>,
            Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>,
            Share: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>,
            SignOut: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>,
            Pencil: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>,
            Home: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>,
            Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>,
            Export: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>,
            Restore: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>,
            DeleteForever: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
            Clipboard: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>,
            Link: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>,
            Photo: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        };

        const { useState, useEffect, useMemo, useRef } = React;

        function App() {
            // States
            const [user, setUser] = useState(null);
            const [viewMode, setViewMode] = useState('browser');
            const [authMode, setAuthMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [loading, setLoading] = useState(true);
            const [isUploading, setIsUploading] = useState(false);

            // Data
            const [fileList, setFileList] = useState([]);
            const [currentDocId, setCurrentDocId] = useState(null);
            const [docMetadata, setDocMetadata] = useState({ title: 'Êú™ÂëΩÂêç', category: '‰∏ÄËà¨' });
            const [data, setData] = useState({});
            const [gridSize, setGridSize] = useState(3);
            const [viewStyle, setViewStyle] = useState('standard');
            const [activeCategory, setActiveCategory] = useState('All');
            const [zoomedGridIndex, setZoomedGridIndex] = useState(null); 
            const [isSharedView, setIsSharedView] = useState(false);

            // Modals
            const [selectedCell, setSelectedCell] = useState(null);
            const [showSaveAsModal, setShowSaveAsModal] = useState(false);
            const [modalMode, setModalMode] = useState('new'); // 'new' or 'save_as'
            const [showImportModal, setShowImportModal] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false);
            const [showGlobalSearchModal, setShowGlobalSearchModal] = useState(false);
            const [previewImage, setPreviewImage] = useState(null);
            const [editActiveField, setEditActiveField] = useState('title'); // 'title' or 'note'
            
            // Other
            const [searchQuery, setSearchQuery] = useState("");
            const [globalSearchResults, setGlobalSearchResults] = useState([]);
            const [importCode, setImportCode] = useState("");
            const [saveStatus, setSaveStatus] = useState('saved');
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeTags, setActiveTags] = useState([]);
            const [showAllCategories, setShowAllCategories] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const ITEMS_PER_PAGE = 12;

            const fileInputRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'linkc-mandala-app-v1';

            // --- Effects ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u && viewMode === 'browser') fetchFileList(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if(!user || !currentDocId || !db || viewMode !== 'editor' || isSharedView) return;
                const timer = setTimeout(async () => {
                    setSaveStatus('saving');
                    try {
                        const path = `artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}`;
                        await db.doc(`${path}/${currentDocId}`).update({
                            cells: data, gridSize, title: docMetadata.title, category: docMetadata.category,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setSaveStatus('saved');
                    } catch(e){ setSaveStatus('error'); }
                }, 2000);
                return () => clearTimeout(timer);
            }, [data, gridSize, docMetadata, user, currentDocId, viewMode]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const importData = params.get('import'); 
                if (importData) {
                    setLoading(true);
                    try {
                        const decoded = decodeShareData(importData);
                        if (decoded) {
                            setData(decoded.cells || {});
                            setGridSize(decoded.gridSize || 3);
                            setDocMetadata({ title: decoded.title, category: decoded.category });
                            setCurrentDocId(null);
                            setIsSharedView(true);
                            setViewMode('editor');
                        }
                    } catch(e) { alert("ÈÄ£ÁµêÂ§±Êïà"); }
                    setLoading(false);
                }
            }, []);

            // --- Handlers ---
            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true); setAuthError('');
                try {
                    if (authMode === 'login') await auth.signInWithEmailAndPassword(email, password);
                    else await auth.createUserWithEmailAndPassword(email, password);
                } catch(err) { setAuthError(err.message); }
                setLoading(false);
            };

            const handleSignOut = () => {
                auth.signOut().then(() => {
                    setUser(null);
                    setFileList([]);
                    setViewMode('browser');
                });
            };

            const fetchFileList = async (u = user) => {
                if(!u) return;
                try {
                    const snap = await db.collection(`artifacts/${appId}/users/${u.uid}/${USER_CONFIG.system.collectionName}`).get();
                    const files = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    files.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                    setFileList(files);
                } catch(e) { console.error(e); }
            };

            const loadFileFromDB = (file) => {
                if (file.deleted) { alert("Ë´ãÂÖàÂæûÂûÉÂúæÁ≠íÈÇÑÂéü"); return; }
                setData(file.cells || {});
                setGridSize(file.gridSize || 3);
                setCurrentDocId(file.id);
                setDocMetadata({ title: file.title, category: file.category });
                setZoomedGridIndex(null);
                setViewMode('editor');
            };

            const createNewFile = async (t, c, initialCells = {}, initialGridSize = 3) => {
                if(!user) return; setLoading(true);
                try {
                    const doc = await db.collection(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}`).add({
                        title: t, category: c, cells: initialCells, gridSize: initialGridSize, deleted: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setData(initialCells); 
                    setGridSize(initialGridSize); 
                    setCurrentDocId(doc.id); 
                    setDocMetadata({ title: t, category: c });
                    setSaveStatus('saved'); 
                    setIsSharedView(false); 
                    setZoomedGridIndex(null);
                    setShowSaveAsModal(false); 
                    setViewMode('editor');
                } catch(e) { alert("Error"); }
                setLoading(false);
            };

            const handleSaveAction = () => {
                const t = document.getElementById('save-title').value;
                const c = document.getElementById('save-cat').value;
                if(!t) return;
                
                // If modalMode is 'new', we create a fresh empty file
                if (modalMode === 'new') {
                    createNewFile(t, c);
                } else {
                    // If modalMode is 'save_as', we clone current data
                    createNewFile(t, c, data, gridSize);
                }
            };

            const moveToTrash = async (fileId) => {
                if (!confirm("Á¢∫ÂÆöÁßªËá≥ÂûÉÂúæÁ≠íÔºü")) return;
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).update({
                        deleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const restoreFromTrash = async (fileId) => {
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).update({
                        deleted: false
                    });
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const deleteForever = async (fileId) => {
                if (!confirm("Á¢∫ÂÆöÊ∞∏‰πÖÂà™Èô§Ôºü")) return;
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).delete();
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const updateCell = (gIdx, cIdx, field, val) => {
                const k = `${gIdx}-${cIdx}`;
                const prev = data[k] || {};
                let newData = { ...data, [k]: { ...prev, [field]: val } };
                if (gridSize === 9 && field === 'title') {
                    if (gIdx === 4 && cIdx !== 4) newData[`${cIdx}-4`] = { ...(data[`${cIdx}-4`]||{}), title: val };
                    else if (gIdx !== 4 && cIdx === 4) newData[`4-${gIdx}`] = { ...(data[`4-${gIdx}`]||{}), title: val };
                }
                setData(newData);
            };

            const clearCell = (gIdx, cIdx) => {
                if(!confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§Ê≠§Ê†ºÂÖßÂÆπÂóéÔºü")) return;
                const k = `${gIdx}-${cIdx}`;
                const newData = { ...data };
                delete newData[k];
                setData(newData);
            };

            const handleImageUpload = async (file) => {
                if (!file) return;
                setIsUploading(true);
                try {
                    const url = await compressImage(file);
                    updateCell(selectedCell.gIdx, selectedCell.cIdx, 'images', [url]);
                } catch (e) {
                    alert("ÂúñÁâá‰∏äÂÇ≥Â§±Êïó");
                }
                setIsUploading(false);
            };
            
            const handleCellClick = (gIdx, cIdx, cellData) => {
                if (gridSize === 9) {
                     if (zoomedGridIndex === null && gIdx === 4 && cIdx !== 4) { setZoomedGridIndex(cIdx); return; }
                     if (zoomedGridIndex !== null && cIdx === 4) { setZoomedGridIndex(null); return; }
                } 
                if (gridSize === 3) {
                     if ((zoomedGridIndex === null || zoomedGridIndex === 4) && cIdx !== 4) { setZoomedGridIndex(cIdx); return; }
                     if (zoomedGridIndex !== null && zoomedGridIndex !== 4 && cIdx === 4) { setZoomedGridIndex(4); return; }
                }
                setEditActiveField('title'); // Reset default active field
                setSelectedCell({ gIdx: (gridSize===3 && zoomedGridIndex!==null) ? zoomedGridIndex : gIdx, cIdx, data: cellData });
            };

            const getNavClass = (gIdx, cIdx) => {
                if (gridSize === 9) {
                    if (zoomedGridIndex === null && gIdx === 4 && cIdx !== 4) return 'nav-cell';
                    if (zoomedGridIndex !== null && cIdx === 4) return 'nav-cell return-cell';
                }
                if (gridSize === 3) {
                    if ((zoomedGridIndex === null || zoomedGridIndex === 4) && cIdx !== 4) return 'nav-cell';
                    if (zoomedGridIndex !== null && zoomedGridIndex !== 4 && cIdx === 4) return 'nav-cell return-cell';
                }
                return '';
            };

            const checkSearchMatch = (text, query) => {
                if (!query) return true;
                if (!text) return false;
                const terms = query.toLowerCase().trim().split(/\s+/);
                const target = text.toLowerCase();
                return terms.every(term => target.includes(term));
            };

            const performGlobalSearch = () => {
                if (!searchQuery) { setGlobalSearchResults([]); return; }
                const results = [];
                fileList.forEach(file => {
                    if (file.deleted) return;
                    let matchCount = 0;
                    if (checkSearchMatch(file.title, searchQuery)) matchCount += 10;
                    if (file.cells) {
                        Object.values(file.cells).forEach(cell => {
                            const content = `${cell.title || ''} ${cell.note || ''}`;
                            if (checkSearchMatch(content, searchQuery)) matchCount++;
                        });
                    }
                    if (matchCount > 0) results.push({ ...file, score: matchCount });
                });
                results.sort((a,b) => b.score - a.score);
                setGlobalSearchResults(results);
                setShowGlobalSearchModal(true);
            };

            const handleImportCodeSubmit = () => {
                if(!importCode) return;
                try {
                    const parsed = JSON.parse(importCode);
                    if (confirm("Âç≥Â∞áÂåØÂÖ•ÊõºÈôÄÁæÖ‰∏¶Ëá™ÂãïÂÑ≤Â≠òÁÇ∫Êñ∞Ê™îÊ°à„ÄÇ\n(Á¢∫ÂÆöÂåØÂÖ•?)")) {
                        createNewFile(
                            parsed.title ? `${parsed.title} (ÂåØÂÖ•)` : 'ÂåØÂÖ•ÁöÑÂàÜ‰∫´',
                            parsed.category || '‰∏ÄËà¨',
                            parsed.cells || {},
                            parsed.gridSize || 3
                        );
                        setShowImportModal(false);
                        setImportCode("");
                    }
                } catch(e) {
                    alert("‰ª£Á¢ºÊ†ºÂºèÈåØË™§");
                }
            };

            const handleExportFile = () => {
                const shareObj = { title: docMetadata.title, category: docMetadata.category, gridSize: gridSize, cells: data, isShareFile: true };
                const blob = new Blob([JSON.stringify(shareObj)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Mandala_Share_${docMetadata.title}.json`;
                a.click();
                setShowShareModal(false);
            };

            const handleCopyCode = () => {
                const shareObj = { title: docMetadata.title, category: docMetadata.category, gridSize: gridSize, cells: data };
                const json = JSON.stringify(shareObj);
                const textArea = document.createElement("textarea");
                textArea.value = json;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                alert("‰ª£Á¢ºÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ");
                setShowShareModal(false);
            };

            const handleExportJPG = async () => {
                setLoading(true);
                const element = document.getElementById('mandala-grid-container');
                if (!element) return;
                const exportContainer = element.cloneNode(true);
                exportContainer.style.width = '1200px'; 
                exportContainer.style.height = 'auto';
                exportContainer.style.position = 'fixed';
                exportContainer.style.top = '-9999px';
                exportContainer.style.zIndex = '-999';
                exportContainer.classList.add('export-mode');
                const header = document.createElement('div');
                header.style.textAlign = 'center';
                header.style.marginBottom = '20px';
                header.innerHTML = `<h1 class="garden-title" style="font-size:32px; color:#44403c; margin-bottom:5px;">${docMetadata.title}</h1><p style="font-size:14px; color:#78716c;">${docMetadata.category} | Linkc Mandala</p>`;
                exportContainer.insertBefore(header, exportContainer.firstChild);
                document.body.appendChild(exportContainer);
                try {
                    const canvas = await html2canvas(exportContainer, { scale: 2, useCORS: true, backgroundColor: '#fcfaf9' });
                    const link = document.createElement('a');
                    link.download = `${docMetadata.title}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                } catch (e) { alert("ÂúñÁâáÂåØÂá∫Â§±Êïó"); }
                document.body.removeChild(exportContainer);
                setLoading(false);
                setShowExportModal(false);
            };

            const handleExportMD = () => {
                const now = new Date().toISOString().split('T')[0];
                const tagList = parseCategories(docMetadata.category);
                const tagsString = `[${tagList.join(', ')}]`;
                let md = `---\ncreated: ${now}\ncategories: Mandala\ntags: ${tagsString}\n---\n\n# ${docMetadata.title}\n\n`;
                
                const size = gridSize;
                const rows = size === 9 ? 9 : 3;
                const cols = size === 9 ? 9 : 3;
                md += `| ${Array(cols).fill(' ').join(' | ')} |\n`;
                md += `| ${Array(cols).fill('---').join(' | ')} |\n`;
                for (let r = 0; r < rows; r++) {
                    let rowContent = [];
                    for (let c = 0; c < cols; c++) {
                        let gIdx, cIdx;
                        if (size === 3) { gIdx = 4; cIdx = r * 3 + c; }
                        else {
                            const gridRow = Math.floor(r / 3);
                            const gridCol = Math.floor(c / 3);
                            gIdx = gridRow * 3 + gridCol;
                            const cellRow = r % 3;
                            const cellCol = c % 3;
                            cIdx = cellRow * 3 + cellCol;
                        }
                        const key = `${gIdx}-${cIdx}`;
                        const cell = data[key] || {};
                        rowContent.push((cell.title || '').replace(/\n/g, ' '));
                    }
                    md += `| ${rowContent.join(' | ')} |\n`;
                }
                md += `\n\n`;

                Object.keys(data).sort().forEach(key => {
                    const cell = data[key];
                    if (cell.title) {
                        md += `## [${key}] ${cell.title}\n`;
                        if(cell.note) md += `${cell.note}\n\n`;
                    }
                });
                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${docMetadata.title}.md`;
                a.click();
                setShowExportModal(false);
            };

            const handleExportPDF = async () => {
                setLoading(true);
                const element = document.getElementById('mandala-grid-container');
                if (!element) return;
                const exportContainer = element.cloneNode(true);
                exportContainer.style.width = '1000px'; 
                exportContainer.style.height = 'auto';
                exportContainer.style.position = 'fixed';
                exportContainer.style.top = '-9999px';
                exportContainer.classList.add('export-mode');
                const header = document.createElement('div');
                header.style.textAlign = 'center';
                header.style.marginBottom = '20px';
                header.innerHTML = `<h1 class="garden-title" style="font-size:32px; color:#44403c; margin-bottom:5px;">${docMetadata.title}</h1>`;
                exportContainer.insertBefore(header, exportContainer.firstChild);
                document.body.appendChild(exportContainer);
                try {
                    const canvas = await html2canvas(exportContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const margin = 10;
                    const maxImgWidth = pageWidth - (margin * 2);
                    const imgHeight = (canvas.height * maxImgWidth) / canvas.width;
                    pdf.addImage(imgData, 'JPEG', margin, margin, maxImgWidth, imgHeight);
                    pdf.save(`${docMetadata.title}.pdf`);
                } catch (e) { alert("PDF ÂåØÂá∫Â§±Êïó"); }
                document.body.removeChild(exportContainer);
                setLoading(false);
                setShowExportModal(false);
            };

            const handleExportXLS = () => {
                let tableHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body>`;
                tableHTML += `<h2>${docMetadata.title}</h2>`;
                tableHTML += `<table border="1" style="border-collapse: collapse; table-layout: fixed;">`;
                
                const size = gridSize;
                const rows = size === 9 ? 9 : 3;
                const cols = size === 9 ? 9 : 3;

                // Loop rows
                for (let r = 0; r < rows; r++) {
                    let rowTitleHTML = `<tr style="height: 40px;">`;
                    let rowNoteHTML = `<tr style="height: 80px;">`;

                    for (let c = 0; c < cols; c++) {
                        let gIdx, cIdx;
                        if (size === 3) {
                            gIdx = 4; 
                            cIdx = r * 3 + c;
                        } else {
                            const gridRow = Math.floor(r / 3);
                            const gridCol = Math.floor(c / 3);
                            gIdx = gridRow * 3 + gridCol;
                            const cellRow = r % 3;
                            const cellCol = c % 3;
                            cIdx = cellRow * 3 + cellCol;
                        }
                        
                        const key = `${gIdx}-${cIdx}`;
                        const cell = data[key] || {};
                        const bg = cell.color ? cell.color : '#ffffff';
                        
                        const text = cell.title ? `<strong>${cell.title}</strong>` : '&nbsp;';
                        rowTitleHTML += `<td style="background-color:${bg}; vertical-align:middle; text-align:center; padding:5px; width:150px; border: 1px solid #000; border-bottom: none; font-size:12pt; mso-number-format:'\@';">${text}</td>`;
                        
                        const note = cell.note ? `<span style="color:#555;">${cell.note}</span>` : '&nbsp;';
                        rowNoteHTML += `<td style="background-color:${bg}; vertical-align:top; padding:5px; width:150px; border: 1px solid #000; border-top: none; font-size:10pt; word-wrap: break-word; mso-number-format:'\@';">${note}</td>`;
                    }
                    
                    rowTitleHTML += `</tr>`;
                    rowNoteHTML += `</tr>`;
                    
                    tableHTML += rowTitleHTML + rowNoteHTML;
                }
                tableHTML += `</table></body></html>`;

                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${docMetadata.title}.xls`;
                a.click();
                setShowExportModal(false);
            };

            const handleFileMenu = (e) => {
                const action = e.target.value;
                e.target.value = "";
                if (action === "new") {
                    if (confirm("Ê∏ÖÁ©∫‰∏¶ÈñãÊñ∞Ê™îÊ°àÔºü")) {
                        setData({}); setCurrentDocId(null); setDocMetadata({title:'Êú™ÂëΩÂêç', category:'‰∏ÄËà¨'});
                        setIsSharedView(false); setZoomedGridIndex(null);
                    }
                } else if (action === "save") {
                    if (isSharedView) { alert("ÂàÜ‰∫´Ê™îË´ãÂè¶Â≠ò"); setModalMode('save_as'); setShowSaveAsModal(true); } 
                    else { currentDocId ? alert("Â∑≤Ëá™ÂãïÂÑ≤Â≠ò") : (()=>{setModalMode('save_as'); setShowSaveAsModal(true);})() }
                } else if (action === "save_as") {
                    setModalMode('save_as');
                    setShowSaveAsModal(true);
                } else if (action === "back") {
                    if (isSharedView) window.history.replaceState({}, document.title, window.location.pathname);
                    setViewMode('browser'); setIsSharedView(false); setZoomedGridIndex(null);
                } else if (action === "import") {
                    fileInputRef.current?.click(); 
                } else if (action === "export_drive") {
                    setShowExportModal(true); 
                } else if (action === "share") {
                    setShowShareModal(true);
                }
            };

            const handleLoadLocal = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const parsed = JSON.parse(ev.target.result);
                        if (confirm("Âç≥Â∞áÂåØÂÖ•ÊõºÈôÄÁæÖ‰∏¶Ëá™ÂãïÂÑ≤Â≠òÁÇ∫Êñ∞Ê™îÊ°à„ÄÇ\n(Á¢∫ÂÆöÂåØÂÖ•?)")) {
                            createNewFile(
                                parsed.title ? `${parsed.title} (ÂåØÂÖ•)` : 'ÂåØÂÖ•ÁöÑÂàÜ‰∫´',
                                parsed.category || '‰∏ÄËà¨',
                                parsed.cells || {},
                                parsed.gridSize || 3
                            );
                        }
                    } catch(e) { alert("Ê†ºÂºèÈåØË™§"); }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };
            
            const handleEmojiClick = (emoji) => {
                const key = `${selectedCell.gIdx}-${selectedCell.cIdx}`;
                const currentVal = (data[key] || {})[editActiveField] || '';
                updateCell(selectedCell.gIdx, selectedCell.cIdx, editActiveField, currentVal + emoji);
            };

            // -- Views --
            const renderCell = (gIdx, cIdx) => {
                const targetGrid = (gridSize === 3 && zoomedGridIndex !== null) ? zoomedGridIndex : gIdx;
                const cellData = data[`${targetGrid}-${cIdx}`] || {};
                const navClass = getNavClass(targetGrid, cIdx);
                
                // Original defaults logic:
                const defaultBg = ((targetGrid===4 && cIdx===4)?'#ecfdf5':(targetGrid===4?'#fdfcdc':(cIdx===4?'#fdfcdc':'#ffffff')));
                const rawBg = cellData.color || defaultBg;
                
                // Apply Tint (40% color, 60% white) - except for defaults which are already light
                // But user wants "Adjust transparency". Tinting works best to keep text readable.
                const finalBg = cellData.color ? getTintedColor(cellData.color, 0.4) : defaultBg;
                
                // Force dark text because we lighten the background
                const textColor = '#44403c'; // stone-700

                return (
                    <div className={`relative border border-stone-300 p-1 flex flex-col h-full overflow-hidden group ${navClass}`}
                         style={{backgroundColor: finalBg, color: textColor}}
                         onClick={() => handleCellClick(targetGrid, cIdx, cellData)}>
                        <div className="flex-1 overflow-hidden">
                            <div className="font-bold text-xs md:text-sm leading-tight mb-1" dangerouslySetInnerHTML={{__html: safeMarkdownInline(cellData.title||'')}} />
                            {viewStyle === 'standard' && <div className="text-[10px] opacity-80 overflow-hidden md-content" dangerouslySetInnerHTML={{__html: safeMarkdown(cellData.note||'')}} />}
                        </div>
                        {navClass && <div className="edit-btn-overlay" onClick={(e)=>{ e.stopPropagation(); setSelectedCell({ gIdx: targetGrid, cIdx, data: cellData }); }}><Icons.Pencil/></div>}
                        
                        <div className="absolute bottom-1 left-1 flex gap-1 z-20">
                            {cellData.link && (
                                <div className="content-icon bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-600"
                                     onClick={(e)=>{ e.stopPropagation(); window.open(cellData.link, '_blank'); }}>
                                    <Icons.Link/>
                                </div>
                            )}
                            {cellData.images && cellData.images.length > 0 && (
                                <div className="content-icon bg-emerald-50 text-emerald-600 border-emerald-200 hover:bg-emerald-600"
                                     onClick={(e)=>{ e.stopPropagation(); setPreviewImage(cellData.images[0]); }}>
                                    <Icons.Photo/>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderGrid = () => {
                if (gridSize === 9 && zoomedGridIndex === null) {
                    return (
                        <div className="grid grid-cols-3 grid-rows-3 gap-1 bg-stone-200 p-1 w-full h-full max-w-4xl max-h-4xl mx-auto aspect-square">
                            {Array.from({length:9}).map((_, g) => (
                                <div key={g} className={`grid grid-cols-3 grid-rows-3 gap-px bg-white ${g===4?'border-2 border-emerald-400 z-10':''}`}>
                                    {Array.from({length:9}).map((_, c) => renderCell(g, c))}
                                </div>
                            ))}
                        </div>
                    );
                } else {
                    const activeGrid = zoomedGridIndex !== null ? zoomedGridIndex : 4;
                    return (
                        <div className="flex flex-col h-full items-center justify-center p-2">
                             <div className="w-full max-w-xl mb-2 flex items-center text-xs text-stone-500 gap-2">
                                <span className="cursor-pointer hover:text-emerald-600" onClick={()=>setZoomedGridIndex(gridSize===9?null:4)}><Icons.Folder/> {gridSize===9?'ÂÖ®ÊôØ':'‰∏ªÁï´Èù¢'}</span>
                                <span>/</span>
                                <span className="font-bold text-stone-700">{activeGrid === 4 ? 'Ê†∏ÂøÉ‰∏ªÈ°å' : `ÂçÄÂüü ${activeGrid}`}</span>
                             </div>
                             <div className="grid grid-cols-3 grid-rows-3 gap-1 bg-stone-300 border-4 border-stone-300 w-full max-w-xl aspect-square shadow-xl">
                                {Array.from({length: 9}).map((_, c) => renderCell(activeGrid, c))}
                            </div>
                        </div>
                    );
                }
            };

            // -- Main --
            if (!user && !isSharedView) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-100 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                            <div className="text-center mb-6"><h1 className="text-2xl font-bold text-stone-800">Mandala Garden</h1></div>
                            <form onSubmit={handleAuth} className="space-y-4">
                                <input className="w-full p-3 border rounded" type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} required />
                                <input className="w-full p-3 border rounded" type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} required />
                                {authError && <div className="text-red-500 text-xs">{authError}</div>}
                                <button className="w-full p-3 bg-emerald-600 text-white rounded font-bold">{authMode==='login'?'ÁôªÂÖ•':'Ë®ªÂÜä'}</button>
                            </form>
                            <button onClick={()=>setAuthMode(authMode==='login'?'register':'login')} className="w-full mt-4 text-sm text-stone-500 underline">{authMode==='login'?'Ê≤íÊúâÂ∏≥ËôüÔºüË®ªÂÜä':'Â∑≤ÊúâÂ∏≥ËôüÔºüÁôªÂÖ•'}</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full w-full overflow-hidden text-stone-800 flex flex-col">
                    {loading && <div className="absolute inset-0 bg-white/90 z-[100] flex items-center justify-center">Loading...</div>}
                    
                    {viewMode === 'browser' ? (
                        <div className="flex h-full bg-[#fcfaf9]">
                            <aside className="w-64 bg-white border-r hidden md:flex flex-col p-4 space-y-2">
                                <div className="mb-4 px-2 text-center">
                                    <div className="font-bold text-sm text-stone-600 break-all leading-tight">{user?.email}</div>
                                    <div className="font-bold text-xl garden-title text-stone-800 mt-1">Mandala Garden</div>
                                </div>
                                <button onClick={()=>setActiveCategory('All')} className={`w-full text-left p-2 rounded ${activeCategory==='All'?'bg-emerald-50':''}`}><Icons.Folder/> ÂÖ®ÈÉ®Ê™îÊ°à</button>
                                <button onClick={()=>setActiveCategory('Trash')} className={`w-full text-left p-2 rounded ${activeCategory==='Trash'?'bg-rose-50':''}`}><Icons.Trash/> ÂûÉÂúæÁ≠í</button>
                                <div className="border-t my-2"></div>
                                <button onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); }} className="w-full text-left p-2"><Icons.Plus/> Êñ∞Â¢û</button>
                                <button onClick={()=>setShowImportModal(true)} className="w-full text-left p-2"><Icons.Share/> ÂåØÂÖ•</button>
                                <button onClick={()=>auth.signOut()} className="w-full text-left p-2 mt-auto"><Icons.SignOut/> ÁôªÂá∫</button>
                            </aside>
                            <main className="flex-1 flex flex-col">
                                <header className="h-14 border-b bg-white flex items-center px-4 justify-between">
                                    <h2 className="font-bold text-lg">{activeCategory === 'All' ? 'ÊàëÁöÑËä±Âúí' : activeCategory}</h2>
                                    <button className="md:hidden" onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); }}><Icons.Plus/></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 content-start">
                                    {fileList.filter(f => activeCategory==='Trash'?f.deleted:!f.deleted).map(f => (
                                        <div key={f.id} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer h-32 flex flex-col justify-between" onClick={()=>loadFileFromDB(f)}>
                                            <div className="font-bold">{f.title}</div>
                                            <div className="text-xs text-stone-400 flex justify-between">
                                                <span>{f.category}</span>
                                                {activeCategory==='Trash' && (
                                                    <div className="flex gap-2">
                                                        <button onClick={(e)=>{e.stopPropagation(); restoreFromTrash(f.id); }} className="text-emerald-600"><Icons.Restore/></button>
                                                        <button onClick={(e)=>{e.stopPropagation(); deleteForever(f.id); }} className="text-rose-600"><Icons.DeleteForever/></button>
                                                    </div>
                                                )}
                                                {activeCategory!=='Trash' && (
                                                    <button onClick={(e)=>{e.stopPropagation(); moveToTrash(f.id); }} className="text-stone-300 hover:text-rose-500"><Icons.Trash/></button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </main>
                        </div>
                    ) : (
                        <div className="flex flex-col h-full bg-[#fcfaf9]">
                            <div className="h-14 bg-white border-b flex items-center justify-between px-4 shrink-0">
                                <div className="flex items-center gap-2">
                                    <button onClick={()=>{setViewMode('browser'); setZoomedGridIndex(null);}} className="text-stone-500">‚Üê</button>
                                    <input className="font-bold text-stone-800 border-none outline-none bg-transparent" value={docMetadata.title} onChange={e=>setDocMetadata({...docMetadata, title:e.target.value})} />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>setShowExportModal(true)}><Icons.Export/></button>
                                    <button onClick={()=>setShowShareModal(true)}><Icons.Share/></button>
                                    <div className="flex border rounded overflow-hidden">
                                        <button onClick={()=>setGridSize(3)} className={`px-2 py-1 text-xs ${gridSize===3?'bg-emerald-100':''}`}>3x3</button>
                                        <button onClick={()=>setGridSize(9)} className={`px-2 py-1 text-xs ${gridSize===9?'bg-emerald-100':''}`}>9x9</button>
                                    </div>
                                    <select className="border rounded text-xs p-1" onChange={handleFileMenu}>
                                        <option value="">ÈÅ∏ÂñÆ</option>
                                        <option value="new">ÈñãÊñ∞Ê™îÊ°à</option>
                                        <option value="save">ÂÑ≤Â≠ò</option>
                                        <option value="save_as">Âè¶Â≠òÊñ∞Ê™î</option>
                                        <option value="share">ÂàÜ‰∫´‰ª£Á¢º</option>
                                        <option value="import">ÂåØÂÖ•Ê™îÊ°à</option>
                                        <option value="back">ÂõûÂàóË°®</option>
                                    </select>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleLoadLocal} />
                                </div>
                            </div>
                            <div className="flex-1 overflow-hidden relative" id="mandala-grid-container">
                                {renderGrid()}
                            </div>
                        </div>
                    )}

                    {/* Modals */}
                    {previewImage && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[60]" onClick={()=>setPreviewImage(null)}>
                            <img src={previewImage} className="max-w-full max-h-full object-contain" />
                            <button className="absolute top-4 right-4 text-white text-4xl" onClick={()=>setPreviewImage(null)}>√ó</button>
                        </div>
                    )}

                    {selectedCell && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setSelectedCell(null)}>
                            <div className="bg-white w-full max-w-md rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[85vh]" onClick={e=>e.stopPropagation()}>
                                <div className="p-3 bg-emerald-600 text-white font-bold flex justify-between"><span>Á∑®ËºØÂÖßÂÆπ</span><button onClick={()=>setSelectedCell(null)}>‚úï</button></div>
                                <div className="p-4 overflow-y-auto flex-1 flex flex-col gap-4">
                                    
                                    {/* Title Section */}
                                    <div className="space-y-1">
                                        <label className="text-xs text-stone-500 font-bold">Ê®ôÈ°å</label>
                                        <input 
                                            className={`w-full border p-2 rounded text-stone-800 font-bold focus:ring-2 focus:ring-emerald-500 outline-none ${editActiveField==='title'?'border-emerald-500':''}`} 
                                            placeholder="Ëº∏ÂÖ•Ê®ôÈ°å..." 
                                            value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).title || ''} 
                                            onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'title', e.target.value)}
                                            onFocus={()=>setEditActiveField('title')}
                                        />
                                    </div>

                                    {/* Note Section */}
                                    <div className="space-y-1 flex-1">
                                        <label className="text-xs text-stone-500 font-bold">ÂÇôË®ª</label>
                                        <textarea 
                                            className={`w-full border p-2 rounded h-32 text-stone-800 focus:ring-2 focus:ring-emerald-500 outline-none resize-none ${editActiveField==='note'?'border-emerald-500':''}`} 
                                            placeholder="Ëº∏ÂÖ•ÂÇôË®ª..." 
                                            value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).note || ''} 
                                            onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'note', e.target.value)}
                                            onFocus={()=>setEditActiveField('note')}
                                        ></textarea>
                                    </div>
                                    
                                    {/* Emoji Section - Moved Below Note */}
                                    <div className="space-y-1">
                                        <div className="flex justify-between items-center"><span className="text-xs font-bold text-stone-500">ÊèíÂÖ•Emoji</span><span className="text-[10px] text-stone-400">ÁõÆÂâç‰ΩçÁΩÆ: {editActiveField === 'title' ? 'Ê®ôÈ°å' : 'ÂÇôË®ª'}</span></div>
                                        <div className="flex gap-1 overflow-x-auto pb-2 scrollbar-hide border-b border-stone-100">
                                            {EMOJI_LIST.map(emoji => (
                                                <button key={emoji} onClick={() => handleEmojiClick(emoji)} className="text-lg hover:bg-stone-100 p-1 rounded transition min-w-[28px]">{emoji}</button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Tools Row: Link & Color */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-xs text-stone-500 font-bold">ÈÄ£Áµê</label>
                                            <input className="w-full border p-2 rounded text-sm text-stone-600 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="https://..." value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).link || ''} onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'link', e.target.value)} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs text-stone-500 font-bold">ËÉåÊôØÈ°èËâ≤</label>
                                            <div className="flex items-center border p-1 rounded h-[38px]">
                                                <input type="color" className="w-full h-full cursor-pointer bg-transparent border-none" value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).color?.startsWith('#') ? (data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).color : '#ffffff'} onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'color', e.target.value)} />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Image Upload */}
                                    <div className="space-y-1">
                                        <label className="text-xs text-stone-500 font-bold">ÂúñÁâá</label>
                                        <div className="border p-2 rounded bg-stone-50 flex items-center justify-between">
                                             {isUploading ? (
                                                <span className="text-emerald-600 text-sm animate-pulse">‰∏äÂÇ≥‰∏≠...</span>
                                            ) : (
                                                <input type="file" className="text-sm text-stone-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200" onChange={e => handleImageUpload(e.target.files[0])} />
                                            )}
                                            {(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).images?.length > 0 && (
                                                <span className="text-xs text-stone-500 bg-white px-2 py-1 rounded border">Â∑≤Â≠ò 1 Âúñ</span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Footer Buttons */}
                                <div className="p-3 border-t bg-stone-50 flex justify-between items-center">
                                    <button 
                                        onClick={()=>clearCell(selectedCell.gIdx, selectedCell.cIdx)}
                                        className="text-red-500 text-sm hover:bg-red-50 px-3 py-1.5 rounded transition font-medium"
                                    >
                                        Ê∏ÖÈô§ÂÖßÂÆπ
                                    </button>
                                    <button 
                                        onClick={()=>setSelectedCell(null)}
                                        className="bg-white border border-stone-300 text-stone-600 px-4 py-1.5 rounded text-sm hover:bg-stone-100 transition shadow-sm font-medium"
                                    >
                                        ÈóúÈñâ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSaveAsModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80">
                                <h3 className="font-bold mb-4">{modalMode === 'new' ? 'Âª∫Á´ãÊñ∞Ê™îÊ°à' : 'Âè¶Â≠òÊñ∞Ê™î'}</h3>
                                <input id="save-title" className="w-full border p-2 rounded mb-2" defaultValue={docMetadata.title} placeholder="Ê®ôÈ°å" />
                                <input id="save-cat" className="w-full border p-2 rounded mb-4" defaultValue={docMetadata.category} placeholder="ÂàÜÈ°û" />
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setShowSaveAsModal(false)} className="px-4 py-2">ÂèñÊ∂à</button>
                                    <button onClick={handleSaveAction} className="px-4 py-2 bg-emerald-600 text-white rounded">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-96">
                                <h3 className="font-bold mb-4">ÂåØÂÖ•</h3>
                                <textarea className="w-full border p-2 h-32 text-xs mb-2" value={importCode} onChange={e=>setImportCode(e.target.value)} placeholder="Ë≤º‰∏ä‰ª£Á¢º..."></textarea>
                                <button onClick={handleImportCodeSubmit} className="w-full bg-stone-800 text-white py-2 rounded">ÂåØÂÖ•‰∏¶Â≠òÊ™î</button>
                                <button onClick={()=>setShowImportModal(false)} className="w-full mt-2 text-stone-500">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    )}

                    {showShareModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80 text-center">
                                <h3 className="font-bold mb-4">ÂàÜ‰∫´</h3>
                                <button onClick={handleCopyCode} className="w-full border p-2 rounded mb-2">Ë§áË£Ω‰ª£Á¢º</button>
                                <button onClick={handleExportFile} className="w-full border p-2 rounded mb-2">‰∏ãËºâ JSON</button>
                                <button onClick={()=>setShowShareModal(false)} className="text-stone-500 mt-2">ÈóúÈñâ</button>
                            </div>
                        </div>
                    )}
                    
                     {showExportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-64 space-y-2 text-center">
                                <h3 className="font-bold mb-4">ÂåØÂá∫</h3>
                                <button onClick={handleExportXLS} className="w-full border p-2 rounded">Excel</button>
                                <button onClick={handleExportJPG} className="w-full border p-2 rounded">JPG</button>
                                <button onClick={handleExportPDF} className="w-full border p-2 rounded">PDF</button>
                                <button onClick={handleExportMD} className="w-full border p-2 rounded">Markdown</button>
                                <button onClick={()=>setShowExportModal(false)} className="text-stone-500 mt-2">ÈóúÈñâ</button>
                            </div>
                        </div>
                    )}

                    {showGlobalSearchModal && (
                         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-4 rounded-xl w-full max-w-lg h-[60vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold">ÂÖ®ÂüüÊêúÂ∞ã</h3><button onClick={()=>setShowGlobalSearchModal(false)}>‚úï</button></div>
                                <div className="flex gap-2 mb-4"><input className="flex-1 border p-2 rounded" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} /><button onClick={performGlobalSearch}>Êêú</button></div>
                                <div className="flex-1 overflow-y-auto space-y-2">
                                    {globalSearchResults.map(f => (
                                        <div key={f.id} className="border p-2 rounded cursor-pointer hover:bg-stone-50" onClick={()=>loadFileFromDB(f)}>
                                            <div className="font-bold">{f.title}</div>
                                            <div className="text-xs text-stone-500">ÂåπÈÖçÂ∫¶: {f.score}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
