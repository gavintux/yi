<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script>
        const SITE_CONFIG = {
            // 1. Á∂≤Á´ôÂü∫Êú¨Ë≥áË®äËàá SEO (Search Engine Optimization)
            seo: {
                title: "Linkc Photo Space",        // ÁÄèË¶ΩÂô®Ê®ôÁ±§Ê®ôÈ°å
                siteName: "Linkc Gallery",         // Á∂≤Á´ôÂêçÁ®± (È°ØÁ§∫Âú® Header)
                description: "Linkc ÁöÑÂÄã‰∫∫ÊîùÂΩ±Á©∫ÈñìÔºåÁ¥ÄÈåÑÁîüÊ¥ªËàáÊóÖË°åÁöÑÁû¨Èñì„ÄÇ", // Á∂≤Á´ôÊèèËø∞ (Áµ¶ÊêúÂ∞ãÂºïÊìéÁúã)
                keywords: "ÊîùÂΩ±, ÊóÖË°å, ÁîüÊ¥ª, Linkc, Áõ∏Á∞ø, ‰ΩúÂìÅÈõÜ, Olympus, TG-6",     // ÈóúÈçµÂ≠ó
                author: "Linkc",                   // ‰ΩúËÄÖÂêçÁ®±
                logoImage: "https://firebasestorage.googleapis.com/v0/b/linkcphoto.firebasestorage.app/o/photos%2Flinkc-w0.png?alt=media&token=63c9b589-aa78-480a-bed2-1c83634f4b9f", // Logo ÂúñÁâáÁ∂≤ÂùÄ
                logoLink: "https://2blog.ilc.edu.tw/linkc/", // ÈªûÊìä Logo Ë∑≥ËΩâÁöÑÁ∂≤ÂùÄ
                portalLink: "https://gavintux.github.io/yi/" // Âú∞ÁêÉÂúñÁ§∫ (Portal) ÈÄ£Áµê
            },

            // 2. Â§ñËßÄ‰∏ªÈ°åË®≠ÂÆö (Theme & Colors)
            theme: {
                primaryColor: '#4f46e5',      // ‰∏ªËâ≤Ë™ø (ÊåâÈàï„ÄÅÈáçÈªûÊñáÂ≠ó) - È†êË®≠ Indigo-600
                secondaryColor: '#6366f1',    // Ê¨°Ë¶ÅËâ≤Ë™ø (Hover ÊïàÊûúÁ≠â) - È†êË®≠ Indigo-500
                backgroundColor: '#f8fafc',   // Á∂≤Á´ôËÉåÊôØÈ°èËâ≤ - È†êË®≠ Slate-50
                textColor: '#1e293b',         // ‰∏ªË¶ÅÊñáÂ≠óÈ°èËâ≤ - È†êË®≠ Slate-800
                fontFamily: 'Inter, system-ui, sans-serif' // Â≠óÈ´îË®≠ÂÆö
            },

            // 3. Firebase Ë®≠ÂÆö (Ë´ãÂú®Ê≠§Â°´ÂÖ•ÊÇ®ÁöÑ Firebase Â∞àÊ°àË≥áË®ä)
            firebase: {
                apiKey: "AIzaSyDwXsplXePeD1wU1GG4BwQBR6iSMd3_5nY",
                authDomain: "linkcphoto.firebaseapp.com",
                projectId: "linkcphoto",
                storageBucket: "linkcphoto.firebasestorage.app",
                messagingSenderId: "841541302440",
                appId: "1:841541302440:web:a2b3dfef70a32bb345ea9d",
                measurementId: "G-902H2EHVFF"
            },
            
            // 4. Á≥ªÁµ±Ë®≠ÂÆö
            system: {
                collectionName: 'linkc_photos_v1', // Firestore Ë≥áÊñôÂ∫´ÈõÜÂêàÂêçÁ®±
                adminPasscode: '590123',           // ÁÆ°ÁêÜÂì°ÁôªÂÖ•ÂØÜÁ¢º
                itemsPerPage: 12,                  // ÊØèÊ¨°ËºâÂÖ•ÁöÑÁÖßÁâáÊï∏Èáè
            },

            // 5. Âú∞ÂúñË®≠ÂÆö
            map: {
                defaultCenter: [23.6, 121], // È†êË®≠‰∏≠ÂøÉÈªû [Á∑ØÂ∫¶, Á∂ìÂ∫¶] (Âè∞ÁÅ£)
                defaultZoom: 8              // È†êË®≠Á∏ÆÊîæÂ±§Á¥ö
            }
        };

        // =============================================================================
        // üöÄ Ëá™ÂãïÂåñÂàùÂßãÂåñËÖ≥Êú¨ (Ë´ãÂãø‰øÆÊîπ‰ª•‰∏ãÂÖßÂÆπÔºåÈô§ÈùûÊÇ®Áü•ÈÅìËá™Â∑±Âú®ÂÅö‰ªÄÈ∫º)
        // =============================================================================
        (function applySiteConfig() {
            // 1. Ë®≠ÂÆö SEO Meta Tags
            document.title = SITE_CONFIG.seo.title;
            
            const setMeta = (name, content) => {
                let meta = document.querySelector(`meta[name="${name}"]`);
                if (!meta) {
                    meta = document.createElement('meta');
                    meta.name = name;
                    document.head.appendChild(meta);
                }
                meta.content = content;
            };
            setMeta('description', SITE_CONFIG.seo.description);
            setMeta('keywords', SITE_CONFIG.seo.keywords);
            setMeta('author', SITE_CONFIG.seo.author);

            // 2. Ê≥®ÂÖ• CSS ËÆäÊï∏ (Áµ¶Èùû Tailwind ÁöÑÊ®£Âºè‰ΩøÁî®ÔºåÂ¶ÇÂú∞Âúñ Marker, Loading)
            const root = document.documentElement;
            root.style.setProperty('--primary-color', SITE_CONFIG.theme.primaryColor);
            root.style.setProperty('--bg-color', SITE_CONFIG.theme.backgroundColor);
            root.style.setProperty('--text-color', SITE_CONFIG.theme.textColor);
            root.style.setProperty('--font-family', SITE_CONFIG.theme.fontFamily);
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Ë®≠ÂÆö Tailwind ‰ΩøÁî® SITE_CONFIG ÁöÑÈ°èËâ≤
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: SITE_CONFIG.theme.fontFamily.split(','),
                        serif: ['"Noto Serif TC"', 'serif'],
                    },
                    colors: {
                        // Ë¶ÜÂØ´ indigo ÁÇ∫‰ΩøÁî®ËÄÖË®≠ÂÆöÁöÑ‰∏ªËâ≤ÔºåÈÄôÊ®£ÊâÄÊúâ indigo-* class ÈÉΩÊúÉËÆäËâ≤
                        indigo: {
                            500: SITE_CONFIG.theme.secondaryColor, 
                            600: SITE_CONFIG.theme.primaryColor,
                            50:  SITE_CONFIG.theme.primaryColor + '10', // 10% opacity hex approximation
                            100: SITE_CONFIG.theme.primaryColor + '20',
                            900: '#312e81', //‰øùÁïôÊ∑±Ëâ≤
                        },
                        slate: {
                            50: SITE_CONFIG.theme.backgroundColor, // Á∂≤Á´ôËÉåÊôØ
                            800: SITE_CONFIG.theme.textColor,      // ‰∏ªË¶ÅÊñáÂ≠ó
                            900: '#0f172a', //‰øùÁïôÊ∑±Ëâ≤
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); -webkit-font-smoothing: antialiased; }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: var(--primary-color); font-weight: 500; letter-spacing: 0.05em; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Masonry Grid */
        .masonry-grid { column-count: 1; column-gap: 1.5rem; }
        @media (min-width: 640px) { .masonry-grid { column-count: 2; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
        .masonry-item { break-inside: avoid; margin-bottom: 1.5rem; }
        
        /* Map Custom Styles */
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        
        /* Dynamic Marker Colors */
        .photo-marker { border: 3px solid white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); overflow: hidden; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: white; position: relative; }
        .photo-marker:hover { transform: scale(1.2); z-index: 1000 !important; border-color: var(--primary-color); }
        .photo-marker img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Custom Cluster Icon */
        .custom-cluster-icon { background: none; border: none; }
        .cluster-marker-inner { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; background-color: var(--primary-color); color: white; border-radius: 50%; font-weight: bold; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 2px solid white; font-size: 0.875rem; }

        .leaflet-top.leaflet-right { margin-top: 10px; margin-right: 10px; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">
            <div class="flex flex-col items-center gap-4">
                <div class="w-8 h-8 border-2 border-t-transparent rounded-full animate-spin" style="border-color: var(--primary-color); border-top-color: transparent;"></div>
                <span class="text-sm uppercase tracking-widest" style="color: #94a3b8;">Loading Gallery...</span>
            </div>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Camera, MapPin, Clock, Search, Upload, Download, Tag, Eye, X, 
            Image as ImageIcon, Maximize2, Share2, Facebook, Instagram, 
            MessageCircle, Copy, Check, Lock, Unlock, Edit, Trash2, LogOut, 
            Cloud, RefreshCw, AlertTriangle, Info, Save, Link as LinkIcon, FileUp, 
            Sparkles, Map as MapIcon, Aperture, Disc, Gauge, 
            ArrowDownWideNarrow, ArrowUpNarrowWide, Filter, FileCode,
            Calendar as CalendarIcon, ChevronLeft, ChevronRight, XCircle, MoreHorizontal, Globe, ChevronDown, Layers
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // =============================================================================
        // üöÄ APP LOGIC
        // =============================================================================

        // ÂàùÂßãÂåñÊ™¢Êü•ÔºöÁ¢∫Ë™ç API Key ÊòØÂê¶Â∑≤Â°´ÂØ´
        const isConfigConfigured = !SITE_CONFIG.firebase.apiKey.includes("ÊÇ®ÁöÑAPI_KEY");

        let app, auth, db, storage;
        if (isConfigConfigured) {
            try {
                app = initializeApp(SITE_CONFIG.firebase);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase Init Error", e);
            }
        }

        // --- Helpers (ËºîÂä©ÂáΩÂºè) ---
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => { const h = setTimeout(() => setDebouncedValue(value), delay); return () => clearTimeout(h); }, [value, delay]);
            return debouncedValue;
        }

        const getExifValue = (item) => {
            if (typeof item === 'number') return item;
            if (typeof item === 'string') return item.includes('/') ? Number(item.split('/')[0]) / Number(item.split('/')[1]) : Number(item);
            if (item && item.numerator !== undefined && item.denominator !== undefined) return item.denominator === 0 ? 0 : item.numerator / item.denominator;
            if (item && typeof item.valueOf === 'function') { const val = item.valueOf(); return isNaN(val) ? 0 : Number(val); }
            return 0;
        };

        const formatExposureBias = (bias) => {
            const val = getExifValue(bias);
            if (val === 0) return "0";
            const sign = val > 0 ? "+" : "";
            const absVal = Math.abs(val);
            if (Math.abs(absVal - 0.333) < 0.01) return `${sign}1/3`;
            if (Math.abs(absVal - 0.666) < 0.01) return `${sign}2/3`;
            if (Math.abs(absVal - 0.5) < 0.01) return `${sign}1/2`;
            return Number.isInteger(val) ? `${sign}${val}` : `${sign}${val.toFixed(1)}`;
        };

        // --- Âº∑ÂåñÁöÑÈè°È†≠Ë≥áË®äËàáÈ´òÂ∫¶Ëß£Êûê ---
        const parseLensInfo = (lensInfo, allTags) => {
            // Á≠ñÁï• A: Áõ¥Êé•ËÆÄÂèñ LensModel (ÊúÄÊ∫ñÁ¢∫)
            if (allTags.LensModel && typeof allTags.LensModel === 'string' && allTags.LensModel.trim() !== '') {
                return allTags.LensModel.replace(/\0/g, '').trim();
            }
            
            // Á≠ñÁï• B: ËÆÄÂèñ Lens (Êüê‰∫õÁõ∏Ê©üÁî®ÈÄôÂÄã tag)
            if (allTags.Lens && typeof allTags.Lens === 'string') {
                return allTags.Lens.replace(/\0/g, '').trim();
            }

            // Á≠ñÁï• C: Âæû LensInfo (ÂõõÂÄãÊï∏ÂÄº) ÊãºÊπä (MinFocal, MaxFocal, MinF, MaxF)
            // Ê≥®ÊÑèÔºöexif-js ÊúâÊôÇÊúÉÊääÈÄôÂÄãÊîæÂú® 'UndefinedTag:0xA432'
            const info = lensInfo || allTags['UndefinedTag:0xA432'];
            
            if (!info || info.length < 4) return "";

            const minFocal = getExifValue(info[0]);
            const maxFocal = getExifValue(info[1]);
            const minF = getExifValue(info[2]);
            const maxF = getExifValue(info[3]);

            if (!minFocal) return "";

            let focalStr = (minFocal === maxFocal) ? `${minFocal}mm` : `${minFocal}-${maxFocal}mm`;
            let apertureStr = "";
            if (minF > 0) {
                apertureStr = (minF === maxF || !maxF) ? `f/${minF}` : `f/${minF}-${maxF}`;
            }

            return `${focalStr} ${apertureStr}`.trim();
        };

        const findLensNameInAllTags = (allTags) => {
            // ÁÇ∫‰∫ÜÁõ∏ÂÆπÊÄß‰øùÁïôÊ≠§ÂáΩÂºèÂÖ•Âè£Ôºå‰ΩÜÈÇèËºØÂ∑≤Âº∑ÂåñËá≥ parseLensInfo
            return parseLensInfo(allTags.LensInfo, allTags);
        };

        // È´òÂ∫¶Ë®àÁÆó (GPSAltitude)
        const getAltitude = (alt, ref) => {
            const value = getExifValue(alt);
            if (!value && value !== 0) return null;
            // Ref: 0 = Above Sea Level, 1 = Below Sea Level
            const isBelowSea = ref === 1 || ref === '1'; 
            return isBelowSea ? -value : value;
        };

        const convertDMSToDD = (dms, ref) => {
            if (!dms) return null;
            const d = getExifValue(dms[0]);
            const m = getExifValue(dms[1]);
            const s = getExifValue(dms[2]);
            let dd = d + m / 60 + s / 3600;
            if (ref === "S" || ref === "W") dd = dd * -1;
            if (isNaN(dd) || (dd === 0 && d === 0 && m === 0)) return null;
            return dd;
        };

        const reverseGeocode = async (lat, lon) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                if (!response.ok) return null;
                const data = await response.json();
                return data.address;
            } catch (error) { console.error("Geocoding failed", error); return null; }
        };

        const copyToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed'; textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try { document.execCommand('copy'); } catch (err) { console.error('Copy failed', err); }
            document.body.removeChild(textArea);
        };

        const downloadWithWatermark = async (imageUrl, filename, e) => {
            if(e) e.stopPropagation();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = imageUrl;
            return new Promise((resolve) => {
                img.onload = () => {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const fontSize = Math.max(20, img.width * 0.03); 
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'bottom';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        const padding = fontSize;
                        ctx.fillText(SITE_CONFIG.seo.author, canvas.width - padding, canvas.height - padding);
                        const link = document.createElement('a');
                        link.download = `${SITE_CONFIG.seo.author}_${filename}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        resolve(true);
                    } catch (err) { console.warn("Canvas Tainted", err); window.open(imageUrl, '_blank'); resolve(false); }
                };
                img.onerror = () => { window.open(imageUrl, '_blank'); resolve(false); };
            });
        };

        // --- Components ---

        const ConfigError = () => (
            <div className="error-container bg-slate-50">
                <div className="error-box border border-slate-200 shadow-md">
                    <AlertTriangle className="mx-auto h-12 w-12 text-yellow-500 mb-4" />
                    <h3 className="error-title text-slate-900">Â∞öÊú™Ë®≠ÂÆö Firebase</h3>
                    <p className="text-slate-600 mb-4">Ë´ãÁ∑®ËºØ HTML Ê™îÊ°àÈ†ÇÈÉ®ÁöÑ SITE_CONFIG ÂçÄÂ°ä„ÄÇ</p>
                </div>
            </div>
        );

        const AuthError = ({ message }) => (
            <div className="error-container bg-slate-50">
                <div className="error-box border border-red-200 shadow-md">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-500 mb-4" />
                    <h3 className="error-title text-slate-900">ÈÄ£Á∑öÂ§±Êïó</h3>
                    <p className="text-slate-800 font-mono text-xs bg-red-50 p-2 rounded mb-4 break-all">{message}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-sm transition-colors">ÈáçÊñ∞Êï¥ÁêÜ</button>
                </div>
            </div>
        );

        const Header = ({ setView, isAdmin, onLoginClick, onLogout, currentView }) => (
            <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-24 flex items-center justify-between">
                <div className="flex items-center gap-2 min-w-0 shrink-0">
                    <a href={SITE_CONFIG.seo.logoLink} target="_blank" rel="noopener noreferrer" className="flex items-center hover:opacity-80 transition-opacity shrink-0" title="ÂâçÂæÄ Blog">
                        <img src={SITE_CONFIG.seo.logoImage} alt="Logo" className="h-16 w-auto mr-2 object-contain shrink-0" />
                    </a>
                    <div className="flex items-center cursor-pointer gap-2 shrink-0" onClick={() => setView('gallery')}>
                        <h1 className="text-lg sm:text-2xl font-bold text-gray-900 tracking-tight whitespace-nowrap">{SITE_CONFIG.seo.siteName}</h1>
                    </div>
                    {isAdmin && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold ml-2 shrink-0">ADMIN</span>}
                </div>
                <div className="flex items-center gap-1 sm:gap-3 shrink-0 ml-2">
                    <a href={SITE_CONFIG.seo.portalLink} target="_blank" rel="noopener noreferrer" className="p-2 sm:p-2.5 rounded-xl transition-all text-gray-400 hover:text-gray-700 hover:bg-gray-100 hidden sm:block" title="Portal">
                        <Globe size={20} />
                    </a>
                    <button onClick={() => setView('map')} className={`p-2 sm:p-2.5 rounded-xl transition-all ${currentView === 'map' ? 'bg-indigo-100 text-indigo-600' : 'text-gray-500 hover:text-indigo-600 hover:bg-gray-100'}`} title="Âú∞ÂúñÊ®°Âºè">
                        <MapIcon size={20} />
                    </button>
                    <button onClick={() => setView('calendar')} className={`p-2 sm:p-2.5 rounded-xl transition-all ${currentView === 'calendar' ? 'bg-indigo-100 text-indigo-600' : 'text-gray-500 hover:text-indigo-600 hover:bg-gray-100'}`} title="Êó•ÊõÜÊ®°Âºè">
                        <CalendarIcon size={20} />
                    </button>

                    {isAdmin ? (
                        <button onClick={onLogout} className="p-2 sm:p-2.5 text-gray-500 hover:text-red-600 transition-colors" title="ÁôªÂá∫"><LogOut size={20} /></button>
                    ) : (
                        <button onClick={onLoginClick} className="p-2 sm:p-2.5 text-gray-400 hover:text-indigo-600 transition-colors" title="ÁôªÂÖ•"><Lock size={20} /></button>
                    )}
                    {isAdmin && (
                        <button onClick={() => setView('upload')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-3 sm:px-5 py-2 sm:py-2.5 rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm">
                            <Upload size={18} /><span className="hidden sm:inline">Êñ∞Â¢û</span>
                        </button>
                    )}
                </div>
                </div>
            </header>
        );

        const MapView = ({ photos }) => {
            const mapRef = useRef(null);
            const clusterGroupRef = useRef(null);
            const tileLayerRef = useRef(null);
            const [currentStyle, setCurrentStyle] = useState('voyager');

            const mapStyles = {
                voyager: { name: 'Êé¢Èö™ (Voyager)', url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png' },
                osm: { name: 'Ê®ôÊ∫ñ (OSM)', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' },
                positron: { name: 'Á∞°Á¥ÑÁôΩ (Positron)', url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png' },
                dark: { name: 'Ê∑±Ëâ≤ (Dark)', url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' },
                satellite: { name: 'Ë°õÊòü (Satellite)', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' }
            };
            
            useEffect(() => {
                if (!document.getElementById('map')) return;
                
                if (!mapRef.current) {
                    mapRef.current = L.map('map', { maxZoom: 18 }).setView(SITE_CONFIG.map.defaultCenter, SITE_CONFIG.map.defaultZoom);
                    
                    clusterGroupRef.current = L.markerClusterGroup({
                        showCoverageOnHover: false,
                        maxClusterRadius: 40,
                        iconCreateFunction: function(cluster) {
                            const count = cluster.getChildCount();
                            return L.divIcon({
                                html: `<div class="cluster-marker-inner">${count}</div>`,
                                className: 'custom-cluster-icon',
                                iconSize: L.point(40, 40)
                            });
                        }
                    });
                    mapRef.current.addLayer(clusterGroupRef.current);
                }
            }, []);

            useEffect(() => {
                if (!mapRef.current) return;
                if (tileLayerRef.current) mapRef.current.removeLayer(tileLayerRef.current);

                const style = mapStyles[currentStyle];
                tileLayerRef.current = L.tileLayer(style.url, {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(mapRef.current);
                
                if (clusterGroupRef.current) clusterGroupRef.current.bringToFront();
            }, [currentStyle]);

            useEffect(() => {
                if (!mapRef.current || !clusterGroupRef.current) return;

                const geotaggedPhotos = photos.filter(p => {
                    const lat = parseFloat(p.location?.lat);
                    const lng = parseFloat(p.location?.lng);
                    return !isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0;
                });

                clusterGroupRef.current.clearLayers();
                const markers = [];

                geotaggedPhotos.forEach(photo => {
                    const lat = parseFloat(photo.location.lat);
                    const lng = parseFloat(photo.location.lng);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const customIcon = L.divIcon({
                            className: 'custom-icon',
                            html: `<div class="photo-marker w-12 h-12 rounded-full border-2 border-white shadow-lg overflow-hidden relative bg-white cursor-pointer group hover:border-indigo-500 transition-colors">
                                     <img src="${photo.url}" class="w-full h-full object-cover" />
                                   </div>`,
                            iconSize: [48, 48],
                            iconAnchor: [24, 48],
                            popupAnchor: [0, -48]
                        });

                        const marker = L.marker([lat, lng], { icon: customIcon });
                        const popupContent = `
                            <div class="text-center min-w-[200px] font-sans p-2">
                                <div class="h-32 w-full mb-3 bg-slate-100 rounded-lg overflow-hidden">
                                    <img src="${photo.url}" class="w-full h-full object-cover" />
                                </div>
                                <p class="font-bold text-base mb-1 text-slate-800">${photo.location.city || ''} ${photo.location.spot || ''}</p>
                                <p class="text-xs text-slate-500 mb-2">${photo.date ? photo.date.split('T')[0] : ''}</p>
                                <button class="w-full py-2 bg-indigo-50 text-indigo-600 rounded-md text-xs font-bold hover:bg-indigo-100 transition-colors" onclick="window.dispatchEvent(new CustomEvent('openLightbox', {detail: '${photo.id}'}))">
                                    Êü•ÁúãÂÆåÊï¥ÁÖßÁâá
                                </button>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        markers.push(marker);
                    }
                });

                if (markers.length > 0) {
                    clusterGroupRef.current.addLayers(markers);
                    setTimeout(() => { mapRef.current.invalidateSize(); }, 100);
                }
            }, [photos]);

            return (
                <div className="w-full h-[calc(100vh-6rem)] relative bg-slate-50 animate-fade-in-up">
                    <div id="map" className="w-full h-full z-0"></div>
                    <div className="absolute top-4 right-4 z-[1000] bg-white p-1 rounded-lg shadow-md border border-slate-200 flex items-center gap-2">
                        <Layers size={16} className="text-slate-400 ml-2" />
                        <select value={currentStyle} onChange={(e) => setCurrentStyle(e.target.value)} className="text-sm text-slate-700 bg-transparent border-none focus:ring-0 cursor-pointer py-1 pr-8">
                            {Object.entries(mapStyles).map(([key, style]) => (<option key={key} value={key}>{style.name}</option>))}
                        </select>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ photos, onSelectDate, onExpand, isAdmin, onEdit, onDelete }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [showPicker, setShowPicker] = useState(false);
            const photoSectionRef = useRef(null);

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay };
            };

            const { days, firstDay } = getDaysInMonth(currentDate);
            const monthNames = ["‰∏ÄÊúà", "‰∫åÊúà", "‰∏âÊúà", "ÂõõÊúà", "‰∫îÊúà", "ÂÖ≠Êúà", "‰∏ÉÊúà", "ÂÖ´Êúà", "‰πùÊúà", "ÂçÅÊúà", "ÂçÅ‰∏ÄÊúà", "ÂçÅ‰∫åÊúà"];
            
            const availableData = useMemo(() => {
                const data = {};
                photos.forEach(p => {
                    const d = p.exif?.date || p.date;
                    if (d) {
                        const year = new Date(d).getFullYear();
                        const month = new Date(d).getMonth();
                        if (!data[year]) data[year] = new Set();
                        data[year].add(month);
                    }
                });
                return data;
            }, [photos]);

            const availableYears = Object.keys(availableData).sort((a, b) => b - a);
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            
            const handleJump = (year, monthIndex) => {
                setCurrentDate(new Date(year, monthIndex, 1));
                setShowPicker(false);
            };

            const getFormattedDate = (day) => {
                const y = currentDate.getFullYear();
                const m = String(currentDate.getMonth() + 1).padStart(2, '0');
                const d = String(day).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            const getPhotosForDate = (dateStr) => photos.filter(p => (p.exif?.date || p.date || '').startsWith(dateStr));
            const handleDateClick = (dateStr) => { setSelectedDate(dateStr); setTimeout(() => { photoSectionRef.current?.scrollIntoView({ behavior: 'smooth' }); }, 100); };
            const selectedPhotos = selectedDate ? getPhotosForDate(selectedDate) : [];

            return (
                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in-up pb-12">
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 sm:p-8 relative">
                        <div className="flex justify-between items-center mb-8">
                            <button onClick={() => setShowPicker(!showPicker)} className="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2 hover:bg-slate-50 px-3 py-1 rounded-lg transition-colors group">
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 sm:p-2 rounded-lg group-hover:bg-indigo-200 transition-colors"><CalendarIcon size={20} /></span>
                                <span>{currentDate.getFullYear()}Âπ¥ {monthNames[currentDate.getMonth()]}</span>
                                <ChevronDown size={18} className={`text-gray-400 transition-transform duration-200 ${showPicker ? 'rotate-180' : ''}`} />
                            </button>
                            <div className="flex gap-2">
                                <button onClick={prevMonth} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors"><ChevronLeft /></button>
                                <button onClick={nextMonth} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors"><ChevronRight /></button>
                            </div>
                        </div>

                        {showPicker && (
                            <div className="absolute top-20 left-0 right-0 z-20 bg-white shadow-xl border border-slate-200 rounded-xl p-6 mx-4 sm:mx-8 animate-fade-in-up max-h-[60vh] overflow-y-auto">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    {availableYears.map(year => (
                                        <div key={year} className="space-y-2">
                                            <h4 className="font-bold text-indigo-600 border-b border-slate-100 pb-1 sticky top-0 bg-white">{year}</h4>
                                            <div className="grid grid-cols-4 gap-2">
                                                {monthNames.map((m, idx) => {
                                                    const hasPhotos = availableData[year]?.has(idx);
                                                    return (
                                                        <button 
                                                            key={idx} 
                                                            onClick={() => handleJump(year, idx)}
                                                            className={`text-sm py-2 rounded transition-colors relative ${
                                                                year == currentDate.getFullYear() && idx === currentDate.getMonth() ? 'bg-indigo-600 text-white font-bold' : 'text-slate-600 hover:bg-indigo-50'
                                                            }`}
                                                        >
                                                            {idx + 1}Êúà
                                                            {hasPhotos && <span className="absolute top-1 right-1 w-2 h-2 bg-indigo-400 rounded-full border border-white"></span>}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-7 gap-1 sm:gap-4 mb-4 text-center text-slate-400 font-bold text-xs uppercase tracking-wider">
                            <div>Êó•</div><div>‰∏Ä</div><div>‰∫å</div><div>‰∏â</div><div>Âõõ</div><div>‰∫î</div><div>ÂÖ≠</div>
                        </div>
                        
                        <div className="grid grid-cols-7 gap-1 sm:gap-4">
                            {Array.from({ length: firstDay }).map((_, i) => (<div key={`empty-${i}`} className="h-14 sm:h-32 rounded-lg sm:rounded-2xl bg-slate-50/50 border border-transparent"></div>))}
                            {Array.from({ length: days }).map((_, i) => {
                                const day = i + 1;
                                const dateStr = getFormattedDate(day);
                                const dayPhotos = getPhotosForDate(dateStr);
                                const count = dayPhotos.length;
                                const isToday = dateStr === new Date().toISOString().split('T')[0];
                                const isSelected = dateStr === selectedDate;
                                return (
                                    <div 
                                        key={day}
                                        onClick={() => count > 0 && handleDateClick(dateStr)}
                                        className={`
                                            h-14 sm:h-32 flex flex-col justify-between p-1 sm:p-3 rounded-lg sm:rounded-2xl transition-all relative border group
                                            ${count > 0 ? 'cursor-pointer hover:shadow-lg hover:-translate-y-1 border-slate-200 bg-white' : 'border-transparent bg-slate-50 text-slate-300'}
                                            ${isSelected ? 'ring-2 ring-indigo-500 ring-offset-1 sm:ring-offset-2 border-indigo-200' : ''}
                                        `}
                                    >
                                        <div className="flex justify-center sm:justify-between items-start">
                                            <span className={`text-xs sm:text-sm font-bold ${isToday ? 'bg-indigo-600 text-white w-6 h-6 flex items-center justify-center rounded-full shadow-md' : ''}`}>{day}</span>
                                        </div>
                                        {count > 0 && (
                                            <div className="sm:hidden flex justify-center"><div className={`w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-indigo-500' : 'bg-indigo-300'}`}></div></div>
                                        )}
                                        {count > 0 && (
                                            <div className="hidden sm:flex flex-col items-center gap-2">
                                                <div className="w-full h-12 rounded-lg overflow-hidden bg-slate-100 relative">
                                                     <img src={dayPhotos[0].url} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" loading="lazy" />
                                                     {count > 1 && <div className="absolute top-1 right-1 bg-black/50 text-white text-[10px] font-bold px-1.5 rounded-full backdrop-blur-sm">+{count-1}</div>}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    {selectedDate && selectedPhotos.length > 0 && (
                        <div ref={photoSectionRef} className="pt-8 border-t-2 border-dashed border-slate-200 animate-fade-in-up">
                            <div className="flex justify-between items-center mb-8 px-2">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center gap-3">
                                    <span className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-sm">{selectedDate}</span>
                                    ÁöÑÁÖßÁâá
                                </h3>
                                <button onClick={() => setSelectedDate(null)} className="p-2 hover:bg-slate-200 rounded-full text-slate-500"><XCircle size={24} /></button>
                            </div>
                            <div className="masonry-grid">
                                {selectedPhotos.map(photo => (<PhotoCard key={photo.id} photo={photo} onExpand={onExpand} isAdmin={isAdmin} onEdit={onEdit} onDelete={onDelete} />))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ShareButtons = ({ photo, minimal = false }) => {
            const shareText = `${photo.thoughts_shooting || 'ÂàÜ‰∫´‰∏ÄÂºµÁÖßÁâá'} \n\n#${SITE_CONFIG.seo.siteName} ${photo.tags.map(t=>'#'+t).join(' ')}`;
            const handleIG = async (e) => { e.stopPropagation(); copyToClipboard(shareText); await downloadWithWatermark(photo.url, photo.id, e); };
            const handleObsidian = (e) => { e.stopPropagation(); const altText = photo.tags.length > 0 ? photo.tags.join(', ') : SITE_CONFIG.seo.siteName; const markdown = `![${altText}](${photo.url})`; copyToClipboard(markdown); alert("Â∑≤Ë§áË£Ω Obsidian Ë™ûÊ≥ïÔºÅ"); };
            const btnClass = minimal ? "text-slate-400 hover:text-slate-700 transition-colors p-1" : "text-slate-500 hover:bg-slate-100 p-2 rounded-full transition-all";
            return (
                <div className="flex items-center gap-1">
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(photo.url)}`, '_blank')}} className={`${btnClass} hover:text-[#1877F2]`}><Facebook size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(photo.url)}`, '_blank')}} className={`${btnClass} hover:text-[#06c755]`}><MessageCircle size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                    <button onClick={handleIG} className={`${btnClass} hover:text-[#E1306C]`}><Instagram size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                    <button onClick={handleObsidian} className={`${btnClass} hover:text-purple-600`}><FileCode size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                </div>
            );
        };

        const Lightbox = ({ photo, onClose, isAdmin, onEdit, onDelete }) => {
            if (!photo) return null;
            
            // Âà§Êñ∑ÊòØÂê¶ÊúâÁí∞Â¢ÉÊï∏Êìö
            const hasEnvData = photo.exif.altitude || photo.exif.temp || photo.exif.pressure;

            return (
                <div className="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center p-4 animate-fade-in-up" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-6 right-6 text-white/50 hover:text-white p-2 z-50 transition-colors"><X size={32} strokeWidth={1} /></button>
                    {isAdmin && (
                        <div className="absolute top-6 left-6 flex gap-4 z-50">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-full backdrop-blur-sm text-sm font-medium transition-all flex items-center gap-2"><Edit size={14}/> Á∑®ËºØ</button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); onClose(); }} className="bg-red-500/80 hover:bg-red-600 text-white px-4 py-2 rounded-full backdrop-blur-sm text-sm font-medium transition-all flex items-center gap-2"><Trash2 size={14}/> Âà™Èô§</button>
                        </div>
                    )}
                    <div className="relative max-w-7xl max-h-[85vh] w-full flex flex-col items-center justify-center" onClick={e => e.stopPropagation()}>
                        <img src={photo.url} className="max-w-full max-h-[80vh] object-contain shadow-2xl rounded-sm" loading="eager" decoding="async" />
                        <div className="mt-6 flex flex-col items-center gap-3 text-white/90">
                            <div className="flex items-center gap-6 text-sm font-light tracking-wide bg-black/40 px-6 py-2 rounded-full backdrop-blur-md border border-white/10">
                                <span className="flex items-center gap-2"><Clock size={14} className="text-indigo-400"/> {photo.date ? photo.date.replace('T', ' ') : ''}</span>
                                <span className="w-px h-3 bg-white/20"></span>
                                <span className="flex items-center gap-2"><MapPin size={14} className="text-indigo-400"/> {photo.location.city} {photo.location.spot && `¬∑ ${photo.location.spot}`}</span>
                                <span className="w-px h-3 bg-white/20"></span>
                                <button onClick={(e) => downloadWithWatermark(photo.url, photo.id, e)} className="hover:text-indigo-300 transition-colors flex items-center gap-2"><Download size={14} /> ‰∏ãËºâ</button>
                            </div>
                            <div className="text-xs text-white/50 font-mono tracking-wider space-x-3">
                                {photo.exif.camera && <span>{photo.exif.camera}</span>}
                                {photo.exif.lens && <span>| {photo.exif.lens}</span>}
                                <span>| {photo.exif.shutter} ¬∑ {photo.exif.aperture} ¬∑ ISO {photo.exif.iso} {photo.exif.focalLength ? `¬∑ ${photo.exif.focalLength}` : ''} {photo.exif.ev ? `¬∑ EV ${photo.exif.ev}` : ''}</span>
                            </div>
                            
                            {/* Áí∞Â¢ÉÊï∏Êìö (Êñ∞Â¢û) */}
                            {hasEnvData && (
                                <div className="flex gap-4 text-xs text-indigo-300 font-medium bg-indigo-900/30 px-4 py-1 rounded-lg border border-indigo-500/20">
                                    {photo.exif.altitude && <span className="flex items-center gap-1"><ArrowUpNarrowWide size={12}/> Êµ∑Êãî {photo.exif.altitude}</span>}
                                    {photo.exif.temp && <span className="flex items-center gap-1"><Sparkles size={12}/> {photo.exif.temp}</span>}
                                    {photo.exif.pressure && <span className="flex items-center gap-1"><Gauge size={12}/> {photo.exif.pressure}</span>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PhotoCard = ({ photo, onExpand, isAdmin, onEdit, onDelete }) => (
            <div className="masonry-item group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border border-slate-100 break-inside-avoid">
                <div className="relative overflow-hidden cursor-zoom-in min-h-[150px] bg-slate-50" onClick={() => onExpand(photo)}>
                    {photo.url ? (
                        <img src={photo.url} className="w-full h-auto object-cover" loading="lazy" decoding="async" />
                    ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-slate-100">
                            <ImageIcon size={32} className="mb-2 opacity-50" />
                            <span className="text-xs font-medium">ÁÑ°ÂΩ±ÂÉè</span>
                        </div>
                    )}
                    
                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                        <div className="flex justify-between items-end">
                            <div className="text-white text-xs font-medium drop-shadow-md"><p className="flex items-center gap-1"><CalendarIcon size={12}/> {photo.date ? photo.date.split('T')[0] : ''}</p></div>
                            <div className="bg-white/90 backdrop-blur-md rounded-full px-2 py-1 shadow-lg"><ShareButtons photo={photo} minimal={true} /></div>
                        </div>
                    </div>
                    {/* Always ensure delete button is accessible for admins, even if image breaks */}
                    {isAdmin && (
                        <div className="absolute top-2 right-2 flex gap-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-white/90 p-1.5 rounded-full hover:bg-white text-slate-600 shadow-sm"><Edit size={14}/></button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); }} className="bg-white/90 p-1.5 rounded-full hover:bg-red-50 text-red-500 shadow-sm"><Trash2 size={14}/></button>
                        </div>
                    )}
                </div>
                <div className="p-4 flex flex-col gap-3">
                    <div><div className="flex items-baseline justify-between mb-1"><h3 className="font-bold text-slate-800 text-lg leading-tight">{photo.location.city}</h3><span className="text-xs text-slate-400 font-medium bg-slate-50 px-2 py-0.5 rounded-md">{photo.location.country}</span></div>{photo.location.spot && <p className="text-xs text-slate-500 font-medium flex items-center gap-1"><MapPin size={10} className="text-indigo-500"/> {photo.location.spot}</p>}</div>
                    <div className="space-y-2">{photo.thoughts_shooting && (<div className="text-sm text-slate-600 leading-relaxed bg-slate-50 p-3 rounded-xl border border-slate-100"><span className="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wide">Shooting</span>{photo.thoughts_shooting}</div>)}{photo.thoughts_viewing && (<div className="text-sm text-slate-600 leading-relaxed bg-indigo-50/50 p-3 rounded-xl border border-indigo-100"><span className="block text-[10px] font-bold text-indigo-400 mb-1 uppercase tracking-wide">Reflection</span>{photo.thoughts_viewing}</div>)}</div>
                    {photo.tags && photo.tags.length > 0 && (<div className="flex flex-wrap gap-1.5">{photo.tags.map(tag => (<span key={tag} className="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[10px] font-bold rounded-md uppercase tracking-wide">#{tag}</span>))}</div>)}
                    <div className="pt-3 mt-1 border-t border-slate-100 flex justify-between items-center text-[10px] text-slate-400 font-mono"><span className="flex items-center gap-1"><Aperture size={10}/> {photo.exif.aperture}</span><span>{photo.exif.shutter}</span><span className="flex items-center gap-1">ISO {photo.exif.iso}</span><span className="flex items-center gap-1">{photo.exif.ev && `EV ${photo.exif.ev}`}</span></div>
                </div>
            </div>
        );

        const PhotoForm = ({ onSave, onCancel, initialData, isSaving }) => {
            const isEditMode = !!initialData;
            const getNowString = () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); return now.toISOString().slice(0, 16); };
            const [formData, setFormData] = useState(initialData || { 
                url: '', 
                tags: '', 
                thoughts_shooting: '', 
                thoughts_viewing: '', 
                exif: { 
                    shutter: '', 
                    aperture: 'f/', 
                    iso: '', 
                    date: getNowString(), 
                    camera: '', 
                    lens: '', 
                    focalLength: '', 
                    ev: '',
                    altitude: '', // Êñ∞Â¢û
                    temp: '',     // Êñ∞Â¢û
                    pressure: ''  // Êñ∞Â¢û
                }, 
                location: { country: '', city: '', spot: '', lat: '', lng: '' } 
            });
            const [status, setStatus] = useState('');
            const [uploadFile, setUploadFile] = useState(null);
            const [exifStatus, setExifStatus] = useState(''); 

            useEffect(() => { if (initialData && Array.isArray(initialData.tags)) { setFormData(prev => ({ ...prev, tags: initialData.tags.join(', ') })); } }, [initialData]);
            const handleChange = (section, field, value) => { if (section) { setFormData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } })); } else { setFormData(prev => ({ ...prev, [field]: value })); } };
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadFile(file);
                    
                    // 1. ËÆæÁΩÆÈ¢ÑËßàÂõæ (Á´ãÂç≥ÊâßË°åÔºå‰∏çÁ≠âÂæÖ EXIF)
                    const previewUrl = URL.createObjectURL(file);
                    setFormData(prev => ({ ...prev, url: previewUrl }));
                    
                    setExifStatus('ÂàÜÊûê‰∏≠...');
                    
                    // 2. ÂòóË©¶ËÆÄÂèñ EXIF
                    try {
                        EXIF.getData(file, async function() {
                            const allTags = EXIF.getAllTags(this);
                            console.log("Full EXIF Dump:", allTags); // Èô§ÈåØÁî®

                            const extractedShutter = EXIF.getTag(this, "ExposureTime");
                            const extractedFNumber = EXIF.getTag(this, "FNumber");
                            const extractedISO = EXIF.getTag(this, "ISOSpeedRatings");
                            const extractedDate = EXIF.getTag(this, "DateTimeOriginal");
                            const extractedFocalLength = EXIF.getTag(this, "FocalLength");
                            const extractedBias = EXIF.getTag(this, "ExposureBiasValue");
                            const make = EXIF.getTag(this, "Make");
                            const model = EXIF.getTag(this, "Model");

                            // --- 1. Èè°È†≠Ë≥áË®ä (Âº∑ÂåñÁâà) ---
                            // ÂÑ™ÂÖàÂÇ≥ÂÖ• LensInfoÔºåÂ¶ÇÊûúÊ≤íÊúâÔºåparseLensInfo ÊúÉËá™Â∑±Âéª allTags Êâæ
                            const extractedLensInfo = EXIF.getTag(this, "LensInfo") || EXIF.getTag(this, "LensSpecification");
                            const lensName = parseLensInfo(extractedLensInfo, allTags);

                            // --- 2. GPS & 3. Áí∞Â¢ÉÊï∏Êìö (Olympus TG-6) ---
                            const lat = EXIF.getTag(this, "GPSLatitude");
                            const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                            const lon = EXIF.getTag(this, "GPSLongitude");
                            const lonRef = EXIF.getTag(this, "GPSLongitudeRef");
                            
                            // È´òÂ∫¶ (Altitude)
                            const alt = EXIF.getTag(this, "GPSAltitude");
                            const altRef = EXIF.getTag(this, "GPSAltitudeRef"); // 0=Above, 1=Below
                            const altitudeVal = getAltitude(alt, altRef);
                            let formattedAltitude = altitudeVal !== null ? `${Math.round(altitudeVal)}m` : "";

                            // ÂòóË©¶ËÆÄÂèñ Olympus Â£ìÂäõËàáÊ∫´Â∫¶
                            let pressure = allTags.Pressure || allTags.AmbientPressure || ""; 
                            let temp = allTags.Temperature || allTags.CameraTemperature || "";

                            // --- Ê†ºÂºèÂåñÊï∏Êìö ---
                            let formattedShutter = "";
                            const shutterVal = getExifValue(extractedShutter);
                            if (shutterVal > 0) formattedShutter = shutterVal < 1 ? "1/" + Math.round(1/shutterVal) : shutterVal.toString();
                            const apertureVal = getExifValue(extractedFNumber);
                            const formattedAperture = apertureVal ? "f/" + apertureVal : "";
                            const formattedEV = formatExposureBias(extractedBias);
                            let formattedDate = "";
                            if (extractedDate) {
                                const parts = extractedDate.split(" ");
                                if (parts.length >= 2) formattedDate = `${parts[0].replace(/:/g, "-")}T${parts[1].substring(0, 5)}`;
                                else if (parts.length === 1) formattedDate = parts[0].replace(/:/g, "-");
                            }
                            let formattedCamera = "";
                            if (make && model) formattedCamera = model.toLowerCase().includes(make.toLowerCase()) ? model : `${make} ${model}`;
                            else formattedCamera = model || make || "";
                            if (formattedCamera) formattedCamera = formattedCamera.replace(/\0/g, '').trim();
                            let formattedFocalLength = "";
                            const focalVal = getExifValue(extractedFocalLength);
                            if (focalVal) formattedFocalLength = `${focalVal}mm`;
                            let locationUpdate = { ...formData.location };
                            let extraStatus = "";
                            
                            // Âè™Ë¶ÅÊúâÁ∂ìÁ∑ØÂ∫¶Èô£ÂàóÔºåÂ∞±ÁÆó Ref ËÆÄ‰∏çÂà∞ÔºåÈ†êË®≠ N/E (Â∏∏Ë¶ãÊÉÖÊ≥Å)
                            if (lat && lat.length === 3 && lon && lon.length === 3) {
                                const decimalLat = convertDMSToDD(lat, latRef || 'N');
                                const decimalLon = convertDMSToDD(lon, lonRef || 'E');
                                if (decimalLat && decimalLon) {
                                    setExifStatus('ÂÆö‰Ωç‰∏≠...');
                                    const address = await reverseGeocode(decimalLat, decimalLon);
                                    locationUpdate.lat = decimalLat;
                                    locationUpdate.lng = decimalLon;
                                    if (address) {
                                        locationUpdate.country = address.country || "";
                                        locationUpdate.city = address.city || address.county || address.town || address.state || "";
                                        locationUpdate.spot = address.suburb || address.village || address.road || address.pedestrian || "";
                                        extraStatus = " + GPS";
                                    } else { extraStatus = " (GPS ÊàêÂäüÔºåÁÑ°Âú∞ÂùÄ)"; }
                                }
                            }
                            setFormData(prev => ({
                                ...prev,
                                exif: {
                                    shutter: formattedShutter || prev.exif.shutter,
                                    aperture: formattedAperture || prev.exif.aperture,
                                    iso: extractedISO ? extractedISO.toString() : prev.exif.iso,
                                    date: formattedDate || prev.exif.date,
                                    camera: formattedCamera || prev.exif.camera,
                                    lens: lensName || prev.exif.lens,
                                    focalLength: formattedFocalLength || prev.exif.focalLength,
                                    ev: formattedEV || prev.exif.ev,
                                    altitude: formattedAltitude,
                                    temp: temp ? `${temp}¬∞C` : "",
                                    pressure: pressure ? `${pressure} hPa` : ""
                                },
                                location: locationUpdate
                            }));
                            setExifStatus(`EXIF ÂÆåÊàê ${extraStatus}`);
                        });
                    } catch (exifErr) {
                        console.warn("EXIF extraction failed", exifErr);
                        setExifStatus('EXIF ËÆÄÂèñÂ§±ÊïóÔºå‰ΩÜÂèØÁπºÁ∫å‰∏äÂÇ≥');
                    }
                }
            };

            const handleSubmit = async (e) => { 
                e.preventDefault();
                
                // È©óË≠âÊ™¢Êü•
                if (!uploadFile && !formData.url) {
                    alert("Ë´ãÈÅ∏ÊìáÁÖßÁâáÊ™îÊ°àÊàñËº∏ÂÖ•ÈÄ£ÁµêÔºÅ");
                    return;
                }

                setStatus('uploading');
                let finalUrl = formData.url;
                try {
                    if (uploadFile) {
                        const filename = `photos/${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${uploadFile.name}`;
                        const storageRef = ref(storage, filename);
                        await uploadBytes(storageRef, uploadFile);
                        finalUrl = await getDownloadURL(storageRef);
                    }
                    const processedData = { ...formData, url: finalUrl, tags: formData.tags.split(',').map(t => t.trim()).filter(t => t), date: formData.exif.date }; 
                    onSave(processedData); 
                } catch (err) { console.error("‰∏äÂÇ≥Â§±Êïó", err); alert("‰∏äÂÇ≥Â§±Êïó: " + err.message); setStatus(''); }
            };

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 sm:p-12 animate-fade-in-up my-8 border border-slate-100">
                    <div className="flex justify-between items-center mb-10 border-b border-slate-100 pb-6"><h2 className="text-3xl font-bold text-slate-800 flex items-center gap-3">{isEditMode ? <Edit className="text-indigo-500"/> : <Upload className="text-indigo-500"/>} {isEditMode ? '‰øÆÊîπÁÖßÁâá' : 'Êñ∞Â¢ûÁÖßÁâá'}</h2><button onClick={onCancel} className="text-slate-400 hover:text-slate-700 transition-colors p-2 hover:bg-slate-50 rounded-full"><X size={24}/></button></div>
                    {status === 'uploading' && (<div className="mb-8 flex justify-center items-center gap-3 text-indigo-600 font-bold bg-indigo-50 p-4 rounded-xl border border-indigo-100 animate-pulse"><RefreshCw className="spinner" size={20}/> Ê≠£Âú®‰∏äÂÇ≥Ëá≥Èõ≤Á´Ø...</div>)}
                    <form onSubmit={handleSubmit} className="space-y-12">
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-12">
                            <div className="md:col-span-2 space-y-6">
                                <label className={`flex flex-col items-center justify-center w-full aspect-[4/3] border-2 border-dashed rounded-2xl cursor-pointer hover:bg-slate-50 transition-all group overflow-hidden relative ${uploadFile ? 'border-indigo-500 bg-indigo-50/30' : 'border-slate-300'}`}>{formData.url ? (<img src={formData.url} className="w-full h-full object-cover p-1 rounded-2xl" />) : (<div className="text-center text-slate-400 group-hover:text-indigo-500 transition-colors"><FileUp className="w-12 h-12 mx-auto mb-3 opacity-70" /><span className="text-sm tracking-wide font-bold uppercase">ÈªûÊìäÈÅ∏ÊìáÁÖßÁâá</span></div>)}<input type="file" accept="image/*" onChange={handleFileChange} className="hidden" disabled={status === 'uploading'} />{uploadFile && <div className="absolute top-2 right-2 bg-indigo-500 text-white p-1.5 rounded-full shadow-md"><Check size={16} strokeWidth={3}/></div>}</label>
                                {exifStatus && (<div className="flex items-center justify-center gap-2 text-sm text-indigo-600 font-medium bg-indigo-50 py-2 rounded-lg border border-indigo-100"><Sparkles size={16}/> {exifStatus}</div>)}
                                <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><LinkIcon className="h-5 w-5 text-slate-400" /></div><input type="url" placeholder="ÊàñË≤º‰∏äÂúñÁâáÈÄ£Áµê" className="block w-full pl-10 border-slate-300 rounded-xl p-3 text-sm border focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" value={formData.url} onChange={(e) => { handleChange(null, 'url', e.target.value); setUploadFile(null); }} disabled={uploadFile || status === 'uploading'} /></div>
                            </div>
                            <div className="md:col-span-3 space-y-8">
                                <div className="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100"><h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-4"><Tag size={14} className="text-indigo-500"/> ÂÖßÂÆπÊèèËø∞</h4><input type="text" placeholder="Ê®ôÁ±§ (‰æãÂ¶Ç: È¢®ÊôØ, Âè∞ÁÅ£)" className="block w-full border-slate-200 rounded-lg p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" value={formData.tags} onChange={(e) => handleChange(null, 'tags', e.target.value)} /><textarea rows="3" placeholder="ÊãçÊîùÁï∂‰∏ãÁöÑÊÉ≥Ê≥ï..." className="block w-full border-slate-200 rounded-lg p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none resize-none" value={formData.thoughts_shooting} onChange={(e) => handleChange(null, 'thoughts_shooting', e.target.value)} /><textarea rows="2" placeholder="‰∫ãÂæåÊ¨£Ë≥ûÁöÑÊÑüÂèó..." className="block w-full border-slate-200 rounded-lg p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none resize-none text-slate-600" value={formData.thoughts_viewing} onChange={(e) => handleChange(null, 'thoughts_viewing', e.target.value)} /></div>
                                <div className="grid grid-cols-2 gap-6"><div className="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100"><h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-4"><MapPin size={14} className="text-indigo-500"/> Âú∞ÈªûË≥áË®ä</h4>
                                <input type="text" placeholder="ÂúãÂÆ∂" className="block w-full border-slate-200 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none" value={formData.location.country} onChange={(e) => handleChange('location', 'country', e.target.value)} />
                                <input type="text" placeholder="ÂüéÂ∏Ç" className="block w-full border-slate-200 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none" value={formData.location.city} onChange={(e) => handleChange('location', 'city', e.target.value)} />
                                <input type="text" placeholder="ÊôØÈªû/Ë°óÈÅì" className="block w-full border-slate-200 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none" value={formData.location.spot} onChange={(e) => handleChange('location', 'spot', e.target.value)} />
                                <div className="grid grid-cols-2 gap-2 mt-2">
                                    <input type="number" step="any" placeholder="Latitude (Á∑ØÂ∫¶)" className="block w-full border-slate-200 rounded-lg p-2 text-xs focus:border-indigo-500 outline-none" value={formData.location.lat} onChange={(e) => handleChange('location', 'lat', e.target.value)} />
                                    <input type="number" step="any" placeholder="Longitude (Á∂ìÂ∫¶)" className="block w-full border-slate-200 rounded-lg p-2 text-xs focus:border-indigo-500 outline-none" value={formData.location.lng} onChange={(e) => handleChange('location', 'lng', e.target.value)} />
                                </div>
                                </div><div className="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100"><h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-4"><Aperture size={14} className="text-indigo-500"/> ÊãçÊîùÂèÉÊï∏</h4><input type="datetime-local" className="block w-full border-slate-200 rounded-lg p-2 text-xs text-slate-600 mb-2" value={formData.exif.date} onChange={(e) => handleChange('exif', 'date', e.target.value)} /><div className="grid grid-cols-2 gap-2"><input type="text" placeholder="Áõ∏Ê©ü" className="border-slate-200 rounded p-1 text-xs" value={formData.exif.camera} onChange={(e) => handleChange('exif', 'camera', e.target.value)} /><input type="text" placeholder="Èè°È†≠" className="border-slate-200 rounded p-1 text-xs" value={formData.exif.lens} onChange={(e) => handleChange('exif', 'lens', e.target.value)} /><input type="text" placeholder="Âø´ÈñÄ" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.shutter} onChange={(e) => handleChange('exif', 'shutter', e.target.value)} /><input type="text" placeholder="ÂÖâÂúà" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.aperture} onChange={(e) => handleChange('exif', 'aperture', e.target.value)} /><input type="text" placeholder="ISO" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.iso} onChange={(e) => handleChange('exif', 'iso', e.target.value)} /><input type="text" placeholder="EV" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.ev} onChange={(e) => handleChange('exif', 'ev', e.target.value)} /></div></div></div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-4 pt-8 border-t border-slate-100"><button type="button" onClick={onCancel} disabled={isSaving || status === 'uploading'} className="px-6 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition-colors">ÂèñÊ∂à</button><button type="submit" disabled={isSaving || status === 'uploading'} className="px-8 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 font-medium flex items-center gap-2 disabled:opacity-50 transition-all hover:-translate-y-0.5">{(isSaving || status === 'uploading') ? <RefreshCw className="animate-spin" size={20} /> : (isEditMode ? <Edit size={20}/> : <Upload size={20}/>)}{isEditMode ? 'Êõ¥Êñ∞ÁÖßÁâá' : 'Áôº‰ΩàÁÖßÁâá'}</button></div>
                    </form>
                </div>
            );
        };

        const AdminLogin = ({ onLogin, onCancel }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (password === SITE_CONFIG.system.adminPasscode) onLogin(); else setPassword(''); };
            return (
                <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in-up">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full border border-slate-100">
                        <div className="text-center mb-6">
                            <div className="mx-auto bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mb-4"><Lock className="text-indigo-600 w-8 h-8" /></div>
                            <h3 className="text-xl font-bold text-slate-800">ÁÆ°ÁêÜÂì°ÁôªÂÖ•</h3>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="password" placeholder="Passcode" className="w-full text-center tracking-widest border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-lg" value={password} onChange={(e) => setPassword(e.target.value)} autoFocus />
                            <div className="flex gap-3"><button type="button" onClick={onCancel} className="flex-1 py-3 text-slate-500 hover:bg-slate-50 rounded-xl transition-colors font-medium">ÂèñÊ∂à</button><button type="submit" className="flex-1 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 font-medium">Ëß£Èéñ</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('gallery'); // 'gallery', 'calendar', 'upload', 'map'
            const [photos, setPhotos] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState(null);
            const [sortOrder, setSortOrder] = useState('newest'); 
            const [dateFilter, setDateFilter] = useState(null); 
            const [isTagsExpanded, setIsTagsExpanded] = useState(false);
            const [visibleCount, setVisibleCount] = useState(SITE_CONFIG.system.itemsPerPage || 12);
            
            // ÁãÄÊÖãÂàùÂßãÂåñÔºöÂæû localStorage ËÆÄÂèñÁÆ°ÁêÜÂì°ÁãÄÊÖã
            const [isAdmin, setIsAdmin] = useState(() => localStorage.getItem('linkc_admin_auth') === 'true');
            const [showLogin, setShowLogin] = useState(false);
            
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [editingPhoto, setEditingPhoto] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [authError, setAuthError] = useState(null);
            
            // Debounce search query
            const debouncedSearchQuery = useDebounce(searchQuery, 300);

            // Reset visible count when filters change
            useEffect(() => {
                setVisibleCount(SITE_CONFIG.system.itemsPerPage || 12);
            }, [debouncedSearchQuery, activeTag, dateFilter, sortOrder]);

            useEffect(() => {
                if (!isConfigConfigured) return; 
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (err) { setAuthError(err.message); } };
                initAuth();
                onAuthStateChanged(auth, (user) => { setCurrentUser(user); if(user) setAuthError(null); });
            }, []);

            useEffect(() => {
                if (!currentUser || !db) return;
                const q = query(collection(db, SITE_CONFIG.system.collectionName), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => { setPhotos(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            }, [currentUser]);

            // ÁÆ°ÁêÜÂì°ÁôªÂÖ•ÈÇèËºØ
            const handleAdminLogin = () => {
                setIsAdmin(true);
                localStorage.setItem('linkc_admin_auth', 'true'); // ÂÑ≤Â≠òÁãÄÊÖã
                setShowLogin(false);
            };

            // ÁÆ°ÁêÜÂì°ÁôªÂá∫ÈÇèËºØ
            const handleAdminLogout = () => {
                setIsAdmin(false);
                localStorage.removeItem('linkc_admin_auth'); // Ê∏ÖÈô§ÁãÄÊÖã
                alert("Â∑≤ÁôªÂá∫");
            };

            const handleSavePhoto = async (photoData) => {
                if (!currentUser) return;
                setIsSaving(true);
                try {
                    const collectionRef = collection(db, SITE_CONFIG.system.collectionName);
                    if (editingPhoto) {
                        await updateDoc(doc(collectionRef, photoData.id), { ...photoData });
                        setEditingPhoto(null);
                    } else {
                        await addDoc(collectionRef, { ...photoData, timestamp: Date.now() });
                    }
                    setView('gallery');
                    setDateFilter(null); 
                } catch (e) { alert("ÂÑ≤Â≠òÂ§±Êïó: " + e.message); } finally { setIsSaving(false); }
            };

            const handleDeletePhoto = async (id) => {
                if (!currentUser) return;
                if(window.confirm('Á¢∫ÂÆöË¶ÅÊ∞∏‰πÖÂà™Èô§Ôºü')) {
                    try { await deleteDoc(doc(db, SITE_CONFIG.system.collectionName, id)); } catch(e) { alert("Âà™Èô§Â§±Êïó"); }
                }
            };

            const startEdit = (photo) => { setEditingPhoto(photo); setView('upload'); if (selectedPhoto) setSelectedPhoto(null); };

            // Handle lightbox open event from map marker popup
            useEffect(() => {
                const handleOpenLightbox = (e) => {
                    const photoId = e.detail;
                    const photo = photos.find(p => p.id === photoId);
                    if (photo) setSelectedPhoto(photo);
                };
                window.addEventListener('openLightbox', handleOpenLightbox);
                return () => window.removeEventListener('openLightbox', handleOpenLightbox);
            }, [photos]);

            if (!isConfigConfigured) return <ConfigError />;
            if (authError) return <AuthError message={authError} />;

            // Use useMemo for heavy calculations
            const allTags = useMemo(() => [...new Set(photos.flatMap(p => p.tags))], [photos]);
            
            const tagCounts = useMemo(() => {
                return photos.flatMap(p => p.tags).reduce((acc, tag) => {
                    acc[tag] = (acc[tag] || 0) + 1;
                    return acc;
                }, {});
            }, [photos]);

            const sortedTags = useMemo(() => {
                return Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
            }, [tagCounts]);

            const visibleTags = isTagsExpanded ? sortedTags : sortedTags.slice(0, 10);
            const hasMoreTags = sortedTags.length > 10;

            // Advanced Search & Filter Logic with Boolean Operators
            const filteredPhotos = useMemo(() => {
                return photos.filter(photo => {
                    if (dateFilter) {
                        const photoDate = photo.exif?.date || photo.date || '';
                        return photoDate.startsWith(dateFilter);
                    }
                    if (activeTag && !(photo.tags || []).includes(activeTag)) return false;
                    
                    if (!debouncedSearchQuery.trim()) return true;

                    const searchableText = [
                        ...(photo.tags || []),
                        photo.thoughts_shooting,
                        photo.thoughts_viewing,
                        photo.location?.country,
                        photo.location?.city,
                        photo.location?.spot,
                        photo.exif?.camera,
                        photo.exif?.lens,
                        photo.exif?.shutter,
                        photo.exif?.aperture,
                        photo.exif?.iso,
                        photo.exif?.focalLength,
                        photo.exif?.ev,
                        photo.exif?.date
                    ].filter(Boolean).join(' ').toLowerCase();

                    const query = debouncedSearchQuery.toLowerCase();
                    const tokens = query.split(/\s+/);
                    
                    let isMatch = true;
                    let operator = 'AND'; 
                    let firstToken = true;

                    for (let i = 0; i < tokens.length; i++) {
                        const token = tokens[i];
                        if (token === 'or' || token === '|') { operator = 'OR'; continue; }
                        if (token === 'and' || token === '&') { operator = 'AND'; continue; }

                        let isNot = false;
                        let term = token;
                        if (term.startsWith('-') && term.length > 1) { isNot = true; term = term.substring(1); }

                        const match = searchableText.includes(term);
                        const conditionMet = isNot ? !match : match;

                        if (firstToken) { isMatch = conditionMet; firstToken = false; }
                        else {
                            if (operator === 'OR') { isMatch = isMatch || conditionMet; operator = 'AND'; }
                            else { isMatch = isMatch && conditionMet; }
                        }
                    }
                    return isMatch;
                });
            }, [photos, debouncedSearchQuery, activeTag, dateFilter]);

            const sortedPhotos = useMemo(() => {
                return [...filteredPhotos].sort((a, b) => {
                    const dateA = a.exif?.date || a.timestamp;
                    const dateB = b.exif?.date || b.timestamp;
                    return sortOrder === 'newest' ? (dateA < dateB ? 1 : -1) : (dateA > dateB ? 1 : -1);
                });
            }, [filteredPhotos, sortOrder]);

            // Pagination Logic
            const visiblePhotos = sortedPhotos.slice(0, visibleCount);
            const hasMorePhotos = visibleCount < sortedPhotos.length;

            return (
                <div className="min-h-screen font-sans pb-20 bg-slate-50 text-slate-800">
                <Header setView={(v) => { setView(v); setEditingPhoto(null); setDateFilter(null); }} isAdmin={isAdmin} onLoginClick={() => setShowLogin(true)} onLogout={handleAdminLogout} currentView={view} />
                
                {showLogin && (<AdminLogin onLogin={handleAdminLogin} onCancel={() => setShowLogin(false)} />)}
                {selectedPhoto && (<Lightbox photo={selectedPhoto} onClose={() => setSelectedPhoto(null)} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />)}

                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    {view === 'map' ? (
                        <MapView 
                            photos={photos} 
                            onSelectPhoto={(p) => setSelectedPhoto(p)} 
                        />
                    ) : view === 'calendar' ? (
                        <CalendarView 
                            photos={photos} 
                            onSelectDate={(d) => { setDateFilter(d); setView('gallery'); }} 
                            onExpand={setSelectedPhoto}
                            isAdmin={isAdmin}
                            onEdit={startEdit}
                            onDelete={handleDeletePhoto}
                        />
                    ) : view === 'gallery' ? (
                    <>
                        {dateFilter && (
                            <div className="mb-10 flex justify-center items-center animate-fade-in-up">
                                <div className="text-center bg-white p-6 rounded-2xl shadow-sm border border-indigo-100">
                                    <h2 className="text-2xl font-bold mb-3 text-slate-800 flex items-center gap-2 justify-center"><CalendarIcon className="text-indigo-500"/> {dateFilter}</h2>
                                    <button onClick={() => setDateFilter(null)} className="px-4 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-sm font-bold rounded-full flex items-center gap-1 transition-colors mx-auto"><XCircle size={16}/> Clear Date Filter</button>
                                </div>
                            </div>
                        )}

                        <div className="flex flex-col gap-6 mb-12 animate-fade-in-up">
                            <div className="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                                <div className="relative w-full md:max-w-md">
                                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><Search className="h-5 w-5 text-slate-400" /></div>
                                    <input 
                                        type="text" 
                                        placeholder="ÊêúÂ∞ãÁÖßÁâá„ÄÅÊ®ôÁ±§„ÄÅÂú∞Èªû„ÄÅÁõ∏Ê©ü..." 
                                        className="w-full pl-12 pr-10 py-2 bg-slate-50 border-transparent rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-slate-700 placeholder-slate-400 transition-all"
                                        value={searchQuery} 
                                        onChange={(e) => setSearchQuery(e.target.value)} 
                                        disabled={!!dateFilter} 
                                    />
                                    <div className="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none"><Filter className="h-4 w-4 text-slate-300" /></div>
                                </div>
                                <div className="flex items-center gap-2 text-sm text-slate-500 font-bold bg-slate-50 p-1.5 rounded-xl">
                                    <button onClick={() => setSortOrder('newest')} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg transition-all ${sortOrder === 'newest' ? 'bg-white text-indigo-600 shadow-sm' : 'hover:text-indigo-600'}`}><ArrowDownWideNarrow size={16}/> ÊúÄÊñ∞</button>
                                    <button onClick={() => setSortOrder('oldest')} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg transition-all ${sortOrder === 'oldest' ? 'bg-white text-indigo-600 shadow-sm' : 'hover:text-indigo-600'}`}><ArrowUpNarrowWide size={16}/> ÊúÄËàä</button>
                                </div>
                            </div>
                            
                            {sortedTags.length > 0 && (
                                <div className="flex flex-wrap gap-2 justify-center items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                                    <div className="flex items-center gap-1 mr-2 text-slate-400 font-bold text-xs uppercase tracking-wider"><Tag size={14}/> Â∏∏Áî®Ê®ôÁ±§:</div>
                                    <button onClick={() => setActiveTag(null)} className={`px-3 py-1 rounded-full text-xs font-medium transition-all ${!activeTag ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>ÂÖ®ÈÉ®</button>
                                    {visibleTags.map(tag => (
                                        <button 
                                            key={tag} 
                                            onClick={() => setActiveTag(tag === activeTag ? null : tag)} 
                                            className={`px-3 py-1 rounded-full text-xs font-medium transition-all ${tag === activeTag ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600'}`}
                                        >
                                            {tag}
                                        </button>
                                    ))}
                                    {hasMoreTags && (
                                        <button 
                                            onClick={() => setIsTagsExpanded(!isTagsExpanded)} 
                                            className="px-3 py-1 rounded-full text-xs font-medium text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition-all flex items-center gap-1"
                                        >
                                            {isTagsExpanded ? 'Êî∂Ëµ∑' : <><MoreHorizontal size={14} /> Êõ¥Â§ö</>}
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>

                        {visiblePhotos.length > 0 ? (
                            <>
                                <div className="masonry-grid animate-fade-in-up">
                                    {visiblePhotos.map(photo => (
                                        <PhotoCard key={photo.id} photo={photo} onExpand={setSelectedPhoto} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />
                                    ))}
                                </div>
                                {hasMorePhotos && (
                                    <div className="mt-12 flex justify-center">
                                        <button 
                                            onClick={() => setVisibleCount(prev => prev + 12)}
                                            className="px-8 py-3 bg-white border border-slate-200 text-slate-600 rounded-full shadow-sm hover:shadow-md hover:text-indigo-600 hover:border-indigo-200 transition-all font-medium flex items-center gap-2"
                                        >
                                            <ArrowDownWideNarrow size={18} /> ËºâÂÖ•Êõ¥Â§öÁÖßÁâá ({sortedPhotos.length - visibleCount})
                                        </button>
                                    </div>
                                )}
                            </>
                        ) : (
                        <div className="text-center py-32 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-4">
                            <div className="bg-slate-50 p-6 rounded-full"><Cloud className="h-12 w-12 text-slate-300" /></div>
                            <h3 className="text-xl font-bold text-slate-700">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁÖßÁâá</h3>
                            <p className="text-slate-500">Ë©¶ËëóË™øÊï¥ÊêúÂ∞ãÊ¢ù‰ª∂{isAdmin ? 'ÔºåÊàñ‰∏äÂÇ≥‰∏ÄÂºµÊñ∞ÁÖßÁâáÂêßÔºÅ' : '„ÄÇ'}</p>
                            {/* Hide upload button for strangers in empty state too */}
                            {isAdmin && (
                                <button onClick={() => setView('upload')} className="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl shadow-lg shadow-indigo-200 transition-all font-medium flex items-center gap-2">
                                    <Upload size={18}/> ‰∏äÂÇ≥ÁÖßÁâá
                                </button>
                            )}
                        </div>
                        )}
                    </>
                    ) : (
                    <PhotoForm onSave={handleSavePhoto} onCancel={() => { setView('gallery'); setEditingPhoto(null); }} initialData={editingPhoto} isSaving={isSaving} />
                    )}
                </main>
                <footer className="border-t border-slate-200 mt-16 py-12 text-center bg-white">
                    <div className="max-w-7xl mx-auto px-4 flex flex-col items-center gap-4">
                        <p className="text-xs text-slate-400 font-medium tracking-widest uppercase">¬© {new Date().getFullYear()} {SITE_CONFIG.seo.siteName}. All rights reserved.</p>
                    </div>
                </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
