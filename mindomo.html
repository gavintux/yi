<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindomo PARA 儀表板</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        /* 自訂捲軸樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        /* 隱藏 select 預設箭頭 */
        .appearance-none {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 定義主類別架構
        const PARA_ROOTS = ['00inbox', '01專案', '02領域', '03資源', '04檔案'];

        // 模擬資料 (更新為 PARA 架構)
        const MOCK_DATA = [
            { id: "1", title: "待辦事項彙整", folder: "00inbox", created_at: "2025-01-20T08:00:00Z", modified_at: "2025-01-21T09:00:00Z" },
            { id: "2", title: "網站改版架構圖", folder: "01專案/公司網站", created_at: "2024-12-01T09:00:00Z", modified_at: "2025-01-15T14:30:00Z" },
            { id: "3", title: "網站內容規劃", folder: "01專案/公司網站", created_at: "2024-12-05T10:00:00Z", modified_at: "2025-01-10T11:00:00Z" },
            { id: "4", title: "Q1 行銷活動", folder: "01專案/行銷Campaign", created_at: "2025-01-02T13:00:00Z", modified_at: "2025-01-18T16:00:00Z" },
            { id: "5", title: "財務管理流程", folder: "02領域/財務", created_at: "2024-11-20T20:00:00Z", modified_at: "2024-12-25T10:15:00Z" },
            { id: "6", title: "健康檢查記錄", folder: "02領域/健康", created_at: "2024-10-15T08:00:00Z", modified_at: "2025-01-05T09:20:00Z" },
            { id: "7", title: "Python 學習筆記", folder: "03資源/程式設計", created_at: "2024-08-15T14:00:00Z", modified_at: "2024-12-20T16:00:00Z" },
            { id: "8", title: "設計素材庫", folder: "03資源/設計", created_at: "2024-09-01T10:00:00Z", modified_at: "2024-11-15T11:00:00Z" },
            { id: "9", title: "2023 專案封存", folder: "04檔案/2023", created_at: "2023-01-01T12:00:00Z", modified_at: "2023-12-31T18:00:00Z" },
            { id: "10", title: "未分類的靈感", folder: null, created_at: "2025-01-22T10:00:00Z", modified_at: "2025-01-22T10:00:00Z" }
        ];

        const formatDate = (isoString) => {
            if (!isoString) return "未知日期";
            const date = new Date(isoString);
            return new Intl.DateTimeFormat('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }).format(date);
        };

        // Icons
        const Icons = {
            File: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>,
            FolderOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="2" y1="10" x2="22" y2="10"/></svg>,
            Grid: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Refresh: ({ spin }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={spin ? "animate-spin" : ""}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            SortAsc: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="M11 4h10"/><path d="M11 8h7"/><path d="M11 12h4"/></svg>,
            SortDesc: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/><path d="M11 12h4"/><path d="M11 16h7"/><path d="M11 20h10"/></svg>,
            ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
        };

        const ITEMS_PER_PAGE = 9;

        function App() {
            const [apiToken, setApiToken] = useState('KgWdA3krt3dkuS3yQ0TWiOghaYeSGR_tp7u_SV9k_go');
            const [diagrams, setDiagrams] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [useRealApi, setUseRealApi] = useState(true);
            const [showConfig, setShowConfig] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            
            // 導航與狀態
            const [activeCategory, setActiveCategory] = useState('recent'); 
            const [expandedFolders, setExpandedFolders] = useState(PARA_ROOTS.reduce((acc, root) => ({...acc, [root]: true}), {}));
            const [currentPage, setCurrentPage] = useState(1);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

            // 排序狀態：預設為 Last Modified (modified_at) 且 遞減 (desc)
            const [sortField, setSortField] = useState('modified_at');
            const [sortOrder, setSortOrder] = useState('desc');

            useEffect(() => {
                if (!useRealApi) setDiagrams(MOCK_DATA);
            }, [useRealApi]);

            useEffect(() => {
                if (useRealApi && apiToken) setShowConfig(false);
                else setShowConfig(true);
            }, [useRealApi]);

            useEffect(() => {
                setCurrentPage(1);
            }, [searchTerm, activeCategory, sortField, sortOrder]);

            const fetchDiagrams = async () => {
                if (!apiToken) { setError("請輸入 API Token"); return; }
                setLoading(true); setError(null);
                try {
                    const response = await fetch('https://www.mindomo.com/api/v1/diagrams', {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${apiToken}`, 'Content-Type': 'application/json' }
                    });
                    if (!response.ok) {
                        if (response.status === 401) throw new Error("認證失敗：Token 無效");
                        if (response.status === 403) throw new Error("權限不足");
                        throw new Error(`API 錯誤: ${response.status}`);
                    }
                    const data = await response.json();
                    let items = Array.isArray(data) ? data : (data.diagrams || []);
                    
                    // 資料正規化 - 增加對 last_modified 的支援
                    const normalizedData = items.map(item => ({
                        id: item.id,
                        title: item.title || item.name || "未命名檔案",
                        folder: item.folder || item.category || null, 
                        created_at: item.created_at || item.creationDate || new Date().toISOString(),
                        // 確保抓到修改時間，增加 item.last_modified 與 item.lastModified (不同命名慣例)
                        modified_at: item.modified_at || item.lastModified || item.last_modified || new Date().toISOString()
                    }));
                    setDiagrams(normalizedData);
                } catch (err) {
                    console.error(err);
                    setError(err.message + " (若是 CORS 錯誤，請嘗試 Demo 模式)");
                } finally {
                    setLoading(false);
                }
            };

            const folderTree = useMemo(() => {
                const tree = {};
                PARA_ROOTS.forEach(root => {
                    tree[root] = { isParaRoot: true, subfolders: new Set(), countRecursive: 0, countDirect: 0 };
                });
                tree['others'] = { isParaRoot: false, subfolders: new Set(), countRecursive: 0, countDirect: 0 };

                diagrams.forEach(d => {
                    if (!d.folder) return;
                    let matchedRoot = PARA_ROOTS.find(root => d.folder === root || d.folder.startsWith(root + '/'));
                    if (matchedRoot) {
                        tree[matchedRoot].countRecursive++;
                        if (d.folder === matchedRoot) {
                            tree[matchedRoot].countDirect++;
                        } else {
                            tree[matchedRoot].subfolders.add(d.folder);
                        }
                    } else {
                        tree['others'].subfolders.add(d.folder);
                        tree['others'].countRecursive++;
                    }
                });
                return tree;
            }, [diagrams]);

            const toggleFolder = (folderName) => {
                setExpandedFolders(prev => ({ ...prev, [folderName]: !prev[folderName] }));
            };

            const processedData = useMemo(() => {
                let baseList = [...diagrams];

                if (searchTerm.trim()) {
                    const lower = searchTerm.toLowerCase();
                    baseList = baseList.filter(item => 
                        item.title.toLowerCase().includes(lower) || 
                        (item.folder && item.folder.toLowerCase().includes(lower))
                    );
                }

                let filtered = [];
                if (activeCategory === 'recent') {
                    // 最近開啟：強制依照修改時間排序，並取前 20 筆
                    // 這裡我們使用獨立的排序邏輯，不受全域 sortField 影響，以確保 "Recent" 的語意正確
                    filtered = [...baseList].sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at)).slice(0, 20);
                } else if (activeCategory === 'all') {
                    filtered = baseList;
                } else if (activeCategory === 'uncategorized') {
                    filtered = baseList.filter(item => !item.folder);
                } else if (activeCategory === 'others_root') {
                     filtered = baseList.filter(d => {
                         if(!d.folder) return false;
                         return !PARA_ROOTS.some(root => d.folder.startsWith(root));
                     });
                } else {
                    if (PARA_ROOTS.includes(activeCategory)) {
                        filtered = baseList.filter(item => item.folder && (item.folder === activeCategory || item.folder.startsWith(activeCategory + '/')));
                    } else {
                        filtered = baseList.filter(item => item.folder === activeCategory);
                    }
                }

                // 針對 Recent 以外的分類應用全域排序
                if (activeCategory !== 'recent') {
                    filtered.sort((a, b) => {
                        let valA = a[sortField];
                        let valB = b[sortField];
                        let comparison = 0;
                        if (sortField === 'title') comparison = valA.localeCompare(valB, 'zh-Hant');
                        else comparison = new Date(valA) - new Date(valB);
                        return sortOrder === 'asc' ? comparison : -comparison;
                    });
                }

                const totalItems = filtered.length;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                const items = filtered.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

                return { items, totalItems, totalPages };
            }, [diagrams, searchTerm, activeCategory, currentPage, sortField, sortOrder]);

            const SidebarGroup = ({ rootName, data }) => {
                const isExpanded = expandedFolders[rootName];
                const isActive = activeCategory === rootName;
                const subfolders = Array.from(data.subfolders).sort();
                const hasActiveChild = subfolders.some(sf => sf === activeCategory);

                return (
                    <div className="mb-1">
                        <div className={`flex items-center gap-1 px-2 py-2 rounded-lg transition-colors ${isActive ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'}`}>
                            <button onClick={(e) => { e.stopPropagation(); toggleFolder(rootName); }} className="p-1 text-gray-400 hover:text-gray-600 rounded">
                                <div className={`transition-transform duration-200 ${isExpanded ? 'rotate-0' : '-rotate-90'}`}><Icons.ChevronDown /></div>
                            </button>
                            <button onClick={() => { setActiveCategory(rootName); setIsMobileMenuOpen(false); }} className="flex-grow flex items-center gap-2 text-sm font-medium text-left">
                                {isActive ? <Icons.FolderOpen /> : <Icons.Folder />}
                                <span className="truncate">{rootName}</span>
                            </button>
                            {data.countRecursive > 0 && <span className="text-xs bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded-md min-w-[20px] text-center">{data.countRecursive}</span>}
                        </div>
                        {isExpanded && subfolders.length > 0 && (
                            <div className="ml-8 mt-1 space-y-0.5 border-l border-gray-200 pl-2">
                                {subfolders.map(sub => {
                                    const displayName = sub.split('/').pop();
                                    const isSubActive = activeCategory === sub;
                                    const count = diagrams.filter(d => d.folder === sub).length;
                                    return (
                                        <button key={sub} onClick={() => { setActiveCategory(sub); setIsMobileMenuOpen(false); }} className={`w-full text-left px-2 py-1.5 text-sm rounded-md flex justify-between items-center group transition-colors ${isSubActive ? 'text-blue-600 bg-blue-50 font-medium' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'}`}>
                                            <span className="truncate">{displayName}</span>
                                            <span className={`text-xs ${isSubActive ? 'text-blue-400' : 'text-gray-300 group-hover:text-gray-400'}`}>{count}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                );
            };

            const Pagination = () => {
                if (processedData.totalPages <= 1) return null;
                return (
                    <div className="flex justify-center items-center gap-2 mt-8 pt-6 border-t border-gray-200">
                        <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="p-2 rounded-md hover:bg-gray-100 disabled:opacity-30"><Icons.ChevronLeft /></button>
                        <span className="text-sm text-gray-600">第 {currentPage} / {processedData.totalPages} 頁</span>
                        <button onClick={() => setCurrentPage(p => Math.min(processedData.totalPages, p + 1))} disabled={currentPage === processedData.totalPages} className="p-2 rounded-md hover:bg-gray-100 disabled:opacity-30"><Icons.ChevronRight /></button>
                    </div>
                );
            };

            const SidebarItem = ({ id, label, icon, count, isActiveOverride }) => (
                <button onClick={() => { setActiveCategory(id); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 ${(activeCategory === id || isActiveOverride) ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}`}>
                    {icon}
                    <span className="flex-grow text-left truncate">{label}</span>
                    {count !== undefined && <span className="text-xs text-gray-400 bg-white px-1.5 py-0.5 rounded border border-gray-100">{count}</span>}
                </button>
            );

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col">
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-30 h-16 flex items-center px-4 justify-between lg:hidden">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 p-1.5 rounded-lg"><svg className="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div>
                            <h1 className="font-bold text-gray-800">Mindomo PARA</h1>
                        </div>
                        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-md"><Icons.Menu /></button>
                    </header>

                    <div className="flex flex-1 overflow-hidden relative">
                        <aside className={`fixed inset-y-0 left-0 z-20 w-64 bg-white border-r border-gray-200 transform transition-transform duration-200 ease-in-out lg:translate-x-0 lg:static lg:h-auto ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="h-full flex flex-col">
                                <div className="hidden lg:flex h-16 items-center px-6 border-b border-gray-100">
                                    <div className="flex items-center gap-2 text-blue-700">
                                        <div className="bg-blue-600 p-1.5 rounded-lg"><svg className="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div>
                                        <span className="font-bold text-lg">Mindomo</span>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar p-4">
                                    <div className="mb-6">
                                        <p className="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">儀表板</p>
                                        <SidebarItem id="recent" label="最近開啟" icon={<Icons.Clock />} />
                                        <SidebarItem id="all" label="全部檔案" icon={<Icons.Grid />} count={diagrams.length} />
                                    </div>
                                    <div className="mb-6">
                                        <p className="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">分類資料夾 (PARA)</p>
                                        {PARA_ROOTS.map(root => (<SidebarGroup key={root} rootName={root} data={folderTree[root]} />))}
                                    </div>
                                    <div>
                                        <p className="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">其他</p>
                                        <SidebarItem id="uncategorized" label="未分類檔案" icon={<Icons.File />} count={diagrams.filter(d => !d.folder).length} />
                                        {folderTree['others'].subfolders.size > 0 && (<SidebarGroup rootName="others" data={{...folderTree['others'], subfolders: folderTree['others'].subfolders}} />)}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-gray-100 bg-gray-50">
                                    <button onClick={() => setUseRealApi(!useRealApi)} className="w-full text-xs py-1.5 px-2 border border-gray-300 rounded bg-white text-gray-600 hover:bg-gray-50 mb-2">{useRealApi ? '切換演示模式' : '切換 API 模式'}</button>
                                    {useRealApi && (<button onClick={() => setShowConfig(!showConfig)} className="w-full flex items-center justify-center gap-2 text-xs text-blue-600 hover:text-blue-800"><Icons.Settings />{showConfig ? '隱藏設定' : '設定 Token'}</button>)}
                                </div>
                            </div>
                        </aside>
                        {isMobileMenuOpen && <div onClick={() => setIsMobileMenuOpen(false)} className="fixed inset-0 z-10 bg-gray-800 bg-opacity-50 lg:hidden"></div>}

                        <main className="flex-1 overflow-y-auto custom-scrollbar h-full bg-gray-50/50 w-full">
                            <div className="max-w-5xl mx-auto px-4 sm:px-8 py-8">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                            {activeCategory === 'recent' ? '最近修改' : activeCategory === 'all' ? '全部檔案' : activeCategory === 'uncategorized' ? '未分類檔案' : activeCategory}
                                        </h2>
                                        <p className="text-sm text-gray-500 mt-1">共 {processedData.totalItems} 個項目</p>
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
                                        <div className="relative group">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Icons.Search /></div>
                                            <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="block w-full sm:w-56 pl-10 pr-3 py-2 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="搜尋..." />
                                        </div>
                                        {activeCategory !== 'recent' && (
                                            <>
                                                <div className="h-8 w-px bg-gray-300 hidden sm:block mx-1"></div>
                                                <div className="flex gap-2">
                                                    <div className="relative">
                                                        <select value={sortField} onChange={(e) => setSortField(e.target.value)} className="appearance-none w-full sm:w-32 bg-white border border-gray-200 text-gray-700 text-sm py-2 pl-3 pr-8 rounded-lg focus:ring-2 focus:ring-blue-500 cursor-pointer outline-none">
                                                            <option value="modified_at">最近修改</option>
                                                            <option value="created_at">創建時間</option>
                                                            <option value="title">檔案名稱</option>
                                                        </select>
                                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><Icons.ArrowDown /></div>
                                                    </div>
                                                    <button onClick={() => setSortOrder(o => o === 'asc' ? 'desc' : 'asc')} className="p-2 bg-white border border-gray-200 rounded-lg text-gray-600 hover:text-blue-600">{sortOrder === 'asc' ? <Icons.SortAsc /> : <Icons.SortDesc />}</button>
                                                </div>
                                            </>
                                        )}
                                        {useRealApi && <button onClick={fetchDiagrams} disabled={loading} className="p-2 bg-white border border-gray-200 rounded-lg text-blue-600 hover:bg-blue-50"><Icons.Refresh spin={loading} /></button>}
                                    </div>
                                </div>

                                {useRealApi && showConfig && (
                                    <div className="mb-8 p-4 bg-white rounded-xl border border-blue-100 shadow-sm animate-fade-in">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">API Access Token</label>
                                        <div className="flex gap-3">
                                            <input type="password" value={apiToken} onChange={(e) => setApiToken(e.target.value)} className="flex-1 px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Token" />
                                            <button onClick={fetchDiagrams} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存</button>
                                        </div>
                                    </div>
                                )}
                                {error && <div className="mb-6 p-4 bg-red-50 text-red-700 rounded-lg border border-red-100">{error}</div>}
                                {processedData.totalItems === 0 ? (
                                    <div className="text-center py-20 animate-fade-in">
                                        <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gray-100 mb-4 text-gray-300"><Icons.Grid /></div>
                                        <h3 className="text-lg font-medium text-gray-900">沒有檔案</h3>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                        {processedData.items.map((item) => (
                                            <div key={item.id} className="group bg-white rounded-xl border border-gray-200 p-5 transition-all duration-200 card-hover flex flex-col h-full relative overflow-hidden">
                                                <div className="absolute top-0 left-0 w-1 h-full bg-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className="p-2.5 bg-blue-50 text-blue-600 rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors"><Icons.File /></div>
                                                    {useRealApi && <a href={`https://www.mindomo.com/mindmap/${item.id}`} target="_blank" className="text-xs font-medium text-blue-600 bg-blue-50 px-2.5 py-1 rounded-full hover:bg-blue-100 transition-colors">開啟</a>}
                                                </div>
                                                <h3 className="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-snug group-hover:text-blue-600 transition-colors">{item.title}</h3>
                                                <div className="mt-auto pt-4 border-t border-gray-50 space-y-2">
                                                    {item.folder && (<div className="flex items-center text-xs text-gray-500"><Icons.Folder /><span className="ml-2 truncate">{item.folder}</span></div>)}
                                                    {/* 強制顯示最後修改時間 */}
                                                    <div className="flex items-center text-xs text-gray-500">
                                                        <Icons.Clock />
                                                        <span className="ml-2">最後修改於 {formatDate(item.modified_at)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <Pagination />
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
