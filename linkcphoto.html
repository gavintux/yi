<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linkc Photo Space</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Babel (è®“ç€è¦½å™¨çœ‹å¾—æ‡‚ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. è¨­å®šä¸€äº›åŸºæœ¬æ¨£å¼ -->
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #f9fafb; }
        .loading-screen {
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; color: #4f46e5; font-weight: bold;
        }
        .error-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding: 20px; text-align: center; color: #374151;
        }
        .error-box {
            background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-width: 500px; width: 100%; border: 1px solid #e5e7eb;
        }
        .error-title { color: #dc2626; font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
        .error-list { text-align: left; list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; }
        .config-code { background: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">æ­£åœ¨å•Ÿå‹• Linkc Photo Space...</div>
    </div>

    <!-- 4. ä¸»è¦ç¨‹å¼é‚è¼¯ (Type=text/babel) -->
    <script type="text/babel" data-type="module">
        // ä½¿ç”¨ ES Modules é€éç¶²è·¯è¼‰å…¥ React, Icons å’Œ Firebase
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Camera, MapPin, Clock, Search, Upload, Download, Tag, Eye, X, 
            Image as ImageIcon, Maximize2, Share2, Facebook, Instagram, 
            MessageCircle, Copy, Check, Lock, Unlock, Edit, Trash2, LogOut, 
            Cloud, RefreshCw, AlertTriangle
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // -----------------------------------------------------------------------------
        // è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Firebase è³‡è¨Š
        // -----------------------------------------------------------------------------
        
        // ğŸ”´ è«‹å°‡ä¸‹æ–¹çš„ç‰©ä»¶æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase Config
        // æ‚¨å¯ä»¥åœ¨ Firebase Console -> Project Settings -> General -> Your apps ä¸‹æ–¹æ‰¾åˆ°
        const firebaseConfig = {
            apiKey: "AIzaSyDwXsplXePeD1wU1GG4BwQBR6iSMd3_5nY",
            authDomain: "linkcphoto.firebaseapp.com",
            projectId: "linkcphoto",
            storageBucket: "linkcphoto.firebasestorage.app",
            messagingSenderId: "841541302440",
            appId: "1:841541302440:web:a2b3dfef70a32bb345ea9d",
            measurementId: "G-902H2EHVFF"
            };

        // æª¢æŸ¥ Config æ˜¯å¦å·²å¡«å¯«
        const isConfigConfigured = !firebaseConfig.apiKey.includes("æ‚¨çš„API_KEY");

        // åˆå§‹åŒ– Firebase
        let app, auth, db;
        if (isConfigConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e);
            }
        }

        // ç°¡åŒ–è·¯å¾‘ï¼Œç›´æ¥ä½¿ç”¨æ ¹ç›®éŒ„ Collection
        const COLLECTION_NAME = 'linkc_photos_v1';

        // -----------------------------------------------------------------------------
        // Components
        // -----------------------------------------------------------------------------

        // Config Error Component
        const ConfigError = () => (
            <div className="error-container bg-gray-50">
                <div className="error-box">
                    <AlertTriangle className="mx-auto h-12 w-12 text-yellow-500 mb-4" />
                    <h3 className="error-title">å°šæœªè¨­å®š Firebase</h3>
                    <p className="text-gray-600 mb-4">
                        ç‚ºäº†è®“æ­¤ç¶²é åœ¨æ‚¨çš„ä¼ºæœå™¨ä¸Šé‹ä½œï¼Œæ‚¨éœ€è¦å¡«å…¥è‡ªå·±çš„ Firebase è¨­å®šã€‚
                    </p>
                    <ol className="error-list text-gray-600">
                        <li>ä½¿ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹ <b>index.html</b></li>
                        <li>æœå°‹ <code>const firebaseConfig</code></li>
                        <li>å°‡å…§å®¹æ›¿æ›ç‚ºæ‚¨åœ¨ Firebase Console å–å¾—çš„è¨­å®š</li>
                    </ol>
                    <div className="text-xs text-gray-400 mt-4">
                        æç¤ºï¼šè«‹å‰å¾€ Firebase Console &gt; Project Settings &gt; General &gt; Your apps
                    </div>
                </div>
            </div>
        );

        // Auth Error Component
        const AuthError = ({ message }) => (
            <div className="error-container bg-gray-50">
                <div className="error-box border-red-200">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-500 mb-4" />
                    <h3 className="error-title">é€£ç·šå¤±æ•— (Auth Error)</h3>
                    <p className="text-gray-800 font-mono text-xs bg-red-50 p-2 rounded mb-4 break-all">{message}</p>
                    <p className="text-gray-600 mb-2 font-bold">å¯èƒ½çš„åŸå› èˆ‡è§£æ±ºæ–¹æ³•ï¼š</p>
                    <ul className="error-list text-gray-600">
                        <li><b>firebaseConfig éŒ¯èª¤ï¼š</b>è«‹ç¢ºèª API Key èˆ‡ Project ID æ˜¯å¦æ­£ç¢ºè¤‡è£½ã€‚</li>
                        <li><b>æœªå•Ÿç”¨åŒ¿åç™»å…¥ï¼š</b>è«‹è‡³ Firebase Console &gt; Authentication &gt; Sign-in methodï¼Œé–‹å•Ÿ <b>Anonymous</b>ã€‚</li>
                        <li><b>ç¶²åŸŸæœªæˆæ¬Šï¼š</b>è‹¥æ‚¨æ”¾åœ¨ Apache/ç¶²é ä¼ºæœå™¨ä¸Šï¼Œè«‹è‡³ Firebase Console &gt; Authentication &gt; Settings &gt; Authorized domainsï¼Œå°‡æ‚¨çš„ç¶²åŸŸåŠ å…¥ç™½åå–®ã€‚</li>
                    </ul>
                    <button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                        é‡æ–°æ•´ç†
                    </button>
                </div>
            </div>
        );

        // ... (Utility functions remain same) ...
        const downloadWithWatermark = async (imageUrl, filename, e) => {
            if(e) e.stopPropagation();
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.crossOrigin = "anonymous";
            img.src = imageUrl;

            return new Promise((resolve, reject) => {
                img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const fontSize = Math.max(20, img.width * 0.03); 
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                const padding = fontSize;
                ctx.fillText('Linkc', canvas.width - padding, canvas.height - padding);
                try {
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                    const link = document.createElement('a');
                    link.download = `Linkc_${filename}.jpg`;
                    link.href = dataUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    resolve(true);
                } catch (err) {
                    alert("ç„¡æ³•ä¸‹è¼‰æ­¤åœ–ç‰‡ï¼ˆå¯èƒ½æ˜¯åŸå§‹åœ–ç‰‡ä¼ºæœå™¨é™åˆ¶äº†è·¨åŸŸå­˜å–ï¼‰ã€‚");
                    console.error(err);
                    resolve(false);
                }
                };
                img.onerror = () => {
                alert("åœ–ç‰‡è¼‰å…¥å¤±æ•—ã€‚");
                resolve(false);
                };
            });
        };

        const copyToClipboard = (text) => {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
            }
        };

        const Header = ({ setView, isAdmin, onLoginClick, onLogout }) => (
            <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div 
                    className="flex items-center cursor-pointer gap-2" 
                    onClick={() => setView('gallery')}
                >
                    <div className="bg-indigo-600 p-2 rounded-lg">
                    <Camera className="w-6 h-6 text-white" />
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900 tracking-tight">Linkc <span className="text-indigo-600 font-light">Gallery</span></h1>
                    {isAdmin && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold ml-2">ADMIN</span>}
                </div>
                
                <div className="flex items-center gap-3">
                    {isAdmin ? (
                        <button onClick={onLogout} className="p-2 text-gray-500 hover:text-red-600 transition-colors" title="ç™»å‡ºç®¡ç†æ¨¡å¼">
                            <LogOut size={20} />
                        </button>
                    ) : (
                        <button onClick={onLoginClick} className="p-2 text-gray-400 hover:text-indigo-600 transition-colors" title="ç®¡ç†å“¡ç™»å…¥">
                            <Lock size={20} />
                        </button>
                    )}
                    <button onClick={() => setView('upload')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full transition-all shadow-md hover:shadow-lg">
                        <Upload size={18} />
                        <span className="hidden sm:inline">æ–°å¢ç…§ç‰‡</span>
                    </button>
                </div>
                </div>
            </header>
        );

        const ShareButtons = ({ photo, className = "" }) => {
            const [showCopied, setShowCopied] = useState(false);
            const shareText = `${photo.thoughts_shooting || 'åˆ†äº«ä¸€å¼µå¾ˆæ£’çš„ç…§ç‰‡ï¼'} \n\n#Linkc #${photo.tags.join(' #')}`;
            const shareUrl = photo.url;
            const handleFB = (e) => { e.stopPropagation(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(shareText)}`, '_blank'); };
            const handleLine = (e) => { e.stopPropagation(); window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`, '_blank'); };
            const handleIG = async (e) => {
                e.stopPropagation();
                copyToClipboard(shareText);
                setShowCopied(true);
                setTimeout(() => setShowCopied(false), 2000);
                await downloadWithWatermark(photo.url, photo.id, e);
                alert("Instagram ä¸æ”¯æ´ç¶²é ç›´æ¥ç™¼æ–‡ã€‚\n\nå·²ç‚ºæ‚¨ï¼š\n1. è¤‡è£½è²¼æ–‡å…§å®¹\n2. ä¸‹è¼‰ç…§ç‰‡\n\nè«‹ç›´æ¥é–‹å•Ÿ Instagram ç™¼ä½ˆï¼");
            };
            return (
                <div className={`flex items-center gap-2 ${className}`}>
                <button onClick={handleFB} className="bg-[#1877F2] hover:bg-[#166fe5] text-white p-2 rounded-full transition-transform hover:scale-110 shadow-sm"><Facebook size={18} fill="currentColor" className="stroke-none" /></button>
                <button onClick={handleLine} className="bg-[#00C300] hover:bg-[#00b300] text-white p-2 rounded-full transition-transform hover:scale-110 shadow-sm"><MessageCircle size={18} fill="currentColor" className="stroke-none" /></button>
                <button onClick={handleIG} className="bg-gradient-to-tr from-[#f09433] via-[#dc2743] to-[#bc1888] text-white p-2 rounded-full transition-transform hover:scale-110 shadow-sm"><Instagram size={18} /></button>
                </div>
            );
        };

        const Lightbox = ({ photo, onClose, isAdmin, onEdit, onDelete }) => {
            if (!photo) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-in fade-in duration-200" onClick={onClose}>
                <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors z-50"><X size={32} /></button>
                {isAdmin && (
                    <div className="absolute top-4 left-4 flex gap-2 z-50">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-600/80 hover:bg-blue-600 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm backdrop-blur-md"><Edit size={14} /> ç·¨è¼¯</button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); onClose(); }} className="bg-red-600/80 hover:bg-red-600 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm backdrop-blur-md"><Trash2 size={14} /> åˆªé™¤</button>
                    </div>
                )}
                <div className="relative max-w-full max-h-[80vh] flex items-center justify-center group" onClick={(e) => e.stopPropagation()}>
                    <img src={photo.url} alt={photo.tags.join(', ')} className="max-w-full max-h-[80vh] object-contain shadow-2xl rounded-sm" />
                    <div className="absolute -bottom-16 left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-white/10 backdrop-blur-md px-6 py-3 rounded-full border border-white/10">
                    <button onClick={(e) => downloadWithWatermark(photo.url, photo.id, e)} className="text-white hover:text-indigo-300 transition-colors flex flex-col items-center gap-1"><Download size={20} /><span className="text-[10px]">ä¸‹è¼‰</span></button>
                    <div className="w-px h-8 bg-white/20 mx-2"></div>
                    <ShareButtons photo={photo} />
                    </div>
                </div>
                <div className="mt-4 text-white/80 text-center" onClick={(e) => e.stopPropagation()}>
                    <p className="text-white/60 text-xs font-mono mb-1">{photo.exif.shutter} Â· {photo.exif.aperture} Â· ISO {photo.exif.iso}</p>
                    <div className="flex items-center justify-center gap-4 text-sm font-medium"><span className="flex items-center gap-1"><Clock size={14}/> {photo.date}</span><span className="flex items-center gap-1"><MapPin size={14}/> {photo.location.city}</span></div>
                </div>
                </div>
            );
        };

        const PhotoCard = ({ photo, onExpand, isAdmin, onEdit, onDelete }) => {
            return (
                <div className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 group flex flex-col h-full border border-gray-100 relative">
                {isAdmin && (
                    <div className="absolute top-2 left-2 z-20 flex gap-2">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600 transition-colors" title="ç·¨è¼¯ç…§ç‰‡"><Edit size={14} /></button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); }} className="bg-red-500 text-white p-2 rounded-full shadow-md hover:bg-red-600 transition-colors" title="åˆªé™¤ç…§ç‰‡"><Trash2 size={14} /></button>
                    </div>
                )}
                <div className="relative aspect-[4/3] overflow-hidden bg-gray-100 cursor-zoom-in" onClick={() => onExpand(photo)}>
                    <img src={photo.url} alt={photo.tags.join(', ')} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onError={(e) => {e.target.src = "https://images.unsplash.com/photo-1623039405147-9477948aa73a?q=80&w=2070&auto=format&fit=crop";}} />
                    <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-2 z-10"><ShareButtons photo={photo} className="flex-col !gap-2" /></div>
                    <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none bg-black/10"><div className="bg-black/50 text-white p-3 rounded-full backdrop-blur-sm"><Maximize2 size={24} /></div></div>
                    <div className="absolute bottom-3 left-3 pointer-events-none"><span className="bg-black/60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-md flex items-center gap-1"><Clock size={12} /> {photo.date}</span></div>
                </div>
                <div className="p-5 flex flex-col flex-grow">
                    <div className="flex items-center text-gray-500 text-sm mb-3"><MapPin size={14} className="mr-1 text-indigo-500" />{photo.location.country} Â· {photo.location.city} {photo.location.spot && `Â· ${photo.location.spot}`}</div>
                    <div className="flex flex-wrap gap-2 mb-4">{photo.tags.map(tag => (<span key={tag} className="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs rounded-full font-medium">#{tag}</span>))}</div>
                    <div className="space-y-3 mb-4 flex-grow">
                    {photo.thoughts_shooting && (<div className="bg-gray-50 p-3 rounded-lg border-l-2 border-orange-300"><div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1"><Camera size={12} /> æ‹æ”ç•¶ä¸‹</div><p className="text-gray-700 text-sm italic">"{photo.thoughts_shooting}"</p></div>)}
                    {photo.thoughts_viewing && (<div className="bg-gray-50 p-3 rounded-lg border-l-2 border-indigo-300"><div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1"><Eye size={12} /> æ¬£è³éš¨ç­†</div><p className="text-gray-700 text-sm italic">"{photo.thoughts_viewing}"</p></div>)}
                    </div>
                    <div className="grid grid-cols-3 gap-2 border-t pt-3 mt-auto text-center">
                        <div className="flex flex-col items-center"><span className="text-[10px] uppercase text-gray-400 font-bold">å¿«é–€</span><span className="text-xs text-gray-700 font-mono">{photo.exif.shutter || '--'}</span></div>
                        <div className="flex flex-col items-center border-l border-r border-gray-100"><span className="text-[10px] uppercase text-gray-400 font-bold">å…‰åœˆ</span><span className="text-xs text-gray-700 font-mono">{photo.exif.aperture || '--'}</span></div>
                        <div className="flex flex-col items-center"><span className="text-[10px] uppercase text-gray-400 font-bold">ISO</span><span className="text-xs text-gray-700 font-mono">{photo.exif.iso || '--'}</span></div>
                    </div>
                    <div className="border-t border-dashed border-gray-200 mt-3 pt-2 flex justify-between items-center"><span className="text-[10px] text-gray-400">CC BY 4.0 å§“åæ¨™ç¤º</span><span className="text-[10px] font-bold text-gray-300 select-none">Linkc</span></div>
                </div>
                </div>
            );
        };

        const PhotoForm = ({ onSave, onCancel, initialData, isSaving }) => {
            const isEditMode = !!initialData;
            const [formData, setFormData] = useState(initialData || { url: '', tags: '', thoughts_shooting: '', thoughts_viewing: '', exif: { shutter: '', aperture: 'f/', iso: '', date: new Date().toISOString().split('T')[0] }, location: { country: '', city: '', spot: '' } });
            useEffect(() => { if (initialData && Array.isArray(initialData.tags)) { setFormData(prev => ({ ...prev, tags: initialData.tags.join(', ') })); } }, [initialData]);
            const handleChange = (section, field, value) => { if (section) { setFormData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } })); } else { setFormData(prev => ({ ...prev, [field]: value })); } };
            const handleSubmit = (e) => { e.preventDefault(); const processedData = { ...formData, tags: formData.tags.split(',').map(t => t.trim()).filter(t => t), date: formData.exif.date, }; onSave(processedData); };
            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 animate-in slide-in-from-bottom-4 duration-300">
                <div className="flex justify-between items-center mb-6 border-b pb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">{isEditMode ? <Edit className="text-blue-600" /> : <Upload className="text-indigo-600" />} {isEditMode ? 'ä¿®æ”¹ç…§ç‰‡è³‡è¨Š' : 'åˆ†äº«æ–°ç…§ç‰‡'}</h2><button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><X size={24} /></button></div>
                <form onSubmit={handleSubmit} className="space-y-8">
                    <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">ç…§ç‰‡é€£çµ (URL)</label>
                    <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><ImageIcon className="h-5 w-5 text-gray-400" /></div><input required type="url" placeholder="https://example.com/image.jpg" className="block w-full pl-10 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5 border" value={formData.url} onChange={(e) => handleChange(null, 'url', e.target.value)} /></div>
                    {!isEditMode && (<p className="text-xs text-gray-500">* é‡å° Google Photoï¼šè«‹åœ¨ç…§ç‰‡ä¸ŠæŒ‰å³éµé¸æ“‡ã€Œè¤‡è£½åœ–ç‰‡ä½å€ã€(Copy Image Address) ä»¥å–å¾—æœ‰æ•ˆé€£çµã€‚</p>)}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="space-y-6">
                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ¨™ç±¤ (Tags)</label><input type="text" placeholder="é¢¨æ™¯, å°ç£, è¡—æ‹ (ä»¥é€—è™Ÿåˆ†éš”)" className="block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5 border" value={formData.tags} onChange={(e) => handleChange(null, 'tags', e.target.value)} /></div>
                        <div className="bg-orange-50 p-4 rounded-lg border border-orange-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ‹æ”æ™‚çš„æ„Ÿå—</label><textarea rows="3" placeholder="æŒ‰ä¸‹å¿«é–€é‚£ä¸€åˆ»ï¼Œä½ åœ¨æƒ³ä»€éº¼ï¼Ÿ" className="block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5 border resize-none" value={formData.thoughts_shooting} onChange={(e) => handleChange(null, 'thoughts_shooting', e.target.value)} /></div>
                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ¬£è³æ™‚çš„æ„Ÿå—</label><textarea rows="3" placeholder="ç¾åœ¨çœ‹é€™å¼µç…§ç‰‡ï¼Œæœ‰ä»€éº¼æ–°çš„é«”æ‚Ÿï¼Ÿ" className="block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5 border resize-none" value={formData.thoughts_viewing} onChange={(e) => handleChange(null, 'thoughts_viewing', e.target.value)} /></div>
                    </div>
                    <div className="space-y-6 bg-gray-50 p-6 rounded-xl border border-gray-200 opacity-90">
                        <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">æ‹æ”åƒæ•¸ & åœ°é» (ä¹Ÿå¯ä¿®æ”¹)</h3>
                        <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-xs font-medium text-gray-500">å¿«é–€é€Ÿåº¦</label><input type="text" placeholder="1/200" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border" value={formData.exif.shutter} onChange={(e) => handleChange('exif', 'shutter', e.target.value)} /></div>
                        <div><label className="block text-xs font-medium text-gray-500">å…‰åœˆ</label><input type="text" placeholder="f/2.8" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border" value={formData.exif.aperture} onChange={(e) => handleChange('exif', 'aperture', e.target.value)} /></div>
                        <div><label className="block text-xs font-medium text-gray-500">ISO</label><input type="text" placeholder="400" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border" value={formData.exif.iso} onChange={(e) => handleChange('exif', 'iso', e.target.value)} /></div>
                        <div><label className="block text-xs font-medium text-gray-500">æ‹æ”æ—¥æœŸ</label><input type="date" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border" value={formData.exif.date} onChange={(e) => handleChange('exif', 'date', e.target.value)} /></div>
                        </div>
                        <div className="border-t border-gray-200 pt-4 mt-4"><div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-xs font-medium text-gray-500">åœ‹å®¶</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border" value={formData.location.country} onChange={(e) => handleChange('location', 'country', e.target.value)} /></div>
                            <div><label className="block text-xs font-medium text-gray-500">åŸå¸‚</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border" value={formData.location.city} onChange={(e) => handleChange('location', 'city', e.target.value)} /></div>
                            <div className="col-span-2"><label className="block text-xs font-medium text-gray-500">åœ°å/æ™¯é»</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border" value={formData.location.spot} onChange={(e) => handleChange('location', 'spot', e.target.value)} /></div>
                        </div></div>
                    </div>
                    </div>
                    <div className="flex justify-end gap-3 pt-6">
                    <button type="button" onClick={onCancel} disabled={isSaving} className="px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">å–æ¶ˆ</button>
                    <button type="submit" disabled={isSaving} className={`px-6 py-2 border border-transparent rounded-lg text-sm font-medium text-white shadow-lg hover:shadow-xl transition-all flex items-center gap-2 ${isEditMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-indigo-600 hover:bg-indigo-700'} disabled:opacity-50`}>{isSaving && <RefreshCw className="animate-spin" size={16} />} {isEditMode ? 'å„²å­˜ä¿®æ”¹' : 'ç™¼ä½ˆç…§ç‰‡'}</button>
                    </div>
                </form>
                </div>
            );
        };

        const AdminLogin = ({ onLogin, onCancel }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); if (password === '590123') { onLogin(); } else { setError(true); setPassword(''); } };
            return (
                <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full animate-in zoom-in-95 duration-200">
                        <div className="text-center mb-6"><div className="mx-auto bg-gray-100 w-12 h-12 rounded-full flex items-center justify-center mb-4"><Lock className="text-gray-600" /></div><h3 className="text-lg font-bold text-gray-900">ç®¡ç†å“¡ç™»å…¥</h3><p className="text-gray-500 text-sm">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å•Ÿç”¨ç·¨è¼¯/åˆªé™¤æ¬Šé™</p></div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="password" placeholder="è¼¸å…¥å¯†ç¢¼" className="w-full text-center tracking-widest border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none" value={password} onChange={(e) => {setPassword(e.target.value); setError(false);}} autoFocus />
                            {error && <p className="text-red-500 text-xs text-center">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚</p>}
                            <div className="flex gap-3"><button type="button" onClick={onCancel} className="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">å–æ¶ˆ</button><button type="submit" className="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-md">è§£é–</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        // -----------------------------------------------------------------------------
        // Main App
        // -----------------------------------------------------------------------------

        function App() {
            const [view, setView] = useState('gallery');
            const [photos, setPhotos] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState(null);
            
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [editingPhoto, setEditingPhoto] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            
            // New States for Error Handling
            const [authError, setAuthError] = useState(null);

            // 1. Auth Setup (Anonymous) with Error Handling
            useEffect(() => {
                if (!isConfigConfigured) return; // Don't try auth if config is missing

                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Auth failed:", err);
                        setAuthError(err.message);
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setCurrentUser(user);
                    if(user) setAuthError(null); // Clear error on success
                });
                return () => unsubscribe();
            }, []);

            // 2. Data Fetching
            useEffect(() => {
                if (!currentUser || !db) return;
                // æ”¹ç”¨æ ¹ç›®éŒ„ Collection
                const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const loadedPhotos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPhotos(loadedPhotos);
                }, (error) => {
                    console.error("Data fetch error:", error);
                });
                return () => unsubscribe();
            }, [currentUser]);

            // CRUD Operations
            const handleSavePhoto = async (photoData) => {
                if (!currentUser) return;
                setIsSaving(true);
                try {
                    // æ”¹ç”¨æ ¹ç›®éŒ„ Collection
                    const collectionRef = collection(db, COLLECTION_NAME);
                    if (editingPhoto) {
                        const docRef = doc(collectionRef, photoData.id);
                        await updateDoc(docRef, { ...photoData });
                        setEditingPhoto(null);
                    } else {
                        await addDoc(collectionRef, { ...photoData, timestamp: Date.now() });
                    }
                    setView('gallery');
                } catch (e) { 
                    console.error("Save error:", e); 
                    // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
                    alert("å„²å­˜å¤±æ•—: " + e.message); 
                } finally { 
                    setIsSaving(false); 
                }
            };

            const handleDeletePhoto = async (id) => {
                if (!currentUser) return;
                if(window.confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿæ­¤å‹•ä½œå°‡åŒæ­¥åˆªé™¤è³‡æ–™åº«ä¸­çš„ç´€éŒ„ã€‚')) {
                    try { 
                        // æ”¹ç”¨æ ¹ç›®éŒ„ Collection
                        await deleteDoc(doc(db, COLLECTION_NAME, id)); 
                    } catch(e) { 
                        console.error("Delete error:", e); 
                        // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
                        alert("åˆªé™¤å¤±æ•—: " + e.message); 
                    }
                }
            };

            const startEdit = (photo) => { setEditingPhoto(photo); setView('upload'); if (selectedPhoto) setSelectedPhoto(null); };

            // Render Logic for Errors
            if (!isConfigConfigured) return <ConfigError />;
            if (authError) return <AuthError message={authError} />;

            // Filter Logic
            const allTags = [...new Set(photos.flatMap(p => p.tags))];
            const filteredPhotos = photos.filter(photo => {
                const matchesSearch = (photo.location.city || '').includes(searchQuery) || (photo.location.country || '').includes(searchQuery) || (photo.location.spot || '').includes(searchQuery) || (photo.thoughts_shooting || '').includes(searchQuery) || (photo.thoughts_viewing || '').includes(searchQuery) || (photo.tags || []).some(t => t.includes(searchQuery));
                const matchesTag = activeTag ? (photo.tags || []).includes(activeTag) : true;
                return matchesSearch && matchesTag;
            });

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                <Header setView={(v) => { setView(v); setEditingPhoto(null); }} isAdmin={isAdmin} onLoginClick={() => setShowLogin(true)} onLogout={() => { setIsAdmin(false); alert("å·²ç™»å‡ºç®¡ç†æ¨¡å¼"); }} />
                {showLogin && (<AdminLogin onLogin={() => { setIsAdmin(true); setShowLogin(false); }} onCancel={() => setShowLogin(false)} />)}
                {selectedPhoto && (<Lightbox photo={selectedPhoto} onClose={() => setSelectedPhoto(null)} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />)}

                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    {view === 'gallery' ? (
                    <>
                        <div className="flex flex-col md:flex-row gap-6 mb-8">
                        <div className="relative flex-grow max-w-xl"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Search className="h-5 w-5 text-gray-400" /></div><input type="text" placeholder="æœå°‹åŸå¸‚ã€åœ°é»ã€æ„Ÿå—æˆ–é—œéµå­—..." className="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition-all" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>
                        <div className="flex-1 flex flex-wrap gap-2 items-center"><span className="text-sm font-bold text-gray-400 mr-2 flex items-center gap-1"><Tag size={14} /> åˆ†é¡:</span><button onClick={() => setActiveTag(null)} className={`px-3 py-1 rounded-full text-sm transition-colors ${!activeTag ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-200'}`}>å…¨éƒ¨</button>{allTags.map(tag => (<button key={tag} onClick={() => setActiveTag(tag === activeTag ? null : tag)} className={`px-3 py-1 rounded-full text-sm transition-colors ${tag === activeTag ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-indigo-50 hover:border-indigo-200'}`}>{tag}</button>))}</div>
                        </div>

                        {filteredPhotos.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">{filteredPhotos.map(photo => (<PhotoCard key={photo.id} photo={photo} onExpand={setSelectedPhoto} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />))}</div>
                        ) : (
                        <div className="text-center py-20 bg-white rounded-xl shadow-sm border border-dashed border-gray-300"><Cloud className="mx-auto h-12 w-12 text-gray-300 mb-3" /><h3 className="text-lg font-medium text-gray-900">è³‡æ–™åº«æ˜¯ç©ºçš„</h3><p className="text-gray-500">é€™æ˜¯ä¸€å€‹å…¨æ–°çš„é›²ç«¯ç›¸ç°¿ï¼Œä¸Šå‚³ç¬¬ä¸€å¼µç…§ç‰‡å§ï¼</p><button onClick={() => setView('upload')} className="mt-4 text-indigo-600 hover:text-indigo-800 font-medium">ä¸Šå‚³æ–°ç…§ç‰‡ &rarr;</button></div>
                        )}
                    </>
                    ) : (
                    <PhotoForm onSave={handleSavePhoto} onCancel={() => { setView('gallery'); setEditingPhoto(null); }} initialData={editingPhoto} isSaving={isSaving} />
                    )}
                </main>
                <footer className="bg-white border-t border-gray-200 mt-12 py-8"><div className="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm"><p>Â© {new Date().getFullYear()} Linkc Photo Space.</p><p className="mt-1">Content Creative Commons Attribution (CC BY).</p></div></footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
