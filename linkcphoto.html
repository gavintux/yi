<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linkc Photo Space</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        serif: ['"Noto Serif TC"', 'serif'],
                    },
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9', // 溫柔的背景色
                            800: '#1e293b', // 深色文字
                            900: '#0f172a',
                        },
                        indigo: {
                            500: '#6366f1', // 主色調
                            600: '#4f46e5',
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 載入 Exif-js -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <!-- 4. 設定 Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- 5. CSS -->
    <style>
        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* Slate-50 */
            color: #1e293b; /* Slate-800 */
            -webkit-font-smoothing: antialiased;
        }
        
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: #4f46e5; font-weight: 500; letter-spacing: 0.05em; }
        
        /* 捲軸樣式 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* 瀑布流佈局 */
        .masonry-grid {
            column-count: 1;
            column-gap: 1.5rem;
        }
        @media (min-width: 640px) { .masonry-grid { column-count: 2; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
        
        /* 避免卡片在列中間斷開 */
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1.5rem;
        }

        .btn-icon {
            @apply p-2 rounded-full transition-all duration-200 hover:bg-slate-100 text-slate-500 hover:text-indigo-600;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">
            <div class="flex flex-col items-center gap-4">
                <div class="w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-sm uppercase tracking-widest text-slate-400">Loading Gallery...</span>
            </div>
        </div>
    </div>

    <!-- 6. React App -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo, useCallback } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Camera, MapPin, Clock, Search, Upload, Download, Tag, Eye, X, 
            Image as ImageIcon, Maximize2, Share2, Facebook, Instagram, 
            MessageCircle, Copy, Check, Lock, Unlock, Edit, Trash2, LogOut, 
            Cloud, RefreshCw, AlertTriangle, Info, Save, Link as LinkIcon, FileUp, 
            Sparkles, Map as MapIcon, Aperture, Disc, Gauge, 
            ArrowDownWideNarrow, ArrowUpNarrowWide, Filter, FileCode,
            Calendar as CalendarIcon, ChevronLeft, ChevronRight, XCircle, MoreHorizontal, LayoutGrid, Globe, ChevronDown
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // -----------------------------------------------------------------------------
        // 設定區
        // -----------------------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyDwXsplXePeD1wU1GG4BwQBR6iSMd3_5nY",
            authDomain: "linkcphoto.firebaseapp.com",
            projectId: "linkcphoto",
            storageBucket: "linkcphoto.firebasestorage.app",
            messagingSenderId: "841541302440",
            appId: "1:841541302440:web:a2b3dfef70a32bb345ea9d",
            measurementId: "G-902H2EHVFF"
        };

        const isConfigConfigured = !firebaseConfig.apiKey.includes("您的API_KEY");
        const COLLECTION_NAME = 'linkc_photos_v1';

        let app, auth, db, storage;
        if (isConfigConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase Init Error", e);
            }
        }

        // -----------------------------------------------------------------------------
        // Hooks & Helpers
        // -----------------------------------------------------------------------------

        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => setDebouncedValue(value), delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        const getExifValue = (item) => {
            if (typeof item === 'number') return item;
            if (typeof item === 'string') {
                if (item.includes('/')) {
                    const [n, d] = item.split('/');
                    return Number(n) / Number(d);
                }
                return Number(item);
            }
            if (item && item.numerator !== undefined && item.denominator !== undefined) {
                return item.denominator === 0 ? 0 : item.numerator / item.denominator;
            }
            if (item && typeof item.valueOf === 'function') {
                const val = item.valueOf();
                return isNaN(val) ? 0 : Number(val);
            }
            return 0;
        };

        const formatExposureBias = (bias) => {
            const val = getExifValue(bias);
            if (val === 0) return "0";
            const sign = val > 0 ? "+" : "";
            const absVal = Math.abs(val);
            if (Math.abs(absVal - 0.333) < 0.01) return `${sign}1/3`;
            if (Math.abs(absVal - 0.666) < 0.01) return `${sign}2/3`;
            if (Math.abs(absVal - 0.5) < 0.01) return `${sign}1/2`;
            if (Number.isInteger(val)) return `${sign}${val}`;
            return `${sign}${val.toFixed(1)}`;
        };

        const parseLensInfo = (lensInfo) => {
            if (!lensInfo || lensInfo.length < 2) return null;
            const minFocal = getExifValue(lensInfo[0]);
            const maxFocal = getExifValue(lensInfo[1]);
            const minF = getExifValue(lensInfo[2]);
            const maxF = getExifValue(lensInfo[3]);

            if (!minFocal) return null;
            let focalStr = minFocal === maxFocal ? `${minFocal}mm` : `${minFocal}-${maxFocal}mm`;
            let apertureStr = "";
            if (minF > 0) apertureStr = (minF === maxF || !maxF) ? `f/${minF}` : `f/${minF}-${maxF}`;
            return `${focalStr} ${apertureStr}`.trim();
        };

        const findLensNameInAllTags = (allTags) => {
            const candidates = [allTags.LensModel, allTags.Lens, allTags.LensID, allTags.LensInfo];
            for (const c of candidates) {
                if (c && typeof c === 'string' && c.trim().length > 0 && !c.toLowerCase().includes("undefined")) return c;
            }
            for (const key in allTags) {
                const val = allTags[key];
                if (typeof val === 'string' && val.length > 3 && key.includes('Lens')) {
                    if (val.toLowerCase().includes('unknown') || val.toLowerCase().includes('defined')) continue;
                    return val;
                }
            }
            if (allTags.LensInfo) return parseLensInfo(allTags.LensInfo);
            if (allTags['UndefinedTag:0xA432']) return parseLensInfo(allTags['UndefinedTag:0xA432']);
            return "";
        };

        const convertDMSToDD = (dms, ref) => {
            if (!dms) return null;
            const d = getExifValue(dms[0]);
            const m = getExifValue(dms[1]);
            const s = getExifValue(dms[2]);
            let dd = d + m / 60 + s / 3600;
            if (ref === "S" || ref === "W") dd = dd * -1;
            if (isNaN(dd) || (dd === 0 && d === 0 && m === 0)) return null;
            return dd;
        };

        const reverseGeocode = async (lat, lon) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                if (!response.ok) return null;
                const data = await response.json();
                return data.address;
            } catch (error) {
                console.error("Geocoding failed", error);
                return null;
            }
        };

        const downloadOriginal = async (imageUrl, filename) => {
            try {
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Linkc_${filename}_original.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                console.error(err);
                window.open(imageUrl, '_blank');
            }
        };

        const downloadWithWatermark = async (imageUrl, filename, e) => {
            if(e) e.stopPropagation();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = imageUrl;
            return new Promise((resolve) => {
                img.onload = () => {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const fontSize = Math.max(20, img.width * 0.03); 
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'bottom';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        const padding = fontSize;
                        ctx.fillText('Linkc', canvas.width - padding, canvas.height - padding);
                        const link = document.createElement('a');
                        link.download = `Linkc_${filename}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        resolve(true);
                    } catch (err) {
                        console.warn("Canvas Tainted", err);
                        downloadOriginal(imageUrl, filename);
                        resolve(false); 
                    }
                };
                img.onerror = () => {
                    downloadOriginal(imageUrl, filename);
                    resolve(false);
                };
            });
        };

        const copyToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { document.execCommand('copy'); } catch (err) { console.error('Copy failed', err); }
            document.body.removeChild(textArea);
        };

        // -----------------------------------------------------------------------------
        // Defined Components
        // -----------------------------------------------------------------------------

        const ConfigError = () => (
            <div className="error-container bg-gray-50">
                <div className="error-box">
                    <AlertTriangle className="mx-auto h-12 w-12 text-yellow-500 mb-4" />
                    <h3 className="error-title text-gray-900">尚未設定 Firebase</h3>
                    <p className="text-gray-600 mb-4">請編輯 index.html 並填入您的 Firebase Config。</p>
                </div>
            </div>
        );

        const AuthError = ({ message }) => (
            <div className="error-container bg-gray-50">
                <div className="error-box border-red-200">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-500 mb-4" />
                    <h3 className="error-title text-gray-900">連線失敗</h3>
                    <p className="text-gray-800 font-mono text-xs bg-red-50 p-2 rounded mb-4 break-all">{message}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-sm transition-colors">重新整理</button>
                </div>
            </div>
        );

        const AdminLogin = ({ onLogin, onCancel }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (password === '590123') onLogin(); else setPassword(''); };
            return (
                <div className="fixed inset-0 z-50 bg-gray-900/60 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in-up">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full border border-gray-100">
                        <div className="text-center mb-6">
                            <div className="mx-auto bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mb-4"><Lock className="text-indigo-600 w-8 h-8" /></div>
                            <h3 className="text-xl font-bold text-gray-800">管理員登入</h3>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="password" placeholder="Passcode" className="w-full text-center tracking-widest border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-lg" value={password} onChange={(e) => setPassword(e.target.value)} autoFocus />
                            <div className="flex gap-3"><button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-500 hover:bg-gray-50 rounded-xl transition-colors font-medium">取消</button><button type="submit" className="flex-1 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 font-medium">解鎖</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const ShareButtons = ({ photo, minimal = false }) => {
            const shareText = `${photo.thoughts_shooting || '分享一張照片'} \n\n#Linkc ${photo.tags.map(t=>'#'+t).join(' ')}`;
            const handleIG = async (e) => { e.stopPropagation(); copyToClipboard(shareText); await downloadWithWatermark(photo.url, photo.id, e); };
            const handleObsidian = (e) => { e.stopPropagation(); const altText = photo.tags.length > 0 ? photo.tags.join(', ') : 'Linkc Photo'; const markdown = `![${altText}](${photo.url})`; copyToClipboard(markdown); alert("已複製 Obsidian 語法！"); };
            
            const btnClass = minimal 
                ? "text-gray-400 hover:text-gray-700 transition-colors p-1"
                : "text-gray-500 hover:bg-gray-100 p-2 rounded-full transition-all";

            return (
                <div className="flex items-center gap-1">
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(photo.url)}`, '_blank')}} className={`${btnClass} hover:text-[#1877F2]`}><Facebook size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(photo.url)}`, '_blank')}} className={`${btnClass} hover:text-[#06c755]`}><MessageCircle size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                    <button onClick={handleIG} className={`${btnClass} hover:text-[#E1306C]`}><Instagram size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                    <button onClick={handleObsidian} className={`${btnClass} hover:text-purple-600`}><FileCode size={minimal ? 16 : 18} strokeWidth={1.5} /></button>
                </div>
            );
        };

        const Lightbox = ({ photo, onClose, isAdmin, onEdit, onDelete }) => {
            if (!photo) return null;
            return (
                <div className="fixed inset-0 z-50 bg-gray-900/95 backdrop-blur-md flex flex-col items-center justify-center p-4 animate-fade-in-up" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-6 right-6 text-white/50 hover:text-white p-2 z-50 transition-colors"><X size={32} strokeWidth={1} /></button>
                    
                    {isAdmin && (
                        <div className="absolute top-6 left-6 flex gap-4 z-50">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-full backdrop-blur-sm text-sm font-medium transition-all flex items-center gap-2"><Edit size={14}/> 編輯</button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); onClose(); }} className="bg-red-500/80 hover:bg-red-600 text-white px-4 py-2 rounded-full backdrop-blur-sm text-sm font-medium transition-all flex items-center gap-2"><Trash2 size={14}/> 刪除</button>
                        </div>
                    )}

                    <div className="relative max-w-7xl max-h-[85vh] w-full flex flex-col items-center justify-center" onClick={e => e.stopPropagation()}>
                        <img src={photo.url} className="max-w-full max-h-[80vh] object-contain shadow-2xl rounded-sm" loading="eager" decoding="async" />
                        
                        <div className="mt-6 flex flex-col items-center gap-3 text-white/90">
                            <div className="flex items-center gap-6 text-sm font-light tracking-wide bg-black/40 px-6 py-2 rounded-full backdrop-blur-md border border-white/10">
                                <span className="flex items-center gap-2"><Clock size={14} className="text-indigo-400"/> {photo.date ? photo.date.replace('T', ' ') : ''}</span>
                                <span className="w-px h-3 bg-white/20"></span>
                                <span className="flex items-center gap-2"><MapPin size={14} className="text-indigo-400"/> {photo.location.city} {photo.location.spot && `· ${photo.location.spot}`}</span>
                                <span className="w-px h-3 bg-white/20"></span>
                                <button onClick={(e) => downloadWithWatermark(photo.url, photo.id, e)} className="hover:text-indigo-300 transition-colors flex items-center gap-2"><Download size={14} /> 下載</button>
                            </div>
                            
                            <div className="text-xs text-white/50 font-mono tracking-wider space-x-3">
                                {photo.exif.camera && <span>{photo.exif.camera}</span>}
                                {photo.exif.lens && <span>| {photo.exif.lens}</span>}
                                <span>| {photo.exif.shutter} · {photo.exif.aperture} · ISO {photo.exif.iso} {photo.exif.focalLength ? `· ${photo.exif.focalLength}` : ''} {photo.exif.ev ? `· EV ${photo.exif.ev}` : ''}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // PhotoCard: 恢復 Indigo/Gray 風格
        const PhotoCard = ({ photo, onExpand, isAdmin, onEdit, onDelete }) => (
            <div className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 group flex flex-col h-full border border-gray-100 relative">
                {isAdmin && (
                    <div className="absolute top-2 left-2 z-20 flex gap-2">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600"><Edit size={14} /></button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); }} className="bg-red-500 text-white p-2 rounded-full shadow-md hover:bg-red-600"><Trash2 size={14} /></button>
                    </div>
                )}
                <div className="relative aspect-[4/3] overflow-hidden bg-gray-100 cursor-zoom-in" onClick={() => onExpand(photo)}>
                    <img src={photo.url} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                    <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-2 z-10"><ShareButtons photo={photo} /></div>
                    <div className="absolute bottom-3 left-3 pointer-events-none">
                        <span className="bg-black/60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-md flex items-center gap-1">
                            <Clock size={12} /> {photo.date ? photo.date.replace('T', ' ') : ''}
                        </span>
                    </div>
                </div>
                
                <div className="p-5 flex flex-col flex-grow">
                    <div className="flex items-center text-gray-500 text-sm mb-3">
                        <MapPin size={14} className="mr-1 text-indigo-500" />
                        {photo.location.country} · {photo.location.city} {photo.location.spot && `· ${photo.location.spot}`}
                    </div>

                    <div className="flex flex-wrap gap-2 mb-4">
                        {photo.tags.map(tag => (
                            <span key={tag} className="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs rounded-full font-medium">#{tag}</span>
                        ))}
                    </div>

                    <div className="space-y-3 mb-4 flex-grow">
                        {photo.thoughts_shooting && (
                            <div className="bg-gray-50 p-3 rounded-lg border-l-2 border-orange-300">
                                <div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1">
                                    <Camera size={12} /> 拍攝當下
                                </div>
                                <p className="text-gray-700 text-sm italic">"{photo.thoughts_shooting}"</p>
                            </div>
                        )}
                        {photo.thoughts_viewing && (
                            <div className="bg-gray-50 p-3 rounded-lg border-l-2 border-indigo-300">
                                <div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1">
                                    <Eye size={12} /> 欣賞隨筆
                                </div>
                                <p className="text-gray-700 text-sm italic">"{photo.thoughts_viewing}"</p>
                            </div>
                        )}
                    </div>

                    {(photo.exif.camera || photo.exif.lens) && (
                        <div className="flex flex-col gap-1 mb-3 text-xs text-gray-600 bg-gray-50 p-2 rounded-lg border border-gray-100">
                            {photo.exif.camera && <div className="flex items-center gap-1 font-medium"><Camera size={12} className="text-gray-400"/> {photo.exif.camera}</div>}
                            {photo.exif.lens && <div className="flex items-center gap-1 text-gray-500"><Disc size={12} className="text-gray-400"/> {photo.exif.lens}</div>}
                        </div>
                    )}

                    <div className="grid grid-cols-4 gap-1 border-t pt-3 mt-auto text-center">
                        <div className="flex flex-col items-center"><span className="text-[10px] uppercase text-gray-400 font-bold">快門</span><span className="text-xs text-gray-700 font-mono">{photo.exif.shutter || '--'}</span></div>
                        <div className="flex flex-col items-center border-l border-gray-100"><span className="text-[10px] uppercase text-gray-400 font-bold">光圈</span><span className="text-xs text-gray-700 font-mono">{photo.exif.aperture || '--'}</span></div>
                        <div className="flex flex-col items-center border-l border-gray-100"><span className="text-[10px] uppercase text-gray-400 font-bold">ISO</span><span className="text-xs text-gray-700 font-mono">{photo.exif.iso || '--'}</span></div>
                        <div className="flex flex-col items-center border-l border-gray-100"><span className="text-[10px] uppercase text-gray-400 font-bold">EV</span><span className="text-xs text-gray-700 font-mono">{photo.exif.ev || '--'}</span></div>
                    </div>
                    
                    <div className="border-t border-dashed border-gray-200 mt-3 pt-2 flex justify-between items-center">
                        <span className="text-[10px] text-gray-400">CC BY 4.0 姓名標示</span>
                        <span className="text-[10px] font-bold text-gray-300 select-none">Linkc</span>
                    </div>
                </div>
            </div>
        );

        // Header: 回歸白色底、靛藍色點綴
        const Header = ({ setView, isAdmin, onLoginClick, onLogout, currentView }) => (
            <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-24 flex items-center justify-between">
                <div className="flex items-center gap-2">
                    {/* Logo 連結至部落格 */}
                    <a href="https://2blog.ilc.edu.tw/linkc/" target="_blank" rel="noopener noreferrer" className="flex items-center hover:opacity-80 transition-opacity" title="前往 Linkc Blog">
                        <img src="https://firebasestorage.googleapis.com/v0/b/linkcphoto.firebasestorage.app/o/photos%2Flinkc-w0.png?alt=media&token=63c9b589-aa78-480a-bed2-1c83634f4b9f" alt="Linkc Logo" className="h-16 w-auto mr-2" />
                    </a>
                    
                    <div className="flex items-center cursor-pointer gap-2" onClick={() => setView('gallery')}>
                        <h1 className="text-2xl font-bold text-gray-900 tracking-tight hidden sm:block">Linkc <span className="text-indigo-600 font-light">Gallery</span></h1>
                    </div>
                    
                    {isAdmin && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold ml-2">ADMIN</span>}
                </div>
                <div className="flex items-center gap-3">
                    <a href="https://gavintux.github.io/yi/" target="_blank" rel="noopener noreferrer" className="p-2.5 rounded-xl transition-all text-gray-400 hover:text-gray-700 hover:bg-gray-100" title="Zen's Portal">
                        <Globe size={20} />
                    </a>
                    <button 
                        onClick={() => setView('calendar')} 
                        className={`p-2.5 rounded-xl transition-all ${currentView === 'calendar' ? 'bg-indigo-100 text-indigo-600' : 'text-gray-500 hover:text-indigo-600 hover:bg-gray-100'}`}
                        title="日曆模式"
                    >
                        <CalendarIcon size={20} />
                    </button>

                    {isAdmin ? (
                        <button onClick={onLogout} className="p-2.5 text-gray-500 hover:text-red-600 transition-colors" title="登出"><LogOut size={20} /></button>
                    ) : (
                        <button onClick={onLoginClick} className="p-2.5 text-gray-400 hover:text-indigo-600 transition-colors" title="登入"><Lock size={20} /></button>
                    )}
                    {/* Conditionally render Upload button based on isAdmin */}
                    {isAdmin && (
                        <button onClick={() => setView('upload')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm">
                            <Upload size={18} /><span className="hidden sm:inline">新增照片</span>
                        </button>
                    )}
                </div>
                </div>
            </header>
        );

        // Updated Calendar View (Mobile Friendly + Picker)
        const CalendarView = ({ photos, onSelectDate, onExpand, isAdmin, onEdit, onDelete }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [showPicker, setShowPicker] = useState(false); // For Year/Month Picker
            const photoSectionRef = useRef(null);

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay };
            };

            const { days, firstDay } = getDaysInMonth(currentDate);
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
            
            // Available Years for Picker
            const availableYears = useMemo(() => {
                const years = new Set(photos.map(p => {
                    const d = p.exif?.date || p.date;
                    // Simple logic to extract year
                    if (!d) return new Date().getFullYear();
                    // Assuming ISO-like format or at least starting with YYYY
                    const yearStr = d.substring(0, 4);
                    const year = parseInt(yearStr);
                    return isNaN(year) ? new Date().getFullYear() : year;
                }));
                years.add(new Date().getFullYear());
                return Array.from(years).sort((a, b) => b - a);
            }, [photos]);

            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            
            const handleJump = (year, monthIndex) => {
                setCurrentDate(new Date(year, monthIndex, 1));
                setShowPicker(false);
            };

            const getFormattedDate = (day) => {
                const y = currentDate.getFullYear();
                const m = String(currentDate.getMonth() + 1).padStart(2, '0');
                const d = String(day).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            const getPhotosForDate = (dateStr) => photos.filter(p => (p.exif?.date || p.date || '').startsWith(dateStr));
            const handleDateClick = (dateStr) => { setSelectedDate(dateStr); setTimeout(() => { photoSectionRef.current?.scrollIntoView({ behavior: 'smooth' }); }, 100); };
            const selectedPhotos = selectedDate ? getPhotosForDate(selectedDate) : [];

            return (
                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in-up pb-12">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 sm:p-8 relative">
                        {/* Header & Picker Toggle */}
                        <div className="flex justify-between items-center mb-8">
                            <button 
                                onClick={() => setShowPicker(!showPicker)}
                                className="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2 hover:bg-gray-50 px-3 py-1 rounded-lg transition-colors group"
                            >
                                <span className="bg-indigo-100 text-indigo-600 p-1.5 sm:p-2 rounded-lg group-hover:bg-indigo-200 transition-colors"><CalendarIcon size={20} /></span>
                                <span>{currentDate.getFullYear()}年 {monthNames[currentDate.getMonth()]}</span>
                                <ChevronDown size={18} className={`text-gray-400 transition-transform duration-200 ${showPicker ? 'rotate-180' : ''}`} />
                            </button>
                            <div className="flex gap-2">
                                <button onClick={prevMonth} className="p-2 hover:bg-gray-100 rounded-full text-gray-500 transition-colors"><ChevronLeft /></button>
                                <button onClick={nextMonth} className="p-2 hover:bg-gray-100 rounded-full text-gray-500 transition-colors"><ChevronRight /></button>
                            </div>
                        </div>

                        {/* Year/Month Picker Overlay */}
                        {showPicker && (
                            <div className="absolute top-20 left-0 right-0 z-20 bg-white shadow-xl border border-gray-200 rounded-xl p-6 mx-4 sm:mx-8 animate-fade-in-up">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto">
                                    {availableYears.map(year => (
                                        <div key={year} className="space-y-2">
                                            <h4 className="font-bold text-indigo-600 border-b border-gray-100 pb-1 sticky top-0 bg-white">{year}</h4>
                                            <div className="grid grid-cols-4 gap-2">
                                                {monthNames.map((m, idx) => (
                                                    <button 
                                                        key={idx} 
                                                        onClick={() => handleJump(year, idx)}
                                                        className={`text-sm py-2 rounded hover:bg-indigo-50 hover:text-indigo-600 transition-colors ${
                                                            year === currentDate.getFullYear() && idx === currentDate.getMonth() ? 'bg-indigo-600 text-white hover:bg-indigo-700 font-bold' : 'text-gray-600'
                                                        }`}
                                                    >
                                                        {idx + 1}月
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-7 gap-1 sm:gap-4 mb-4 text-center text-gray-400 font-bold text-xs uppercase tracking-wider">
                            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                        </div>
                        
                        {/* Responsive Grid: Mobile (Compact) vs Desktop (Detailed) */}
                        <div className="grid grid-cols-7 gap-1 sm:gap-4">
                            {Array.from({ length: firstDay }).map((_, i) => (<div key={`empty-${i}`} className="h-14 sm:h-32 rounded-lg sm:rounded-2xl bg-gray-50/50 border border-transparent"></div>))}
                            {Array.from({ length: days }).map((_, i) => {
                                const day = i + 1;
                                const dateStr = getFormattedDate(day);
                                const dayPhotos = getPhotosForDate(dateStr);
                                const count = dayPhotos.length;
                                const isToday = dateStr === new Date().toISOString().split('T')[0];
                                const isSelected = dateStr === selectedDate;
                                return (
                                    <div 
                                        key={day}
                                        onClick={() => count > 0 && handleDateClick(dateStr)}
                                        className={`
                                            h-14 sm:h-32 flex flex-col justify-between p-1 sm:p-3 rounded-lg sm:rounded-2xl transition-all relative border group
                                            ${count > 0 ? 'cursor-pointer hover:shadow-lg hover:-translate-y-1 border-gray-200 bg-white' : 'border-transparent bg-gray-50 text-gray-300'}
                                            ${isSelected ? 'ring-2 ring-indigo-500 ring-offset-1 sm:ring-offset-2 border-indigo-200' : ''}
                                        `}
                                    >
                                        <div className="flex justify-center sm:justify-between items-start">
                                            <span className={`text-xs sm:text-sm font-bold ${isToday ? 'bg-indigo-600 text-white w-6 h-6 flex items-center justify-center rounded-full shadow-md' : ''}`}>{day}</span>
                                        </div>
                                        
                                        {/* Mobile: Dot Indicator */}
                                        {count > 0 && (
                                            <div className="sm:hidden flex justify-center">
                                                <div className={`w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-indigo-500' : 'bg-indigo-300'}`}></div>
                                            </div>
                                        )}

                                        {/* Desktop: Image Preview */}
                                        {count > 0 && (
                                            <div className="hidden sm:flex flex-col items-center gap-2">
                                                <div className="w-full h-12 rounded-lg overflow-hidden bg-gray-100 relative">
                                                     <img src={dayPhotos[0].url} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" loading="lazy" />
                                                     {count > 1 && <div className="absolute top-1 right-1 bg-black/50 text-white text-[10px] font-bold px-1.5 rounded-full backdrop-blur-sm">+{count-1}</div>}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    {selectedDate && selectedPhotos.length > 0 && (
                        <div ref={photoSectionRef} className="pt-8 border-t-2 border-dashed border-gray-200 animate-fade-in-up">
                            <div className="flex justify-between items-center mb-8 px-2">
                                <h3 className="text-xl font-bold text-gray-800 flex items-center gap-3">
                                    <span className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-sm">{selectedDate}</span>
                                    的照片
                                </h3>
                                <button onClick={() => setSelectedDate(null)} className="p-2 hover:bg-gray-200 rounded-full text-slate-500"><XCircle size={24} /></button>
                            </div>
                            <div className="masonry-grid">
                                {selectedPhotos.map(photo => (<PhotoCard key={photo.id} photo={photo} onExpand={onExpand} isAdmin={isAdmin} onEdit={onEdit} onDelete={onDelete} />))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const PhotoForm = ({ onSave, onCancel, initialData, isSaving }) => {
            const isEditMode = !!initialData;
            const getNowString = () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); return now.toISOString().slice(0, 16); };
            const [formData, setFormData] = useState(initialData || { url: '', tags: '', thoughts_shooting: '', thoughts_viewing: '', exif: { shutter: '', aperture: 'f/', iso: '', date: getNowString(), camera: '', lens: '', focalLength: '', ev: '' }, location: { country: '', city: '', spot: '' } });
            const [status, setStatus] = useState('');
            const [uploadFile, setUploadFile] = useState(null);
            const [exifStatus, setExifStatus] = useState(''); 

            useEffect(() => { if (initialData && Array.isArray(initialData.tags)) { setFormData(prev => ({ ...prev, tags: initialData.tags.join(', ') })); } }, [initialData]);
            const handleChange = (section, field, value) => { if (section) { setFormData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } })); } else { setFormData(prev => ({ ...prev, [field]: value })); } };
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadFile(file);
                    setExifStatus('分析中...');
                    const previewUrl = URL.createObjectURL(file);
                    setFormData(prev => ({ ...prev, url: previewUrl }));
                    EXIF.getData(file, async function() {
                        // ... Same EXIF logic ...
                        const extractedShutter = EXIF.getTag(this, "ExposureTime");
                        const extractedFNumber = EXIF.getTag(this, "FNumber");
                        const extractedISO = EXIF.getTag(this, "ISOSpeedRatings");
                        const extractedDate = EXIF.getTag(this, "DateTimeOriginal");
                        const extractedFocalLength = EXIF.getTag(this, "FocalLength");
                        const extractedBias = EXIF.getTag(this, "ExposureBiasValue");
                        const make = EXIF.getTag(this, "Make");
                        const model = EXIF.getTag(this, "Model");
                        const allTags = EXIF.getAllTags(this);
                        let lensModel = findLensNameInAllTags(allTags);
                        if (lensModel && typeof lensModel === 'string') {
                            lensModel = lensModel.replace(/\0/g, '').trim();
                            const lensMake = EXIF.getTag(this, "LensMake");
                            if (lensMake && !lensModel.toLowerCase().includes(lensMake.toLowerCase())) lensModel = `${lensMake} ${lensModel}`;
                        }
                        const lat = EXIF.getTag(this, "GPSLatitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                        const lon = EXIF.getTag(this, "GPSLongitude");
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");
                        let formattedShutter = "";
                        const shutterVal = getExifValue(extractedShutter);
                        if (shutterVal > 0) formattedShutter = shutterVal < 1 ? "1/" + Math.round(1/shutterVal) : shutterVal.toString();
                        const apertureVal = getExifValue(extractedFNumber);
                        const formattedAperture = apertureVal ? "f/" + apertureVal : "";
                        const formattedEV = formatExposureBias(extractedBias);
                        let formattedDate = "";
                        if (extractedDate) {
                            const parts = extractedDate.split(" ");
                            if (parts.length >= 2) formattedDate = `${parts[0].replace(/:/g, "-")}T${parts[1].substring(0, 5)}`;
                            else if (parts.length === 1) formattedDate = parts[0].replace(/:/g, "-");
                        }
                        let formattedCamera = "";
                        if (make && model) formattedCamera = model.toLowerCase().includes(make.toLowerCase()) ? model : `${make} ${model}`;
                        else formattedCamera = model || make || "";
                        if (formattedCamera) formattedCamera = formattedCamera.replace(/\0/g, '').trim();
                        let formattedFocalLength = "";
                        const focalVal = getExifValue(extractedFocalLength);
                        if (focalVal) formattedFocalLength = `${focalVal}mm`;
                        let locationUpdate = { ...formData.location };
                        let extraStatus = "";
                        if (lat && lon) {
                            const decimalLat = convertDMSToDD(lat, latRef || 'N');
                            const decimalLon = convertDMSToDD(lon, lonRef || 'E');
                            if (decimalLat && decimalLon) {
                                setExifStatus('定位中...');
                                const address = await reverseGeocode(decimalLat, decimalLon);
                                if (address) {
                                    locationUpdate = {
                                        country: address.country || "",
                                        city: address.city || address.county || address.town || address.state || "",
                                        spot: address.suburb || address.village || address.road || address.pedestrian || ""
                                    };
                                    extraStatus = " + GPS";
                                } else { extraStatus = " (GPS 失敗)"; }
                            }
                        }
                        setFormData(prev => ({
                            ...prev,
                            exif: {
                                shutter: formattedShutter || prev.exif.shutter,
                                aperture: formattedAperture || prev.exif.aperture,
                                iso: extractedISO ? extractedISO.toString() : prev.exif.iso,
                                date: formattedDate || prev.exif.date,
                                camera: formattedCamera || prev.exif.camera,
                                lens: lensModel || prev.exif.lens,
                                focalLength: formattedFocalLength || prev.exif.focalLength,
                                ev: formattedEV || prev.exif.ev
                            },
                            location: locationUpdate
                        }));
                        setExifStatus(`EXIF 完成 ${extraStatus}`);
                    });
                }
            };
            const handleSubmit = async (e) => { 
                e.preventDefault();
                setStatus('uploading');
                let finalUrl = formData.url;
                try {
                    if (uploadFile) {
                        const filename = `photos/${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${uploadFile.name}`;
                        const storageRef = ref(storage, filename);
                        await uploadBytes(storageRef, uploadFile);
                        finalUrl = await getDownloadURL(storageRef);
                    }
                    const processedData = { ...formData, url: finalUrl, tags: formData.tags.split(',').map(t => t.trim()).filter(t => t), date: formData.exif.date }; 
                    onSave(processedData); 
                } catch (err) { console.error("上傳失敗", err); alert("上傳失敗: " + err.message); setStatus(''); }
            };

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 sm:p-12 animate-fade-in-up my-8 border border-slate-100">
                    <div className="flex justify-between items-center mb-10 border-b border-slate-100 pb-6"><h2 className="text-3xl font-bold text-slate-800 flex items-center gap-3">{isEditMode ? <Edit className="text-indigo-500"/> : <Upload className="text-indigo-500"/>} {isEditMode ? '修改照片' : '新增照片'}</h2><button onClick={onCancel} className="text-slate-400 hover:text-slate-700 transition-colors p-2 hover:bg-slate-50 rounded-full"><X size={24}/></button></div>
                    {status === 'uploading' && (<div className="mb-8 flex justify-center items-center gap-3 text-indigo-600 font-bold bg-indigo-50 p-4 rounded-xl border border-indigo-100 animate-pulse"><RefreshCw className="spinner" size={20}/> 正在上傳至雲端...</div>)}
                    <form onSubmit={handleSubmit} className="space-y-12">
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-12">
                            <div className="md:col-span-2 space-y-6">
                                <label className={`flex flex-col items-center justify-center w-full aspect-[4/3] border-2 border-dashed rounded-2xl cursor-pointer hover:bg-slate-50 transition-all group overflow-hidden relative ${uploadFile ? 'border-indigo-500 bg-indigo-50/30' : 'border-slate-300'}`}>{formData.url ? (<img src={formData.url} className="w-full h-full object-cover p-1 rounded-2xl" />) : (<div className="text-center text-slate-400 group-hover:text-indigo-500 transition-colors"><FileUp className="w-12 h-12 mx-auto mb-3 opacity-70" /><span className="text-sm tracking-wide font-bold uppercase">點擊選擇照片</span></div>)}<input type="file" accept="image/*" onChange={handleFileChange} className="hidden" disabled={status === 'uploading'} />{uploadFile && <div className="absolute top-2 right-2 bg-indigo-500 text-white p-1.5 rounded-full shadow-md"><Check size={16} strokeWidth={3}/></div>}</label>
                                {exifStatus && (<div className="flex items-center justify-center gap-2 text-sm text-indigo-600 font-medium bg-indigo-50 py-2 rounded-lg border border-indigo-100"><Sparkles size={16}/> {exifStatus}</div>)}
                                <div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><LinkIcon className="h-5 w-5 text-slate-400" /></div><input type="url" placeholder="或貼上圖片連結" className="block w-full pl-10 border-slate-300 rounded-xl p-3 text-sm border focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" value={formData.url} onChange={(e) => { handleChange(null, 'url', e.target.value); setUploadFile(null); }} disabled={uploadFile || status === 'uploading'} /></div>
                            </div>
                            <div className="md:col-span-3 space-y-8">
                                <div className="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100"><h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-4"><Tag size={14} className="text-indigo-500"/> 內容描述</h4><input type="text" placeholder="標籤 (例如: 風景, 台灣)" className="block w-full border-slate-200 rounded-lg p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" value={formData.tags} onChange={(e) => handleChange(null, 'tags', e.target.value)} /><textarea rows="3" placeholder="拍攝當下的想法..." className="block w-full border-slate-200 rounded-lg p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none resize-none" value={formData.thoughts_shooting} onChange={(e) => handleChange(null, 'thoughts_shooting', e.target.value)} /><textarea rows="2" placeholder="事後欣賞的感受..." className="block w-full border-slate-200 rounded-lg p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none resize-none text-slate-600" value={formData.thoughts_viewing} onChange={(e) => handleChange(null, 'thoughts_viewing', e.target.value)} /></div>
                                <div className="grid grid-cols-2 gap-6"><div className="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100"><h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-4"><MapPin size={14} className="text-indigo-500"/> 地點資訊</h4><input type="text" placeholder="國家" className="block w-full border-slate-200 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none" value={formData.location.country} onChange={(e) => handleChange('location', 'country', e.target.value)} /><input type="text" placeholder="城市" className="block w-full border-slate-200 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none" value={formData.location.city} onChange={(e) => handleChange('location', 'city', e.target.value)} /><input type="text" placeholder="景點/街道" className="block w-full border-slate-200 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none" value={formData.location.spot} onChange={(e) => handleChange('location', 'spot', e.target.value)} /></div><div className="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-100"><h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-4"><Aperture size={14} className="text-indigo-500"/> 拍攝參數</h4><input type="datetime-local" className="block w-full border-slate-200 rounded-lg p-2 text-xs text-slate-600 mb-2" value={formData.exif.date} onChange={(e) => handleChange('exif', 'date', e.target.value)} /><div className="grid grid-cols-2 gap-2"><input type="text" placeholder="相機" className="border-slate-200 rounded p-1 text-xs" value={formData.exif.camera} onChange={(e) => handleChange('exif', 'camera', e.target.value)} /><input type="text" placeholder="鏡頭" className="border-slate-200 rounded p-1 text-xs" value={formData.exif.lens} onChange={(e) => handleChange('exif', 'lens', e.target.value)} /><input type="text" placeholder="快門" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.shutter} onChange={(e) => handleChange('exif', 'shutter', e.target.value)} /><input type="text" placeholder="光圈" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.aperture} onChange={(e) => handleChange('exif', 'aperture', e.target.value)} /><input type="text" placeholder="ISO" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.iso} onChange={(e) => handleChange('exif', 'iso', e.target.value)} /><input type="text" placeholder="EV" className="border-slate-200 rounded p-1 text-xs text-center" value={formData.exif.ev} onChange={(e) => handleChange('exif', 'ev', e.target.value)} /></div></div></div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-4 pt-8 border-t border-slate-100"><button type="button" onClick={onCancel} disabled={isSaving || status === 'uploading'} className="px-6 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition-colors">取消</button><button type="submit" disabled={isSaving || status === 'uploading'} className="px-8 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 font-medium flex items-center gap-2 disabled:opacity-50 transition-all hover:-translate-y-0.5">{(isSaving || status === 'uploading') ? <RefreshCw className="animate-spin" size={20} /> : (isEditMode ? <Edit size={20}/> : <Upload size={20}/>)}{isEditMode ? '更新照片' : '發佈照片'}</button></div>
                    </form>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('gallery');
            const [photos, setPhotos] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState(null);
            const [sortOrder, setSortOrder] = useState('newest'); 
            const [dateFilter, setDateFilter] = useState(null); 
            const [isTagsExpanded, setIsTagsExpanded] = useState(false);
            
            // 狀態初始化：從 localStorage 讀取管理員狀態
            const [isAdmin, setIsAdmin] = useState(() => localStorage.getItem('linkc_admin_auth') === 'true');
            const [showLogin, setShowLogin] = useState(false);
            
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [editingPhoto, setEditingPhoto] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [authError, setAuthError] = useState(null);
            
            // Debounce search query
            const debouncedSearchQuery = useDebounce(searchQuery, 300);

            useEffect(() => {
                if (!isConfigConfigured) return; 
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (err) { setAuthError(err.message); } };
                initAuth();
                onAuthStateChanged(auth, (user) => { setCurrentUser(user); if(user) setAuthError(null); });
            }, []);

            useEffect(() => {
                if (!currentUser || !db) return;
                const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => { setPhotos(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            }, [currentUser]);

            // 管理員登入邏輯
            const handleAdminLogin = () => {
                setIsAdmin(true);
                localStorage.setItem('linkc_admin_auth', 'true'); // 儲存狀態
                setShowLogin(false);
            };

            // 管理員登出邏輯
            const handleAdminLogout = () => {
                setIsAdmin(false);
                localStorage.removeItem('linkc_admin_auth'); // 清除狀態
                alert("已登出");
            };

            const handleSavePhoto = async (photoData) => {
                if (!currentUser) return;
                setIsSaving(true);
                try {
                    const collectionRef = collection(db, COLLECTION_NAME);
                    if (editingPhoto) {
                        await updateDoc(doc(collectionRef, photoData.id), { ...photoData });
                        setEditingPhoto(null);
                    } else {
                        await addDoc(collectionRef, { ...photoData, timestamp: Date.now() });
                    }
                    setView('gallery');
                    setDateFilter(null); 
                } catch (e) { alert("儲存失敗: " + e.message); } finally { setIsSaving(false); }
            };

            const handleDeletePhoto = async (id) => {
                if (!currentUser) return;
                if(window.confirm('確定要永久刪除？')) {
                    try { await deleteDoc(doc(db, COLLECTION_NAME, id)); } catch(e) { alert("刪除失敗"); }
                }
            };

            const startEdit = (photo) => { setEditingPhoto(photo); setView('upload'); if (selectedPhoto) setSelectedPhoto(null); };

            if (!isConfigConfigured) return <ConfigError />;
            if (authError) return <AuthError message={authError} />;

            // Use useMemo for heavy calculations
            const allTags = useMemo(() => [...new Set(photos.flatMap(p => p.tags))], [photos]);
            
            const tagCounts = useMemo(() => {
                return photos.flatMap(p => p.tags).reduce((acc, tag) => {
                    acc[tag] = (acc[tag] || 0) + 1;
                    return acc;
                }, {});
            }, [photos]);

            const sortedTags = useMemo(() => {
                return Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
            }, [tagCounts]);

            const visibleTags = isTagsExpanded ? sortedTags : sortedTags.slice(0, 10);
            const hasMoreTags = sortedTags.length > 10;

            // Advanced Search & Filter Logic with Boolean Operators
            const filteredPhotos = useMemo(() => {
                return photos.filter(photo => {
                    if (dateFilter) {
                        const photoDate = photo.exif?.date || photo.date || '';
                        return photoDate.startsWith(dateFilter);
                    }
                    if (activeTag && !(photo.tags || []).includes(activeTag)) return false;
                    
                    if (!debouncedSearchQuery.trim()) return true;

                    const searchableText = [
                        ...(photo.tags || []),
                        photo.thoughts_shooting,
                        photo.thoughts_viewing,
                        photo.location?.country,
                        photo.location?.city,
                        photo.location?.spot,
                        photo.exif?.camera,
                        photo.exif?.lens,
                        photo.exif?.shutter,
                        photo.exif?.aperture,
                        photo.exif?.iso,
                        photo.exif?.focalLength,
                        photo.exif?.ev,
                        photo.exif?.date
                    ].filter(Boolean).join(' ').toLowerCase();

                    const query = debouncedSearchQuery.toLowerCase();
                    const tokens = query.split(/\s+/);
                    
                    let isMatch = true;
                    let operator = 'AND'; 
                    let firstToken = true;

                    for (let i = 0; i < tokens.length; i++) {
                        const token = tokens[i];
                        if (token === 'or' || token === '|') { operator = 'OR'; continue; }
                        if (token === 'and' || token === '&') { operator = 'AND'; continue; }

                        let isNot = false;
                        let term = token;
                        if (term.startsWith('-') && term.length > 1) { isNot = true; term = term.substring(1); }

                        const match = searchableText.includes(term);
                        const conditionMet = isNot ? !match : match;

                        if (firstToken) { isMatch = conditionMet; firstToken = false; }
                        else {
                            if (operator === 'OR') { isMatch = isMatch || conditionMet; operator = 'AND'; }
                            else { isMatch = isMatch && conditionMet; }
                        }
                    }
                    return isMatch;
                });
            }, [photos, debouncedSearchQuery, activeTag, dateFilter]);

            const sortedPhotos = useMemo(() => {
                return [...filteredPhotos].sort((a, b) => {
                    const dateA = a.exif?.date || a.timestamp;
                    const dateB = b.exif?.date || b.timestamp;
                    return sortOrder === 'newest' ? (dateA < dateB ? 1 : -1) : (dateA > dateB ? 1 : -1);
                });
            }, [filteredPhotos, sortOrder]);

            return (
                <div className="min-h-screen font-sans text-slate-800 pb-20 bg-slate-50">
                <Header setView={(v) => { setView(v); setEditingPhoto(null); setDateFilter(null); }} isAdmin={isAdmin} onLoginClick={() => setShowLogin(true)} onLogout={handleAdminLogout} currentView={view} />
                
                {showLogin && (<AdminLogin onLogin={handleAdminLogin} onCancel={() => setShowLogin(false)} />)}
                {selectedPhoto && (<Lightbox photo={selectedPhoto} onClose={() => setSelectedPhoto(null)} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />)}

                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    {view === 'calendar' ? (
                        <CalendarView 
                            photos={photos} 
                            onSelectDate={(d) => { setDateFilter(d); setView('gallery'); }} 
                            onExpand={setSelectedPhoto}
                            isAdmin={isAdmin}
                            onEdit={startEdit}
                            onDelete={handleDeletePhoto}
                        />
                    ) : view === 'gallery' ? (
                    <>
                        {dateFilter && (
                            <div className="mb-10 flex justify-center items-center animate-fade-in-up">
                                <div className="text-center bg-white p-6 rounded-2xl shadow-sm border border-indigo-100">
                                    <h2 className="text-2xl font-bold mb-3 text-slate-800 flex items-center gap-2 justify-center"><CalendarIcon className="text-indigo-500"/> {dateFilter}</h2>
                                    <button onClick={() => setDateFilter(null)} className="px-4 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-sm font-bold rounded-full flex items-center gap-1 transition-colors mx-auto"><XCircle size={16}/> Clear Date Filter</button>
                                </div>
                            </div>
                        )}

                        <div className="flex flex-col gap-6 mb-12 animate-fade-in-up">
                            <div className="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                                <div className="relative w-full md:max-w-md">
                                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><Search className="h-5 w-5 text-slate-400" /></div>
                                    <input 
                                        type="text" 
                                        placeholder="搜尋照片、標籤、地點、相機..." 
                                        className="w-full pl-12 pr-10 py-2 bg-slate-50 border-transparent rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-slate-700 placeholder-slate-400 transition-all"
                                        value={searchQuery} 
                                        onChange={(e) => setSearchQuery(e.target.value)} 
                                        disabled={!!dateFilter} 
                                    />
                                    <div className="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none"><Filter className="h-4 w-4 text-slate-300" /></div>
                                </div>
                                <div className="flex items-center gap-2 text-sm text-slate-500 font-bold bg-slate-50 p-1.5 rounded-xl">
                                    <button onClick={() => setSortOrder('newest')} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg transition-all ${sortOrder === 'newest' ? 'bg-white text-indigo-600 shadow-sm' : 'hover:text-indigo-600'}`}><ArrowDownWideNarrow size={16}/> 最新</button>
                                    <button onClick={() => setSortOrder('oldest')} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg transition-all ${sortOrder === 'oldest' ? 'bg-white text-indigo-600 shadow-sm' : 'hover:text-indigo-600'}`}><ArrowUpNarrowWide size={16}/> 最舊</button>
                                </div>
                            </div>
                            
                            {sortedTags.length > 0 && (
                                <div className="flex flex-wrap gap-2 justify-center items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                                    <div className="flex items-center gap-1 mr-2 text-slate-400 font-bold text-xs uppercase tracking-wider"><Tag size={14}/> 常用標籤:</div>
                                    <button onClick={() => setActiveTag(null)} className={`px-3 py-1 rounded-full text-xs font-medium transition-all ${!activeTag ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>全部</button>
                                    {visibleTags.map(tag => (
                                        <button 
                                            key={tag} 
                                            onClick={() => setActiveTag(tag === activeTag ? null : tag)} 
                                            className={`px-3 py-1 rounded-full text-xs font-medium transition-all ${tag === activeTag ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600'}`}
                                        >
                                            {tag}
                                        </button>
                                    ))}
                                    {hasMoreTags && (
                                        <button 
                                            onClick={() => setIsTagsExpanded(!isTagsExpanded)} 
                                            className="px-3 py-1 rounded-full text-xs font-medium text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition-all flex items-center gap-1"
                                        >
                                            {isTagsExpanded ? '收起' : <><MoreHorizontal size={14} /> 更多</>}
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>

                        {sortedPhotos.length > 0 ? (
                        <div className="masonry-grid animate-fade-in-up">
                            {sortedPhotos.map(photo => (
                                <PhotoCard key={photo.id} photo={photo} onExpand={setSelectedPhoto} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />
                            ))}
                        </div>
                        ) : (
                        <div className="text-center py-32 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-4">
                            <div className="bg-slate-50 p-6 rounded-full"><Cloud className="h-12 w-12 text-slate-300" /></div>
                            <h3 className="text-xl font-bold text-slate-700">沒有符合條件的照片</h3>
                            <p className="text-slate-500">試著調整搜尋條件{isAdmin ? '，或上傳一張新照片吧！' : '。'}</p>
                            {/* Hide upload button for strangers in empty state too */}
                            {isAdmin && (
                                <button onClick={() => setView('upload')} className="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl shadow-lg shadow-indigo-200 transition-all font-medium flex items-center gap-2">
                                    <Upload size={18}/> 上傳照片
                                </button>
                            )}
                        </div>
                        )}
                    </>
                    ) : (
                    <PhotoForm onSave={handleSavePhoto} onCancel={() => { setView('gallery'); setEditingPhoto(null); }} initialData={editingPhoto} isSaving={isSaving} />
                    )}
                </main>
                <footer className="border-t border-slate-200 mt-16 py-12 text-center bg-white">
                    <div className="max-w-7xl mx-auto px-4 flex flex-col items-center gap-4">
                        <p className="text-xs text-slate-400 font-medium tracking-widest uppercase">© {new Date().getFullYear()} Linkc Photo Space. All rights reserved.</p>
                    </div>
                </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
