<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linkc Photo Space</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Exif-js -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <!-- 4. CSS (Classic Style) -->
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background-color: #f9fafb; /* gray-50 */ color: #111827; /* gray-900 */ }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: #4f46e5; /* indigo-600 */ font-weight: bold; }
        .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; color: #374151; }
        .error-box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 500px; width: 100%; border: 1px solid #e5e7eb; }
        .error-title { color: #dc2626; font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
        
        /* æ²è»¸æ¨£å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">æ­£åœ¨å•Ÿå‹• Linkc Photo Space...</div>
    </div>

    <!-- 5. React App -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Camera, MapPin, Clock, Search, Upload, Download, Tag, Eye, X, 
            Image as ImageIcon, Maximize2, Share2, Facebook, Instagram, 
            MessageCircle, Copy, Check, Lock, Unlock, Edit, Trash2, LogOut, 
            Cloud, RefreshCw, AlertTriangle, Info, Save, Link as LinkIcon, FileUp, 
            Sparkles, Map as MapIcon, Aperture, Disc, Gauge, 
            ArrowDownWideNarrow, ArrowUpNarrowWide, Filter, FileCode,
            Calendar as CalendarIcon, ChevronLeft, ChevronRight, XCircle, MoreHorizontal
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // -----------------------------------------------------------------------------
        // è¨­å®šå€
        // -----------------------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyDwXsplXePeD1wU1GG4BwQBR6iSMd3_5nY",
            authDomain: "linkcphoto.firebaseapp.com",
            projectId: "linkcphoto",
            storageBucket: "linkcphoto.firebasestorage.app",
            messagingSenderId: "841541302440",
            appId: "1:841541302440:web:a2b3dfef70a32bb345ea9d",
            measurementId: "G-902H2EHVFF"
        };

        const isConfigConfigured = !firebaseConfig.apiKey.includes("æ‚¨çš„API_KEY");

        let app, auth, db, storage;
        if (isConfigConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e);
            }
        }

        const COLLECTION_NAME = 'linkc_photos_v1';

        // -----------------------------------------------------------------------------
        // Helper Functions (åŠŸèƒ½ä¿æŒæœ€æ–°ç‰ˆæœ¬)
        // -----------------------------------------------------------------------------

        const getExifValue = (item) => {
            if (typeof item === 'number') return item;
            if (typeof item === 'string') {
                if (item.includes('/')) {
                    const [n, d] = item.split('/');
                    return Number(n) / Number(d);
                }
                return Number(item);
            }
            if (item && item.numerator !== undefined && item.denominator !== undefined) {
                return item.denominator === 0 ? 0 : item.numerator / item.denominator;
            }
            if (item && typeof item.valueOf === 'function') {
                const val = item.valueOf();
                return isNaN(val) ? 0 : Number(val);
            }
            return 0;
        };

        const formatExposureBias = (bias) => {
            const val = getExifValue(bias);
            if (val === 0) return "0";
            const sign = val > 0 ? "+" : "";
            const absVal = Math.abs(val);
            if (Math.abs(absVal - 0.333) < 0.01) return `${sign}1/3`;
            if (Math.abs(absVal - 0.666) < 0.01) return `${sign}2/3`;
            if (Math.abs(absVal - 0.5) < 0.01) return `${sign}1/2`;
            if (Number.isInteger(val)) return `${sign}${val}`;
            return `${sign}${val.toFixed(1)}`;
        };

        const parseLensInfo = (lensInfo) => {
            if (!lensInfo || lensInfo.length < 2) return null;
            const minFocal = getExifValue(lensInfo[0]);
            const maxFocal = getExifValue(lensInfo[1]);
            const minF = getExifValue(lensInfo[2]);
            const maxF = getExifValue(lensInfo[3]);

            if (!minFocal) return null;
            let focalStr = minFocal === maxFocal ? `${minFocal}mm` : `${minFocal}-${maxFocal}mm`;
            let apertureStr = "";
            if (minF > 0) apertureStr = (minF === maxF || !maxF) ? `f/${minF}` : `f/${minF}-${maxF}`;
            return `${focalStr} ${apertureStr}`.trim();
        };

        const findLensNameInAllTags = (allTags) => {
            const candidates = [allTags.LensModel, allTags.Lens, allTags.LensID, allTags.LensInfo];
            for (const c of candidates) {
                if (c && typeof c === 'string' && c.trim().length > 0) {
                    if(c.toLowerCase().includes("undefined")) continue;
                    return c;
                }
            }
            for (const key in allTags) {
                const val = allTags[key];
                if (typeof val === 'string' && val.length > 3 && key.includes('Lens')) {
                    if (val.toLowerCase().includes('unknown') || val.toLowerCase().includes('defined')) continue;
                    return val;
                }
            }
            if (allTags.LensInfo) return parseLensInfo(allTags.LensInfo);
            if (allTags['UndefinedTag:0xA432']) return parseLensInfo(allTags['UndefinedTag:0xA432']);
            return "";
        };

        const convertDMSToDD = (dms, ref) => {
            if (!dms) return null;
            const d = getExifValue(dms[0]);
            const m = getExifValue(dms[1]);
            const s = getExifValue(dms[2]);
            let dd = d + m / 60 + s / 3600;
            if (ref === "S" || ref === "W") dd = dd * -1;
            if (isNaN(dd) || (dd === 0 && d === 0 && m === 0)) return null;
            return dd;
        };

        const reverseGeocode = async (lat, lon) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                if (!response.ok) return null;
                const data = await response.json();
                return data.address;
            } catch (error) {
                console.error("Geocoding failed", error);
                return null;
            }
        };

        const downloadOriginal = async (imageUrl, filename) => {
            try {
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Linkc_${filename}_original.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                console.error(err);
                window.open(imageUrl, '_blank');
            }
        };

        const downloadWithWatermark = async (imageUrl, filename, e) => {
            if(e) e.stopPropagation();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = imageUrl;
            return new Promise((resolve) => {
                img.onload = () => {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const fontSize = Math.max(20, img.width * 0.03); 
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'bottom';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        const padding = fontSize;
                        ctx.fillText('Linkc', canvas.width - padding, canvas.height - padding);
                        const link = document.createElement('a');
                        link.download = `Linkc_${filename}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        resolve(true);
                    } catch (err) {
                        console.warn("Canvas Tainted", err);
                        downloadOriginal(imageUrl, filename);
                        resolve(false); 
                    }
                };
                img.onerror = () => {
                    downloadOriginal(imageUrl, filename);
                    resolve(false);
                };
            });
        };

        const copyToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—', err);
            }
            document.body.removeChild(textArea);
        };

        // -----------------------------------------------------------------------------
        // UI Components (Classic/Original Style)
        // -----------------------------------------------------------------------------

        const ConfigError = () => (
            <div className="error-container bg-gray-50">
                <div className="error-box">
                    <AlertTriangle className="mx-auto h-12 w-12 text-yellow-500 mb-4" />
                    <h3 className="error-title text-gray-900">å°šæœªè¨­å®š Firebase</h3>
                    <p className="text-gray-600 mb-4">è«‹ç·¨è¼¯ index.html ä¸¦å¡«å…¥æ‚¨çš„ Firebase Configã€‚</p>
                </div>
            </div>
        );

        const AuthError = ({ message }) => (
            <div className="error-container bg-gray-50">
                <div className="error-box border-red-200">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-500 mb-4" />
                    <h3 className="error-title text-gray-900">é€£ç·šå¤±æ•—</h3>
                    <p className="text-gray-800 font-mono text-xs bg-red-50 p-2 rounded mb-4 break-all">{message}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded">é‡æ–°æ•´ç†</button>
                </div>
            </div>
        );

        // Header: å›æ­¸ç™½è‰²åº•ã€é›è—è‰²é»ç¶´
        const Header = ({ setView, isAdmin, onLoginClick, onLogout, currentView }) => (
            <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-24 flex items-center justify-between">
                <div className="flex items-center gap-2">
                    {/* Logo é€£çµè‡³éƒ¨è½æ ¼ */}
                    <a href="https://2blog.ilc.edu.tw/linkc/" target="_blank" rel="noopener noreferrer" className="flex items-center hover:opacity-80 transition-opacity" title="å‰å¾€ Linkc Blog">
                        <img src="https://firebasestorage.googleapis.com/v0/b/linkcphoto.firebasestorage.app/o/photos%2Flinkc-w0.png?alt=media&token=63c9b589-aa78-480a-bed2-1c83634f4b9f" alt="Linkc Logo" className="h-20 w-auto mr-2" />
                    </a>
                    
                    <div className="flex items-center cursor-pointer gap-2" onClick={() => setView('gallery')}>
                        <h1 className="text-2xl font-bold text-gray-900 tracking-tight hidden sm:block">Linkc <span className="text-indigo-600 font-light">Gallery</span></h1>
                    </div>
                    
                    {isAdmin && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold ml-2">ADMIN</span>}
                </div>
                <div className="flex items-center gap-3">
                    <button 
                        onClick={() => setView('calendar')} 
                        className={`p-2 rounded-full transition-colors ${currentView === 'calendar' ? 'bg-indigo-100 text-indigo-600' : 'text-gray-500 hover:text-indigo-600 hover:bg-gray-100'}`}
                        title="æ—¥æ›†æ¨¡å¼"
                    >
                        <CalendarIcon size={20} />
                    </button>

                    {isAdmin ? (
                        <button onClick={onLogout} className="p-2 text-gray-500 hover:text-red-600 transition-colors" title="ç™»å‡º"><LogOut size={20} /></button>
                    ) : (
                        <button onClick={onLoginClick} className="p-2 text-gray-400 hover:text-indigo-600 transition-colors" title="ç™»å…¥"><Lock size={20} /></button>
                    )}
                    <button onClick={() => setView('upload')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full transition-all shadow-md hover:shadow-lg">
                        <Upload size={18} /><span className="hidden sm:inline">æ–°å¢ç…§ç‰‡</span>
                    </button>
                </div>
                </div>
            </header>
        );

        // CalendarView: ä½¿ç”¨ Indigo é…è‰²
        const CalendarView = ({ photos, onSelectDate, onExpand, isAdmin, onEdit, onDelete }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const photoSectionRef = useRef(null);

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay };
            };

            const { days, firstDay } = getDaysInMonth(currentDate);
            const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];

            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));

            const getFormattedDate = (day) => {
                const y = currentDate.getFullYear();
                const m = String(currentDate.getMonth() + 1).padStart(2, '0');
                const d = String(day).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            const getPhotosForDate = (dateStr) => {
                return photos.filter(p => {
                    const photoDate = p.exif?.date || p.date || '';
                    return photoDate.startsWith(dateStr);
                });
            };

            const handleDateClick = (dateStr) => {
                setSelectedDate(dateStr);
                setTimeout(() => { photoSectionRef.current?.scrollIntoView({ behavior: 'smooth' }); }, 100);
            };

            const selectedPhotos = selectedDate ? getPhotosForDate(selectedDate) : [];

            return (
                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">
                                {currentDate.getFullYear()}å¹´ {monthNames[currentDate.getMonth()]}
                            </h2>
                            <div className="flex gap-2">
                                <button onClick={prevMonth} className="p-2 hover:bg-gray-100 rounded-full"><ChevronLeft /></button>
                                <button onClick={nextMonth} className="p-2 hover:bg-gray-100 rounded-full"><ChevronRight /></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-7 gap-2 mb-2 text-center text-gray-400 font-medium text-sm">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {Array.from({ length: firstDay }).map((_, i) => (<div key={`empty-${i}`} className="h-24 sm:h-32"></div>))}
                            {Array.from({ length: days }).map((_, i) => {
                                const day = i + 1;
                                const dateStr = getFormattedDate(day);
                                const dayPhotos = getPhotosForDate(dateStr);
                                const count = dayPhotos.length;
                                const isToday = dateStr === new Date().toISOString().split('T')[0];
                                const isSelected = dateStr === selectedDate;
                                return (
                                    <div 
                                        key={day}
                                        onClick={() => count > 0 && handleDateClick(dateStr)}
                                        className={`h-24 sm:h-32 border rounded-lg p-2 flex flex-col justify-between transition-all relative group
                                            ${count > 0 
                                                ? 'cursor-pointer hover:bg-indigo-50 border-indigo-100 hover:border-indigo-300 hover:shadow-md' 
                                                : 'bg-gray-50 border-gray-100 text-gray-400'
                                            }
                                            ${isSelected ? 'ring-2 ring-indigo-500 ring-offset-2 bg-indigo-50 border-indigo-400' : ''}
                                            ${isToday ? 'ring-1 ring-offset-1 ring-gray-400' : ''}
                                        `}
                                    >
                                        <div className="flex justify-between items-start">
                                            <span className={`text-sm font-medium ${isToday ? 'text-indigo-600 bg-indigo-100 px-1.5 rounded-full' : ''}`}>{day}</span>
                                        </div>
                                        {count > 0 && (
                                            <div className="flex flex-col items-center gap-1 mb-1">
                                                <div className="flex justify-center gap-1 flex-wrap max-w-full">
                                                     {Array.from({ length: Math.min(count, 3) }).map((_, dotIdx) => (
                                                        <div key={dotIdx} className={`w-2 h-2 rounded-full ${isSelected ? 'bg-indigo-600' : 'bg-indigo-400'}`}></div>
                                                     ))}
                                                     {count > 3 && <span className="text-[10px] text-indigo-400 leading-none">+</span>}
                                                </div>
                                                <span className="text-[10px] text-gray-400">{count} å¼µ</span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {selectedDate && selectedPhotos.length > 0 && (
                        <div ref={photoSectionRef} className="bg-gray-50 border-t-4 border-indigo-500 rounded-xl p-6 shadow-inner animate-fade-in">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <CalendarIcon className="text-indigo-600"/>
                                    {selectedDate} çš„ç…§ç‰‡ ({selectedPhotos.length} å¼µ)
                                </h3>
                                <button onClick={() => setSelectedDate(null)} className="p-2 hover:bg-gray-200 rounded-full text-gray-500"><XCircle size={24} /></button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {selectedPhotos.map(photo => (
                                    <PhotoCard key={photo.id} photo={photo} onExpand={onExpand} isAdmin={isAdmin} onEdit={onEdit} onDelete={onDelete} />
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ShareButtons = ({ photo }) => {
            const shareText = `${photo.thoughts_shooting || 'åˆ†äº«ä¸€å¼µç…§ç‰‡'} \n\n#Linkc ${photo.tags.map(t=>'#'+t).join(' ')}`;
            const handleIG = async (e) => { e.stopPropagation(); copyToClipboard(shareText); await downloadWithWatermark(photo.url, photo.id, e); };
            const handleObsidian = (e) => { e.stopPropagation(); const altText = photo.tags.length > 0 ? photo.tags.join(', ') : 'Linkc Photo'; const markdown = `![${altText}](${photo.url})`; copyToClipboard(markdown); alert("å·²è¤‡è£½ Obsidian èªæ³•ï¼"); };
            return (
                <div className="flex items-center gap-2">
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(photo.url)}`, '_blank')}} className="bg-[#1877f2] text-white p-2 rounded-full hover:scale-110 transition-transform"><Facebook size={18} /></button>
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(photo.url)}`, '_blank')}} className="bg-[#06c755] text-white p-2 rounded-full hover:scale-110 transition-transform"><MessageCircle size={18} /></button>
                    <button onClick={handleIG} className="bg-gradient-to-tr from-[#f09433] via-[#dc2743] to-[#bc1888] text-white p-2 rounded-full hover:scale-110 transition-transform"><Instagram size={18} /></button>
                    <button onClick={handleObsidian} className="bg-purple-600 text-white p-2 rounded-full hover:scale-110 transition-transform"><FileCode size={18} /></button>
                </div>
            );
        };

        // Lightbox: é»‘åº•ç™½å­—
        const Lightbox = ({ photo, onClose, isAdmin, onEdit, onDelete }) => {
            if (!photo) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white p-2 z-50"><X size={32} /></button>
                    {isAdmin && (
                        <div className="absolute top-4 left-4 flex gap-2 z-50">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-600/80 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm"><Edit size={14} /> ç·¨è¼¯</button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); onClose(); }} className="bg-red-600/80 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm"><Trash2 size={14} /> åˆªé™¤</button>
                        </div>
                    )}
                    <div className="relative max-w-full max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <img src={photo.url} className="max-w-full max-h-[85vh] object-contain shadow-2xl rounded-sm" />
                        <div className="absolute -bottom-16 left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-white/10 backdrop-blur-md px-6 py-3 rounded-full border border-white/10">
                            <button onClick={(e) => downloadWithWatermark(photo.url, photo.id, e)} className="text-white hover:text-indigo-300 flex flex-col items-center gap-1"><Download size={20} /><span className="text-[10px]">ä¸‹è¼‰</span></button>
                            <div className="w-px h-8 bg-white/20 mx-2"></div>
                            <ShareButtons photo={photo} />
                        </div>
                    </div>
                    <div className="mt-4 text-white/80 text-center" onClick={(e) => e.stopPropagation()}>
                        <div className="flex items-center justify-center gap-4 text-sm font-medium mb-1">
                            <span className="flex items-center gap-1"><Clock size={14}/> {photo.date ? photo.date.replace('T', ' ') : ''}</span>
                            <span className="flex items-center gap-1"><MapPin size={14}/> {photo.location.city}</span>
                        </div>
                        {(photo.exif.camera || photo.exif.lens) && (
                            <div className="flex items-center justify-center gap-3 text-xs text-white/70 mb-1">
                                {photo.exif.camera && <span className="flex items-center gap-1"><Camera size={12}/> {photo.exif.camera}</span>}
                                {photo.exif.lens && <span className="flex items-center gap-1"><Disc size={12}/> {photo.exif.lens}</span>}
                            </div>
                        )}
                        <p className="text-white/60 text-xs font-mono">
                            {photo.exif.shutter} Â· {photo.exif.aperture} Â· ISO {photo.exif.iso} {photo.exif.focalLength ? `Â· ${photo.exif.focalLength}` : ''} {photo.exif.ev ? `Â· EV ${photo.exif.ev}` : ''}
                        </p>
                    </div>
                </div>
            );
        };

        // PhotoCard: æ¢å¾© Indigo/Gray é¢¨æ ¼
        const PhotoCard = ({ photo, onExpand, isAdmin, onEdit, onDelete }) => (
            <div className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 group flex flex-col h-full border border-gray-100 relative">
                {isAdmin && (
                    <div className="absolute top-2 left-2 z-20 flex gap-2">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600"><Edit size={14} /></button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); }} className="bg-red-500 text-white p-2 rounded-full shadow-md hover:bg-red-600"><Trash2 size={14} /></button>
                    </div>
                )}
                <div className="relative aspect-[4/3] overflow-hidden bg-gray-100 cursor-zoom-in" onClick={() => onExpand(photo)}>
                    <img src={photo.url} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                    <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-2 z-10"><ShareButtons photo={photo} /></div>
                    <div className="absolute bottom-3 left-3 pointer-events-none">
                        <span className="bg-black/60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-md flex items-center gap-1">
                            <Clock size={12} /> {photo.date ? photo.date.replace('T', ' ') : ''}
                        </span>
                    </div>
                </div>
                
                <div className="p-5 flex flex-col flex-grow">
                    <div className="flex items-center text-gray-500 text-sm mb-3">
                        <MapPin size={14} className="mr-1 text-indigo-500" />
                        {photo.location.country} Â· {photo.location.city} {photo.location.spot && `Â· ${photo.location.spot}`}
                    </div>

                    <div className="flex flex-wrap gap-2 mb-4">
                        {photo.tags.map(tag => (
                            <span key={tag} className="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs rounded-full font-medium">#{tag}</span>
                        ))}
                    </div>

                    <div className="space-y-3 mb-4 flex-grow">
                        {photo.thoughts_shooting && (
                            <div className="bg-gray-50 p-3 rounded-lg border-l-2 border-orange-300">
                                <div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1">
                                    <Camera size={12} /> æ‹æ”ç•¶ä¸‹
                                </div>
                                <p className="text-gray-700 text-sm italic">"{photo.thoughts_shooting}"</p>
                            </div>
                        )}
                        {photo.thoughts_viewing && (
                            <div className="bg-gray-50 p-3 rounded-lg border-l-2 border-indigo-300">
                                <div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1">
                                    <Eye size={12} /> æ¬£è³éš¨ç­†
                                </div>
                                <p className="text-gray-700 text-sm italic">"{photo.thoughts_viewing}"</p>
                            </div>
                        )}
                    </div>

                    {(photo.exif.camera || photo.exif.lens) && (
                        <div className="flex flex-col gap-1 mb-3 text-xs text-gray-600 bg-gray-50 p-2 rounded-lg border border-gray-100">
                            {photo.exif.camera && <div className="flex items-center gap-1 font-medium"><Camera size={12} className="text-gray-400"/> {photo.exif.camera}</div>}
                            {photo.exif.lens && <div className="flex items-center gap-1 text-gray-500"><Disc size={12} className="text-gray-400"/> {photo.exif.lens}</div>}
                        </div>
                    )}

                    <div className="grid grid-cols-4 gap-1 border-t pt-3 mt-auto text-center">
                        <div className="flex flex-col items-center"><span className="text-[10px] uppercase text-gray-400 font-bold">å¿«é–€</span><span className="text-xs text-gray-700 font-mono">{photo.exif.shutter || '--'}</span></div>
                        <div className="flex flex-col items-center border-l border-gray-100"><span className="text-[10px] uppercase text-gray-400 font-bold">å…‰åœˆ</span><span className="text-xs text-gray-700 font-mono">{photo.exif.aperture || '--'}</span></div>
                        <div className="flex flex-col items-center border-l border-gray-100"><span className="text-[10px] uppercase text-gray-400 font-bold">ISO</span><span className="text-xs text-gray-700 font-mono">{photo.exif.iso || '--'}</span></div>
                        <div className="flex flex-col items-center border-l border-gray-100"><span className="text-[10px] uppercase text-gray-400 font-bold">EV</span><span className="text-xs text-gray-700 font-mono">{photo.exif.ev || '--'}</span></div>
                    </div>
                    
                    <div className="border-t border-dashed border-gray-200 mt-3 pt-2 flex justify-between items-center">
                        <span className="text-[10px] text-gray-400">CC BY 4.0 å§“åæ¨™ç¤º</span>
                        <span className="text-[10px] font-bold text-gray-300 select-none">Linkc</span>
                    </div>
                </div>
            </div>
        );

        // PhotoForm: æ¢å¾© Indigo/Gray é¢¨æ ¼
        const PhotoForm = ({ onSave, onCancel, initialData, isSaving }) => {
            const isEditMode = !!initialData;
            const getNowString = () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); return now.toISOString().slice(0, 16); };
            const [formData, setFormData] = useState(initialData || { url: '', tags: '', thoughts_shooting: '', thoughts_viewing: '', exif: { shutter: '', aperture: 'f/', iso: '', date: getNowString(), camera: '', lens: '', focalLength: '', ev: '' }, location: { country: '', city: '', spot: '' } });
            const [status, setStatus] = useState('');
            const [uploadFile, setUploadFile] = useState(null);
            const [exifStatus, setExifStatus] = useState(''); 

            useEffect(() => { if (initialData && Array.isArray(initialData.tags)) { setFormData(prev => ({ ...prev, tags: initialData.tags.join(', ') })); } }, [initialData]);
            const handleChange = (section, field, value) => { if (section) { setFormData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } })); } else { setFormData(prev => ({ ...prev, [field]: value })); } };
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadFile(file);
                    setExifStatus('åˆ†æä¸­...');
                    const previewUrl = URL.createObjectURL(file);
                    setFormData(prev => ({ ...prev, url: previewUrl }));
                    
                    EXIF.getData(file, async function() {
                        const extractedShutter = EXIF.getTag(this, "ExposureTime");
                        const extractedFNumber = EXIF.getTag(this, "FNumber");
                        const extractedISO = EXIF.getTag(this, "ISOSpeedRatings");
                        const extractedDate = EXIF.getTag(this, "DateTimeOriginal");
                        const extractedFocalLength = EXIF.getTag(this, "FocalLength");
                        const extractedBias = EXIF.getTag(this, "ExposureBiasValue");
                        const make = EXIF.getTag(this, "Make");
                        const model = EXIF.getTag(this, "Model");
                        const allTags = EXIF.getAllTags(this);
                        
                        let lensModel = findLensNameInAllTags(allTags);
                        if (lensModel && typeof lensModel === 'string') {
                            lensModel = lensModel.replace(/\0/g, '').trim();
                            const lensMake = EXIF.getTag(this, "LensMake");
                            if (lensMake && !lensModel.toLowerCase().includes(lensMake.toLowerCase())) lensModel = `${lensMake} ${lensModel}`;
                        }

                        const lat = EXIF.getTag(this, "GPSLatitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                        const lon = EXIF.getTag(this, "GPSLongitude");
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

                        let formattedShutter = "";
                        const shutterVal = getExifValue(extractedShutter);
                        if (shutterVal > 0) formattedShutter = shutterVal < 1 ? "1/" + Math.round(1/shutterVal) : shutterVal.toString();
                        
                        const apertureVal = getExifValue(extractedFNumber);
                        const formattedAperture = apertureVal ? "f/" + apertureVal : "";
                        
                        const formattedEV = formatExposureBias(extractedBias);

                        let formattedDate = "";
                        if (extractedDate) {
                            const parts = extractedDate.split(" ");
                            if (parts.length >= 2) formattedDate = `${parts[0].replace(/:/g, "-")}T${parts[1].substring(0, 5)}`;
                            else if (parts.length === 1) formattedDate = parts[0].replace(/:/g, "-");
                        }

                        let formattedCamera = "";
                        if (make && model) formattedCamera = model.toLowerCase().includes(make.toLowerCase()) ? model : `${make} ${model}`;
                        else formattedCamera = model || make || "";
                        if (formattedCamera) formattedCamera = formattedCamera.replace(/\0/g, '').trim();

                        let formattedFocalLength = "";
                        const focalVal = getExifValue(extractedFocalLength);
                        if (focalVal) formattedFocalLength = `${focalVal}mm`;

                        let locationUpdate = { ...formData.location };
                        let extraStatus = "";

                        if (lat && lon) {
                            const decimalLat = convertDMSToDD(lat, latRef || 'N');
                            const decimalLon = convertDMSToDD(lon, lonRef || 'E');
                            if (decimalLat && decimalLon) {
                                setExifStatus('æ­£åœ¨è§£æ GPS åœ°å€...');
                                const address = await reverseGeocode(decimalLat, decimalLon);
                                if (address) {
                                    locationUpdate = {
                                        country: address.country || "",
                                        city: address.city || address.county || address.town || address.state || "",
                                        spot: address.suburb || address.village || address.road || address.pedestrian || ""
                                    };
                                    extraStatus = " + GPS ğŸ“";
                                } else { extraStatus = " (GPS è§£æå¤±æ•—)"; }
                            }
                        }
                        setFormData(prev => ({
                            ...prev,
                            exif: {
                                shutter: formattedShutter || prev.exif.shutter,
                                aperture: formattedAperture || prev.exif.aperture,
                                iso: extractedISO ? extractedISO.toString() : prev.exif.iso,
                                date: formattedDate || prev.exif.date,
                                camera: formattedCamera || prev.exif.camera,
                                lens: lensModel || prev.exif.lens,
                                focalLength: formattedFocalLength || prev.exif.focalLength,
                                ev: formattedEV || prev.exif.ev
                            },
                            location: locationUpdate
                        }));
                        setExifStatus(`EXIF è®€å–å®Œæˆ${extraStatus} âœ¨`);
                    });
                }
            };

            const handleSubmit = async (e) => { 
                e.preventDefault();
                setStatus('uploading');
                let finalUrl = formData.url;
                try {
                    if (uploadFile) {
                        const filename = `photos/${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${uploadFile.name}`;
                        const storageRef = ref(storage, filename);
                        await uploadBytes(storageRef, uploadFile);
                        finalUrl = await getDownloadURL(storageRef);
                    }
                    const processedData = { ...formData, url: finalUrl, tags: formData.tags.split(',').map(t => t.trim()).filter(t => t), date: formData.exif.date }; 
                    onSave(processedData); 
                } catch (err) {
                    console.error("ä¸Šå‚³å¤±æ•—", err);
                    alert("ä¸Šå‚³å¤±æ•—: " + err.message);
                    setStatus('');
                }
            };

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 animate-fade-in my-8 border border-gray-100">
                    <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">{isEditMode ? <Edit className="text-blue-600" /> : <Upload className="text-indigo-600" />} {isEditMode ? 'ä¿®æ”¹ç…§ç‰‡è³‡è¨Š' : 'åˆ†äº«æ–°ç…§ç‰‡'}</h2><button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><X size={24} /></button></div>
                    {status === 'uploading' && (<div className="mb-4 bg-blue-50 text-blue-700 p-4 rounded-lg flex items-center gap-2 animate-pulse"><RefreshCw className="spinner" size={20} /><span>æ­£åœ¨ä¸Šå‚³ç…§ç‰‡è‡³é›²ç«¯ï¼Œè«‹ç¨å€™...</span></div>)}
                    <form onSubmit={handleSubmit} className="space-y-8">
                        {formData.url && (<div className="flex justify-center mb-6 bg-gray-100 rounded-lg p-4 border border-gray-200"><img src={formData.url} alt="Preview" className="max-h-80 w-auto object-contain rounded shadow-sm" referrerPolicy="no-referrer" onError={(e) => e.target.style.display = 'none'} /></div>)}
                        <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200"><label className="block text-sm font-bold text-gray-700 mb-2">æ­¥é©Ÿ 1ï¼šé¸æ“‡ç…§ç‰‡ä¾†æº</label><div className="relative"><input type="file" accept="image/*" onChange={handleFileChange} className="hidden" id="file-upload" disabled={status === 'uploading'} /><label htmlFor="file-upload" className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer hover:bg-gray-100 transition-colors ${uploadFile ? 'border-green-500 bg-green-50' : 'border-gray-300'}`}>{uploadFile ? (<><Check className="w-8 h-8 text-green-500 mb-2" /><span className="text-sm font-medium text-green-600">å·²é¸æ“‡ï¼š{uploadFile.name}</span>{exifStatus && <span className="text-xs text-blue-500 mt-1 flex items-center gap-1"><Sparkles size={10}/> {exifStatus}</span>}</>) : (<><FileUp className="w-8 h-8 text-gray-400 mb-2" /><span className="text-sm font-medium text-gray-600">é»æ“Šä¸Šå‚³æª”æ¡ˆ (æ¨è–¦)</span><span className="text-xs text-gray-500 mt-1">è‡ªå‹•è®€å– EXIFã€GPSã€ç›¸æ©Ÿèˆ‡é¡é ­è³‡è¨Šï¼Œæ°¸ä¹…ä¿å­˜</span></>)}</label></div><div className="text-center text-gray-400 text-xs">- æˆ– -</div><div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><LinkIcon className="h-4 w-4 text-gray-400" /></div><input type="url" placeholder="è¼¸å…¥åœ–ç‰‡é€£çµ (ä¸æ¨è–¦)" className="block w-full pl-9 border-gray-300 rounded-lg p-2 text-sm border" value={formData.url} onChange={(e) => { handleChange(null, 'url', e.target.value); setUploadFile(null); setExifStatus(''); }} disabled={uploadFile || status === 'uploading'} /></div></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8"><div className="space-y-6"><div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ¨™ç±¤ (Tags)</label><input type="text" placeholder="é¢¨æ™¯, å°ç£" className="block w-full border-gray-300 rounded-lg p-2.5 border" value={formData.tags} onChange={(e) => handleChange(null, 'tags', e.target.value)} /></div><div className="bg-orange-50 p-4 rounded-lg border border-orange-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ‹æ”æ„Ÿå—</label><textarea rows="3" placeholder="..." className="block w-full border-gray-300 rounded-lg p-2.5 border resize-none" value={formData.thoughts_shooting} onChange={(e) => handleChange(null, 'thoughts_shooting', e.target.value)} /></div><div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ¬£è³æ„Ÿå—</label><textarea rows="3" placeholder="..." className="block w-full border-gray-300 rounded-lg p-2.5 border resize-none" value={formData.thoughts_viewing} onChange={(e) => handleChange(null, 'thoughts_viewing', e.target.value)} /></div></div><div className="space-y-6 bg-gray-50 p-6 rounded-xl border border-gray-200"><h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-2">æ‹æ”åƒæ•¸ {exifStatus && <span className="text-xs text-green-500 font-normal normal-case">({exifStatus})</span>}</h3><div className="grid grid-cols-1 gap-4 mb-4"><div><label className="block text-xs font-medium text-gray-500">ç›¸æ©Ÿå‹è™Ÿ</label><input type="text" placeholder="ä¾‹å¦‚ï¼šSony A7III" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.camera} onChange={(e) => handleChange('exif', 'camera', e.target.value)} /></div><div><label className="block text-xs font-medium text-gray-500">é¡é ­è³‡è¨Š</label><input type="text" placeholder="ä¾‹å¦‚ï¼šFE 24-105mm F4 G" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.lens} onChange={(e) => handleChange('exif', 'lens', e.target.value)} /></div></div><div className="grid grid-cols-2 gap-4 border-t pt-4"><div><label className="block text-xs font-medium text-gray-500">å¿«é–€</label><input type="text" placeholder="1/200" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.shutter} onChange={(e) => handleChange('exif', 'shutter', e.target.value)} /></div><div><label className="block text-xs font-medium text-gray-500">å…‰åœˆ</label><input type="text" placeholder="f/2.8" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.aperture} onChange={(e) => handleChange('exif', 'aperture', e.target.value)} /></div><div><label className="block text-xs font-medium text-gray-500">ISO</label><input type="text" placeholder="400" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.iso} onChange={(e) => handleChange('exif', 'iso', e.target.value)} /></div><div><label className="block text-xs font-medium text-gray-500">ç„¦æ®µ</label><input type="text" placeholder="50mm" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.focalLength} onChange={(e) => handleChange('exif', 'focalLength', e.target.value)} /></div><div><label className="block text-xs font-medium text-gray-500">EV æ›å…‰è£œå„Ÿ</label><input type="text" placeholder="+0" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.ev} onChange={(e) => handleChange('exif', 'ev', e.target.value)} /></div><div><label className="block text-xs font-medium text-gray-500">æ—¥æœŸèˆ‡æ™‚é–“</label><input type="datetime-local" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.date} onChange={(e) => handleChange('exif', 'date', e.target.value)} /></div></div><div className="grid grid-cols-2 gap-4 mt-4 pt-4 border-t"><div><label className="block text-xs font-medium text-gray-500">åœ‹å®¶ {formData.location.country && <MapIcon size={12} className="inline text-green-500"/>}</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.country} onChange={(e) => handleChange('location', 'country', e.target.value)} /></div><div><label className="block text-xs font-medium text-gray-500">åŸå¸‚</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.city} onChange={(e) => handleChange('location', 'city', e.target.value)} /></div><div className="col-span-2"><label className="block text-xs font-medium text-gray-500">åœ°å/æ™¯é»</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.spot} onChange={(e) => handleChange('location', 'spot', e.target.value)} /></div></div></div></div>
                        <div className="flex justify-end gap-3 pt-6 border-t border-gray-100"><button type="button" onClick={onCancel} disabled={isSaving || status === 'uploading'} className="px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">å–æ¶ˆ</button><button type="submit" disabled={isSaving || status === 'uploading'} className={`px-6 py-2 border border-transparent rounded-lg text-sm font-medium text-white shadow-lg hover:shadow-xl transition-all flex items-center gap-2 ${isEditMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-indigo-600 hover:bg-indigo-700'} disabled:opacity-50`}>{(isSaving || status === 'uploading') && <RefreshCw className="animate-spin" size={16} />} {status === 'uploading' ? 'ä¸Šå‚³ä¸­...' : (isEditMode ? 'å„²å­˜ä¿®æ”¹' : 'ç™¼ä½ˆç…§ç‰‡')}</button></div>
                    </form>
                </div>
            );
        };

        const AdminLogin = ({ onLogin, onCancel }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (password === '590123') onLogin(); else setPassword(''); };
            return (
                <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full"><h3 className="text-lg font-bold text-center mb-4">ç®¡ç†å“¡ç™»å…¥</h3><form onSubmit={handleSubmit} className="space-y-4"><input type="password" placeholder="å¯†ç¢¼" className="w-full text-center border p-2 rounded" value={password} onChange={(e) => setPassword(e.target.value)} autoFocus /><div className="flex gap-2"><button type="button" onClick={onCancel} className="flex-1 bg-gray-200 py-2 rounded">å–æ¶ˆ</button><button type="submit" className="flex-1 bg-indigo-600 text-white py-2 rounded">è§£é–</button></div></form></div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('gallery');
            const [photos, setPhotos] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState(null);
            const [sortOrder, setSortOrder] = useState('newest'); 
            const [dateFilter, setDateFilter] = useState(null); 
            
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [editingPhoto, setEditingPhoto] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [authError, setAuthError] = useState(null);
            const [isTagsExpanded, setIsTagsExpanded] = useState(false);

            useEffect(() => {
                if (!isConfigConfigured) return; 
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (err) { setAuthError(err.message); } };
                initAuth();
                onAuthStateChanged(auth, (user) => { setCurrentUser(user); if(user) setAuthError(null); });
            }, []);

            useEffect(() => {
                if (!currentUser || !db) return;
                const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => { setPhotos(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            }, [currentUser]);

            const handleSavePhoto = async (photoData) => {
                if (!currentUser) return;
                setIsSaving(true);
                try {
                    const collectionRef = collection(db, COLLECTION_NAME);
                    if (editingPhoto) {
                        await updateDoc(doc(collectionRef, photoData.id), { ...photoData });
                        setEditingPhoto(null);
                    } else {
                        await addDoc(collectionRef, { ...photoData, timestamp: Date.now() });
                    }
                    setView('gallery');
                    setDateFilter(null); 
                } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); } finally { setIsSaving(false); }
            };

            const handleDeletePhoto = async (id) => {
                if (!currentUser) return;
                if(window.confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ï¼Ÿ')) {
                    try { await deleteDoc(doc(db, COLLECTION_NAME, id)); } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
                }
            };

            const startEdit = (photo) => { setEditingPhoto(photo); setView('upload'); if (selectedPhoto) setSelectedPhoto(null); };

            if (!isConfigConfigured) return <ConfigError />;
            if (authError) return <AuthError message={authError} />;

            const allTags = [...new Set(photos.flatMap(p => p.tags))];
            
            // Tag Frequency Sort
            const tagCounts = photos.flatMap(p => p.tags).reduce((acc, tag) => {
                acc[tag] = (acc[tag] || 0) + 1;
                return acc;
            }, {});
            const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]); 
            const visibleTags = isTagsExpanded ? sortedTags : sortedTags.slice(0, 10);
            const hasMoreTags = sortedTags.length > 10;

            // Advanced Search & Filter Logic with Boolean Operators
            const filteredPhotos = photos.filter(photo => {
                // 0. Date Filter
                if (dateFilter) {
                    const photoDate = photo.exif?.date || photo.date || '';
                    return photoDate.startsWith(dateFilter);
                }
                
                // 1. Tag Filter
                if (activeTag && !(photo.tags || []).includes(activeTag)) return false;
                
                // 2. Search Query with Boolean Operators
                if (!searchQuery.trim()) return true;

                // Construct a searchable string from relevant fields only
                const searchableText = [
                    ...(photo.tags || []),
                    photo.thoughts_shooting,
                    photo.thoughts_viewing,
                    photo.location?.country,
                    photo.location?.city,
                    photo.location?.spot,
                    photo.exif?.camera,
                    photo.exif?.lens,
                    photo.exif?.shutter,
                    photo.exif?.aperture,
                    photo.exif?.iso,
                    photo.exif?.focalLength,
                    photo.exif?.ev,
                    photo.exif?.date
                ].filter(Boolean).join(' ').toLowerCase();

                const query = searchQuery.toLowerCase();
                const tokens = query.split(/\s+/);
                
                let isMatch = true;
                let operator = 'AND'; // 'AND' or 'OR'
                let firstToken = true;

                for (let i = 0; i < tokens.length; i++) {
                    const token = tokens[i];
                    
                    if (token === 'or' || token === '|') {
                        operator = 'OR';
                        continue;
                    }
                    if (token === 'and' || token === '&') {
                        operator = 'AND';
                        continue;
                    }

                    let isNot = false;
                    let term = token;
                    
                    if (term.startsWith('-') && term.length > 1) {
                        isNot = true;
                        term = term.substring(1);
                    }

                    const match = searchableText.includes(term);
                    const conditionMet = isNot ? !match : match;

                    if (firstToken) {
                        isMatch = conditionMet;
                        firstToken = false;
                    } else {
                        if (operator === 'OR') {
                            isMatch = isMatch || conditionMet;
                            operator = 'AND'; // Reset
                        } else {
                            isMatch = isMatch && conditionMet;
                        }
                    }
                }
                return isMatch;
            });

            const sortedPhotos = [...filteredPhotos].sort((a, b) => {
                if (sortOrder === 'newest') {
                    const dateA = a.exif?.date || a.timestamp;
                    const dateB = b.exif?.date || b.timestamp;
                    if (dateA < dateB) return 1;
                    if (dateA > dateB) return -1;
                    return 0;
                } else {
                    const dateA = a.exif?.date || a.timestamp;
                    const dateB = b.exif?.date || b.timestamp;
                    if (dateA > dateB) return 1;
                    if (dateA < dateB) return -1;
                    return 0;
                }
            });

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                <Header setView={(v) => { setView(v); setEditingPhoto(null); setDateFilter(null); }} isAdmin={isAdmin} onLoginClick={() => setShowLogin(true)} onLogout={() => { setIsAdmin(false); alert("å·²ç™»å‡º"); }} currentView={view} />
                
                {showLogin && (<AdminLogin onLogin={() => { setIsAdmin(true); setShowLogin(false); }} onCancel={() => setShowLogin(false)} />)}
                
                {selectedPhoto && (<Lightbox photo={selectedPhoto} onClose={() => setSelectedPhoto(null)} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />)}

                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    {view === 'calendar' ? (
                        <CalendarView 
                            photos={photos} 
                            onSelectDate={(d) => { setDateFilter(d); setView('gallery'); }} 
                            onExpand={setSelectedPhoto}
                            isAdmin={isAdmin}
                            onEdit={startEdit}
                            onDelete={handleDeletePhoto}
                        />
                    ) : view === 'gallery' ? (
                    <>
                        {dateFilter && (
                            <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4 flex justify-between items-center animate-in slide-in-from-top-2">
                                <span className="text-indigo-700 font-medium flex items-center gap-2">
                                    <CalendarIcon size={18} />
                                    æ­£åœ¨æª¢è¦– {dateFilter} çš„ç…§ç‰‡ ({filteredPhotos.length} å¼µ)
                                </span>
                                <button onClick={() => setDateFilter(null)} className="text-indigo-600 hover:text-indigo-800 text-sm font-bold flex items-center gap-1"><XCircle size={16} /> æ¸…é™¤ç¯©é¸</button>
                            </div>
                        )}

                        <div className="flex flex-col gap-4 mb-8">
                            <div className="flex flex-col md:flex-row gap-4">
                                <div className="relative flex-grow">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Search className="h-5 w-5 text-gray-400" /></div>
                                    <input 
                                        type="text" 
                                        placeholder="æœå°‹... (æ”¯æ´: å°åŒ— å®œè˜­ OR èŠ±è“® -å¤œæ™¯ #é¢¨æ™¯)" 
                                        className="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm" 
                                        value={searchQuery} 
                                        onChange={(e) => setSearchQuery(e.target.value)} 
                                        disabled={!!dateFilter} 
                                    />
                                    <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><Filter className="h-4 w-4 text-gray-300" /></div>
                                </div>
                                <button onClick={() => setSortOrder(prev => prev === 'newest' ? 'oldest' : 'newest')} className="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50 shadow-sm min-w-[140px] transition-all">
                                    {sortOrder === 'newest' ? <ArrowDownWideNarrow size={18} /> : <ArrowUpNarrowWide size={18} />}
                                    <span>{sortOrder === 'newest' ? 'æœ€æ–°åœ¨ä¸Š' : 'æœ€èˆŠåœ¨ä¸Š'}</span>
                                </button>
                            </div>
                            <div className="flex flex-wrap gap-2 items-center">
                                <span className="text-sm font-bold text-gray-400 mr-2 flex items-center gap-1"><Tag size={14} /> åˆ†é¡:</span>
                                <button onClick={() => setActiveTag(null)} className={`px-3 py-1 rounded-full text-sm transition-colors ${!activeTag ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-200'}`}>å…¨éƒ¨</button>
                                {visibleTags.map(tag => (
                                    <button 
                                        key={tag} 
                                        onClick={() => setActiveTag(tag === activeTag ? null : tag)} 
                                        className={`px-3 py-1 rounded-full text-sm transition-colors ${tag === activeTag ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-indigo-50 hover:border-indigo-200'}`}
                                    >
                                        {tag}
                                    </button>
                                ))}
                                {hasMoreTags && (
                                    <button onClick={() => setIsTagsExpanded(!isTagsExpanded)} className="text-xs text-gray-400 hover:text-gray-600 ml-2" title={isTagsExpanded ? "æ”¶åˆ" : "å±•é–‹"}>
                                        {isTagsExpanded ? 'æ”¶åˆ' : <MoreHorizontal size={16} />}
                                    </button>
                                )}
                            </div>
                        </div>

                        {sortedPhotos.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">{sortedPhotos.map(photo => (<PhotoCard key={photo.id} photo={photo} onExpand={setSelectedPhoto} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />))}</div>
                        ) : (
                        <div className="text-center py-20 bg-white rounded-xl shadow-sm border border-dashed border-gray-300"><Cloud className="mx-auto h-12 w-12 text-gray-300 mb-3" /><h3 className="text-lg font-medium text-gray-900">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç…§ç‰‡</h3><button onClick={() => setView('upload')} className="mt-4 text-indigo-600 hover:text-indigo-800 font-medium">ä¸Šå‚³ç¬¬ä¸€å¼µç…§ç‰‡ &rarr;</button></div>
                        )}
                    </>
                    ) : (
                    <PhotoForm onSave={handleSavePhoto} onCancel={() => { setView('gallery'); setEditingPhoto(null); }} initialData={editingPhoto} isSaving={isSaving} />
                    )}
                </main>
                <footer className="bg-white border-t border-gray-200 mt-12 py-8"><div className="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm"><p>Â© {new Date().getFullYear()} Linkc Photo Space.</p><p className="mt-1">Content Creative Commons Attribution (CC BY).</p></div></footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
