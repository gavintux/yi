<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linkc Photo Space</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Exif-js -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <!-- 4. CSS -->
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #f9fafb; }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: #4f46e5; font-weight: bold; }
        .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; color: #374151; }
        .error-box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 500px; width: 100%; border: 1px solid #e5e7eb; }
        .error-title { color: #dc2626; font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
        .error-list { text-align: left; list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; }
        
        /* è¼‰å…¥å‹•ç•« */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">æ­£åœ¨å•Ÿå‹• Linkc Photo Space...</div>
    </div>

    <!-- 5. React App -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Camera, MapPin, Clock, Search, Upload, Download, Tag, Eye, X, 
            Image as ImageIcon, Maximize2, Share2, Facebook, Instagram, 
            MessageCircle, Copy, Check, Lock, Unlock, Edit, Trash2, LogOut, 
            Cloud, RefreshCw, AlertTriangle, Info, Save, Link as LinkIcon, FileUp, Sparkles, Map as MapIcon, Aperture, Disc,
            ArrowDownWideNarrow, ArrowUpNarrowWide, Filter
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // -----------------------------------------------------------------------------
        // è¨­å®šå€
        // -----------------------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyDwXsplXePeD1wU1GG4BwQBR6iSMd3_5nY",
            authDomain: "linkcphoto.firebaseapp.com",
            projectId: "linkcphoto",
            storageBucket: "linkcphoto.firebasestorage.app",
            messagingSenderId: "841541302440",
            appId: "1:841541302440:web:a2b3dfef70a32bb345ea9d",
            measurementId: "G-902H2EHVFF"
        };

        const isConfigConfigured = !firebaseConfig.apiKey.includes("æ‚¨çš„API_KEY");

        let app, auth, db, storage;
        if (isConfigConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e);
            }
        }

        const COLLECTION_NAME = 'linkc_photos_v1';

        // -----------------------------------------------------------------------------
        // Helper Functions (å¼·åŠ›è§£æç‰ˆ)
        // -----------------------------------------------------------------------------

        // æš´åŠ›æœç´¢æ‰€æœ‰æ¨™ç±¤ä¾†æ‰¾é¡é ­åç¨±
        const findLensNameInAllTags = (allTags) => {
            // 1. å„ªå…ˆæª¢æŸ¥æ¨™æº–æ¨™ç±¤
            if (allTags.LensModel && typeof allTags.LensModel === 'string' && allTags.LensModel.trim() !== '') return allTags.LensModel;
            if (allTags.Lens && typeof allTags.Lens === 'string' && allTags.Lens.trim() !== '') return allTags.Lens;
            if (allTags.LensID && typeof allTags.LensID === 'string' && allTags.LensID.trim() !== '') return allTags.LensID;

            // 2. æœå°‹ä»»ä½•åŒ…å« "Lens" ä¸”å€¼ç‚ºå­—ä¸²çš„æ¨™ç±¤ (æ’é™¤ LensInfo æ•¸å€¼)
            for (const key in allTags) {
                const val = allTags[key];
                if (key.includes("Lens") && typeof val === 'string' && val.length > 2) {
                    // æ’é™¤ä¸€äº›ç„¡æ•ˆå­—ä¸²
                    if (val.toLowerCase().includes("unknown")) continue;
                    return val;
                }
            }

            // 3. æœ€å¾Œå˜—è©¦è§£æ LensInfo (æ•¸å€¼è¦æ ¼)
            if (allTags.LensInfo) {
                return parseLensInfo(allTags.LensInfo);
            }

            return "";
        };

        const parseLensInfo = (lensInfo) => {
            if (!lensInfo || lensInfo.length < 2) return null;
            
            // è™•ç†ä¸åŒçš„ LensInfo æ ¼å¼
            const minFocal = lensInfo[0] ? Number(lensInfo[0]) : 0;
            const maxFocal = lensInfo[1] ? Number(lensInfo[1]) : 0;
            const minF = lensInfo[2] ? Number(lensInfo[2]) : 0;
            const maxF = lensInfo[3] ? Number(lensInfo[3]) : 0;

            if (minFocal === 0) return null;

            let focalStr = "";
            if (minFocal === maxFocal) {
                focalStr = `${minFocal}mm`;
            } else {
                focalStr = `${minFocal}-${maxFocal}mm`;
            }

            let apertureStr = "";
            if (minF > 0) {
                if (minF === maxF || maxF === 0) {
                    apertureStr = `f/${minF}`;
                } else {
                    apertureStr = `f/${minF}-${maxF}`;
                }
            }

            return `${focalStr} ${apertureStr}`;
        };

        const convertDMSToDD = (dms, ref) => {
            if (!dms) return null;
            
            // å¼·åŠ›è½‰æ›ï¼šè™•ç†å„ç¨®å¥‡æ€ªçš„ Exif è³‡æ–™çµæ§‹ (Array, Object, Number)
            const getVal = (item) => {
                if (typeof item === 'number') return item;
                if (item && typeof item.valueOf === 'function') return item.valueOf(); // è™•ç† Number ç‰©ä»¶
                if (item && item.numerator && item.denominator) return item.numerator / item.denominator; // è™•ç†åˆ†æ•¸ç‰©ä»¶
                return 0;
            };

            const d = getVal(dms[0]);
            const m = getVal(dms[1]);
            const s = getVal(dms[2]);

            let dd = d + m / 60 + s / 3600;
            
            if (ref === "S" || ref === "W") {
                dd = dd * -1;
            }
            
            // åŸºæœ¬é©—è­‰
            if (isNaN(dd) || (dd === 0 && d === 0 && m === 0)) return null;
            return dd;
        };

        const reverseGeocode = async (lat, lon) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                if (!response.ok) return null;
                const data = await response.json();
                return data.address;
            } catch (error) {
                console.error("Geocoding failed", error);
                return null;
            }
        };

        const downloadOriginal = async (imageUrl, filename) => {
            try {
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Linkc_${filename}_original.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                console.error("åŸå§‹åœ–ç‰‡ä¸‹è¼‰ä¹Ÿå¤±æ•—", err);
                window.open(imageUrl, '_blank');
            }
        };

        const downloadWithWatermark = async (imageUrl, filename, e) => {
            if(e) e.stopPropagation();
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.crossOrigin = "anonymous";
            img.src = imageUrl;

            return new Promise((resolve) => {
                img.onload = () => {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const fontSize = Math.max(20, img.width * 0.03); 
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'bottom';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        const padding = fontSize;
                        ctx.fillText('Linkc', canvas.width - padding, canvas.height - padding);

                        const link = document.createElement('a');
                        link.download = `Linkc_${filename}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        resolve(true);
                    } catch (err) {
                        console.warn("Canvas Tainted (CORS é™åˆ¶)ï¼Œè½‰ç‚ºä¸‹è¼‰åŸåœ–ã€‚", err);
                        downloadOriginal(imageUrl, filename);
                        resolve(false); 
                    }
                };
                
                img.onerror = () => {
                    console.warn("åœ–ç‰‡è¼‰å…¥å¤±æ•— (CORS é™åˆ¶)ï¼Œè½‰ç‚ºä¸‹è¼‰åŸåœ–ã€‚");
                    downloadOriginal(imageUrl, filename);
                    resolve(false);
                };
            });
        };

        const copyToClipboard = (text) => {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
            }
        };

        // -----------------------------------------------------------------------------
        // UI Components
        // -----------------------------------------------------------------------------

        const ConfigError = () => (
            <div className="error-container bg-gray-50">
                <div className="error-box">
                    <AlertTriangle className="mx-auto h-12 w-12 text-yellow-500 mb-4" />
                    <h3 className="error-title">å°šæœªè¨­å®š Firebase</h3>
                    <p className="text-gray-600 mb-4">è«‹ç·¨è¼¯ index.html ä¸¦å¡«å…¥æ‚¨çš„ Firebase Configã€‚</p>
                </div>
            </div>
        );

        const AuthError = ({ message }) => (
            <div className="error-container bg-gray-50">
                <div className="error-box border-red-200">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-500 mb-4" />
                    <h3 className="error-title">é€£ç·šå¤±æ•—</h3>
                    <p className="text-gray-800 font-mono text-xs bg-red-50 p-2 rounded mb-4 break-all">{message}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-indigo-600 text-white rounded">é‡æ–°æ•´ç†</button>
                </div>
            </div>
        );

        const Header = ({ setView, isAdmin, onLoginClick, onLogout }) => (
            <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div className="flex items-center cursor-pointer gap-2" onClick={() => setView('gallery')}>
                    {/* Logo */}
                    <img src="https://firebasestorage.googleapis.com/v0/b/linkcphoto.firebasestorage.app/o/photos%2Flinkc-w0.png?alt=media&token=63c9b589-aa78-480a-bed2-1c83634f4b9f" alt="Linkc Logo" className="h-10 w-auto mr-2" />
                    
                    {/* åŸæœ¬çš„ç›¸æ©Ÿåœ–ç¤º */}
                    <div className="bg-indigo-600 p-2 rounded-lg"><Camera className="w-6 h-6 text-white" /></div>
                    
                    {/* åŸæœ¬çš„æ–‡å­— */}
                    <h1 className="text-2xl font-bold text-gray-900 tracking-tight hidden sm:block">Linkc <span className="text-indigo-600 font-light">Gallery</span></h1>
                    
                    {isAdmin && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold ml-2">ADMIN</span>}
                </div>
                <div className="flex items-center gap-3">
                    {isAdmin ? (
                        <button onClick={onLogout} className="p-2 text-gray-500 hover:text-red-600 transition-colors" title="ç™»å‡º"><LogOut size={20} /></button>
                    ) : (
                        <button onClick={onLoginClick} className="p-2 text-gray-400 hover:text-indigo-600 transition-colors" title="ç™»å…¥"><Lock size={20} /></button>
                    )}
                    <button onClick={() => setView('upload')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full transition-all shadow-md hover:shadow-lg">
                        <Upload size={18} /><span className="hidden sm:inline">æ–°å¢ç…§ç‰‡</span>
                    </button>
                </div>
                </div>
            </header>
        );

        const ShareButtons = ({ photo }) => {
            const shareText = `${photo.thoughts_shooting || 'åˆ†äº«ä¸€å¼µç…§ç‰‡'} \n\n#Linkc ${photo.tags.map(t=>'#'+t).join(' ')}`;
            
            const handleIG = async (e) => {
                e.stopPropagation();
                copyToClipboard(shareText);
                const success = await downloadWithWatermark(photo.url, photo.id, e);
                if (success) {
                    alert("å·²è¤‡è£½è²¼æ–‡å…§å®¹ä¸¦ä¸‹è¼‰ç…§ç‰‡ (å«æµ®æ°´å°)ï¼\n\nè«‹é–‹å•Ÿ Instagram é¸æ“‡ç…§ç‰‡ä¸¦è²¼ä¸Šæ–‡å­—ã€‚");
                } else {
                    alert("å·²è¤‡è£½è²¼æ–‡å…§å®¹ï¼\n\nå› ç€è¦½å™¨é™åˆ¶ï¼Œç„¡æ³•è‡ªå‹•ä¸‹è¼‰åˆæˆæµ®æ°´å°çš„ç…§ç‰‡ã€‚\nç³»çµ±å·²ç‚ºæ‚¨é–‹å•ŸåŸåœ–ï¼Œè«‹é•·æŒ‰å„²å­˜å¾Œï¼Œå†è‡³ Instagram ç™¼ä½ˆã€‚");
                }
            };

            return (
                <div className="flex items-center gap-2">
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(photo.url)}`, '_blank')}} className="bg-blue-600 text-white p-2 rounded-full hover:scale-110 transition-transform"><Facebook size={18} /></button>
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(photo.url)}`, '_blank')}} className="bg-green-500 text-white p-2 rounded-full hover:scale-110 transition-transform"><MessageCircle size={18} /></button>
                    <button onClick={handleIG} className="bg-gradient-to-tr from-[#f09433] via-[#dc2743] to-[#bc1888] text-white p-2 rounded-full hover:scale-110 transition-transform" title="åˆ†äº«åˆ° Instagram"><Instagram size={18} /></button>
                </div>
            );
        };

        const Lightbox = ({ photo, onClose, isAdmin, onEdit, onDelete }) => {
            if (!photo) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-4" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white p-2 z-50"><X size={32} /></button>
                    
                    {isAdmin && (
                        <div className="absolute top-4 left-4 flex gap-2 z-50">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-600/80 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm"><Edit size={14} /> ç·¨è¼¯</button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); onClose(); }} className="bg-red-600/80 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm"><Trash2 size={14} /> åˆªé™¤</button>
                        </div>
                    )}

                    <div className="relative max-w-full max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <img src={photo.url} className="max-w-full max-h-[85vh] object-contain shadow-2xl rounded-sm" />
                        <div className="absolute -bottom-16 left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-white/10 backdrop-blur-md px-6 py-3 rounded-full border border-white/10">
                            <button onClick={(e) => downloadWithWatermark(photo.url, photo.id, e)} className="text-white hover:text-indigo-300 flex flex-col items-center gap-1">
                                <Download size={20} /><span className="text-[10px]">ä¸‹è¼‰</span>
                            </button>
                            <div className="w-px h-8 bg-white/20 mx-2"></div>
                            <ShareButtons photo={photo} />
                        </div>
                    </div>
                    
                    <div className="mt-4 text-white/80 text-center" onClick={(e) => e.stopPropagation()}>
                        <div className="flex items-center justify-center gap-4 text-sm font-medium mb-1">
                            <span className="flex items-center gap-1"><Clock size={14}/> {photo.date ? photo.date.replace('T', ' ') : ''}</span>
                            <span className="flex items-center gap-1"><MapPin size={14}/> {photo.location.city}</span>
                        </div>
                        {(photo.exif.camera || photo.exif.lens) && (
                            <div className="flex items-center justify-center gap-3 text-xs text-white/70 mb-1">
                                {photo.exif.camera && <span className="flex items-center gap-1"><Camera size={12}/> {photo.exif.camera}</span>}
                                {photo.exif.lens && <span className="flex items-center gap-1"><Disc size={12}/> {photo.exif.lens}</span>}
                            </div>
                        )}
                        <p className="text-white/60 text-xs font-mono">
                            {photo.exif.shutter} Â· {photo.exif.aperture} Â· ISO {photo.exif.iso} {photo.exif.focalLength ? `Â· ${photo.exif.focalLength}` : ''}
                        </p>
                    </div>
                </div>
            );
        };

        const PhotoCard = ({ photo, onExpand, isAdmin, onEdit, onDelete }) => (
            <div className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 group flex flex-col h-full border border-gray-100 relative">
                {isAdmin && (
                    <div className="absolute top-2 left-2 z-20 flex gap-2">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600"><Edit size={14} /></button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); }} className="bg-red-500 text-white p-2 rounded-full shadow-md hover:bg-red-600"><Trash2 size={14} /></button>
                    </div>
                )}
                <div className="relative aspect-[4/3] overflow-hidden bg-gray-100 cursor-zoom-in" onClick={() => onExpand(photo)}>
                    <img src={photo.url} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                    <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-2 z-10"><ShareButtons photo={photo} /></div>
                    <div className="absolute bottom-3 left-3 pointer-events-none">
                        <span className="bg-black/60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-md flex items-center gap-1">
                            <Clock size={12} /> {photo.date ? photo.date.replace('T', ' ') : ''}
                        </span>
                    </div>
                </div>
                
                <div className="p-5 flex flex-col flex-grow">
                    <div className="flex items-center text-gray-500 text-sm mb-3">
                        <MapPin size={14} className="mr-1 text-indigo-500" />
                        {photo.location.country} Â· {photo.location.city} {photo.location.spot && `Â· ${photo.location.spot}`}
                    </div>

                    <div className="flex flex-wrap gap-2 mb-4">
                        {photo.tags.map(tag => (
                            <span key={tag} className="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs rounded-full font-medium">#{tag}</span>
                        ))}
                    </div>

                    <div className="space-y-3 mb-4 flex-grow">
                        {photo.thoughts_shooting && (
                            <div className="bg-gray-50 p-3 rounded-lg border-l-2 border-orange-300">
                                <div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1">
                                    <Camera size={12} /> æ‹æ”ç•¶ä¸‹
                                </div>
                                <p className="text-gray-700 text-sm italic">"{photo.thoughts_shooting}"</p>
                            </div>
                        )}
                        {photo.thoughts_viewing && (
                            <div className="bg-gray-50 p-3 rounded-lg border-l-2 border-indigo-300">
                                <div className="flex items-center gap-1 text-xs font-bold text-gray-500 mb-1">
                                    <Eye size={12} /> æ¬£è³éš¨ç­†
                                </div>
                                <p className="text-gray-700 text-sm italic">"{photo.thoughts_viewing}"</p>
                            </div>
                        )}
                    </div>

                    {(photo.exif.camera || photo.exif.lens) && (
                        <div className="flex flex-col gap-1 mb-3 text-xs text-gray-600 bg-gray-50 p-2 rounded-lg border border-gray-100">
                            {photo.exif.camera && <div className="flex items-center gap-1 font-medium"><Camera size={12} className="text-gray-400"/> {photo.exif.camera}</div>}
                            {photo.exif.lens && <div className="flex items-center gap-1 text-gray-500"><Disc size={12} className="text-gray-400"/> {photo.exif.lens}</div>}
                        </div>
                    )}

                    <div className="grid grid-cols-4 gap-1 border-t pt-3 mt-auto text-center">
                        <div className="flex flex-col items-center">
                            <span className="text-[10px] uppercase text-gray-400 font-bold">å¿«é–€</span>
                            <span className="text-xs text-gray-700 font-mono">{photo.exif.shutter || '--'}</span>
                        </div>
                        <div className="flex flex-col items-center border-l border-gray-100">
                            <span className="text-[10px] uppercase text-gray-400 font-bold">å…‰åœˆ</span>
                            <span className="text-xs text-gray-700 font-mono">{photo.exif.aperture || '--'}</span>
                        </div>
                        <div className="flex flex-col items-center border-l border-gray-100">
                            <span className="text-[10px] uppercase text-gray-400 font-bold">ISO</span>
                            <span className="text-xs text-gray-700 font-mono">{photo.exif.iso || '--'}</span>
                        </div>
                        <div className="flex flex-col items-center border-l border-gray-100">
                            <span className="text-[10px] uppercase text-gray-400 font-bold">ç„¦æ®µ</span>
                            <span className="text-xs text-gray-700 font-mono">{photo.exif.focalLength || '--'}</span>
                        </div>
                    </div>
                    
                    <div className="border-t border-dashed border-gray-200 mt-3 pt-2 flex justify-between items-center">
                        <span className="text-[10px] text-gray-400">CC BY 4.0 å§“åæ¨™ç¤º</span>
                        <span className="text-[10px] font-bold text-gray-300 select-none">Linkc</span>
                    </div>
                </div>
            </div>
        );

        const PhotoForm = ({ onSave, onCancel, initialData, isSaving }) => {
            const isEditMode = !!initialData;
            
            const getNowString = () => {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                return now.toISOString().slice(0, 16);
            };

            const [formData, setFormData] = useState(initialData || { 
                url: '', 
                tags: '', 
                thoughts_shooting: '', 
                thoughts_viewing: '', 
                exif: { shutter: '', aperture: 'f/', iso: '', date: getNowString(), camera: '', lens: '', focalLength: '' }, 
                location: { country: '', city: '', spot: '' } 
            });
            const [status, setStatus] = useState('');
            const [uploadFile, setUploadFile] = useState(null);
            const [exifStatus, setExifStatus] = useState(''); 

            useEffect(() => { if (initialData && Array.isArray(initialData.tags)) { setFormData(prev => ({ ...prev, tags: initialData.tags.join(', ') })); } }, [initialData]);
            
            const handleChange = (section, field, value) => { if (section) { setFormData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } })); } else { setFormData(prev => ({ ...prev, [field]: value })); } };
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadFile(file);
                    setExifStatus('åˆ†æä¸­...');
                    
                    EXIF.getData(file, async function() {
                        // 1. åŸºæœ¬è³‡è¨Š
                        const extractedShutter = EXIF.getTag(this, "ExposureTime");
                        const extractedFNumber = EXIF.getTag(this, "FNumber");
                        const extractedISO = EXIF.getTag(this, "ISOSpeedRatings");
                        const extractedDate = EXIF.getTag(this, "DateTimeOriginal");
                        const extractedFocalLength = EXIF.getTag(this, "FocalLength");
                        
                        const make = EXIF.getTag(this, "Make");
                        const model = EXIF.getTag(this, "Model");
                        
                        // 2. æš´åŠ›æŠ“å–é¡é ­è³‡è¨Š
                        const allTags = EXIF.getAllTags(this);
                        let lensModel = findLensNameInAllTags(allTags);
                        
                        // 3. æ¸…ç†é¡é ­åç¨±
                        if (lensModel && typeof lensModel === 'string') {
                            lensModel = lensModel.replace(/\0/g, '').trim();
                            // å¦‚æœ LensMake (å¦‚æœæœ‰çš„è©±) å·²ç¶“åœ¨åç¨±è£¡ï¼Œå°±ä¸é‡è¤‡åŠ 
                            const lensMake = EXIF.getTag(this, "LensMake");
                            if (lensMake && !lensModel.toLowerCase().includes(lensMake.toLowerCase())) {
                                lensModel = `${lensMake} ${lensModel}`;
                            }
                        }

                        // 4. GPS (åŒ…å« TG-6 ä¿®æ­£)
                        const lat = EXIF.getTag(this, "GPSLatitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                        const lon = EXIF.getTag(this, "GPSLongitude");
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

                        // 5. æ ¼å¼åŒ–æ•¸å€¼
                        let formattedShutter = "";
                        if (extractedShutter) {
                            if (extractedShutter < 1) {
                                formattedShutter = "1/" + Math.round(1/extractedShutter);
                            } else {
                                formattedShutter = extractedShutter.toString();
                            }
                        }
                        const formattedAperture = extractedFNumber ? "f/" + extractedFNumber : "";
                        
                        let formattedDate = "";
                        if (extractedDate) {
                            const parts = extractedDate.split(" ");
                            if (parts.length >= 2) {
                                const d = parts[0].replace(/:/g, "-");
                                const t = parts[1].substring(0, 5);
                                formattedDate = `${d}T${t}`;
                            } else if (parts.length === 1) {
                                formattedDate = parts[0].replace(/:/g, "-");
                            }
                        }

                        let formattedCamera = "";
                        if (make && model) {
                            if (model.toLowerCase().includes(make.toLowerCase())) {
                                formattedCamera = model;
                            } else {
                                formattedCamera = `${make} ${model}`;
                            }
                        } else {
                            formattedCamera = model || make || "";
                        }
                        if (formattedCamera) formattedCamera = formattedCamera.replace(/\0/g, '').trim();

                        let formattedFocalLength = "";
                        if (extractedFocalLength) {
                            formattedFocalLength = `${Number(extractedFocalLength)}mm`;
                        }

                        // 6. GPS èˆ‡åœ°å€è§£æ
                        let locationUpdate = { ...formData.location };
                        let extraStatus = "";

                        // ä¿®æ­£ï¼šå®¹éŒ¯è™•ç†ï¼Œè‹¥ç„¡ Ref é è¨­ N/E
                        if (lat && lon) {
                            const decimalLat = convertDMSToDD(lat, latRef || 'N');
                            const decimalLon = convertDMSToDD(lon, lonRef || 'E');
                            
                            if (decimalLat && decimalLon) {
                                setExifStatus('æ­£åœ¨è§£æ GPS åœ°å€...');
                                const address = await reverseGeocode(decimalLat, decimalLon);
                                if (address) {
                                    locationUpdate = {
                                        country: address.country || "",
                                        city: address.city || address.county || address.town || address.state || "",
                                        spot: address.suburb || address.village || address.road || address.pedestrian || ""
                                    };
                                    extraStatus = " + GPS ğŸ“";
                                } else {
                                    extraStatus = " (GPS è§£æå¤±æ•—)";
                                }
                            }
                        }

                        setFormData(prev => ({
                            ...prev,
                            exif: {
                                shutter: formattedShutter || prev.exif.shutter,
                                aperture: formattedAperture || prev.exif.aperture,
                                iso: extractedISO ? extractedISO.toString() : prev.exif.iso,
                                date: formattedDate || prev.exif.date,
                                camera: formattedCamera || prev.exif.camera,
                                lens: lensModel || prev.exif.lens,
                                focalLength: formattedFocalLength || prev.exif.focalLength
                            },
                            location: locationUpdate
                        }));
                        setExifStatus(`EXIF è®€å–å®Œæˆ${extraStatus} âœ¨`);
                    });
                }
            };

            const handleSubmit = async (e) => { 
                e.preventDefault();
                setStatus('uploading');
                
                let finalUrl = formData.url;

                try {
                    if (uploadFile) {
                        const filename = `photos/${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${uploadFile.name}`;
                        const storageRef = ref(storage, filename);
                        await uploadBytes(storageRef, uploadFile);
                        finalUrl = await getDownloadURL(storageRef);
                    } else if (formData.url) {
                        if (formData.url.includes('googleusercontent') || formData.url.includes('photos.app.goo.gl')) {
                            if (!confirm("è­¦å‘Šï¼šä½¿ç”¨ Google Photos é€£çµæ¥µé«˜æ©Ÿç‡æœƒå› ç‚ºæ™‚æ•ˆæ€§è€Œç ´åœ–ã€‚\n\nå¼·çƒˆå»ºè­°æ‚¨å°‡ç…§ç‰‡ä¸‹è¼‰å¾Œï¼Œä½¿ç”¨ã€Œä¸Šå‚³æª”æ¡ˆã€åŠŸèƒ½ã€‚\n\næ‚¨ç¢ºå®šè¦ç¹¼çºŒä½¿ç”¨é€£çµå—ï¼Ÿ")) {
                                setStatus('');
                                return;
                            }
                        }
                    } else {
                        alert("è«‹é¸æ“‡ä¸€å¼µç…§ç‰‡æª”æ¡ˆä¸Šå‚³ï¼Œæˆ–è¼¸å…¥åœ–ç‰‡é€£çµã€‚");
                        setStatus('');
                        return;
                    }

                    const processedData = { 
                        ...formData, 
                        url: finalUrl,
                        tags: formData.tags.split(',').map(t => t.trim()).filter(t => t), 
                        date: formData.exif.date 
                    }; 
                    onSave(processedData); 

                } catch (err) {
                    console.error("ä¸Šå‚³å¤±æ•—", err);
                    alert("ä¸Šå‚³å¤±æ•—: " + err.message + "\n\nè«‹ç¢ºèªæ‚¨çš„ Firebase Storage æ˜¯å¦å·²å•Ÿç”¨ (Test Mode)ã€‚");
                    setStatus('');
                }
            };

            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 animate-in slide-in-from-bottom-4 duration-300">
                    <div className="flex justify-between items-center mb-6 border-b pb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">{isEditMode ? <Edit className="text-blue-600" /> : <Upload className="text-indigo-600" />} {isEditMode ? 'ä¿®æ”¹ç…§ç‰‡è³‡è¨Š' : 'åˆ†äº«æ–°ç…§ç‰‡'}</h2><button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><X size={24} /></button></div>
                    
                    {status === 'uploading' && (
                        <div className="mb-4 bg-blue-50 text-blue-700 p-4 rounded-lg flex items-center gap-2 animate-pulse">
                            <RefreshCw className="spinner" size={20} />
                            <span>æ­£åœ¨ä¸Šå‚³ç…§ç‰‡è‡³é›²ç«¯ï¼Œè«‹ç¨å€™...</span>
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-8">
                        <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label className="block text-sm font-bold text-gray-700 mb-2">æ­¥é©Ÿ 1ï¼šé¸æ“‡ç…§ç‰‡ä¾†æº</label>
                            
                            <div className="relative">
                                <input type="file" accept="image/*" onChange={handleFileChange} className="hidden" id="file-upload" disabled={status === 'uploading'} />
                                <label htmlFor="file-upload" className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer hover:bg-gray-100 transition-colors ${uploadFile ? 'border-green-500 bg-green-50' : 'border-gray-300'}`}>
                                    {uploadFile ? (
                                        <>
                                            <Check className="w-8 h-8 text-green-500 mb-2" />
                                            <span className="text-sm font-medium text-green-600">å·²é¸æ“‡ï¼š{uploadFile.name}</span>
                                            {exifStatus && <span className="text-xs text-blue-500 mt-1 flex items-center gap-1"><Sparkles size={10}/> {exifStatus}</span>}
                                        </>
                                    ) : (
                                        <>
                                            <FileUp className="w-8 h-8 text-gray-400 mb-2" />
                                            <span className="text-sm font-medium text-gray-600">é»æ“Šä¸Šå‚³æª”æ¡ˆ (æ¨è–¦)</span>
                                            <span className="text-xs text-gray-500 mt-1">è‡ªå‹•è®€å– EXIFã€GPSã€ç›¸æ©Ÿèˆ‡é¡é ­è³‡è¨Šï¼Œæ°¸ä¹…ä¿å­˜</span>
                                        </>
                                    )}
                                </label>
                            </div>

                            <div className="text-center text-gray-400 text-xs">- æˆ– -</div>

                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><LinkIcon className="h-4 w-4 text-gray-400" /></div>
                                <input type="url" placeholder="è¼¸å…¥åœ–ç‰‡é€£çµ (ä¸æ¨è–¦ Google Photos é€£çµ)" className="block w-full pl-9 border-gray-300 rounded-lg p-2 text-sm border" value={formData.url} onChange={(e) => { handleChange(null, 'url', e.target.value); setUploadFile(null); setExifStatus(''); }} disabled={uploadFile || status === 'uploading'} />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ¨™ç±¤ (Tags)</label><input type="text" placeholder="é¢¨æ™¯, å°ç£" className="block w-full border-gray-300 rounded-lg p-2.5 border" value={formData.tags} onChange={(e) => handleChange(null, 'tags', e.target.value)} /></div>
                                <div className="bg-orange-50 p-4 rounded-lg border border-orange-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ‹æ”æ„Ÿå—</label><textarea rows="3" placeholder="..." className="block w-full border-gray-300 rounded-lg p-2.5 border resize-none" value={formData.thoughts_shooting} onChange={(e) => handleChange(null, 'thoughts_shooting', e.target.value)} /></div>
                                <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200"><label className="block text-sm font-bold text-gray-800 mb-1">æ¬£è³æ„Ÿå—</label><textarea rows="3" placeholder="..." className="block w-full border-gray-300 rounded-lg p-2.5 border resize-none" value={formData.thoughts_viewing} onChange={(e) => handleChange(null, 'thoughts_viewing', e.target.value)} /></div>
                            </div>
                            <div className="space-y-6 bg-gray-50 p-6 rounded-xl border border-gray-200">
                                <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-2">
                                    æ‹æ”åƒæ•¸ {exifStatus && <span className="text-xs text-green-500 font-normal normal-case">({exifStatus})</span>}
                                </h3>
                                
                                <div className="grid grid-cols-1 gap-4 mb-4">
                                    <div><label className="block text-xs font-medium text-gray-500">ç›¸æ©Ÿå‹è™Ÿ</label><input type="text" placeholder="ä¾‹å¦‚ï¼šSony A7III" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.camera} onChange={(e) => handleChange('exif', 'camera', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">é¡é ­è³‡è¨Š</label><input type="text" placeholder="ä¾‹å¦‚ï¼šFE 24-105mm F4 G" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.lens} onChange={(e) => handleChange('exif', 'lens', e.target.value)} /></div>
                                </div>

                                <div className="grid grid-cols-2 gap-4 border-t pt-4">
                                    <div><label className="block text-xs font-medium text-gray-500">å¿«é–€</label><input type="text" placeholder="1/200" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.shutter} onChange={(e) => handleChange('exif', 'shutter', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">å…‰åœˆ</label><input type="text" placeholder="f/2.8" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.aperture} onChange={(e) => handleChange('exif', 'aperture', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">ISO</label><input type="text" placeholder="400" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.iso} onChange={(e) => handleChange('exif', 'iso', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">ç„¦æ®µ</label><input type="text" placeholder="50mm" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.focalLength} onChange={(e) => handleChange('exif', 'focalLength', e.target.value)} /></div>
                                    <div className="col-span-2"><label className="block text-xs font-medium text-gray-500">æ—¥æœŸèˆ‡æ™‚é–“</label><input type="datetime-local" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.date} onChange={(e) => handleChange('exif', 'date', e.target.value)} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mt-4 pt-4 border-t">
                                    <div><label className="block text-xs font-medium text-gray-500">åœ‹å®¶ {formData.location.country && <MapIcon size={12} className="inline text-green-500"/>}</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.country} onChange={(e) => handleChange('location', 'country', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">åŸå¸‚</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.city} onChange={(e) => handleChange('location', 'city', e.target.value)} /></div>
                                    <div className="col-span-2"><label className="block text-xs font-medium text-gray-500">åœ°å/æ™¯é»</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.spot} onChange={(e) => handleChange('location', 'spot', e.target.value)} /></div>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 pt-6">
                            <button type="button" onClick={onCancel} disabled={isSaving || status === 'uploading'} className="px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">å–æ¶ˆ</button>
                            <button type="submit" disabled={isSaving || status === 'uploading'} className={`px-6 py-2 border border-transparent rounded-lg text-sm font-medium text-white shadow-lg hover:shadow-xl transition-all flex items-center gap-2 ${isEditMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-indigo-600 hover:bg-indigo-700'} disabled:opacity-50`}>
                                {(isSaving || status === 'uploading') && <RefreshCw className="animate-spin" size={16} />} 
                                {status === 'uploading' ? 'ä¸Šå‚³ä¸­...' : (isEditMode ? 'å„²å­˜ä¿®æ”¹' : 'ç™¼ä½ˆç…§ç‰‡')}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const AdminLogin = ({ onLogin, onCancel }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (password === '590123') onLogin(); else setPassword(''); };
            return (
                <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full"><h3 className="text-lg font-bold text-center mb-4">ç®¡ç†å“¡ç™»å…¥</h3><form onSubmit={handleSubmit} className="space-y-4"><input type="password" placeholder="å¯†ç¢¼" className="w-full text-center border p-2 rounded" value={password} onChange={(e) => setPassword(e.target.value)} autoFocus /><div className="flex gap-2"><button type="button" onClick={onCancel} className="flex-1 bg-gray-200 py-2 rounded">å–æ¶ˆ</button><button type="submit" className="flex-1 bg-indigo-600 text-white py-2 rounded">è§£é–</button></div></form></div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('gallery');
            const [photos, setPhotos] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState(null);
            const [sortOrder, setSortOrder] = useState('newest'); // 'newest' | 'oldest'
            
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [editingPhoto, setEditingPhoto] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                if (!isConfigConfigured) return; 
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (err) { setAuthError(err.message); } };
                initAuth();
                onAuthStateChanged(auth, (user) => { setCurrentUser(user); if(user) setAuthError(null); });
            }, []);

            useEffect(() => {
                if (!currentUser || !db) return;
                // Query all photos first (client-side sorting is easier for complex logic, or use simple query)
                // Using simple order for initial fetch
                const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => { setPhotos(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            }, [currentUser]);

            const handleSavePhoto = async (photoData) => {
                if (!currentUser) return;
                setIsSaving(true);
                try {
                    const collectionRef = collection(db, COLLECTION_NAME);
                    if (editingPhoto) {
                        await updateDoc(doc(collectionRef, photoData.id), { ...photoData });
                        setEditingPhoto(null);
                    } else {
                        await addDoc(collectionRef, { ...photoData, timestamp: Date.now() });
                    }
                    setView('gallery');
                } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); } finally { setIsSaving(false); }
            };

            const handleDeletePhoto = async (id) => {
                if (!currentUser) return;
                if(window.confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ï¼Ÿ')) {
                    try { await deleteDoc(doc(db, COLLECTION_NAME, id)); } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
                }
            };

            const startEdit = (photo) => { setEditingPhoto(photo); setView('upload'); if (selectedPhoto) setSelectedPhoto(null); };

            if (!isConfigConfigured) return <ConfigError />;
            if (authError) return <AuthError message={authError} />;

            const allTags = [...new Set(photos.flatMap(p => p.tags))];

            // Advanced Search Logic
            const filteredPhotos = photos.filter(photo => {
                // 1. Tag Filter (if clicked from tag cloud)
                if (activeTag && !(photo.tags || []).includes(activeTag)) {
                    return false;
                }

                // 2. Search Query Parser (AND, OR, NOT)
                if (!searchQuery.trim()) return true;

                const query = searchQuery.toLowerCase();
                const photoString = JSON.stringify(photo).toLowerCase(); // Simple full-text search base

                // Tokens separated by spaces
                const tokens = query.split(/\s+/);
                
                // Logic:
                // Default is AND.
                // "OR" keyword makes next term OR.
                // "-" prefix is NOT.
                
                // We'll evaluate expression left-to-right loosely.
                let isMatch = true;
                let nextIsOr = false;

                for (let i = 0; i < tokens.length; i++) {
                    let token = tokens[i];
                    if (token === 'or') {
                        nextIsOr = true;
                        continue;
                    }

                    let isNot = false;
                    if (token.startsWith('-')) {
                        // Check if it's just "-" or "-keyword"
                        if (token.length > 1) {
                            isNot = true;
                            token = token.substring(1);
                        } else {
                            // ignore standalone "-" or handle as literal if desired
                            // For now, treat standalone "-" as literal
                        }
                    }

                    // Check match for this token
                    const tokenMatch = photoString.includes(token);
                    const conditionMet = isNot ? !tokenMatch : tokenMatch;

                    if (i === 0) {
                        isMatch = conditionMet;
                    } else {
                        if (nextIsOr) {
                            isMatch = isMatch || conditionMet;
                            nextIsOr = false;
                        } else {
                            isMatch = isMatch && conditionMet;
                        }
                    }
                }
                return isMatch;
            });

            // Sorting Logic
            const sortedPhotos = [...filteredPhotos].sort((a, b) => {
                if (sortOrder === 'newest') {
                    // Sort by shooting date (exif.date) if available, else timestamp (upload time)
                    const dateA = a.exif?.date || a.timestamp;
                    const dateB = b.exif?.date || b.timestamp;
                    // String comparison works for ISO dates
                    if (dateA < dateB) return 1;
                    if (dateA > dateB) return -1;
                    return 0;
                } else {
                    const dateA = a.exif?.date || a.timestamp;
                    const dateB = b.exif?.date || b.timestamp;
                    if (dateA > dateB) return 1;
                    if (dateA < dateB) return -1;
                    return 0;
                }
            });

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                <Header setView={(v) => { setView(v); setEditingPhoto(null); }} isAdmin={isAdmin} onLoginClick={() => setShowLogin(true)} onLogout={() => { setIsAdmin(false); alert("å·²ç™»å‡º"); }} />
                {showLogin && (<AdminLogin onLogin={() => { setIsAdmin(true); setShowLogin(false); }} onCancel={() => setShowLogin(false)} />)}
                {selectedPhoto && (<Lightbox photo={selectedPhoto} onClose={() => setSelectedPhoto(null)} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />)}

                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    {view === 'gallery' ? (
                    <>
                        {/* Search and Filter Controls */}
                        <div className="flex flex-col gap-4 mb-8">
                            <div className="flex flex-col md:flex-row gap-4">
                                {/* Search Bar */}
                                <div className="relative flex-grow">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Search className="h-5 w-5 text-gray-400" /></div>
                                    <input 
                                        type="text" 
                                        placeholder="æœå°‹... (æ”¯æ´: å°åŒ— å®œè˜­ OR èŠ±è“® -å¤œæ™¯ #é¢¨æ™¯)" 
                                        className="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm" 
                                        value={searchQuery} 
                                        onChange={(e) => setSearchQuery(e.target.value)} 
                                    />
                                    <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                        <Filter className="h-4 w-4 text-gray-300" />
                                    </div>
                                </div>
                                
                                {/* Sort Button */}
                                <button 
                                    onClick={() => setSortOrder(prev => prev === 'newest' ? 'oldest' : 'newest')}
                                    className="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50 shadow-sm min-w-[140px] transition-all"
                                >
                                    {sortOrder === 'newest' ? <ArrowDownWideNarrow size={18} /> : <ArrowUpNarrowWide size={18} />}
                                    <span>{sortOrder === 'newest' ? 'æœ€æ–°åœ¨ä¸Š' : 'æœ€èˆŠåœ¨ä¸Š'}</span>
                                </button>
                            </div>

                            {/* Tag Cloud */}
                            <div className="flex flex-wrap gap-2 items-center">
                                <span className="text-sm font-bold text-gray-400 mr-2 flex items-center gap-1"><Tag size={14} /> åˆ†é¡:</span>
                                <button onClick={() => setActiveTag(null)} className={`px-3 py-1 rounded-full text-sm transition-colors ${!activeTag ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-200'}`}>å…¨éƒ¨</button>
                                {allTags.map(tag => (
                                    <button 
                                        key={tag} 
                                        onClick={() => setActiveTag(tag === activeTag ? null : tag)} 
                                        className={`px-3 py-1 rounded-full text-sm transition-colors ${tag === activeTag ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-indigo-50 hover:border-indigo-200'}`}
                                    >
                                        {tag}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {sortedPhotos.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">{sortedPhotos.map(photo => (<PhotoCard key={photo.id} photo={photo} onExpand={setSelectedPhoto} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />))}</div>
                        ) : (
                        <div className="text-center py-20 bg-white rounded-xl shadow-sm border border-dashed border-gray-300"><Cloud className="mx-auto h-12 w-12 text-gray-300 mb-3" /><h3 className="text-lg font-medium text-gray-900">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç…§ç‰‡</h3><button onClick={() => setView('upload')} className="mt-4 text-indigo-600 hover:text-indigo-800 font-medium">ä¸Šå‚³ç¬¬ä¸€å¼µç…§ç‰‡ &rarr;</button></div>
                        )}
                    </>
                    ) : (
                    <PhotoForm onSave={handleSavePhoto} onCancel={() => { setView('gallery'); setEditingPhoto(null); }} initialData={editingPhoto} isSaving={isSaving} />
                    )}
                </main>
                <footer className="bg-white border-t border-gray-200 mt-12 py-8"><div className="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm"><p>Â© {new Date().getFullYear()} Linkc Photo Space.</p><p className="mt-1">Content Creative Commons Attribution (CC BY).</p></div></footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
