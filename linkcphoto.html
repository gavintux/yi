<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linkc Photo Space</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. CSS -->
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #f9fafb; }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: #4f46e5; font-weight: bold; }
        .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; color: #374151; }
        .error-box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 500px; width: 100%; border: 1px solid #e5e7eb; }
        .error-title { color: #dc2626; font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
        .error-list { text-align: left; list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; }
        
        /* 載入動畫 */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">正在啟動 Linkc Photo Space...</div>
    </div>

    <!-- 4. React App -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Camera, MapPin, Clock, Search, Upload, Download, Tag, Eye, X, 
            Image as ImageIcon, Maximize2, Share2, Facebook, Instagram, 
            MessageCircle, Copy, Check, Lock, Unlock, Edit, Trash2, LogOut, 
            Cloud, RefreshCw, AlertTriangle, Info, Save, Link as LinkIcon, FileUp
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        // 新增 Storage 模組
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // -----------------------------------------------------------------------------
        // 設定區
        // -----------------------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyDwXsplXePeD1wU1GG4BwQBR6iSMd3_5nY",
            authDomain: "linkcphoto.firebaseapp.com",
            projectId: "linkcphoto",
            storageBucket: "linkcphoto.firebasestorage.app",
            messagingSenderId: "841541302440",
            appId: "1:841541302440:web:a2b3dfef70a32bb345ea9d",
            measurementId: "G-902H2EHVFF"
            };

        const isConfigConfigured = !firebaseConfig.apiKey.includes("您的API_KEY");

        let app, auth, db, storage;
        if (isConfigConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase 初始化失敗", e);
            }
        }

        const COLLECTION_NAME = 'linkc_photos_v1';

        // -----------------------------------------------------------------------------
        // Helper Functions
        // -----------------------------------------------------------------------------

        const downloadWithWatermark = async (imageUrl, filename, e) => {
            if(e) e.stopPropagation();
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = imageUrl;

            return new Promise((resolve) => {
                img.onload = () => {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // Watermark
                        const fontSize = Math.max(20, img.width * 0.03); 
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'bottom';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        const padding = fontSize;
                        ctx.fillText('Linkc', canvas.width - padding, canvas.height - padding);

                        const link = document.createElement('a');
                        link.download = `Linkc_${filename}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        resolve(true);
                    } catch (err) {
                        console.error(err);
                        alert("浮水印製作失敗，改為下載原圖。");
                        window.open(imageUrl, '_blank');
                        resolve(false);
                    }
                };
                img.onerror = () => {
                    alert("圖片載入失敗，無法下載。");
                    resolve(false);
                };
            });
        };

        const copyToClipboard = (text) => {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
            }
        };

        // -----------------------------------------------------------------------------
        // UI Components
        // -----------------------------------------------------------------------------

        const ConfigError = () => (
            <div className="error-container bg-gray-50">
                <div className="error-box">
                    <AlertTriangle className="mx-auto h-12 w-12 text-yellow-500 mb-4" />
                    <h3 className="error-title">尚未設定 Firebase</h3>
                    <p className="text-gray-600 mb-4">請編輯 index.html 並填入您的 Firebase Config。</p>
                </div>
            </div>
        );

        const AuthError = ({ message }) => (
            <div className="error-container bg-gray-50">
                <div className="error-box border-red-200">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-500 mb-4" />
                    <h3 className="error-title">連線失敗</h3>
                    <p className="text-gray-800 font-mono text-xs bg-red-50 p-2 rounded mb-4 break-all">{message}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-indigo-600 text-white rounded">重新整理</button>
                </div>
            </div>
        );

        const Header = ({ setView, isAdmin, onLoginClick, onLogout }) => (
            <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div className="flex items-center cursor-pointer gap-2" onClick={() => setView('gallery')}>
                    <div className="bg-indigo-600 p-2 rounded-lg"><Camera className="w-6 h-6 text-white" /></div>
                    <h1 className="text-2xl font-bold text-gray-900 tracking-tight">Linkc <span className="text-indigo-600 font-light">Gallery</span></h1>
                    {isAdmin && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold ml-2">ADMIN</span>}
                </div>
                <div className="flex items-center gap-3">
                    {isAdmin ? (
                        <button onClick={onLogout} className="p-2 text-gray-500 hover:text-red-600 transition-colors" title="登出"><LogOut size={20} /></button>
                    ) : (
                        <button onClick={onLoginClick} className="p-2 text-gray-400 hover:text-indigo-600 transition-colors" title="登入"><Lock size={20} /></button>
                    )}
                    <button onClick={() => setView('upload')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full transition-all shadow-md hover:shadow-lg">
                        <Upload size={18} /><span className="hidden sm:inline">新增照片</span>
                    </button>
                </div>
                </div>
            </header>
        );

        const ShareButtons = ({ photo }) => {
            const shareText = `${photo.thoughts_shooting || '分享一張照片'} #Linkc`;
            const handleIG = async (e) => {
                e.stopPropagation();
                copyToClipboard(shareText);
                await downloadWithWatermark(photo.url, photo.id, e);
                alert("已複製文字並下載照片，請至 IG 發佈。");
            };
            return (
                <div className="flex items-center gap-2">
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(photo.url)}`, '_blank')}} className="bg-blue-600 text-white p-2 rounded-full hover:scale-110 transition-transform"><Facebook size={18} /></button>
                    <button onClick={(e) => {e.stopPropagation(); window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(photo.url)}`, '_blank')}} className="bg-green-500 text-white p-2 rounded-full hover:scale-110 transition-transform"><MessageCircle size={18} /></button>
                    <button onClick={handleIG} className="bg-pink-600 text-white p-2 rounded-full hover:scale-110 transition-transform"><Instagram size={18} /></button>
                </div>
            );
        };

        const Lightbox = ({ photo, onClose, isAdmin, onEdit, onDelete }) => {
            if (!photo) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-4" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white p-2 z-50"><X size={32} /></button>
                    
                    {isAdmin && (
                        <div className="absolute top-4 left-4 flex gap-2 z-50">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-600/80 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm"><Edit size={14} /> 編輯</button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); onClose(); }} className="bg-red-600/80 text-white px-3 py-1.5 rounded-full flex items-center gap-2 text-sm"><Trash2 size={14} /> 刪除</button>
                        </div>
                    )}

                    <div className="relative max-w-full max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <img src={photo.url} className="max-w-full max-h-[85vh] object-contain shadow-2xl rounded-sm" />
                        <div className="absolute -bottom-16 left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-white/10 backdrop-blur-md px-6 py-3 rounded-full border border-white/10">
                            <button onClick={(e) => downloadWithWatermark(photo.url, photo.id, e)} className="text-white hover:text-indigo-300 flex flex-col items-center gap-1">
                                <Download size={20} /><span className="text-[10px]">下載</span>
                            </button>
                            <div className="w-px h-8 bg-white/20 mx-2"></div>
                            <ShareButtons photo={photo} />
                        </div>
                    </div>
                    
                    <div className="mt-4 text-white/80 text-center">
                        <p className="text-white/60 text-xs font-mono mb-1">{photo.exif.shutter} · {photo.exif.aperture} · ISO {photo.exif.iso}</p>
                        <div className="flex items-center justify-center gap-4 text-sm font-medium">
                            <span className="flex items-center gap-1"><Clock size={14}/> {photo.date}</span>
                            <span className="flex items-center gap-1"><MapPin size={14}/> {photo.location.city}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const PhotoCard = ({ photo, onExpand, isAdmin, onEdit, onDelete }) => (
            <div className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 group flex flex-col h-full border border-gray-100 relative">
                {isAdmin && (
                    <div className="absolute top-2 left-2 z-20 flex gap-2">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(photo); }} className="bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600"><Edit size={14} /></button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(photo.id); }} className="bg-red-500 text-white p-2 rounded-full shadow-md hover:bg-red-600"><Trash2 size={14} /></button>
                    </div>
                )}
                <div className="relative aspect-[4/3] overflow-hidden bg-gray-100 cursor-zoom-in" onClick={() => onExpand(photo)}>
                    <img src={photo.url} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                    <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-2 z-10"><ShareButtons photo={photo} /></div>
                    <div className="absolute bottom-3 left-3 pointer-events-none"><span className="bg-black/60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-md flex items-center gap-1"><Clock size={12} /> {photo.date}</span></div>
                </div>
                <div className="p-5 flex flex-col flex-grow">
                    <div className="flex items-center text-gray-500 text-sm mb-3"><MapPin size={14} className="mr-1 text-indigo-500" />{photo.location.country} · {photo.location.city}</div>
                    <div className="flex flex-wrap gap-2 mb-4">{photo.tags.map(tag => (<span key={tag} className="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs rounded-full font-medium">#{tag}</span>))}</div>
                    <div className="space-y-3 mb-4 flex-grow">
                        {photo.thoughts_shooting && <div className="bg-gray-50 p-3 rounded-lg border-l-2 border-orange-300"><p className="text-gray-700 text-sm italic">"{photo.thoughts_shooting}"</p></div>}
                    </div>
                    <div className="border-t border-dashed border-gray-200 mt-3 pt-2 flex justify-between items-center"><span className="text-[10px] text-gray-400">CC BY 4.0 姓名標示</span><span className="text-[10px] font-bold text-gray-300 select-none">Linkc</span></div>
                </div>
            </div>
        );

        const PhotoForm = ({ onSave, onCancel, initialData, isSaving }) => {
            const isEditMode = !!initialData;
            const [formData, setFormData] = useState(initialData || { url: '', tags: '', thoughts_shooting: '', thoughts_viewing: '', exif: { shutter: '', aperture: 'f/', iso: '', date: new Date().toISOString().split('T')[0] }, location: { country: '', city: '', spot: '' } });
            const [status, setStatus] = useState(''); // 'fetching', 'uploading', 'error', ''
            const [uploadFile, setUploadFile] = useState(null); // 新增：檔案上傳狀態

            useEffect(() => { if (initialData && Array.isArray(initialData.tags)) { setFormData(prev => ({ ...prev, tags: initialData.tags.join(', ') })); } }, [initialData]);
            
            const handleChange = (section, field, value) => { if (section) { setFormData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } })); } else { setFormData(prev => ({ ...prev, [field]: value })); } };
            
            const handleFileChange = (e) => {
                if (e.target.files[0]) {
                    setUploadFile(e.target.files[0]);
                }
            };

            const handleSubmit = async (e) => { 
                e.preventDefault();
                setStatus('uploading');
                
                let finalUrl = formData.url;

                try {
                    // 如果有選擇檔案，優先處理檔案上傳
                    if (uploadFile) {
                        const filename = `photos/${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${uploadFile.name}`;
                        const storageRef = ref(storage, filename);
                        await uploadBytes(storageRef, uploadFile);
                        finalUrl = await getDownloadURL(storageRef);
                    } else if (formData.url) {
                         // 如果是輸入網址，檢查是否為 Google Photos
                        if (formData.url.includes('googleusercontent') || formData.url.includes('photos.app.goo.gl')) {
                            if (!confirm("警告：使用 Google Photos 連結極高機率會因為時效性而破圖。\n\n強烈建議您將照片下載後，使用「上傳檔案」功能。\n\n您確定要繼續使用連結嗎？")) {
                                setStatus('');
                                return;
                            }
                        }
                    } else {
                        alert("請選擇一張照片檔案上傳，或輸入圖片連結。");
                        setStatus('');
                        return;
                    }

                    const processedData = { 
                        ...formData, 
                        url: finalUrl,
                        tags: formData.tags.split(',').map(t => t.trim()).filter(t => t), 
                        date: formData.exif.date 
                    }; 
                    onSave(processedData); 

                } catch (err) {
                    console.error("上傳失敗", err);
                    alert("上傳失敗: " + err.message + "\n\n請確認您的 Firebase Storage 是否已啟用 (Test Mode)。");
                    setStatus('');
                }
            };

            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 animate-in slide-in-from-bottom-4 duration-300">
                    <div className="flex justify-between items-center mb-6 border-b pb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">{isEditMode ? <Edit className="text-blue-600" /> : <Upload className="text-indigo-600" />} {isEditMode ? '修改照片資訊' : '分享新照片'}</h2><button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><X size={24} /></button></div>
                    
                    {status === 'uploading' && (
                        <div className="mb-4 bg-blue-50 text-blue-700 p-4 rounded-lg flex items-center gap-2 animate-pulse">
                            <RefreshCw className="spinner" size={20} />
                            <span>正在上傳照片至雲端，請稍候...</span>
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-8">
                        {/* 圖片來源選擇區 */}
                        <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label className="block text-sm font-bold text-gray-700 mb-2">步驟 1：選擇照片來源</label>
                            
                            {/* 檔案上傳 (推薦) */}
                            <div className="relative">
                                <input type="file" accept="image/*" onChange={handleFileChange} className="hidden" id="file-upload" disabled={status === 'uploading'} />
                                <label htmlFor="file-upload" className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer hover:bg-gray-100 transition-colors ${uploadFile ? 'border-green-500 bg-green-50' : 'border-gray-300'}`}>
                                    {uploadFile ? (
                                        <>
                                            <Check className="w-8 h-8 text-green-500 mb-2" />
                                            <span className="text-sm font-medium text-green-600">已選擇：{uploadFile.name}</span>
                                            <span className="text-xs text-green-500 mt-1">(將會上傳至您的雲端)</span>
                                        </>
                                    ) : (
                                        <>
                                            <FileUp className="w-8 h-8 text-gray-400 mb-2" />
                                            <span className="text-sm font-medium text-gray-600">點擊上傳檔案 (推薦)</span>
                                            <span className="text-xs text-gray-500 mt-1">支援 Google Photos 下載後的照片，永久保存</span>
                                        </>
                                    )}
                                </label>
                            </div>

                            <div className="text-center text-gray-400 text-xs">- 或 -</div>

                            {/* 網址輸入 (備用) */}
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><LinkIcon className="h-4 w-4 text-gray-400" /></div>
                                <input type="url" placeholder="輸入圖片連結 (不推薦 Google Photos 連結)" className="block w-full pl-9 border-gray-300 rounded-lg p-2 text-sm border" value={formData.url} onChange={(e) => { handleChange(null, 'url', e.target.value); setUploadFile(null); }} disabled={uploadFile || status === 'uploading'} />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200"><label className="block text-sm font-bold text-gray-800 mb-1">標籤 (Tags)</label><input type="text" placeholder="風景, 台灣" className="block w-full border-gray-300 rounded-lg p-2.5 border" value={formData.tags} onChange={(e) => handleChange(null, 'tags', e.target.value)} /></div>
                                <div className="bg-orange-50 p-4 rounded-lg border border-orange-200"><label className="block text-sm font-bold text-gray-800 mb-1">拍攝感受</label><textarea rows="3" placeholder="..." className="block w-full border-gray-300 rounded-lg p-2.5 border resize-none" value={formData.thoughts_shooting} onChange={(e) => handleChange(null, 'thoughts_shooting', e.target.value)} /></div>
                                <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200"><label className="block text-sm font-bold text-gray-800 mb-1">欣賞感受</label><textarea rows="3" placeholder="..." className="block w-full border-gray-300 rounded-lg p-2.5 border resize-none" value={formData.thoughts_viewing} onChange={(e) => handleChange(null, 'thoughts_viewing', e.target.value)} /></div>
                            </div>
                            <div className="space-y-6 bg-gray-50 p-6 rounded-xl border border-gray-200">
                                <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">拍攝參數</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-medium text-gray-500">快門</label><input type="text" placeholder="1/200" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.shutter} onChange={(e) => handleChange('exif', 'shutter', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">光圈</label><input type="text" placeholder="f/2.8" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.aperture} onChange={(e) => handleChange('exif', 'aperture', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">ISO</label><input type="text" placeholder="400" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.iso} onChange={(e) => handleChange('exif', 'iso', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">日期</label><input type="date" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.exif.date} onChange={(e) => handleChange('exif', 'date', e.target.value)} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mt-4 pt-4 border-t">
                                    <div><label className="block text-xs font-medium text-gray-500">國家</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.country} onChange={(e) => handleChange('location', 'country', e.target.value)} /></div>
                                    <div><label className="block text-xs font-medium text-gray-500">城市</label><input type="text" className="mt-1 block w-full border-gray-300 rounded-md p-2 border" value={formData.location.city} onChange={(e) => handleChange('location', 'city', e.target.value)} /></div>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 pt-6">
                            <button type="button" onClick={onCancel} disabled={isSaving || status === 'uploading'} className="px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">取消</button>
                            <button type="submit" disabled={isSaving || status === 'uploading'} className={`px-6 py-2 border border-transparent rounded-lg text-sm font-medium text-white shadow-lg hover:shadow-xl transition-all flex items-center gap-2 ${isEditMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-indigo-600 hover:bg-indigo-700'} disabled:opacity-50`}>
                                {(isSaving || status === 'uploading') && <RefreshCw className="animate-spin" size={16} />} 
                                {status === 'uploading' ? '上傳中...' : (isEditMode ? '儲存修改' : '發佈照片')}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const AdminLogin = ({ onLogin, onCancel }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (password === '590123') onLogin(); else setPassword(''); };
            return (
                <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full"><h3 className="text-lg font-bold text-center mb-4">管理員登入</h3><form onSubmit={handleSubmit} className="space-y-4"><input type="password" placeholder="密碼" className="w-full text-center border p-2 rounded" value={password} onChange={(e) => setPassword(e.target.value)} autoFocus /><div className="flex gap-2"><button type="button" onClick={onCancel} className="flex-1 bg-gray-200 py-2 rounded">取消</button><button type="submit" className="flex-1 bg-indigo-600 text-white py-2 rounded">解鎖</button></div></form></div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('gallery');
            const [photos, setPhotos] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState(null);
            
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [editingPhoto, setEditingPhoto] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                if (!isConfigConfigured) return; 
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (err) { setAuthError(err.message); } };
                initAuth();
                onAuthStateChanged(auth, (user) => { setCurrentUser(user); if(user) setAuthError(null); });
            }, []);

            useEffect(() => {
                if (!currentUser || !db) return;
                const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => { setPhotos(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            }, [currentUser]);

            const handleSavePhoto = async (photoData) => {
                if (!currentUser) return;
                setIsSaving(true);
                try {
                    const collectionRef = collection(db, COLLECTION_NAME);
                    if (editingPhoto) {
                        await updateDoc(doc(collectionRef, photoData.id), { ...photoData });
                        setEditingPhoto(null);
                    } else {
                        await addDoc(collectionRef, { ...photoData, timestamp: Date.now() });
                    }
                    setView('gallery');
                } catch (e) { alert("儲存失敗: " + e.message); } finally { setIsSaving(false); }
            };

            const handleDeletePhoto = async (id) => {
                if (!currentUser) return;
                if(window.confirm('確定要永久刪除？')) {
                    try { await deleteDoc(doc(db, COLLECTION_NAME, id)); } catch(e) { alert("刪除失敗"); }
                }
            };

            const startEdit = (photo) => { setEditingPhoto(photo); setView('upload'); if (selectedPhoto) setSelectedPhoto(null); };

            if (!isConfigConfigured) return <ConfigError />;
            if (authError) return <AuthError message={authError} />;

            const allTags = [...new Set(photos.flatMap(p => p.tags))];
            const filteredPhotos = photos.filter(photo => {
                const matchesSearch = JSON.stringify(photo).toLowerCase().includes(searchQuery.toLowerCase());
                const matchesTag = activeTag ? (photo.tags || []).includes(activeTag) : true;
                return matchesSearch && matchesTag;
            });

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                <Header setView={(v) => { setView(v); setEditingPhoto(null); }} isAdmin={isAdmin} onLoginClick={() => setShowLogin(true)} onLogout={() => { setIsAdmin(false); alert("已登出"); }} />
                {showLogin && (<AdminLogin onLogin={() => { setIsAdmin(true); setShowLogin(false); }} onCancel={() => setShowLogin(false)} />)}
                {selectedPhoto && (<Lightbox photo={selectedPhoto} onClose={() => setSelectedPhoto(null)} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />)}

                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    {view === 'gallery' ? (
                    <>
                        <div className="flex flex-col md:flex-row gap-6 mb-8">
                            <div className="relative flex-grow max-w-xl"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Search className="h-5 w-5 text-gray-400" /></div><input type="text" placeholder="搜尋..." className="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>
                            <div className="flex-1 flex flex-wrap gap-2 items-center"><span className="text-sm font-bold text-gray-400 mr-2 flex items-center gap-1"><Tag size={14} /> 分類:</span><button onClick={() => setActiveTag(null)} className={`px-3 py-1 rounded-full text-sm ${!activeTag ? 'bg-gray-800 text-white' : 'bg-white text-gray-600'}`}>全部</button>{allTags.map(tag => (<button key={tag} onClick={() => setActiveTag(tag === activeTag ? null : tag)} className={`px-3 py-1 rounded-full text-sm ${tag === activeTag ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600 border'}`}>{tag}</button>))}</div>
                        </div>
                        {filteredPhotos.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">{filteredPhotos.map(photo => (<PhotoCard key={photo.id} photo={photo} onExpand={setSelectedPhoto} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDeletePhoto} />))}</div>
                        ) : (
                        <div className="text-center py-20 bg-white rounded-xl shadow-sm border border-dashed border-gray-300"><Cloud className="mx-auto h-12 w-12 text-gray-300 mb-3" /><h3 className="text-lg font-medium text-gray-900">資料庫是空的</h3><button onClick={() => setView('upload')} className="mt-4 text-indigo-600 hover:text-indigo-800 font-medium">上傳第一張照片 &rarr;</button></div>
                        )}
                    </>
                    ) : (
                    <PhotoForm onSave={handleSavePhoto} onCancel={() => { setView('gallery'); setEditingPhoto(null); }} initialData={editingPhoto} isSaving={isSaving} />
                    )}
                </main>
                <footer className="bg-white border-t border-gray-200 mt-12 py-8"><div className="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm"><p>© {new Date().getFullYear()} Linkc Photo Space.</p><p className="mt-1">Content Creative Commons Attribution (CC BY).</p></div></footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
