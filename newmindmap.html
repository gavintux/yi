<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Mindomo 檔案列表</title>
  <style>
    #apiDiv, #searchDiv, #sortDiv { margin: 20px 0; }
    #apiKey { user-select: none; }
    #apiDiv { display: block; }
    #fileTable { border-collapse: collapse; width: 100%; }
    #fileTable th, #fileTable td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    #hideTip { color: #888; font-size: 12px; }
  </style>
</head>
<body>
<div id="apiDiv">
  <label>輸入 Mindomo API key：</label>
  <input type="password" id="apiKey" autocomplete="new-password">
  <button onclick="submitKey()">確認</button>
  <span id="hideTip">（只保存於本頁面記憶體，輸入後隱藏且不可複製，不外洩）</span>
</div>
<div id="sortDiv" style="display:none">
  <label>排序依據：</label>
  <select id="sortKey" onchange="renderTable()">
    <option value="name">檔案名稱</option>
    <option value="createdAt">建立時間</option>
    <option value="updatedAt">修改時間</option>
  </select>
  <select id="sortOrder" onchange="renderTable()">
    <option value="asc">遞增</option>
    <option value="desc">遞減</option>
  </select>
</div>
<div id="searchDiv" style="display:none">
  <label>搜尋檔名：</label>
  <input type="text" id="search" oninput="renderTable()">
</div>
<table id="fileTable" style="display:none">
  <thead>
    <tr>
      <th>類別</th>
      <th>檔名</th>
      <th>建立時間</th>
      <th>修改時間</th>
    </tr>
  </thead>
  <tbody id="fileBody"></tbody>
</table>

<script>
let apiKey = "";
let allFiles = [];

function submitKey() {
  apiKey = document.getElementById("apiKey").value;
  document.getElementById("apiDiv").style.display = "none";
  document.getElementById("searchDiv").style.display = "block";
  document.getElementById("fileTable").style.display = "table";
  document.getElementById("sortDiv").style.display = "block";
  fetchFiles();
}

// 禁止 API key 複製，不允許 user-select
document.getElementById("apiKey").addEventListener('copy', function(e) { e.preventDefault(); });

function fetchFiles() {
  fetch("https://www.mindomo.com/api/v1/diagrams", {
    headers: { Authorization: `Bearer ${apiKey}` }
  })
  .then(response => response.json())
  .then(files => {
    allFiles = Array.isArray(files) ? files : [];
    renderTable();
  });
}

function renderTable() {
  const tbody = document.getElementById("fileBody");
  tbody.innerHTML = "";
  const searchVal = document.getElementById("search").value.toLowerCase();
  const sortKey = document.getElementById("sortKey").value;
  const sortOrder = document.getElementById("sortOrder").value;

  const filteredFiles = allFiles.filter(file =>
    (file.name || "").toLowerCase().includes(searchVal)
  );

  // 排序
  filteredFiles.sort((a, b) => {
    const aVal = a[sortKey] || "";
    const bVal = b[sortKey] || "";
    if (sortKey === "createdAt" || sortKey === "updatedAt") {
      const aTime = new Date(aVal).getTime();
      const bTime = new Date(bVal).getTime();
      return sortOrder === "asc" ? aTime - bTime : bTime - aTime;
    }
    return sortOrder === "asc"
      ? aVal.localeCompare(bVal, "zh-Hant")
      : bVal.localeCompare(aVal, "zh-Hant");
  });

  filteredFiles.forEach(file => {
    const category = file.category || file.folder || "";
    const row = `<tr>
      <td>${category}</td>
      <td>${file.name || ""}</td>
      <td>${file.createdAt || ""}</td>
      <td>${file.updatedAt || ""}</td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}
</script>
</body>
</html>
