import React, { useState, useEffect } from "react";
import { Table, Input, Button, Modal } from "antd";

// 1. 使用者輸入 API KEY，存在 State，輸入後隱藏
function MindomoFileList() {
  const [apiKey, setApiKey] = useState("");
  const [showInput, setShowInput] = useState(true);
  const [data, setData] = useState([]);
  const [search, setSearch] = useState("");

  // 提交 API key 後隱藏，不再顯示欄位
  const handleKeySubmit = () => setShowInput(false);

  // 取得資料：GET diagrams
  useEffect(() => {
    if (apiKey) {
      fetch("https://www.mindomo.com/api/v1/diagrams", {
        headers: {
          Authorization: `Bearer ${apiKey}`,
        },
      })
        .then(res => res.json())
        .then(res => setData(res)); // 假設回傳為 array
    }
  }, [apiKey]);

  // 關鍵字搜尋
  const filteredData = data.filter(item =>
    item.name.toLowerCase().includes(search.toLowerCase())
  );

  // 表格欄位設計
  const columns = [
    { title: "類別", dataIndex: "category", key: "category" },
    { title: "檔名", dataIndex: "name", key: "name" },
    { title: "建立時間", dataIndex: "createdAt", key: "createdAt" },
    { title: "修改時間", dataIndex: "updatedAt", key: "updatedAt" }
  ];

  return (
    <div>
      {showInput && (
        <Modal
          title="輸入Mindomo API Key"
          visible={showInput}
          onOk={handleKeySubmit}
          okText="確定"
          cancelButtonProps={{ style: { display: 'none' } }}
          closable={false}
        >
          <Input.Password
            placeholder="請貼上 API Key"
            onChange={e => setApiKey(e.target.value)}
            style={{ userSelect: "none" }} // 禁止鍵選
          />
          <div style={{ fontSize: 12, color: "#888" }}>此欄輸入後將隱藏，且你的瀏覽器不會顯示明文 key</div>
        </Modal>
      )}
      {!showInput && (
        <div>
          <Input.Search
            placeholder="搜尋檔名..."
            onChange={e => setSearch(e.target.value)}
            style={{ width: 250, marginBottom: 12 }}
          />
          <Table columns={columns} dataSource={filteredData} rowKey="id" />
        </div>
      )}
    </div>
  );
}

export default MindomoFileList;
