<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMap Garden</title>
    
    <!-- 設定瀏覽器分頁圖示 (Favicon) -->
    <link rel="icon" href="https://2blog.ilc.edu.tw/linkc/wp-content/uploads/sites/141/2024/12/linkc-logo.png" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap');
        
        :root {
            --garden-bg: #f5f5f4; /* Stone 100 */
            --sidebar-bg: #ffffff;
            --primary-green: #059669; /* Emerald 600 */
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--garden-bg);
            color: #44403c; /* Stone 700 */
        }

        /* 玻璃擬態特效 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* 自訂捲軸樣式 - 更細緻 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d6d3d1; /* Stone 300 */
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #a8a29e; /* Stone 400 */
        }

        .appearance-none {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Tooltip 樣式 */
        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 50;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            width: 280px;
            background-color: #292524; /* Stone 800 */
            color: #fafaf9;
            text-align: left;
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            line-height: 1.6;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateY(2px);
        }

        /* 漸層封面產生器樣式 */
        .pattern-grid {
            background-image: radial-gradient(rgba(255, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .pattern-wave {
            background: repeating-linear-gradient( 45deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px );
        }
        
        /* 下拉選單動畫 */
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in {
            animation: scaleIn 0.1s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // 定義主類別架構
        const PARA_ROOTS = ['00inbox', '01專案', '02領域', '03資源', '04檔案'];

        // 模擬資料 (Fallback)
        const INITIAL_MOCK_DATA = [
            { id: "1", title: "2025 年度目標規劃", description: "包含 #工作 #學習 的年度大計畫 #share", modified_at: "2025-01-21T09:00:00Z" },
            { id: "2", title: "網站改版架構圖", description: "公司官網設計 #工作 #專案 #急件", modified_at: "2025-01-15T14:30:00Z" },
            { id: "3", title: "個人財務報表", description: "每季回顧 #健康 #財務", modified_at: "2025-01-10T11:00:00Z" },
            { id: "4", title: "Python 學習筆記", description: "爬蟲與數據分析 #學習 #程式 #Coding #share", modified_at: "2025-01-18T16:00:00Z" },
            { id: "5", title: "健身菜單", description: "重訓與飲食控制 #健康 #運動", modified_at: "2024-12-25T10:15:00Z" },
            { id: "6", title: "雜七雜八的想法", description: "還沒整理的靈感", modified_at: "2025-01-22T10:00:00Z" }, 
            { id: "7", title: "日本旅遊攻略", description: "行程安排 #旅遊 #休閒 #2025 #share", modified_at: "2024-11-05T09:00:00Z" },
            { id: "8", title: "讀書筆記：原子習慣", description: "#學習 #閱讀 #習慣 #share", modified_at: "2024-11-01T09:00:00Z" },
            { id: "9", title: "Q1 專案檢討", description: "#工作 #專案 #會議", modified_at: "2025-02-01T09:00:00Z" }
        ];

        const extractTags = (text) => {
            if (!text || typeof text !== 'string') return [];
            const cleanText = text.replace(/<[^>]*>?/gm, '');
            const matches = cleanText.match(/#[\S]+/g);
            if (!matches) return [];
            return matches.map(tag => tag.substring(1)).filter(t => t.length > 0);
        };
        
        const formatDate = (isoString) => {
            if (!isoString) return "無資料";
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return "日期錯誤";
            return new Intl.DateTimeFormat('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }).format(date);
        };

        // --- 視覺產生器：為每個檔案產生獨特的漸層封面 ---
        const generateVisualIdentity = (id, title) => {
            const str = id + title;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            // 定義幾個符合「花園」主題的色票
            const palettes = [
                ['from-emerald-400 to-cyan-500', 'from-teal-400 to-yellow-200'], // 森林系
                ['from-rose-300 to-orange-300', 'from-amber-200 to-yellow-400'], // 暖陽系
                ['from-fuchsia-300 to-purple-400', 'from-violet-400 to-fuchsia-300'], // 花朵系
                ['from-blue-400 to-indigo-400', 'from-sky-300 to-blue-500'], // 湖泊系
                ['from-lime-400 to-green-500', 'from-emerald-300 to-lime-300']  // 草地系
            ];
            
            const paletteIndex = Math.abs(hash) % palettes.length;
            const gradientType = Math.abs(hash >> 1) % 2; // 0 或 1，決定漸層方向或樣式
            
            return {
                gradient: palettes[paletteIndex][gradientType],
                isWave: (Math.abs(hash >> 2) % 2) === 0 // 是否有波紋效果
            };
        };

        // Icons (使用 Lucide 風格 SVG)
        const Icons = {
            Leaf: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.79 8.55-9.76 10H11Z"/><path d="M8 14h.01"/><path d="M12.5 9h.01"/></svg>,
            Flower: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 7.5a4.5 4.5 0 1 1 4.5 4.5M12 7.5A4.5 4.5 0 1 0 7.5 12M12 7.5V9m-4.5 3a4.5 4.5 0 1 1 4.5 4.5M7.5 12H9m3 4.5a4.5 4.5 0 1 1 4.5-4.5M12 16.5V15m4.5-3a4.5 4.5 0 1 0-4.5-4.5M16.5 12H15"/></svg>,
            Portal: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m4.93 4.93 14.14 14.14"/><path d="m14.83 9.17-5.66 5.66"/></svg>,
            ExternalLink: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            File: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Tag: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>,
            Grid: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Refresh: ({ spin }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={spin ? "animate-spin" : ""}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            SortAsc: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="M11 4h10"/><path d="M11 8h7"/><path d="M11 12h4"/></svg>,
            SortDesc: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/><path d="M11 12h4"/><path d="M11 16h7"/><path d="M11 20h10"/></svg>,
            ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            Bug: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Share2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
            Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-500 fill-emerald-100"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Circle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-white drop-shadow-md"><circle cx="12" cy="12" r="10"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        };

        const ITEMS_PER_PAGE = 9;
        const HARDCODED_TOKEN = 'KgWdA3krt3dkuS3yQ0TWiOghaYeSGR_tp7u_SV9k_go';
        const ACCESS_PASSWORD = '590123';

        // 密碼輸入視窗
        const PasswordModal = ({ onSubmit, onClose }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = () => {
                if (input === ACCESS_PASSWORD) {
                    onSubmit();
                } else {
                    setError('密碼錯誤');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-stone-900 bg-opacity-40 animate-fade-in p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6 border border-stone-100">
                        <h3 className="text-lg font-bold text-stone-800 mb-4 flex items-center gap-2"><Icons.Lock /> 管理員權限驗證</h3>
                        <p className="text-sm text-stone-600 mb-4">請輸入密碼以進入花園深處：</p>
                        <input 
                            type="password" 
                            value={input}
                            onChange={(e) => { setInput(e.target.value); setError(''); }}
                            onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
                            className="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none mb-2 text-stone-800"
                            placeholder="輸入密碼"
                            autoFocus
                        />
                        {error && <p className="text-xs text-rose-500 mb-2">{error}</p>}
                        <div className="flex justify-end gap-2 mt-4">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-stone-500 hover:bg-stone-100 rounded-xl transition-colors">取消</button>
                            <button onClick={handleSubmit} className="px-4 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-xl transition-colors shadow-lg shadow-emerald-600/20">確認</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [apiToken] = useState(HARDCODED_TOKEN);
            const [isAuthorized, setIsAuthorized] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);

            const [diagrams, setDiagrams] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            const [useRealApi, setUseRealApi] = useState(true);
            const [showDebug, setShowDebug] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [debouncedSearchTerm, setDebouncedSearchTerm] = useState('');

            const [rawData, setRawData] = useState(null);
            const [downloadingState, setDownloadingState] = useState(null);
            
            const [activeCategory, setActiveCategory] = useState('all'); 
            const [currentPage, setCurrentPage] = useState(1);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [tagSearchQuery, setTagSearchQuery] = useState('');
            const [isTagExpanded, setIsTagExpanded] = useState(false);
            const [sortField, setSortField] = useState('modified_at');
            const [sortOrder, setSortOrder] = useState('desc');
            
            // 選取功能狀態
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [collectionIds, setCollectionIds] = useState(null); // 從 URL 讀取的分享 ID 列表

            // 檢查 URL 參數，讀取分享的 IDs
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const idsParam = params.get('ids');
                if (idsParam) {
                    const ids = idsParam.split(',').filter(id => id.trim().length > 0);
                    if (ids.length > 0) {
                        setCollectionIds(ids);
                        setActiveCategory('shared_collection'); // 自動切換到分享檢視模式
                    }
                }
            }, []);

            // 搜尋防抖動
            useEffect(() => {
                const timer = setTimeout(() => setDebouncedSearchTerm(searchTerm), 300);
                return () => clearTimeout(timer);
            }, [searchTerm]);

            useEffect(() => {
                if (!useRealApi) {
                     const normalizedMock = INITIAL_MOCK_DATA.map(item => ({
                         ...item,
                         tags: extractTags(item.description) 
                     }));
                     setDiagrams(normalizedMock);
                     setRawData(INITIAL_MOCK_DATA);
                } else {
                    fetchDiagrams();
                }
            }, [useRealApi]);

            useEffect(() => {
                setCurrentPage(1);
            }, [debouncedSearchTerm, activeCategory, sortField, sortOrder, collectionIds]);

            const fetchDiagrams = async () => {
                if (!apiToken) { setError("程式碼中未設定 Token"); return; }
                setLoading(true); setError(null);
                setRawData(null);
                try {
                    const response = await fetch('https://www.mindomo.com/api/v1/diagrams', {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${apiToken}`, 'Content-Type': 'application/json' }
                    });
                    if (!response.ok) {
                        if (response.status === 401) throw new Error("認證失敗：Token 無效");
                        if (response.status === 403) throw new Error("權限不足");
                        throw new Error(`API 錯誤: ${response.status}`);
                    }
                    const data = await response.json();
                    setRawData(data);
                    let items = Array.isArray(data) ? data : (data.diagrams || []);
                    
                    const normalizedData = items.map(item => {
                        const modDate = item.modified || item.lastModified || item.modified_at || item.updated || item.updated_at || item.dateModified || item.last_modified;
                        const createDate = item.created_at || item.creationDate || item.created || item.dateCreated;
                        const description = item.description || item.note || ""; 
                        const tags = extractTags(description);

                        return {
                            id: item.id,
                            title: item.title || item.name || "未命名檔案",
                            description: description,
                            tags: tags, 
                            thumbnailUrl: item.thumbnailUrl || item.thumbnail_url,
                            created_at: createDate || new Date().toISOString(),
                            modified_at: modDate || createDate,
                            _raw: item
                        };
                    });
                    setDiagrams(normalizedData);
                } catch (err) {
                    console.error(err);
                    setError(err.message + " (若是 CORS 錯誤，請嘗試 Demo 模式)");
                } finally {
                    setLoading(false);
                }
            };

            const handleDownload = async (e, item, format) => {
                e.stopPropagation();
                if (!apiToken) { alert("API Token 設定錯誤"); return; }
                setDownloadingState({ id: item.id, format: format });
                try {
                    const apiFormat = format === 'md' ? 'txt' : format;
                    if (!useRealApi) {
                        await new Promise(resolve => setTimeout(resolve, 800));
                        alert(`(Demo 模式) 模擬下載 ${item.title}.${format}`);
                        setDownloadingState(null);
                        return;
                    }
                    const response = await fetch(`https://www.mindomo.com/api/v1/diagrams/${item.id}.${apiFormat}`, {
                        headers: { 'Authorization': `Bearer ${apiToken}` }
                    });
                    if (!response.ok) throw new Error(`API 錯誤: ${response.status} ${response.statusText}`);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${item.title}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (err) {
                    console.error(err);
                    alert('下載失敗: ' + err.message);
                } finally {
                    setDownloadingState(null);
                }
            };

            const toggleSelection = (e, id) => {
                e.stopPropagation();
                const newSelection = new Set(selectedIds);
                if (newSelection.has(id)) {
                    newSelection.delete(id);
                } else {
                    newSelection.add(id);
                }
                setSelectedIds(newSelection);
            };

            const handleGenerateCollectionLink = () => {
                if (selectedIds.size === 0) return;
                try {
                    const idsString = Array.from(selectedIds).join(',');
                    // 建構標準 URL
                    const url = new URL(window.location.href);
                    url.search = `?ids=${idsString}`;
                    const shareUrl = url.toString();

                    // 複製到剪貼簿
                    const fallbackCopy = (text) => {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert(`分享連結已複製！\n\n包含了 ${selectedIds.size} 個檔案。`);
                        } catch (err) {
                            console.error('Copy failed', err);
                            prompt("無法自動複製，請手動複製連結：", text);
                        }
                        document.body.removeChild(textArea);
                    };

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(shareUrl).then(() => {
                            alert(`分享連結已複製！\n\n包含了 ${selectedIds.size} 個檔案。`);
                        }).catch(() => fallbackCopy(shareUrl));
                    } else {
                        fallbackCopy(shareUrl);
                    }
                } catch (e) {
                    console.error("URL gen failed", e);
                }
            };

            const clearSelection = () => {
                setSelectedIds(new Set());
            };

            const permittedDiagrams = useMemo(() => {
                if (isAuthorized) return diagrams;
                return diagrams.filter(item => 
                    item.tags && item.tags.some(t => t.toLowerCase() === 'share')
                );
            }, [diagrams, isAuthorized]);

            const sortedTags = useMemo(() => {
                const tagsCount = {};
                permittedDiagrams.forEach(d => {
                    if (d.tags && d.tags.length > 0) {
                        d.tags.forEach(tag => {
                            tagsCount[tag] = (tagsCount[tag] || 0) + 1;
                        });
                    }
                });
                return Object.entries(tagsCount)
                    .sort(([, a], [, b]) => b - a) 
                    .map(([tag, count]) => ({ name: tag, count }));
            }, [permittedDiagrams]);

            const visibleTags = useMemo(() => {
                let tags = sortedTags;
                if (tagSearchQuery) {
                    tags = tags.filter(t => t.name.toLowerCase().includes(tagSearchQuery.toLowerCase()));
                }
                if (!isTagExpanded && !tagSearchQuery) {
                    return tags.slice(0, 10);
                }
                return tags;
            }, [sortedTags, tagSearchQuery, isTagExpanded]);

            const checkBooleanSearch = (item, query) => {
                try {
                    // 1. 預處理：轉小寫、全形轉半形
                    let evalStr = query.toLowerCase()
                        .replace(/＆/g, '&').replace(/｜/g, '|').replace(/！/g, '!')
                        .replace(/（/g, '(').replace(/）/g, ')');

                    // 2. 支援文字型運算子
                    evalStr = evalStr
                        .replace(/\bnot\b/g, '!')
                        .replace(/\band\b/g, '&')
                        .replace(/\bor\b/g, '|');

                    // 3. 運算子標準化
                    evalStr = evalStr
                        .replace(/&/g, ' && ')
                        .replace(/\|/g, ' || ')
                        .replace(/!/g, ' ! ')
                        .replace(/\(/g, ' ( ')
                        .replace(/\)/g, ' ) ');

                    const itemTags = new Set((item.tags || []).map(t => t.toLowerCase()));
                    const title = (item.title || '').toLowerCase();
                    const desc = (item.description || '').toLowerCase();
                    
                    // 4. 解析 Token (非運算子、非空白)
                    evalStr = evalStr.replace(/[^&|!()\s]+/g, (token) => {
                        // 避免取代已存在的布林關鍵字
                        if (token === 'true' || token === 'false') return token;
                        if (token === '&&' || token === '||' || token === '!') return token;

                        if (token.startsWith('#')) {
                            // 標籤搜尋
                            const cleanTagName = token.substring(1); 
                            return itemTags.has(cleanTagName) ? 'true' : 'false';
                        } else {
                            // 內文搜尋 (標題或描述)
                            return (title.includes(token) || desc.includes(token)) ? 'true' : 'false';
                        }
                    });

                    // 隱式 AND 支援 (兩個布林值中間有空白)
                    evalStr = evalStr.replace(/(true|false|\))\s+(?=(true|false|\(|!))/g, '$1 && ');

                    // 5. 安全性檢查
                    if (!/^(true|false|&&|\|\||!|\(|\)|\s)+$/.test(evalStr)) return null;
                    
                    return new Function(`return (${evalStr})`)();
                } catch (e) {
                    return null;
                }
            };

            const processedData = useMemo(() => {
                let baseList = [...permittedDiagrams];
                const trimmedTerm = debouncedSearchTerm.trim();

                if (trimmedTerm) {
                    baseList = baseList.filter(item => {
                        // 嘗試布林搜尋
                        // 只要有布林符號、關鍵字或 #，都嘗試解析
                        const hasBooleanChars = /[&|!()]/.test(trimmedTerm) || /\b(and|or|not)\b/i.test(trimmedTerm);
                        const hasTags = /#/.test(trimmedTerm);
                        
                        // 嘗試解析布林搜尋
                        const booleanResult = checkBooleanSearch(item, trimmedTerm);
                        
                        // 如果布林解析成功 (不是 null)，直接回傳結果
                        if (booleanResult !== null) return booleanResult;

                        // 降級：一般文字搜尋 (容錯處理)
                        const lower = trimmedTerm.toLowerCase();
                        
                        // 特殊處理：如果搜尋詞是單一 #tag (未被布林解析捕獲的情況)
                        let tagMatch = false;
                        if (lower.startsWith('#')) {
                            const cleanTag = lower.substring(1);
                            tagMatch = item.tags && item.tags.some(t => t.toLowerCase().includes(cleanTag));
                        }

                        return item.title.toLowerCase().includes(lower) || 
                               (item.description && item.description.toLowerCase().includes(lower)) ||
                               (item.tags && item.tags.some(t => t.toLowerCase().includes(lower))) || 
                               tagMatch;
                    });
                }
                
                let filtered = [];
                // 優先處理 Collection View
                if (activeCategory === 'shared_collection' && collectionIds) {
                    filtered = baseList.filter(item => collectionIds.includes(String(item.id)));
                } else if (activeCategory === 'recent') {
                    filtered = [...baseList]
                        .filter(item => item.modified_at)
                        .sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at))
                        .slice(0, 20);
                } else if (activeCategory === 'all') {
                    filtered = baseList;
                } else if (activeCategory === 'uncategorized') {
                    filtered = baseList.filter(item => !item.tags || item.tags.length === 0);
                } else if (activeCategory !== 'shared_collection') {
                    filtered = baseList.filter(item => item.tags && item.tags.includes(activeCategory));
                }

                if (activeCategory !== 'recent') {
                    filtered.sort((a, b) => {
                        let valA = a[sortField];
                        let valB = b[sortField];
                        if (!valA && !valB) return 0;
                        if (!valA) return 1;
                        if (!valB) return -1;
                        let comparison = 0;
                        if (sortField === 'title') comparison = valA.localeCompare(valB, 'zh-Hant');
                        else comparison = new Date(valA) - new Date(valB);
                        return sortOrder === 'asc' ? comparison : -comparison;
                    });
                }
                const totalItems = filtered.length;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                const items = filtered.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
                return { items, totalItems, totalPages };
            }, [permittedDiagrams, debouncedSearchTerm, activeCategory, currentPage, sortField, sortOrder, collectionIds]);

            const Pagination = () => {
                if (processedData.totalPages <= 1) return null;
                return (
                    <div className="flex justify-center items-center gap-4 mt-12 pb-8">
                        <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="p-2 bg-white border border-stone-200 rounded-full hover:bg-stone-50 disabled:opacity-30 shadow-sm transition-all"><Icons.ChevronLeft /></button>
                        <span className="text-sm font-medium text-stone-600 bg-white px-4 py-1.5 rounded-full border border-stone-200 shadow-sm">第 {currentPage} / {processedData.totalPages} 頁</span>
                        <button onClick={() => setCurrentPage(p => Math.min(processedData.totalPages, p + 1))} disabled={currentPage === processedData.totalPages} className="p-2 bg-white border border-stone-200 rounded-full hover:bg-stone-50 disabled:opacity-30 shadow-sm transition-all"><Icons.ChevronRight /></button>
                    </div>
                );
            };

            const SidebarItem = ({ id, label, icon, count, activeOverride }) => (
                <button 
                    onClick={() => { setActiveCategory(id); setIsMobileMenuOpen(false); }} 
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 mb-1.5
                    ${(activeCategory === id || activeOverride) 
                        ? 'bg-emerald-50 text-emerald-700 shadow-sm border border-emerald-100' 
                        : 'text-stone-600 hover:bg-white hover:shadow-sm hover:text-stone-800 border border-transparent'}`}
                >
                    {icon}
                    <span className="flex-grow text-left truncate">{label}</span>
                    {count !== undefined && <span className="text-xs text-stone-400 bg-stone-100 px-2 py-0.5 rounded-full">{count}</span>}
                </button>
            );

            // 花園卡片組件
            const GardenCard = ({ item }) => {
                const visual = useMemo(() => generateVisualIdentity(item.id, item.title), [item.id, item.title]);
                const [showShareMenu, setShowShareMenu] = useState(false);
                const [copyFeedback, setCopyFeedback] = useState(null);
                const menuRef = useRef(null);
                const isSelected = selectedIds.has(item.id);

                // 點擊外部關閉選單
                useEffect(() => {
                    const handleClickOutside = (event) => {
                        if (menuRef.current && !menuRef.current.contains(event.target)) {
                            setShowShareMenu(false);
                        }
                    };
                    document.addEventListener("mousedown", handleClickOutside);
                    return () => {
                        document.removeEventListener("mousedown", handleClickOutside);
                    };
                }, []);

                const handleCopyLink = (e, type) => {
                    e.stopPropagation();
                    let url = "";
                    if (type === 'mindomo') {
                        url = `https://www.mindomo.com/mindmap/${item.id}`;
                    }
                    
                    const onSuccess = () => {
                        setCopyFeedback(type);
                        setTimeout(() => setCopyFeedback(null), 2000);
                        setTimeout(() => setShowShareMenu(false), 800);
                    };

                    const fallbackCopy = (text) => {
                        try {
                            const textArea = document.createElement("textarea");
                            textArea.value = text;
                            textArea.style.position = "fixed";
                            textArea.style.left = "-9999px";
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            const successful = document.execCommand('copy');
                            document.body.removeChild(textArea);
                            if (successful) onSuccess();
                            else alert('複製失敗，請手動複製連結');
                        } catch (err) {
                            console.error('Fallback copy error', err);
                        }
                    }

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(url).then(onSuccess).catch(err => {
                            console.warn('Clipboard API blocked, trying fallback...', err);
                            fallbackCopy(url);
                        });
                    } else {
                        fallbackCopy(url);
                    }
                };
                
                return (
                    <div onClick={() => window.open(`https://www.mindomo.com/mindmap/${item.id}`, '_blank')} 
                         className={`group bg-white rounded-2xl border border-stone-100 shadow-sm hover:shadow-lg transition-all duration-300 flex flex-col h-full overflow-hidden cursor-pointer transform hover:-translate-y-1 relative ${isSelected ? 'ring-2 ring-emerald-500' : ''}`}>
                        
                        {/* 1. 視覺封面區 */}
                        <div className={`h-16 relative overflow-hidden bg-gradient-to-br ${visual.gradient}`}>
                            <div className={`absolute inset-0 opacity-20 ${visual.isWave ? 'pattern-wave' : 'pattern-grid'}`}></div>
                            <div className="absolute -bottom-6 -right-6 text-white opacity-10 transform rotate-12 group-hover:scale-110 transition-transform duration-500">
                                <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                            </div>
                            {/* 選取 Toggle 按鈕 (置於左上角) */}
                            <button onClick={(e) => toggleSelection(e, item.id)} className="absolute top-2 left-2 p-1.5 hover:scale-110 transition-transform z-10">
                                {isSelected ? <Icons.CheckCircle /> : <Icons.Circle />}
                            </button>
                            <div className="absolute top-2 right-3 bg-white/20 backdrop-blur-md px-2 py-0.5 rounded-lg border border-white/30 text-white text-[10px] font-medium">
                                Mind Map
                            </div>
                        </div>

                        {/* 2. 內容資訊區 */}
                        <div className="p-5 flex-1 flex flex-col">
                            <div className="flex items-start justify-between gap-3 mb-3">
                                <h3 className={`font-bold text-stone-800 leading-snug group-hover:text-emerald-600 transition-colors text-lg line-clamp-2`}>
                                    {item.title}
                                </h3>
                            </div>
                            
                            {/* 標籤 */}
                            <div className="flex flex-wrap gap-1.5 mb-4">
                                {item.tags && item.tags.length > 0 ? (
                                    item.tags.map(tag => (
                                        <span key={tag} onClick={(e) => { e.stopPropagation(); setActiveCategory(tag); }} 
                                              className="inline-flex items-center px-2 py-0.5 rounded-md text-[11px] font-medium bg-stone-50 text-stone-500 border border-stone-100 hover:bg-emerald-50 hover:text-emerald-600 hover:border-emerald-100 transition-colors">
                                            #{tag}
                                        </span>
                                    ))
                                ) : (
                                    <span className="text-xs text-stone-300 italic">無標籤</span>
                                )}
                            </div>

                            <div className="mt-auto pt-4 border-t border-stone-50 flex items-center justify-between">
                                <div className="flex items-center text-xs text-stone-400 gap-1.5">
                                    <Icons.Clock />
                                    <span>{formatDate(item.modified_at).split(' ')[0]}</span>
                                </div>
                                
                                <div className="flex gap-1 relative" ref={menuRef}>
                                    {/* 分享按鈕 */}
                                    <button onClick={(e) => { e.stopPropagation(); setShowShareMenu(!showShareMenu); }}
                                            className={`px-2 py-1 text-stone-400 bg-stone-50 hover:bg-stone-100 rounded border border-stone-200 transition-colors hover:text-emerald-600 ${showShareMenu ? 'bg-stone-100 text-emerald-600' : ''}`}
                                            title="分享連結">
                                        <Icons.Share2 />
                                    </button>

                                    {/* 分享選單 Popup */}
                                    {showShareMenu && (
                                        <div className="absolute bottom-full right-0 mb-2 w-48 bg-white rounded-xl shadow-xl border border-stone-100 overflow-hidden z-20 animate-scale-in flex flex-col p-1">
                                            <div className="text-[10px] font-bold text-stone-400 px-2 py-1 uppercase tracking-wider">複製連結</div>
                                            
                                            <button onClick={(e) => handleCopyLink(e, 'mindomo')} 
                                                    className="flex items-center justify-between px-2 py-2 text-xs text-stone-600 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors text-left group/btn">
                                                <span className="flex items-center gap-2"><Icons.ExternalLink /> Mindomo 網頁連結</span>
                                                {copyFeedback === 'mindomo' ? <span className="text-emerald-500"><Icons.Check /></span> : <span className="opacity-0 group-hover/btn:opacity-50"><Icons.Copy /></span>}
                                            </button>
                                        </div>
                                    )}

                                    <div className="w-px bg-stone-200 mx-1 h-5 self-center"></div>

                                    {/* 新增 PNG 下載按鈕 */}
                                    <button onClick={(e) => handleDownload(e, item, 'png')} disabled={downloadingState && downloadingState.id === item.id} 
                                            className="px-2 py-1 text-[10px] font-bold text-stone-500 bg-stone-50 hover:bg-stone-100 rounded border border-stone-200 transition-colors uppercase tracking-wide" title="下載 PNG">
                                        {downloadingState?.id === item.id && downloadingState.format === 'png' ? <Icons.Refresh spin={true} /> : 'PNG'}
                                    </button>

                                    {/* 原有 PDF 下載按鈕 */}
                                    <button onClick={(e) => handleDownload(e, item, 'pdf')} disabled={downloadingState && downloadingState.id === item.id} 
                                            className="px-2 py-1 text-[10px] font-bold text-stone-500 bg-stone-50 hover:bg-stone-100 rounded border border-stone-200 transition-colors uppercase tracking-wide" title="下載 PDF">
                                        {downloadingState?.id === item.id && downloadingState.format === 'pdf' ? <Icons.Refresh spin={true} /> : 'PDF'}
                                    </button>

                                    {/* 新增 MM 下載按鈕 */}
                                    <button onClick={(e) => handleDownload(e, item, 'mm')} disabled={downloadingState && downloadingState.id === item.id} 
                                            className="px-2 py-1 text-[10px] font-bold text-stone-500 bg-stone-50 hover:bg-stone-100 rounded border border-stone-200 transition-colors uppercase tracking-wide" title="下載 FreeMind 檔案">
                                        {downloadingState?.id === item.id && downloadingState.format === 'mm' ? <Icons.Refresh spin={true} /> : 'MM'}
                                    </button>

                                    {/* 原有 MD 下載按鈕 */}
                                    <button onClick={(e) => handleDownload(e, item, 'md')} disabled={downloadingState && downloadingState.id === item.id} 
                                            className="px-2 py-1 text-[10px] font-bold text-stone-500 bg-stone-50 hover:bg-stone-100 rounded border border-stone-200 transition-colors uppercase tracking-wide" title="下載 Markdown">
                                        MD
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* Mobile Header */}
                    <header className="lg:hidden bg-white/80 backdrop-blur-md border-b border-stone-200 sticky top-0 z-30 h-16 flex items-center px-4 justify-between">
                        <div className="flex items-center gap-3">
                            <img src="https://2blog.ilc.edu.tw/linkc/wp-content/uploads/sites/141/2024/12/linkc-logo.png" alt="Logo" className="h-8 w-8 rounded-lg object-cover shadow-sm" />
                            <h1 className="font-bold text-stone-800 text-lg tracking-wide">Linkc MindMap Garden</h1>
                        </div>
                        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="p-2 text-stone-600 hover:bg-stone-100 rounded-lg"><Icons.Menu /></button>
                    </header>

                    <div className="flex flex-1 overflow-hidden relative">
                        {/* Sidebar */}
                        <aside className={`fixed inset-y-0 left-0 z-20 w-72 bg-white/90 border-r border-stone-200 transform transition-transform duration-300 cubic-bezier(0.4, 0, 0.2, 1) lg:translate-x-0 lg:static lg:h-auto backdrop-blur-xl ${isMobileMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'}`}>
                            <div className="h-full flex flex-col">
                                <div className="hidden lg:flex h-20 items-center px-6">
                                    <div className="flex items-center gap-3 text-stone-800">
                                        <img src="https://2blog.ilc.edu.tw/linkc/wp-content/uploads/sites/141/2024/12/linkc-logo.png" alt="Logo" className="h-8 w-8 rounded-xl object-cover shadow-md" />
                                        <div className="flex flex-col">
                                            <span className="font-bold text-lg tracking-tight leading-tight">Linkc MindMap</span>
                                            <span className="text-xs text-emerald-600 font-medium tracking-widest uppercase">Garden</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto custom-scrollbar px-4 py-2">
                                    {/* 01. Zen's Portal */}
                                    <div className="mb-6 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl p-4 border border-emerald-100/50 shadow-inner relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity"><Icons.Portal /></div>
                                        <h4 className="text-xs font-bold text-emerald-700 uppercase tracking-wider mb-3 flex items-center gap-1.5"><Icons.Leaf /> 傳送門</h4>
                                        <a href="https://gavintux.github.io/yi/" target="_blank" className="flex items-center gap-2 text-sm font-medium text-stone-700 hover:text-emerald-700 hover:underline transition-colors bg-white/60 p-2 rounded-lg border border-white/50 shadow-sm">
                                            <span>Zen's Portal</span>
                                            <Icons.ExternalLink />
                                        </a>
                                    </div>

                                    <div className="mb-6">
                                        <p className="px-3 text-xs font-bold text-stone-400 uppercase tracking-widest mb-3">儀表板</p>
                                        <SidebarItem id="recent" label="最近翻土 (修改)" icon={<Icons.Clock />} />
                                        <SidebarItem id="all" label="花園全貌 (全部)" icon={<Icons.Grid />} count={permittedDiagrams.length} />
                                        
                                        {/* 如果目前處於分享連結檢視模式，顯示此選項 */}
                                        {collectionIds && (
                                            <SidebarItem id="shared_collection" label="精選花束 (分享連結)" icon={<Icons.Share2 />} count={collectionIds.length} activeOverride={activeCategory === 'shared_collection'} />
                                        )}
                                    </div>
                                    
                                    <div className="mb-8">
                                        <div className="flex items-center justify-between px-3 mb-3">
                                            <p className="text-xs font-bold text-stone-400 uppercase tracking-widest">標籤花圃</p>
                                            {(isTagExpanded || sortedTags.length > 8) && (
                                                <input 
                                                    type="text" 
                                                    placeholder="搜尋種子..." 
                                                    value={tagSearchQuery}
                                                    onChange={(e) => setTagSearchQuery(e.target.value)}
                                                    className="w-24 text-xs bg-stone-100 border-none rounded-md px-2 py-1 focus:ring-1 focus:ring-emerald-300 transition-all"
                                                />
                                            )}
                                        </div>

                                        <div className="px-1 flex flex-wrap gap-2">
                                            {visibleTags.map(tag => {
                                                const isActive = activeCategory === tag.name;
                                                return (
                                                    <button 
                                                        key={tag.name}
                                                        onClick={() => { setActiveCategory(tag.name); setIsMobileMenuOpen(false); }}
                                                        className={`inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200 border ${
                                                            isActive 
                                                                ? 'bg-emerald-600 text-white border-emerald-600 shadow-md shadow-emerald-200' 
                                                                : 'bg-white text-stone-600 border-stone-200 hover:border-emerald-300 hover:text-emerald-700'
                                                        }`}
                                                    >
                                                        #{tag.name}
                                                        <span className={`ml-1.5 text-[10px] px-1 rounded-full ${isActive ? 'bg-white/20' : 'bg-stone-100 text-stone-500'}`}>{tag.count}</span>
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        
                                        {sortedTags.length > 10 && !tagSearchQuery && (
                                            <button 
                                                onClick={() => setIsTagExpanded(!isTagExpanded)}
                                                className="w-full text-center text-xs text-stone-400 hover:text-emerald-600 mt-3 py-1 transition-colors flex items-center justify-center gap-1"
                                            >
                                                {isTagExpanded ? '收合' : `查看全部 (${sortedTags.length})`}
                                            </button>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="p-4 border-t border-stone-100 bg-stone-50/50 backdrop-blur-sm space-y-2">
                                    <button 
                                        onClick={() => isAuthorized ? setIsAuthorized(false) : setShowPasswordModal(true)} 
                                        className={`w-full flex items-center justify-center gap-2 text-xs py-2.5 px-3 rounded-xl transition-all font-medium ${isAuthorized ? 'bg-rose-50 text-rose-600 hover:bg-rose-100' : 'bg-white text-stone-600 border border-stone-200 hover:border-stone-300 hover:shadow-sm'}`}
                                    >
                                        {isAuthorized ? <Icons.Unlock /> : <Icons.Lock />}
                                        {isAuthorized ? '離開管理模式' : '管理員登入'}
                                    </button>

                                    <button onClick={() => setUseRealApi(!useRealApi)} className="w-full text-xs py-2 px-3 rounded-xl text-stone-500 hover:bg-stone-100 transition-colors">
                                        {useRealApi ? 'Switch to Demo' : 'Switch to API'}
                                    </button>
                                </div>
                            </div>
                        </aside>
                        
                        {isMobileMenuOpen && <div onClick={() => setIsMobileMenuOpen(false)} className="fixed inset-0 z-10 bg-stone-900/20 backdrop-blur-sm lg:hidden"></div>}

                        {/* Main Content */}
                        <main className="flex-1 overflow-y-auto custom-scrollbar h-full bg-stone-50/50 w-full relative">
                            {/* 裝飾背景 */}
                            <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-emerald-50/50 to-transparent pointer-events-none"></div>

                            <div className="max-w-6xl mx-auto px-4 sm:px-8 py-10 relative z-0">
                                {/* Header Section */}
                                <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10">
                                    <div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <h2 className="text-3xl font-bold text-stone-800 flex items-center gap-3">
                                                {activeCategory === 'shared_collection' ? '精選花束 (分享)' : 
                                                 activeCategory === 'recent' ? '最近翻土' : 
                                                 activeCategory === 'all' ? '花園全貌' : 
                                                 activeCategory === 'uncategorized' ? '未分類種子' : 
                                                 `# ${activeCategory}`}
                                            </h2>
                                            {!isAuthorized && (
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-amber-100 text-amber-800 border border-amber-200">
                                                    Guest View (#share)
                                                </span>
                                            )}
                                        </div>
                                        <p className="text-stone-500 font-medium">目前共培育了 {processedData.totalItems} 株知識樹</p>
                                    </div>
                                    
                                    {/* Toolbar */}
                                    <div className="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center bg-white p-1.5 rounded-2xl shadow-sm border border-stone-200">
                                        <div className="relative group min-w-[240px]">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-stone-400"><Icons.Search /></div>
                                            <input 
                                                type="text" 
                                                value={searchTerm} 
                                                onChange={(e) => setSearchTerm(e.target.value)} 
                                                className="block w-full pl-10 pr-10 py-2.5 border-none rounded-xl bg-transparent focus:ring-0 text-sm text-stone-700 placeholder-stone-400" 
                                                placeholder="搜尋花園... (例如 #工作)" 
                                            />
                                            <div className="absolute inset-y-0 right-0 pr-3 flex items-center cursor-help has-tooltip">
                                                <div className="text-stone-300 hover:text-emerald-500 transition-colors"><Icons.Info /></div>
                                                <div className="tooltip">
                                                    <p className="font-bold mb-1 text-emerald-300">花園搜尋語法：</p>
                                                    <ul className="list-disc list-inside space-y-1 text-stone-300">
                                                        <li>AND: <code className="bg-stone-700 px-1 rounded">&</code></li>
                                                        <li>OR: <code className="bg-stone-700 px-1 rounded">|</code></li>
                                                        <li>NOT: <code className="bg-stone-700 px-1 rounded">!</code></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {activeCategory !== 'recent' && (
                                            <>
                                                <div className="h-6 w-px bg-stone-200 hidden sm:block mx-1"></div>
                                                <div className="flex gap-2">
                                                    <div className="relative">
                                                        <select value={sortField} onChange={(e) => setSortField(e.target.value)} className="appearance-none bg-stone-50 hover:bg-stone-100 border border-stone-200 text-stone-600 text-sm py-2 pl-3 pr-8 rounded-xl focus:outline-none cursor-pointer font-medium transition-colors">
                                                            <option value="modified_at">最近灌溉</option>
                                                            <option value="created_at">種植時間</option>
                                                            <option value="title">品種名稱</option>
                                                        </select>
                                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-400"><Icons.ArrowDown /></div>
                                                    </div>
                                                    <button onClick={() => setSortOrder(o => o === 'asc' ? 'desc' : 'asc')} className="p-2 bg-stone-50 hover:bg-stone-100 border border-stone-200 rounded-xl text-stone-500 hover:text-emerald-600 transition-colors">
                                                        {sortOrder === 'asc' ? <Icons.SortAsc /> : <Icons.SortDesc />}
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                        {useRealApi && <button onClick={fetchDiagrams} disabled={loading} className="p-2 bg-emerald-50 hover:bg-emerald-100 border border-emerald-100 rounded-xl text-emerald-600 transition-colors ml-1"><Icons.Refresh spin={loading} /></button>}
                                    </div>
                                </div>
                                
                                {/* Error Message */}
                                {error && <div className="mb-8 p-4 bg-rose-50 text-rose-700 rounded-2xl border border-rose-100 flex items-center gap-3"><Icons.Bug /> {error}</div>}
                                
                                {/* Content Grid */}
                                {processedData.totalItems === 0 ? (
                                    <div className="text-center py-32 animate-fade-in flex flex-col items-center">
                                        <div className="w-24 h-24 rounded-full bg-stone-100 flex items-center justify-center text-stone-300 mb-6 shadow-inner">
                                            <Icons.Flower />
                                        </div>
                                        <h3 className="text-xl font-bold text-stone-700 mb-2">這片區域還是一片荒地</h3>
                                        <p className="text-stone-500 max-w-md mx-auto">
                                            {collectionIds ? "連結中的 ID 似乎無法讀取，或者這些檔案未公開。" : (isAuthorized ? "試著在 Mindomo 的描述欄位加上 #標籤 來播種吧！" : "目前沒有公開分享 (#share) 的植栽。")}
                                        </p>
                                        {collectionIds && <button onClick={() => { setCollectionIds(null); setActiveCategory('all'); window.history.replaceState(null, '', window.location.pathname); }} className="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-colors">查看全部</button>}
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 pb-10">
                                        {processedData.items.map((item) => (
                                            <GardenCard key={item.id} item={item} />
                                        ))}
                                    </div>
                                )}
                                
                                <Pagination />
                                
                                {/* 浮動選取工具列 */}
                                {selectedIds.size > 0 && (
                                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-stone-900/90 text-white backdrop-blur-md px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-6 animate-slide-up border border-stone-700">
                                        <div className="flex items-center gap-2">
                                            <span className="bg-emerald-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{selectedIds.size}</span>
                                            <span className="text-sm font-medium">已選取</span>
                                        </div>
                                        <div className="h-4 w-px bg-stone-700"></div>
                                        <button onClick={handleGenerateCollectionLink} className="flex items-center gap-2 text-sm font-bold hover:text-emerald-400 transition-colors">
                                            <Icons.Link /> 複製分享連結
                                        </button>
                                        <div className="h-4 w-px bg-stone-700"></div>
                                        <button onClick={clearSelection} className="flex items-center gap-1 text-sm text-stone-400 hover:text-white transition-colors">
                                            <Icons.X /> 清除
                                        </button>
                                    </div>
                                )}
                                
                                {/* Modals */}
                                {showPasswordModal && (
                                    <PasswordModal 
                                        onSubmit={() => { setIsAuthorized(true); setShowPasswordModal(false); }}
                                        onClose={() => setShowPasswordModal(false)}
                                    />
                                )}

                                {useRealApi && rawData && showDebug && (
                                    <div className="mt-16 p-6 bg-stone-900 text-stone-300 rounded-2xl shadow-2xl animate-fade-in border border-stone-800">
                                        <div className="flex items-center justify-between mb-4 border-b border-stone-800 pb-4">
                                            <div className="flex items-center gap-2 text-emerald-400">
                                                <Icons.Bug />
                                                <h3 className="text-lg font-bold">Soil Analysis (Debug)</h3>
                                            </div>
                                            <button onClick={() => setShowDebug(false)} className="text-xs text-stone-500 hover:text-white">Close</button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 text-xs font-mono">
                                            <div className="bg-black/50 p-4 rounded-xl">
                                                <h4 className="text-emerald-500 font-bold mb-2">Data Sample</h4>
                                                <pre className="overflow-x-auto text-stone-400">{JSON.stringify(Array.isArray(rawData) ? rawData[0] : (rawData.diagrams ? rawData.diagrams[0] : rawData), null, 2)}</pre>
                                            </div>
                                            <div className="bg-black/50 p-4 rounded-xl">
                                                <h4 className="text-emerald-500 font-bold mb-2">Garden Stats</h4>
                                                <p>Total Seeds: {Array.isArray(rawData) ? rawData.length : (rawData.diagrams ? rawData.diagrams.length : 0)}</p>
                                                <p>Tag Groups: {sortedTags.length}</p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
