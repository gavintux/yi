<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mandala Garden</title>
    <link rel="icon" href="https://duk.tw/3eXGrY.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'slide-in-left': 'slideInLeft 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideInLeft: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Utils -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #fcfaf9; height: 100dvh; width: 100vw; overflow: hidden; color: #44403c; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .grid-border { border-color: #d6d3d1; }
        .dash-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .dash-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(87, 105, 85, 0.1); }
        .garden-title { font-family: 'Noto Serif TC', serif; }
        
        .export-mode .export-hidden { display: none !important; }
        .export-mode .export-full-text { white-space: normal !important; overflow: visible !important; display: block !important; -webkit-line-clamp: unset !important; line-clamp: unset !important; height: auto !important; font-size: 0.7rem !important; line-height: 1.1 !important; }
        .export-mode .grid-cell-content { padding: 2px !important; }

        /* Navigation Styles */
        .nav-cell { cursor: pointer; position: relative; }
        .nav-cell:hover { background-color: rgba(16, 185, 129, 0.1) !important; }
        .nav-cell::after { content: "â†—"; position: absolute; top: 2px; left: 2px; font-size: 10px; color: #059669; opacity: 0.6; transition: all 0.2s; font-weight: bold; }
        .nav-cell.return-cell::after { content: "â†©"; }
        .nav-cell:hover::after { transform: scale(1.2); opacity: 1; }
        
        .edit-btn-overlay { position: absolute; bottom: 3px; right: 3px; width: 20px; height: 20px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; cursor: pointer; z-index: 30; opacity: 0; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .group:hover .edit-btn-overlay { opacity: 1; }
        .edit-btn-overlay:hover { background: #10b981; color: white; border-color: #10b981; }

        .content-icon { width: 16px; height: 16px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; background: rgba(255,255,255,0.8); border: 1px solid #d1d5db; color: #4b5563; cursor: pointer; transition: all 0.2s; }
        .content-icon:hover { background: #10b981; color: white; border-color: #10b981; transform: scale(1.1); }

        .md-content a { color: #059669; text-decoration: underline; pointer-events: auto; }
        .md-content p { margin-bottom: 0.2em; }
        .md-content ul { padding-left: 1rem; list-style: disc; }
        .md-content ol { padding-left: 1rem; list-style: decimal; }
        
        /* Custom scrollbar for emoji list */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const USER_CONFIG = {
            seo: { title: "Mandala Garden", logoImage: "https://firebasestorage.googleapis.com/v0/b/linkcphoto.firebasestorage.app/o/photos%2Flinkc-w0.png?alt=media&token=63c9b589-aa78-480a-bed2-1c83634f4b9f", logoLink: "https://gavintux.github.io/yi/" },
            firebase: { apiKey: "AIzaSyDmPdUMPzloG7f_9qBpeUGIvG0iyebgyXI",
                        authDomain: "fir-7bf67.firebaseapp.com",
                        projectId: "fir-7bf67",
                        storageBucket: "fir-7bf67.firebasestorage.app",
                        messagingSenderId: "23185940342",
                        appId: "1:23185940342:web:ac7b9919f39ae9858a6457",
                        measurementId: "G-W9DJ13E9CH"
                     },
            system: { collectionName: 'mandala_charts', defaultGridSize: 3, defaultViewStyle: 'standard' }
        };

        try { firebase.initializeApp(USER_CONFIG.firebase); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Utils
        const getTransparentColor = (hex, opacity = 0.25) => { 
            if (!hex || !hex.startsWith('#')) return '#ffffff';
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        };

        const safeMarkdown = (text) => { try { return typeof marked !== 'undefined' ? marked.parse(text) : text; } catch { return text; } };
        const safeMarkdownInline = (text) => { try { return typeof marked !== 'undefined' ? marked.parseInline(text) : text; } catch { return text; } };
        const encodeShareData = (d) => btoa(unescape(encodeURIComponent(JSON.stringify(d))));
        const decodeShareData = (s) => JSON.parse(decodeURIComponent(escape(atob(s))));
        const compressImage = (file) => new Promise((res) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const w = 300; c.width=w; c.height=i.height*(w/i.width); c.getContext('2d').drawImage(i,0,0,w,c.height); res(c.toDataURL('image/jpeg', 0.7)); } } });
        const extractTags = (text) => (text?.match(/#[\w\u4e00-\u9fa5]+/g) || []).map(x => x.substring(1));
        const parseCategories = (s) => (!s ? ['æœªåˆ†é¡ž'] : s.split(/[,ï¼Œ\s]+/).filter(c=>c.trim().length>0));
        
        // Advanced Search Matcher
        const checkSearchMatch = (text, query) => {
            if (!query) return true;
            if (!text && text !== 0) return false;
            const target = String(text).toLowerCase();
            
            // Boolean Logic: OR logic first (split by ' OR ')
            const orGroups = query.split(/\s+OR\s+/i);
            
            return orGroups.some(group => {
                // Inside OR group: AND logic (split by space)
                const terms = group.trim().split(/\s+/);
                return terms.every(term => {
                    // NOT logic: -term
                    if (term.startsWith('-')) {
                        const cleanTerm = term.substring(1).toLowerCase();
                        return cleanTerm && !target.includes(cleanTerm);
                    }
                    return target.includes(term.toLowerCase());
                });
            });
        };

        // Helper to get formatted name
        const getUserName = (user) => {
            if (!user || !user.email) return "Guest";
            const name = user.email.split('@')[0];
            return name.charAt(0).toUpperCase() + name.slice(1);
        };

        // --- NEW EMOJI STRUCTURE ---
        const EMOJI_CATEGORIES = {
            "è¡¨æƒ…": ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜Ÿ', 'ðŸ˜•', 'ðŸ™', 'â˜¹ï¸', 'ðŸ˜£', 'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ¥º', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ¤¯', 'ðŸ˜³', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ˜±', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜“', 'ðŸ¤—', 'ðŸ¤”', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤¥', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¬', 'ðŸ™„', 'ðŸ˜¯', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜®', 'ðŸ˜²', 'ðŸ¥±', 'ðŸ˜´', 'ðŸ¤¤', 'ðŸ˜ª', 'ðŸ˜µ', 'ðŸ¤', 'ðŸ¥´', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤‘', 'ðŸ¤ ', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ‘¹', 'ðŸ‘º', 'ðŸ¤¡', 'ðŸ’©', 'ðŸ‘»', 'ðŸ’€', 'â˜ ï¸', 'ðŸ‘½', 'ðŸ‘¾', 'ðŸ¤–', 'ðŸ‘', 'ðŸ‘‹', 'ðŸ‘', 'ðŸ‘Ž', 'ðŸ‘Š', 'âœŠ', 'ðŸ¤›', 'ðŸ¤œ', 'ðŸ¤ž', 'âœŒï¸', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ‘Œ', 'ðŸ¤', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ‘‡', 'â˜ï¸', 'âœ‹', 'ðŸ¤š', 'ðŸ–ï¸', 'ðŸ––', 'ðŸ™', 'ðŸ’ª', 'ðŸ§ ', 'ðŸ«€', 'ðŸ«', 'ðŸ¦·', 'ðŸ¦´', 'ðŸ‘€', 'ðŸ‘ï¸'],
            "è‡ªç„¶": ['ðŸŒ¿', 'ðŸŒ¸', 'ðŸŒ¼', 'ðŸ„', 'ðŸŒ±', 'ðŸƒ', 'ðŸŒ»', 'ðŸŒµ', 'ðŸŒº', 'ðŸ‚', 'ðŸŒ¹', 'ðŸŒ·', 'ðŸ’', 'ðŸª´', 'ðŸŒ²', 'ðŸŒ³', 'ðŸŒ´', 'ðŸªµ', 'ðŸª¨', 'ðŸŒ¾', 'ðŸŽ‹', 'ðŸ', 'ðŸ‡', 'ðŸˆ', 'ðŸ‰', 'ðŸŠ', 'ðŸ‹', 'ðŸŒ', 'ðŸ', 'ðŸ¥­', 'ðŸŽ', 'ðŸ', 'ðŸ', 'ðŸ‘', 'ðŸ’', 'ðŸ“', 'ðŸ«', 'ðŸ¥', 'ðŸ…', 'ðŸ«’', 'ðŸ¥¥', 'ðŸ¥‘', 'ðŸ†', 'ðŸ¥”', 'ðŸ¥•', 'ðŸŒ½', 'ðŸŒ¶ï¸', 'ðŸ«‘', 'ðŸ¥’', 'ðŸ¥¬', 'ðŸ¥¦', 'ðŸ§„', 'ðŸ§…', 'ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ»â€â„ï¸', 'ðŸ¨', 'ðŸ¯', 'ðŸ¦', 'ðŸ®', 'ðŸ·', 'ðŸ½', 'ðŸ¸', 'ðŸµ', 'ðŸ™ˆ', 'ðŸ™‰', 'ðŸ™Š', 'ðŸ’', 'ðŸ”', 'ðŸ§', 'ðŸ¦', 'ðŸ¤', 'ðŸ£', 'ðŸ¥', 'ðŸ¦†', 'ðŸ¦…', 'ðŸ¦‰', 'ðŸ¦‡', 'ðŸº', 'ðŸ—', 'ðŸ´', 'ðŸ¦„', 'ðŸ', 'ðŸª±', 'ðŸ›', 'ðŸ¦‹', 'ðŸŒ', 'ðŸž', 'ðŸœ', 'ðŸª°', 'ðŸª²', 'ðŸª³', 'ðŸ¦Ÿ', 'ðŸ¦—', 'ðŸ•·ï¸', 'ðŸ•¸ï¸', 'ðŸ¦‚', 'ðŸ¢', 'ðŸ', 'ðŸ¦Ž', 'ðŸ¦–', 'ðŸ¦•', 'ðŸ™', 'ðŸ¦‘', 'ðŸ¦', 'ðŸ¦ž', 'ðŸ¦€', 'ðŸ¡', 'ðŸ ', 'ðŸŸ', 'ðŸ¬', 'ðŸ³', 'ðŸ‹', 'ðŸ¦ˆ', 'ðŸ¦­', 'ðŸŠ', 'ðŸ…', 'ðŸ†', 'ðŸ¦“', 'ðŸ¦', 'ðŸ¦§', 'ðŸ¦£', 'ðŸ˜', 'ðŸ¦›', 'ðŸ¦', 'ðŸª', 'ðŸ«', 'ðŸ¦’', 'ðŸ¦˜', 'ðŸ¦¬', 'ðŸƒ', 'ðŸ‚', 'ðŸ„', 'ðŸŽ', 'ðŸ–', 'ðŸ', 'ðŸ‘', 'ðŸ¦™', 'ðŸ', 'ðŸ¦Œ', 'ðŸ•', 'ðŸ©', 'ðŸ¦®', 'ðŸ•â€ðŸ¦º', 'ðŸˆ', 'ðŸˆâ€â¬›', 'ðŸ“', 'ðŸ¦ƒ', 'ðŸ¦š', 'ðŸ¦œ', 'ðŸ¦¢', 'ðŸ¦©', 'ðŸ•Šï¸', 'ðŸ‡', 'ðŸ¦', 'ðŸ¦¨', 'ðŸ¦¡', 'ðŸ¦«', 'ðŸ¦¦', 'ðŸ¦¥', 'ðŸ', 'ðŸ€', 'ðŸ¿ï¸', 'ðŸ¦”', 'ðŸ¾', 'ðŸ‰', 'ðŸ²', 'â˜€ï¸', 'ðŸŒ¤ï¸', 'â›…', 'ðŸŒ¥ï¸', 'â˜ï¸', 'ðŸŒ¦ï¸', 'ðŸŒ§ï¸', 'â›ˆï¸', 'ðŸŒ©ï¸', 'ðŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ðŸŒ¬ï¸', 'ðŸ’¨', 'ðŸ’§', 'ðŸ’¦', 'â˜”', 'â˜‚ï¸', 'ðŸŒŠ', 'ðŸŒ«ï¸', 'ðŸŒ', 'ðŸŒŽ', 'ðŸŒ', 'ðŸŒ‘', 'ðŸŒ’', 'ðŸŒ“', 'ðŸŒ”', 'ðŸŒ•', 'ðŸŒ–', 'ðŸŒ—', 'ðŸŒ˜', 'ðŸŒ™', 'ðŸŒš', 'ðŸŒ›', 'ðŸŒœ', 'ðŸŒž', 'â­', 'ðŸŒŸ', 'ðŸŒ ', 'ðŸŒŒ', 'ðŸª', 'ðŸ’«', 'â˜„ï¸', 'ðŸ”¥', 'ðŸŒ‹'],
            "ç‰©ä»¶": ['ðŸ’¡', 'ðŸ”¦', 'ðŸ®', 'ðŸª”', 'ðŸ“”', 'ðŸ“•', 'ðŸ“–', 'ðŸ“—', 'ðŸ“˜', 'ðŸ“™', 'ðŸ“š', 'ðŸ““', 'ðŸ“’', 'ðŸ“ƒ', 'ðŸ“œ', 'ðŸ“„', 'ðŸ“°', 'ðŸ—žï¸', 'ðŸ“‘', 'ðŸ”–', 'ðŸ·ï¸', 'ðŸ’°', 'ðŸª™', 'ðŸ’´', 'ðŸ’µ', 'ðŸ’¶', 'ðŸ’·', 'ðŸ’¸', 'ðŸ’³', 'ðŸ§¾', 'ðŸ’¹', 'âœ‰ï¸', 'ðŸ“§', 'ðŸ“¨', 'ðŸ“©', 'ðŸ“¤', 'ðŸ“¥', 'ðŸ“¦', 'ðŸ“«', 'ðŸ“ª', 'ðŸ“¬', 'ðŸ“­', 'ðŸ“®', 'ðŸ—³ï¸', 'âœï¸', 'âœ’ï¸', 'ðŸ–‹ï¸', 'ðŸ–Šï¸', 'ðŸ–Œï¸', 'ðŸ–ï¸', 'ðŸ“', 'ðŸ’¼', 'ðŸ“', 'ðŸ“‚', 'ðŸ—‚ï¸', 'ðŸ“…', 'ðŸ“†', 'ðŸ—’ï¸', 'ðŸ—“ï¸', 'ðŸ“‡', 'ðŸ“ˆ', 'ðŸ“‰', 'ðŸ“Š', 'ðŸ“‹', 'ðŸ“Œ', 'ðŸ“', 'ðŸ“Ž', 'ðŸ–‡ï¸', 'ðŸ“', 'ðŸ“', 'âœ‚ï¸', 'ðŸ—ƒï¸', 'ðŸ—„ï¸', 'ðŸ—‘ï¸', 'ðŸ”’', 'ðŸ”“', 'ðŸ”', 'ðŸ”', 'ðŸ”‘', 'ðŸ—ï¸', 'ðŸ”¨', 'ðŸª“', 'â›ï¸', 'âš’ï¸', 'ðŸ› ï¸', 'ðŸ—¡ï¸', 'âš”ï¸', 'ðŸ”«', 'ðŸªƒ', 'ðŸ¹', 'ðŸ›¡ï¸', 'ðŸªš', 'ðŸ”§', 'ðŸª›', 'ðŸ”©', 'âš™ï¸', 'ðŸ—œï¸', 'âš–ï¸', 'ðŸ¦¯', 'ðŸ”—', 'â›“ï¸', 'ðŸª', 'ðŸ§°', 'ðŸ§²', 'ðŸªœ', 'âš—ï¸', 'ðŸ§ª', 'ðŸ§«', 'ðŸ§¬', 'ðŸ”¬', 'ðŸ”­', 'ðŸ“¡', 'ðŸ’‰', 'ðŸ©¸', 'ðŸ’Š', 'ðŸ©¹', 'ðŸ©º', 'ðŸšª', 'ðŸ›—', 'ðŸªž', 'ðŸªŸ', 'ðŸ›ï¸', 'ðŸ›‹ï¸', 'ðŸª‘', 'ðŸš½', 'ðŸª ', 'ðŸš¿', 'ðŸ›', 'ðŸ§¼', 'ðŸª¥', 'ðŸª’', 'ðŸ§½', 'ðŸª£', 'ðŸ§´', 'ðŸ›Žï¸', 'ðŸ§¸', 'ðŸª†', 'ðŸ–¼ï¸', 'ðŸ›ï¸', 'ðŸ›’', 'ðŸŽ', 'ðŸŽˆ', 'ðŸŽ', 'ðŸŽ€', 'ðŸª„', 'ðŸª…', 'ðŸŽŠ', 'ðŸŽ‰', 'ðŸŽŽ', 'ðŸŽ', 'ðŸ§§', 'âŒš', 'ðŸ“±', 'ðŸ“²', 'ðŸ’»', 'âŒ¨ï¸', 'ðŸ–¥ï¸', 'ðŸ–¨ï¸', 'ðŸ–±ï¸', 'ðŸ–²ï¸', 'ðŸ•¹ï¸', 'ðŸ—œï¸', 'ðŸ’½', 'ðŸ’¾', 'ðŸ’¿', 'ðŸ“€', 'ðŸ“¼', 'ðŸ“·', 'ðŸ“¸', 'ðŸ“¹', 'ðŸŽ¥', 'ðŸ“½ï¸', 'ðŸŽžï¸', 'ðŸ“ž', 'â˜Žï¸', 'ðŸ“Ÿ', 'ðŸ“ ', 'ðŸ“º', 'ðŸ“»', 'ðŸŽ™ï¸', 'ðŸŽšï¸', 'ðŸŽ›ï¸', 'ðŸ§­', 'â±ï¸', 'â²ï¸', 'â°', 'ðŸ•°ï¸', 'âŒ›', 'â³', 'ðŸš—', 'ðŸš•', 'ðŸš™', 'ðŸšŒ', 'ðŸšŽ', 'ðŸŽï¸', 'ðŸš“', 'ðŸš‘', 'ðŸš’', 'ðŸš', 'ðŸ›»', 'ðŸšš', 'ðŸš›', 'ðŸšœ', 'ðŸï¸', 'ðŸ›µ', 'ðŸš²', 'ðŸ¦¼', 'ðŸ¦½', 'ðŸ›º', 'ðŸ›¹', 'ðŸ›¼', 'ðŸš¨', 'ðŸš”', 'ðŸš', 'ðŸš˜', 'ðŸš–', 'ðŸš¡', 'ðŸš ', 'ðŸšŸ', 'ðŸšƒ', 'ðŸš‹', 'ðŸšž', 'ðŸš', 'ðŸš„', 'ðŸš…', 'ðŸšˆ', 'ðŸš‚', 'ðŸš†', 'ðŸš‡', 'ðŸšŠ', 'ðŸš‰', 'âœˆï¸', 'ðŸ›«', 'ðŸ›¬', 'ðŸ›©ï¸', 'ðŸ’º', 'ðŸ›°ï¸', 'ðŸš€', 'ðŸ›¸', 'ðŸš', 'ðŸ›¶', 'â›µ', 'ðŸš¤', 'ðŸ›¥ï¸', 'ðŸ›³ï¸', 'â›´ï¸', 'ðŸš¢', 'âš“', 'ðŸš§', 'â›½', 'ðŸš', 'ðŸš¦', 'ðŸš¥', 'ðŸ›‘'],
            "ç¬¦è™Ÿ": ['â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ¤Ž', 'ðŸ’”', 'â£ï¸', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ðŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ðŸ”¯', 'ðŸ•Ž', 'â˜¯ï¸', 'â˜¦ï¸', 'ðŸ›', 'â›Ž', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™Ž', 'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'ðŸ†”', 'âš›ï¸', 'ðŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ðŸ“´', 'ðŸ“³', 'ðŸˆ¶', 'ðŸˆš', 'ðŸˆ¸', 'ðŸˆº', 'ðŸˆ·ï¸', 'âœ´ï¸', 'ðŸ†š', 'ðŸ’®', 'ðŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸', 'ðŸˆ´', 'ðŸˆµ', 'ðŸˆ¹', 'ðŸˆ²', 'ðŸ…°ï¸', 'ðŸ…±ï¸', 'ðŸ†Ž', 'ðŸ†‘', 'ðŸ…¾ï¸', 'ðŸ†˜', 'âŒ', 'â­•', 'ðŸ›‘', 'â›”', 'ðŸ“›', 'ðŸš«', 'ðŸ’¯', 'ðŸ’¢', 'â™¨ï¸', 'ðŸš·', 'ðŸš¯', 'ðŸš³', 'ðŸš±', 'ðŸ”ž', 'ðŸ“µ', 'ðŸš­', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ðŸ”…', 'ðŸ”†', 'ã€½ï¸', 'âš ï¸', 'ðŸš¸', 'ðŸ”±', 'âšœï¸', 'ðŸ”°', 'â™»ï¸', 'âœ…', 'ðŸˆ¯', 'ðŸ’¹', 'â‡ï¸', 'âœ³ï¸', 'âŽ', 'ðŸŒ', 'ðŸ’ ', 'â“‚ï¸', 'ðŸŒ€', 'ðŸ’¤', 'ðŸ§', 'ðŸš¾', 'â™¿', 'ðŸ…¿ï¸', 'ðŸ›—', 'ðŸˆ³', 'ðŸˆ‚ï¸', 'ðŸ›‚', 'ðŸ›ƒ', 'ðŸ›„', 'ðŸ›…', 'ðŸš¹', 'ðŸšº', 'ðŸš¼', 'âš§', 'ðŸš»', 'ðŸš®', 'ðŸŽ¦', 'ðŸ“¶', 'ðŸˆ', 'ðŸ”£', 'â„¹ï¸', 'ðŸ”¤', 'ðŸ”¡', 'ðŸ” ', 'ðŸ†–', 'ðŸ†—', 'ðŸ†™', 'ðŸ†’', 'ðŸ†•', 'ðŸ†“', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ', 'ðŸ”¢', '#ï¸âƒ£', '*ï¸âƒ£', 'âï¸', 'â–¶ï¸', 'â¸ï¸', 'â¯ï¸', 'â¹ï¸', 'âºï¸', 'â­ï¸', 'â®ï¸', 'â©', 'âª', 'â«', 'â¬', 'â—€ï¸', 'ðŸ”¼', 'ðŸ”½', 'âž¡ï¸', 'â¬…ï¸', 'â¬†ï¸', 'â¬‡ï¸', 'â†—ï¸', 'â†˜ï¸', 'â†™ï¸', 'â†–ï¸', 'â†•ï¸', 'â†”ï¸', 'â†ªï¸', 'â†©ï¸', 'â¤´ï¸', 'â¤µï¸', 'ðŸ”€', 'ðŸ”', 'ðŸ”‚', 'ðŸ”„', 'ðŸ”ƒ', 'ðŸŽµ', 'ðŸŽ¶', 'âž•', 'âž–', 'âž—', 'âœ–ï¸', 'â™¾ï¸', 'ðŸ’²', 'ðŸ’±', 'â„¢ï¸', 'Â©ï¸', 'Â®ï¸', 'ðŸ‘ï¸â€ðŸ—¨ï¸', 'ðŸ”š', 'ðŸ”™', 'ðŸ”›', 'ðŸ”', 'ðŸ”œ', 'ã€°ï¸', 'âž°', 'âž¿', 'âœ”ï¸', 'â˜‘ï¸', 'ðŸ”˜', 'ðŸ”´', 'ðŸŸ ', 'ðŸŸ¡', 'ðŸŸ¢', 'ðŸ”µ', 'ðŸŸ£', 'âš«', 'âšª', 'ðŸŸ¤', 'ðŸ”º', 'ðŸ”»', 'ðŸ”¸', 'ðŸ”¹', 'ðŸ”¶', 'ðŸ”·', 'ðŸ”³', 'ðŸ”²', 'â–ªï¸', 'â–«ï¸', 'â—¾', 'â—½', 'â—¼ï¸', 'â—»ï¸', 'ðŸŸ¥', 'ðŸŸ§', 'ðŸŸ¨', 'ðŸŸ©', 'ðŸŸ¦', 'ðŸŸª', 'â¬›', 'â¬œ', 'ðŸŸ«', 'ðŸ”ˆ', 'ðŸ”‡', 'ðŸ”‰', 'ðŸ”Š', 'ðŸ””', 'ðŸ”•', 'ðŸ“£', 'ðŸ“¢', 'ðŸ’¬', 'ðŸ’­', 'ðŸ—¯ï¸']
        };
        
        const Icons = {
            Folder: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>,
            Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path></svg>,
            Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>,
            Share: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>,
            SignOut: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>,
            Pencil: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>,
            Home: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>,
            Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>,
            Export: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>,
            Restore: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>,
            DeleteForever: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
            Clipboard: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>,
            Link: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>,
            Photo: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>,
            X: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>,
            Tag: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
        };

        const { useState, useEffect, useMemo, useRef } = React;

        function App() {
            // States
            const [user, setUser] = useState(null);
            const [viewMode, setViewMode] = useState('browser');
            const [authMode, setAuthMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [loading, setLoading] = useState(true);
            const [isUploading, setIsUploading] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [showAllTags, setShowAllTags] = useState(false);
            const [emojiTab, setEmojiTab] = useState('è¡¨æƒ…'); 

            // Data
            const [fileList, setFileList] = useState([]);
            const [currentDocId, setCurrentDocId] = useState(null);
            const [docMetadata, setDocMetadata] = useState({ title: 'æœªå‘½å', category: 'ä¸€èˆ¬' });
            const [data, setData] = useState({});
            const [gridSize, setGridSize] = useState(3);
            const [viewStyle, setViewStyle] = useState('standard');
            const [activeCategory, setActiveCategory] = useState('All');
            const [zoomedGridIndex, setZoomedGridIndex] = useState(null); 
            const [isSharedView, setIsSharedView] = useState(false);

            // Modals
            const [selectedCell, setSelectedCell] = useState(null);
            const [showSaveAsModal, setShowSaveAsModal] = useState(false);
            const [modalMode, setModalMode] = useState('new'); // 'new' or 'save_as'
            const [showImportModal, setShowImportModal] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false);
            const [showGlobalSearchModal, setShowGlobalSearchModal] = useState(false);
            const [showMetadataModal, setShowMetadataModal] = useState(false);
            const [previewImage, setPreviewImage] = useState(null);
            const [editActiveField, setEditActiveField] = useState('title'); // 'title' or 'note'
            
            // Other
            const [searchQuery, setSearchQuery] = useState("");
            const [globalSearchResults, setGlobalSearchResults] = useState([]);
            const [importCode, setImportCode] = useState("");
            const [saveStatus, setSaveStatus] = useState('saved');
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [activeTags, setActiveTags] = useState([]);
            const [showAllCategories, setShowAllCategories] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const ITEMS_PER_PAGE = 12;

            const fileInputRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'linkc-mandala-app-v1';

            // Counts & Tags Calculation
            const activeFileCount = fileList.filter(f => !f.deleted).length;
            const trashFileCount = fileList.filter(f => f.deleted).length;

            const tagStats = useMemo(() => {
                const stats = {};
                fileList.forEach(f => {
                    if (f.deleted) return;
                    const fileTags = new Set();
                    
                    // 1. From Category field
                    if (f.category) {
                        f.category.split(/[,ï¼Œ\s]+/).forEach(c => {
                            if (c.trim() && c.trim() !== 'æœªåˆ†é¡ž') fileTags.add(c.trim());
                        });
                    }
                    
                    // 2. From Hashtags in cells
                    if (f.cells) {
                        Object.values(f.cells).forEach(cell => {
                            const content = (cell.title || '') + ' ' + (cell.note || '');
                            const extracted = extractTags(content);
                            extracted.forEach(t => fileTags.add(t));
                        });
                    }
                    
                    fileTags.forEach(t => {
                        stats[t] = (stats[t] || 0) + 1;
                    });
                });
                return Object.entries(stats).map(([name, count]) => ({ name, count })).sort((a,b) => b.count - a.count);
            }, [fileList]);

            // Filtered File List
            const filteredFileList = useMemo(() => {
                return fileList.filter(f => {
                    if (activeCategory === 'Trash') return f.deleted;
                    if (f.deleted) return false;
                    
                    if (activeCategory === 'All') return true;
                    
                    // Check if file belongs to active Tag
                    const fileTags = new Set();
                    if (f.category) f.category.split(/[,ï¼Œ\s]+/).forEach(c => c.trim() && fileTags.add(c.trim()));
                    if (f.cells) {
                        Object.values(f.cells).forEach(cell => {
                            extractTags((cell.title || '') + ' ' + (cell.note || '')).forEach(t => fileTags.add(t));
                        });
                    }
                    return fileTags.has(activeCategory);
                });
            }, [fileList, activeCategory]);


            // --- Effects ---
            // 1. Auth Listener (Runs once)
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. File List Fetcher
            useEffect(() => {
                if (user && viewMode === 'browser') {
                    fetchFileList(user);
                }
            }, [user, viewMode]);

            useEffect(() => {
                if(!user || !currentDocId || !db || viewMode !== 'editor' || isSharedView) return;
                const timer = setTimeout(async () => {
                    setSaveStatus('saving');
                    try {
                        const path = `artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}`;
                        await db.doc(`${path}/${currentDocId}`).update({
                            cells: data, gridSize, title: docMetadata.title, category: docMetadata.category,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setSaveStatus('saved');
                    } catch(e){ setSaveStatus('error'); }
                }, 2000);
                return () => clearTimeout(timer);
            }, [data, gridSize, docMetadata, user, currentDocId, viewMode]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const importData = params.get('import'); 
                if (importData) {
                    setLoading(true);
                    try {
                        const decoded = decodeShareData(importData);
                        if (decoded) {
                            setData(decoded.cells || {});
                            setGridSize(decoded.gridSize || 3);
                            setDocMetadata({ title: decoded.title, category: decoded.category });
                            setCurrentDocId(null);
                            setIsSharedView(true);
                            setViewMode('editor');
                        }
                    } catch(e) { alert("é€£çµå¤±æ•ˆ"); }
                    setLoading(false);
                }
            }, []);

            // --- Handlers ---
            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true); setAuthError('');
                try {
                    if (authMode === 'login') await auth.signInWithEmailAndPassword(email, password);
                    else await auth.createUserWithEmailAndPassword(email, password);
                } catch(err) { setAuthError(err.message); }
                setLoading(false);
            };

            const handleSignOut = () => {
                auth.signOut().then(() => {
                    setUser(null);
                    setFileList([]);
                    setViewMode('browser');
                });
            };

            const fetchFileList = async (u = user) => {
                if(!u) return;
                try {
                    const snap = await db.collection(`artifacts/${appId}/users/${u.uid}/${USER_CONFIG.system.collectionName}`).get();
                    const files = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    files.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                    setFileList(files);
                } catch(e) { console.error(e); }
            };

            const loadFileFromDB = (file) => {
                if (file.deleted) { alert("è«‹å…ˆå¾žåžƒåœ¾ç­’é‚„åŽŸ"); return; }
                setData(file.cells || {});
                setGridSize(file.gridSize || 3);
                setCurrentDocId(file.id);
                setDocMetadata({ title: file.title, category: file.category });
                setZoomedGridIndex(null);
                setViewMode('editor');
            };

            const createNewFile = async (t, c, initialCells = {}, initialGridSize = 3) => {
                if(!user) return; setLoading(true);
                try {
                    const doc = await db.collection(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}`).add({
                        title: t, category: c, cells: initialCells, gridSize: initialGridSize, deleted: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setData(initialCells); 
                    setGridSize(initialGridSize); 
                    setCurrentDocId(doc.id); 
                    setDocMetadata({ title: t, category: c });
                    setSaveStatus('saved'); 
                    setIsSharedView(false); 
                    setZoomedGridIndex(null);
                    setShowSaveAsModal(false); 
                    setViewMode('editor');
                } catch(e) { alert("Error"); }
                setLoading(false);
            };

            const handleSaveAction = () => {
                const t = document.getElementById('save-title').value;
                const c = document.getElementById('save-cat').value;
                if(!t) return;
                
                if (modalMode === 'new') {
                    createNewFile(t, c);
                } else {
                    createNewFile(t, c, data, gridSize);
                }
            };

            const moveToTrash = async (fileId) => {
                if (!confirm("ç¢ºå®šç§»è‡³åžƒåœ¾ç­’ï¼Ÿ")) return;
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).update({
                        deleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const restoreFromTrash = async (fileId) => {
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).update({
                        deleted: false
                    });
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const deleteForever = async (fileId) => {
                if (!confirm("ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ")) return;
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).delete();
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const updateCell = (gIdx, cIdx, field, val) => {
                const k = `${gIdx}-${cIdx}`;
                const prev = data[k] || {};
                let newData = { ...data, [k]: { ...prev, [field]: val } };
                
                // --- SYNC LOGIC ---
                if (gridSize === 9 && (field === 'title' || field === 'color')) {
                    if (gIdx === 4 && cIdx !== 4) {
                        const targetK = `${cIdx}-4`;
                        newData[targetK] = { ...(data[targetK]||{}), [field]: val };
                    }
                    else if (gIdx !== 4 && cIdx === 4) {
                        const targetK = `4-${gIdx}`;
                        newData[targetK] = { ...(data[targetK]||{}), [field]: val };
                    }
                }
                setData(newData);
            };

            const clearCell = (gIdx, cIdx) => {
                if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ­¤æ ¼å…§å®¹å—Žï¼Ÿ")) return;
                const k = `${gIdx}-${cIdx}`;
                const newData = { ...data };
                delete newData[k];
                if (gridSize === 9) {
                    if (gIdx === 4 && cIdx !== 4) delete newData[`${cIdx}-4`];
                    else if (gIdx !== 4 && cIdx === 4) delete newData[`4-${gIdx}`];
                }
                setData(newData);
            };

            const handleImageUpload = async (file) => {
                if (!file) return;
                setIsUploading(true);
                try {
                    const url = await compressImage(file);
                    updateCell(selectedCell.gIdx, selectedCell.cIdx, 'images', [url]);
                } catch (e) {
                    alert("åœ–ç‰‡ä¸Šå‚³å¤±æ•—");
                }
                setIsUploading(false);
            };
            
            const handleCellClick = (gIdx, cIdx, cellData) => {
                if (gridSize === 9) {
                     if (zoomedGridIndex === null && gIdx === 4 && cIdx !== 4) { setZoomedGridIndex(cIdx); return; }
                     if (zoomedGridIndex !== null && cIdx === 4) { setZoomedGridIndex(null); return; }
                } 
                if (gridSize === 3) {
                     if ((zoomedGridIndex === null || zoomedGridIndex === 4) && cIdx !== 4) { setZoomedGridIndex(cIdx); return; }
                     if (zoomedGridIndex !== null && zoomedGridIndex !== 4 && cIdx === 4) { setZoomedGridIndex(4); return; }
                }
                setEditActiveField('title'); 
                setSelectedCell({ gIdx: (gridSize===3 && zoomedGridIndex!==null) ? zoomedGridIndex : gIdx, cIdx, data: cellData });
            };

            const getNavClass = (gIdx, cIdx) => {
                if (gridSize === 9) {
                    if (zoomedGridIndex === null && gIdx === 4 && cIdx !== 4) return 'nav-cell';
                    if (zoomedGridIndex !== null && cIdx === 4) return 'nav-cell return-cell';
                }
                if (gridSize === 3) {
                    if ((zoomedGridIndex === null || zoomedGridIndex === 4) && cIdx !== 4) return 'nav-cell';
                    if (zoomedGridIndex !== null && zoomedGridIndex !== 4 && cIdx === 4) return 'nav-cell return-cell';
                }
                return '';
            };

            // Enhanced Search Matcher
            const checkSearchMatch = (text, query) => {
                if (!query) return true;
                if (!text && text !== 0) return false;
                const target = String(text).toLowerCase();
                
                // Boolean Logic: OR logic first (split by ' OR ')
                const orGroups = query.split(/\s+OR\s+/i);
                
                return orGroups.some(group => {
                    // Inside OR group: AND logic (split by space)
                    const terms = group.trim().split(/\s+/);
                    return terms.every(term => {
                        // NOT logic: -term
                        if (term.startsWith('-')) {
                            const cleanTerm = term.substring(1).toLowerCase();
                            return cleanTerm && !target.includes(cleanTerm);
                        }
                        return target.includes(term.toLowerCase());
                    });
                });
            };

            const performGlobalSearch = () => {
                if (!searchQuery) { setGlobalSearchResults([]); return; }
                const results = [];
                fileList.forEach(file => {
                    if (file.deleted) return;
                    let matchCount = 0;
                    if (checkSearchMatch(file.title, searchQuery)) matchCount += 10;
                    if (checkSearchMatch(file.category, searchQuery)) matchCount += 5; // Search category too
                    if (file.cells) {
                        Object.values(file.cells).forEach(cell => {
                            const content = `${cell.title || ''} ${cell.note || ''}`;
                            if (checkSearchMatch(content, searchQuery)) matchCount++;
                        });
                    }
                    if (matchCount > 0) results.push({ ...file, score: matchCount });
                });
                results.sort((a,b) => b.score - a.score);
                setGlobalSearchResults(results);
                setShowGlobalSearchModal(true);
            };

            const handleImportCodeSubmit = () => {
                if(!importCode) return;
                try {
                    const parsed = JSON.parse(importCode);
                    if (confirm("å³å°‡åŒ¯å…¥æ›¼é™€ç¾…ä¸¦è‡ªå‹•å„²å­˜ç‚ºæ–°æª”æ¡ˆã€‚\n(ç¢ºå®šåŒ¯å…¥?)")) {
                        createNewFile(
                            parsed.title ? `${parsed.title} (åŒ¯å…¥)` : 'åŒ¯å…¥çš„åˆ†äº«',
                            parsed.category || 'ä¸€èˆ¬',
                            parsed.cells || {},
                            parsed.gridSize || 3
                        );
                        setShowImportModal(false);
                        setImportCode("");
                    }
                } catch(e) {
                    alert("ä»£ç¢¼æ ¼å¼éŒ¯èª¤");
                }
            };

            const handleExportFile = () => {
                const shareObj = { title: docMetadata.title, category: docMetadata.category, gridSize: gridSize, cells: data, isShareFile: true };
                const blob = new Blob([JSON.stringify(shareObj)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Mandala_Share_${docMetadata.title}.json`;
                a.click();
                setShowShareModal(false);
            };

            const handleCopyCode = () => {
                const shareObj = { title: docMetadata.title, category: docMetadata.category, gridSize: gridSize, cells: data };
                const json = JSON.stringify(shareObj);
                const textArea = document.createElement("textarea");
                textArea.value = json;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                alert("ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
                setShowShareModal(false);
            };

            const handleExportJPG = async () => {
                setLoading(true);
                const element = document.getElementById('mandala-grid-container');
                if (!element) return;
                const exportContainer = element.cloneNode(true);
                exportContainer.style.width = '1200px'; 
                exportContainer.style.height = 'auto';
                exportContainer.style.position = 'fixed';
                exportContainer.style.top = '-9999px';
                exportContainer.style.zIndex = '-999';
                exportContainer.classList.add('export-mode');
                const header = document.createElement('div');
                header.style.textAlign = 'center';
                header.style.marginBottom = '20px';
                header.innerHTML = `<h1 class="garden-title" style="font-size:32px; color:#44403c; margin-bottom:5px;">${docMetadata.title}</h1><p style="font-size:14px; color:#78716c;">${docMetadata.category} | Linkc Mandala</p>`;
                exportContainer.insertBefore(header, exportContainer.firstChild);
                document.body.appendChild(exportContainer);
                try {
                    const canvas = await html2canvas(exportContainer, { scale: 2, useCORS: true, backgroundColor: '#fcfaf9' });
                    const link = document.createElement('a');
                    link.download = `${docMetadata.title}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                } catch (e) { alert("åœ–ç‰‡åŒ¯å‡ºå¤±æ•—"); }
                document.body.removeChild(exportContainer);
                setLoading(false);
                setShowExportModal(false);
            };

            const handleExportMD = () => {
                const now = new Date().toISOString().split('T')[0];
                const tagList = parseCategories(docMetadata.category);
                const tagsString = `[${tagList.join(', ')}]`;
                let md = `---\ncreated: ${now}\ncategories: Mandala\ntags: ${tagsString}\n---\n\n# ${docMetadata.title}\n\n`;
                
                const size = gridSize;
                const rows = size === 9 ? 9 : 3;
                const cols = size === 9 ? 9 : 3;
                md += `| ${Array(cols).fill(' ').join(' | ')} |\n`;
                md += `| ${Array(cols).fill('---').join(' | ')} |\n`;
                for (let r = 0; r < rows; r++) {
                    let rowContent = [];
                    for (let c = 0; c < cols; c++) {
                        let gIdx, cIdx;
                        if (size === 3) { gIdx = 4; cIdx = r * 3 + c; }
                        else {
                            const gridRow = Math.floor(r / 3);
                            const gridCol = Math.floor(c / 3);
                            gIdx = gridRow * 3 + gridCol;
                            const cellRow = r % 3;
                            const cellCol = c % 3;
                            cIdx = cellRow * 3 + cellCol;
                        }
                        const key = `${gIdx}-${cIdx}`;
                        const cell = data[key] || {};
                        rowContent.push((cell.title || '').replace(/\n/g, ' '));
                    }
                    md += `| ${rowContent.join(' | ')} |\n`;
                }
                md += `\n\n`;

                Object.keys(data).sort().forEach(key => {
                    const cell = data[key];
                    if (cell.title) {
                        md += `## [${key}] ${cell.title}\n`;
                        if(cell.note) md += `${cell.note}\n\n`;
                    }
                });
                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${docMetadata.title}.md`;
                a.click();
                setShowExportModal(false);
            };

            const handleExportPDF = async () => {
                setLoading(true);
                const element = document.getElementById('mandala-grid-container');
                if (!element) return;
                const exportContainer = element.cloneNode(true);
                exportContainer.style.width = '1000px'; 
                exportContainer.style.height = 'auto';
                exportContainer.style.position = 'fixed';
                exportContainer.style.top = '-9999px';
                exportContainer.classList.add('export-mode');
                const header = document.createElement('div');
                header.style.textAlign = 'center';
                header.style.marginBottom = '20px';
                header.innerHTML = `<h1 class="garden-title" style="font-size:32px; color:#44403c; margin-bottom:5px;">${docMetadata.title}</h1>`;
                exportContainer.insertBefore(header, exportContainer.firstChild);
                document.body.appendChild(exportContainer);
                try {
                    const canvas = await html2canvas(exportContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const margin = 10;
                    const maxImgWidth = pageWidth - (margin * 2);
                    const imgHeight = (canvas.height * maxImgWidth) / canvas.width;
                    pdf.addImage(imgData, 'JPEG', margin, margin, maxImgWidth, imgHeight);
                    pdf.save(`${docMetadata.title}.pdf`);
                } catch (e) { alert("PDF åŒ¯å‡ºå¤±æ•—"); }
                document.body.removeChild(exportContainer);
                setLoading(false);
                setShowExportModal(false);
            };

            const handleExportXLS = () => {
                let tableHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body>`;
                tableHTML += `<h2>${docMetadata.title}</h2>`;
                tableHTML += `<table border="1" style="border-collapse: collapse; table-layout: fixed;">`;
                
                const size = gridSize;
                const rows = size === 9 ? 9 : 3;
                const cols = size === 9 ? 9 : 3;

                // Loop rows
                for (let r = 0; r < rows; r++) {
                    let rowTitleHTML = `<tr style="height: 40px;">`;
                    let rowNoteHTML = `<tr style="height: 80px;">`;

                    for (let c = 0; c < cols; c++) {
                        let gIdx, cIdx;
                        if (size === 3) {
                            gIdx = 4; 
                            cIdx = r * 3 + c;
                        } else {
                            const gridRow = Math.floor(r / 3);
                            const gridCol = Math.floor(c / 3);
                            gIdx = gridRow * 3 + gridCol;
                            const cellRow = r % 3;
                            const cellCol = c % 3;
                            cIdx = cellRow * 3 + cellCol;
                        }
                        
                        const key = `${gIdx}-${cIdx}`;
                        const cell = data[key] || {};
                        const bg = cell.color ? cell.color : '#ffffff';
                        
                        const text = cell.title ? `<strong>${cell.title}</strong>` : '&nbsp;';
                        rowTitleHTML += `<td style="background-color:${bg}; vertical-align:middle; text-align:center; padding:5px; width:150px; border: 1px solid #000; border-bottom: none; font-size:12pt; mso-number-format:'\@';">${text}</td>`;
                        
                        const note = cell.note ? `<span style="color:#555;">${cell.note}</span>` : '&nbsp;';
                        rowNoteHTML += `<td style="background-color:${bg}; vertical-align:top; padding:5px; width:150px; border: 1px solid #000; border-top: none; font-size:10pt; word-wrap: break-word; mso-number-format:'\@';">${note}</td>`;
                    }
                    
                    rowTitleHTML += `</tr>`;
                    rowNoteHTML += `</tr>`;
                    
                    tableHTML += rowTitleHTML + rowNoteHTML;
                }
                tableHTML += `</table></body></html>`;

                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${docMetadata.title}.xls`;
                a.click();
                setShowExportModal(false);
            };

            const handleFileMenu = (e) => {
                const action = e.target.value;
                e.target.value = "";
                if (action === "new") {
                    if (confirm("æ¸…ç©ºä¸¦é–‹æ–°æª”æ¡ˆï¼Ÿ")) {
                        setData({}); setCurrentDocId(null); setDocMetadata({title:'æœªå‘½å', category:'ä¸€èˆ¬'});
                        setIsSharedView(false); setZoomedGridIndex(null);
                    }
                } else if (action === "save") {
                    if (isSharedView) { alert("åˆ†äº«æª”è«‹å¦å­˜"); setModalMode('save_as'); setShowSaveAsModal(true); } 
                    else { currentDocId ? alert("å·²è‡ªå‹•å„²å­˜") : (()=>{setModalMode('save_as'); setShowSaveAsModal(true);})() }
                } else if (action === "save_as") {
                    setModalMode('save_as');
                    setShowSaveAsModal(true);
                } else if (action === "back") {
                    if (isSharedView) window.history.replaceState({}, document.title, window.location.pathname);
                    setViewMode('browser'); setIsSharedView(false); setZoomedGridIndex(null);
                } else if (action === "import") {
                    fileInputRef.current?.click(); 
                } else if (action === "export_drive") {
                    setShowExportModal(true); 
                } else if (action === "share") {
                    setShowShareModal(true);
                }
            };

            const handleLoadLocal = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const parsed = JSON.parse(ev.target.result);
                        if (confirm("å³å°‡åŒ¯å…¥æ›¼é™€ç¾…ä¸¦è‡ªå‹•å„²å­˜ç‚ºæ–°æª”æ¡ˆã€‚\n(ç¢ºå®šåŒ¯å…¥?)")) {
                            createNewFile(
                                parsed.title ? `${parsed.title} (åŒ¯å…¥)` : 'åŒ¯å…¥çš„åˆ†äº«',
                                parsed.category || 'ä¸€èˆ¬',
                                parsed.cells || {},
                                parsed.gridSize || 3
                            );
                        }
                    } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };
            
            const handleEmojiClick = (emoji) => {
                const key = `${selectedCell.gIdx}-${selectedCell.cIdx}`;
                const currentVal = (data[key] || {})[editActiveField] || '';
                updateCell(selectedCell.gIdx, selectedCell.cIdx, editActiveField, currentVal + emoji);
            };

            // -- Views --
            const renderCell = (gIdx, cIdx) => {
                const targetGrid = (gridSize === 3 && zoomedGridIndex !== null) ? zoomedGridIndex : gIdx;
                const cellData = data[`${targetGrid}-${cIdx}`] || {};
                const navClass = getNavClass(targetGrid, cIdx);
                
                // Defaults Logic
                const defaultBg = ((targetGrid===4 && cIdx===4)?'#ecfdf5':(targetGrid===4?'#fdfcdc':(cIdx===4?'#fdfcdc':'#ffffff')));
                
                // Transparency Logic (RGBA 0.25)
                const finalBg = cellData.color ? getTransparentColor(cellData.color, 0.25) : defaultBg;
                
                // Text color
                const textColor = '#44403c'; 

                return (
                    <div className={`relative border border-stone-300 p-1 flex flex-col h-full overflow-hidden group ${navClass}`}
                         style={{backgroundColor: finalBg, color: textColor}}
                         onClick={() => handleCellClick(targetGrid, cIdx, cellData)}>
                        <div className="flex-1 overflow-hidden flex flex-col justify-start items-center w-full">
                            <div className="font-bold text-xs md:text-sm leading-tight mb-1 text-center w-full" dangerouslySetInnerHTML={{__html: safeMarkdownInline(cellData.title||'')}} />
                            {viewStyle === 'standard' && <div className="text-[10px] opacity-80 overflow-hidden md-content w-full text-left" dangerouslySetInnerHTML={{__html: safeMarkdown(cellData.note||'')}} />}
                        </div>
                        {navClass && <div className="edit-btn-overlay" onClick={(e)=>{ e.stopPropagation(); setSelectedCell({ gIdx: targetGrid, cIdx, data: cellData }); }}><Icons.Pencil/></div>}
                        
                        <div className="absolute bottom-1 left-1 flex gap-1 z-20">
                            {cellData.link && (
                                <div className="content-icon bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-600"
                                     onClick={(e)=>{ e.stopPropagation(); window.open(cellData.link, '_blank'); }}>
                                    <Icons.Link/>
                                </div>
                            )}
                            {cellData.images && cellData.images.length > 0 && (
                                <div className="content-icon bg-emerald-50 text-emerald-600 border-emerald-200 hover:bg-emerald-600"
                                     onClick={(e)=>{ e.stopPropagation(); setPreviewImage(cellData.images[0]); }}>
                                    <Icons.Photo/>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderGrid = () => {
                if (gridSize === 9 && zoomedGridIndex === null) {
                    return (
                        <div className="grid grid-cols-3 grid-rows-3 gap-px bg-stone-200 w-full h-full mx-auto aspect-square">
                            {Array.from({length:9}).map((_, g) => (
                                <div key={g} className={`grid grid-cols-3 grid-rows-3 gap-px bg-white ${g===4?'border-2 border-emerald-400 z-10':''}`}>
                                    {Array.from({length:9}).map((_, c) => renderCell(g, c))}
                                </div>
                            ))}
                        </div>
                    );
                } else {
                    const activeGrid = zoomedGridIndex !== null ? zoomedGridIndex : 4;
                    return (
                        <div className="flex flex-col h-full items-center justify-center">
                             <div className="w-full max-w-xl mb-2 flex items-center text-xs text-stone-500 gap-2 px-2">
                                <span className="cursor-pointer hover:text-emerald-600" onClick={()=>setZoomedGridIndex(gridSize===9?null:4)}><Icons.Folder/> {gridSize===9?'å…¨æ™¯':'ä¸»ç•«é¢'}</span>
                                <span>/</span>
                                <span className="font-bold text-stone-700">{activeGrid === 4 ? 'æ ¸å¿ƒä¸»é¡Œ' : `å€åŸŸ ${activeGrid}`}</span>
                             </div>
                             <div className="grid grid-cols-3 grid-rows-3 gap-1 bg-stone-300 border-4 border-stone-300 w-full max-w-xl aspect-square shadow-xl">
                                {Array.from({length: 9}).map((_, c) => renderCell(activeGrid, c))}
                            </div>
                        </div>
                    );
                }
            };

            // -- Sidebar Component --
            const SidebarContent = () => (
                <>
                    <div className="mb-6 px-2 text-center">
                        <div className="text-lg font-medium text-stone-500 font-serif leading-none">{getUserName(user)}'s</div>
                        <div className="text-xl font-bold text-stone-800 garden-title mt-1">Mandala Garden</div>
                    </div>
                    
                    <button 
                        onClick={() => { setShowGlobalSearchModal(true); setIsSidebarOpen(false); }} 
                        className="w-full text-left p-2 rounded flex items-center gap-2 hover:bg-stone-50 text-stone-600 mb-2 border border-stone-100"
                    >
                        <Icons.Search/> <span>å…¨åŸŸæœå°‹...</span>
                    </button>

                    <button onClick={()=>{ setActiveCategory('All'); setIsSidebarOpen(false); }} className={`w-full text-left p-2 rounded ${activeCategory==='All'?'bg-emerald-50':''}`}><Icons.Folder/> å…¨éƒ¨æª”æ¡ˆ ({activeFileCount})</button>
                    <button onClick={()=>{ setActiveCategory('Trash'); setIsSidebarOpen(false); }} className={`w-full text-left p-2 rounded ${activeCategory==='Trash'?'bg-rose-50':''}`}><Icons.Trash/> åžƒåœ¾ç­’ ({trashFileCount})</button>
                    
                    <div className="border-t my-2 pt-2">
                        <div className="px-2 text-xs font-bold text-stone-400 mb-2 flex justify-between items-center">
                            <span>æ¨™ç±¤åˆ†é¡ž</span>
                            <span className="text-[10px] bg-stone-100 px-1 rounded">{tagStats.length}</span>
                        </div>
                        <div className="space-y-1">
                            {tagStats.length === 0 && <div className="px-2 text-xs text-stone-300">å°šç„¡æ¨™ç±¤ (ä½¿ç”¨ #tag)</div>}
                            {tagStats.slice(0, showAllTags ? undefined : 8).map(tag => (
                                <button key={tag.name} onClick={()=>{ setActiveCategory(tag.name); setIsSidebarOpen(false); }} className={`w-full text-left p-2 rounded flex justify-between items-center text-sm ${activeCategory===tag.name?'bg-emerald-50 text-emerald-700':''}`}>
                                    <span className="flex items-center gap-2 truncate"><Icons.Tag/> {tag.name}</span>
                                    <span className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{tag.count}</span>
                                </button>
                            ))}
                            {tagStats.length > 8 && (
                                <button onClick={()=>setShowAllTags(!showAllTags)} className="text-xs text-stone-400 w-full text-left px-2 py-1 hover:text-stone-600">
                                    {showAllTags ? 'æ”¶èµ·æ¨™ç±¤' : `é¡¯ç¤ºæ›´å¤š (${tagStats.length - 8})`}
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="border-t my-2 pt-2 mt-auto">
                        <button onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); setIsSidebarOpen(false); }} className="w-full text-left p-2"><Icons.Plus/> æ–°å¢žæª”æ¡ˆ</button>
                        <button onClick={()=>{ setShowImportModal(true); setIsSidebarOpen(false); }} className="w-full text-left p-2"><Icons.Share/> åŒ¯å…¥æª”æ¡ˆ</button>
                        <button onClick={()=>auth.signOut()} className="w-full text-left p-2"><Icons.SignOut/> ç™»å‡º</button>
                    </div>
                </>
            );

            // -- Main --
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-100 p-4">
                        <div className="text-emerald-600 font-bold text-lg animate-pulse flex flex-col items-center">
                            <div className="mb-2 text-2xl">ðŸŒ¿</div>
                            <div>Loading Mandala Garden...</div>
                        </div>
                    </div>
                );
            }

            if (!user && !isSharedView) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-100 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                            <div className="mb-6">
                                <h1 className="text-3xl font-bold text-stone-800 garden-title mb-1">Mandala Garden</h1>
                                <p className="text-stone-500 text-sm">æ‚¨çš„æ€ç¶­èŠ±åœ’</p>
                            </div>
                            <form onSubmit={handleAuth} className="space-y-4 text-left">
                                <input className="w-full p-3 border rounded" type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} required />
                                <input className="w-full p-3 border rounded" type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} required />
                                {authError && <div className="text-red-500 text-xs">{authError}</div>}
                                <button className="w-full p-3 bg-emerald-600 text-white rounded font-bold">{authMode==='login'?'ç™»å…¥':'è¨»å†Š'}</button>
                            </form>
                            <button onClick={()=>setAuthMode(authMode==='login'?'register':'login')} className="w-full mt-4 text-sm text-stone-500 underline">{authMode==='login'?'æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š':'å·²æœ‰å¸³è™Ÿï¼Ÿç™»å…¥'}</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full w-full overflow-hidden text-stone-800 flex flex-col">
                    
                    {viewMode === 'browser' ? (
                        <div className="flex h-full bg-[#fcfaf9]">
                            {/* Mobile Sidebar Overlay */}
                            {isSidebarOpen && (
                                <div className="fixed inset-0 z-50 flex md:hidden">
                                    <div className="fixed inset-0 bg-black/50" onClick={() => setIsSidebarOpen(false)}></div>
                                    <div className="relative w-72 bg-white h-full shadow-xl flex flex-col p-4 animate-slide-in-left">
                                        <div className="absolute top-4 right-4"><button onClick={() => setIsSidebarOpen(false)} className="text-stone-400"><Icons.X/></button></div>
                                        <SidebarContent />
                                    </div>
                                </div>
                            )}

                            {/* Desktop Sidebar */}
                            <aside className="w-64 bg-white border-r hidden md:flex flex-col p-4">
                                <SidebarContent />
                            </aside>
                            
                            <main className="flex-1 flex flex-col">
                                <header className="h-14 border-b bg-white flex items-center px-4 justify-between sticky top-0 z-20">
                                    <div className="flex items-center gap-3">
                                        <button className="md:hidden text-stone-600" onClick={() => setIsSidebarOpen(true)}><Icons.Menu/></button>
                                        <h2 className="font-bold text-lg flex items-center gap-2">
                                            {activeCategory === 'All' ? 'å…¨éƒ¨æª”æ¡ˆ' : (activeCategory === 'Trash' ? 'åžƒåœ¾ç­’' : `# ${activeCategory}`)}
                                        </h2>
                                    </div>
                                    <button className="md:hidden bg-emerald-100 text-emerald-700 p-2 rounded-full" onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); }}><Icons.Plus/></button>
                                    <button className="hidden md:block" onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); }}><Icons.Plus/></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 content-start">
                                    {filteredFileList.length === 0 && <div className="col-span-full text-center text-stone-400 mt-10">æ²’æœ‰æ‰¾åˆ°æª”æ¡ˆ</div>}
                                    {filteredFileList.map(f => (
                                        <div key={f.id} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer h-32 flex flex-col justify-between" onClick={()=>loadFileFromDB(f)}>
                                            <div className="font-bold truncate">{f.title}</div>
                                            <div className="text-xs text-stone-400 flex justify-between">
                                                <span className="truncate max-w-[60%]">{f.category}</span>
                                                {activeCategory==='Trash' && (
                                                    <div className="flex gap-2">
                                                        <button onClick={(e)=>{e.stopPropagation(); restoreFromTrash(f.id); }} className="text-emerald-600"><Icons.Restore/></button>
                                                        <button onClick={(e)=>{e.stopPropagation(); deleteForever(f.id); }} className="text-rose-600"><Icons.DeleteForever/></button>
                                                    </div>
                                                )}
                                                {activeCategory!=='Trash' && (
                                                    <button onClick={(e)=>{e.stopPropagation(); moveToTrash(f.id); }} className="text-stone-300 hover:text-rose-500"><Icons.Trash/></button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </main>
                        </div>
                    ) : (
                        <div className="flex flex-col h-full bg-[#fcfaf9]">
                            <div className="h-14 bg-white border-b flex items-center justify-between px-2 md:px-4 shrink-0 gap-2">
                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                    <button onClick={()=>{setViewMode('browser'); setZoomedGridIndex(null);}} className="text-stone-500 p-1">â†</button>
                                    <input className="font-bold text-stone-800 border-none outline-none bg-transparent w-full min-w-0" value={docMetadata.title} onChange={e=>setDocMetadata({...docMetadata, title:e.target.value})} />
                                    <button onClick={()=>setShowMetadataModal(true)} className="p-1 rounded hover:bg-stone-100 text-stone-500" title="ç·¨è¼¯æ¨™ç±¤"><Icons.Tag/></button>
                                </div>
                                <div className="flex gap-2 items-center shrink-0">
                                    <button className="hidden sm:block" onClick={()=>setShowExportModal(true)}><Icons.Export/></button>
                                    <button className="hidden sm:block" onClick={()=>setShowShareModal(true)}><Icons.Share/></button>
                                    <div className="flex border rounded overflow-hidden text-[10px] md:text-xs">
                                        <button onClick={()=>setGridSize(3)} className={`px-2 py-1 ${gridSize===3?'bg-emerald-100':''}`}>3x3</button>
                                        <button onClick={()=>setGridSize(9)} className={`px-2 py-1 ${gridSize===9?'bg-emerald-100':''}`}>9x9</button>
                                    </div>
                                    <select className="border rounded text-xs p-1 max-w-[80px]" onChange={handleFileMenu}>
                                        <option value="">é¸å–®</option>
                                        <option value="save">å„²å­˜</option>
                                        <option value="save_as">å¦å­˜</option>
                                        <option value="new">é–‹æ–°</option>
                                        <option className="sm:hidden" value="share">åˆ†äº«</option>
                                        <option className="sm:hidden" value="export_drive">åŒ¯å‡º</option>
                                        <option value="import">åŒ¯å…¥</option>
                                        <option value="back">åˆ—è¡¨</option>
                                    </select>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleLoadLocal} />
                                </div>
                            </div>
                            <div className="flex-1 overflow-hidden relative" id="mandala-grid-container">
                                {renderGrid()}
                            </div>
                        </div>
                    )}

                    {/* Modals */}
                    {/* ... existing Modals: previewImage, selectedCell, showSaveAsModal, showImportModal, showShareModal, showExportModal ... */}
                    {previewImage && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[60]" onClick={()=>setPreviewImage(null)}>
                            <img src={previewImage} className="max-w-full max-h-full object-contain" />
                            <button className="absolute top-4 right-4 text-white text-4xl" onClick={()=>setPreviewImage(null)}>Ã—</button>
                        </div>
                    )}

                    {selectedCell && (
                        <div className="fixed inset-0 bg-black/50 flex items-end md:items-center justify-center z-50" onClick={()=>setSelectedCell(null)}>
                            <div className="bg-white w-full h-[90dvh] md:h-auto md:max-h-[85vh] md:w-full md:max-w-md rounded-t-xl md:rounded-xl overflow-hidden shadow-2xl flex flex-col transition-transform duration-300 animate-slide-up md:animate-none" onClick={e=>e.stopPropagation()}>
                                <div className="p-3 bg-emerald-600 text-white font-bold flex justify-between items-center">
                                    <span className="text-sm md:text-base">ç·¨è¼¯å…§å®¹ {selectedCell.gIdx}-{selectedCell.cIdx}</span>
                                    <button onClick={()=>setSelectedCell(null)} className="text-white/80 hover:text-white px-2">âœ•</button>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1 flex flex-col gap-4">
                                    
                                    {/* Title Section */}
                                    <div className="space-y-1">
                                        <label className="text-xs text-stone-500 font-bold">æ¨™é¡Œ</label>
                                        <input 
                                            className={`w-full border p-2 rounded text-stone-800 font-bold focus:ring-2 focus:ring-emerald-500 outline-none ${editActiveField==='title'?'border-emerald-500':''}`} 
                                            placeholder="è¼¸å…¥æ¨™é¡Œ..." 
                                            value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).title || ''} 
                                            onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'title', e.target.value)}
                                            onFocus={()=>setEditActiveField('title')}
                                        />
                                    </div>

                                    {/* Note Section */}
                                    <div className="space-y-1 flex-1">
                                        <label className="text-xs text-stone-500 font-bold">å‚™è¨»</label>
                                        <textarea 
                                            className={`w-full border p-2 rounded h-32 text-stone-800 focus:ring-2 focus:ring-emerald-500 outline-none resize-none ${editActiveField==='note'?'border-emerald-500':''}`} 
                                            placeholder="è¼¸å…¥å‚™è¨»..." 
                                            value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).note || ''} 
                                            onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'note', e.target.value)}
                                            onFocus={()=>setEditActiveField('note')}
                                        ></textarea>
                                    </div>
                                    
                                    {/* Emoji Section - MOVED HERE */}
                                    <div className="space-y-2 border rounded-lg p-2 bg-stone-50/50">
                                        <div className="flex justify-between items-center px-1">
                                            <span className="text-xs font-bold text-stone-500 flex items-center gap-1">ðŸ˜€ æ’å…¥ Emoji</span>
                                            <span className="text-[10px] text-stone-400 bg-white px-2 py-0.5 rounded border">è‡³: {editActiveField === 'title' ? 'æ¨™é¡Œ' : 'å‚™è¨»'}</span>
                                        </div>
                                        
                                        {/* Category Tabs */}
                                        <div className="flex gap-1 overflow-x-auto pb-1 scrollbar-hide">
                                            {Object.keys(EMOJI_CATEGORIES).map(cat => (
                                                <button 
                                                    key={cat}
                                                    type="button"
                                                    onClick={(e) => { e.preventDefault(); e.stopPropagation(); setEmojiTab(cat); }}
                                                    className={`px-3 py-1 text-xs rounded-full whitespace-nowrap transition-colors ${emojiTab === cat ? 'bg-emerald-100 text-emerald-700 font-bold' : 'bg-white text-stone-500 hover:bg-stone-100'}`}
                                                >
                                                    {cat}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Emoji Grid */}
                                        <div className="grid grid-cols-8 gap-1 h-32 overflow-y-auto p-1 bg-white rounded border border-stone-100">
                                            {EMOJI_CATEGORIES[emojiTab].map(emoji => (
                                                <button 
                                                    key={emoji} 
                                                    type="button"
                                                    onClick={() => handleEmojiClick(emoji)} 
                                                    className="aspect-square flex items-center justify-center text-lg hover:bg-emerald-50 rounded transition hover:scale-110 active:scale-95"
                                                >
                                                    {emoji}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Tools Row: Link & Color */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-xs text-stone-500 font-bold">é€£çµ</label>
                                            <input className="w-full border p-2 rounded text-sm text-stone-600 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="https://..." value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).link || ''} onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'link', e.target.value)} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs text-stone-500 font-bold">èƒŒæ™¯é¡è‰²</label>
                                            <div className="flex items-center border p-1 rounded h-[38px]">
                                                <input type="color" className="w-full h-full cursor-pointer bg-transparent border-none" value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).color?.startsWith('#') ? (data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).color : '#ffffff'} onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'color', e.target.value)} />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Image Upload */}
                                    <div className="space-y-1">
                                        <label className="text-xs text-stone-500 font-bold">åœ–ç‰‡</label>
                                        <div className="border p-2 rounded bg-stone-50 flex items-center justify-between">
                                             {isUploading ? (
                                                <span className="text-emerald-600 text-sm animate-pulse">ä¸Šå‚³ä¸­...</span>
                                            ) : (
                                                <input type="file" className="text-sm text-stone-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200" onChange={e => handleImageUpload(e.target.files[0])} />
                                            )}
                                            {(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).images?.length > 0 && (
                                                <span className="text-xs text-stone-500 bg-white px-2 py-1 rounded border">å·²å­˜ 1 åœ–</span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Footer Buttons */}
                                <div className="p-3 border-t bg-stone-50 flex justify-between items-center">
                                    <button 
                                        onClick={()=>clearCell(selectedCell.gIdx, selectedCell.cIdx)}
                                        className="text-red-500 text-sm hover:bg-red-50 px-3 py-1.5 rounded transition font-medium"
                                    >
                                        æ¸…é™¤å…§å®¹
                                    </button>
                                    <button 
                                        onClick={()=>setSelectedCell(null)}
                                        className="bg-white border border-stone-300 text-stone-600 px-4 py-1.5 rounded text-sm hover:bg-stone-100 transition shadow-sm font-medium"
                                    >
                                        é—œé–‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSaveAsModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80">
                                <h3 className="font-bold mb-4">{modalMode === 'new' ? 'å»ºç«‹æ–°æª”æ¡ˆ' : 'å¦å­˜æ–°æª”'}</h3>
                                <input id="save-title" className="w-full border p-2 rounded mb-2" defaultValue={docMetadata.title} placeholder="æ¨™é¡Œ" />
                                <input id="save-cat" className="w-full border p-2 rounded mb-4" defaultValue={docMetadata.category} placeholder="åˆ†é¡ž" />
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setShowSaveAsModal(false)} className="px-4 py-2">å–æ¶ˆ</button>
                                    <button onClick={handleSaveAction} className="px-4 py-2 bg-emerald-600 text-white rounded">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Metadata Modal (New) */}
                    {showMetadataModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80">
                                <h3 className="font-bold mb-4">ç·¨è¼¯æª”æ¡ˆè³‡è¨Š</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs text-stone-500 mb-1">æ¨™é¡Œ</label>
                                        <input className="w-full border p-2 rounded" value={docMetadata.title} onChange={e=>setDocMetadata({...docMetadata, title:e.target.value})} placeholder="æª”æ¡ˆæ¨™é¡Œ" />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-stone-500 mb-1">åˆ†é¡žæ¨™ç±¤</label>
                                        <input className="w-full border p-2 rounded" value={docMetadata.category} onChange={e=>setDocMetadata({...docMetadata, category:e.target.value})} placeholder="ä¾‹å¦‚: å·¥ä½œ, éˆæ„Ÿ" />
                                    </div>
                                </div>
                                <div className="flex justify-end mt-6">
                                    <button onClick={()=>setShowMetadataModal(false)} className="px-4 py-2 bg-emerald-600 text-white rounded">å®Œæˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-96">
                                <h3 className="font-bold mb-4">åŒ¯å…¥</h3>
                                <textarea className="w-full border p-2 h-32 text-xs mb-2" value={importCode} onChange={e=>setImportCode(e.target.value)} placeholder="è²¼ä¸Šä»£ç¢¼..."></textarea>
                                <button onClick={handleImportCodeSubmit} className="w-full bg-stone-800 text-white py-2 rounded">åŒ¯å…¥ä¸¦å­˜æª”</button>
                                <button onClick={()=>setShowImportModal(false)} className="w-full mt-2 text-stone-500">å–æ¶ˆ</button>
                            </div>
                        </div>
                    )}

                    {showShareModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80 text-center">
                                <h3 className="font-bold mb-4">åˆ†äº«</h3>
                                <button onClick={handleCopyCode} className="w-full border p-2 rounded mb-2">è¤‡è£½ä»£ç¢¼</button>
                                <button onClick={handleExportFile} className="w-full border p-2 rounded mb-2">ä¸‹è¼‰ JSON</button>
                                <button onClick={()=>setShowShareModal(false)} className="text-stone-500 mt-2">é—œé–‰</button>
                            </div>
                        </div>
                    )}
                    
                     {showExportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-64 space-y-2 text-center">
                                <h3 className="font-bold mb-4">åŒ¯å‡º</h3>
                                <button onClick={handleExportXLS} className="w-full border p-2 rounded">Excel</button>
                                <button onClick={handleExportJPG} className="w-full border p-2 rounded">JPG</button>
                                <button onClick={handleExportPDF} className="w-full border p-2 rounded">PDF</button>
                                <button onClick={handleExportMD} className="w-full border p-2 rounded">Markdown</button>
                                <button onClick={()=>setShowExportModal(false)} className="text-stone-500 mt-2">é—œé–‰</button>
                            </div>
                        </div>
                    )}

                    {showGlobalSearchModal && (
                         <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity duration-300">
                            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[70vh] overflow-hidden transform transition-all scale-100">
                                <div className="p-4 border-b flex justify-between items-center bg-stone-50/80">
                                    <h3 className="font-bold text-stone-700 flex items-center gap-2 text-lg">
                                        <span className="text-emerald-600"><Icons.Search/></span> å…¨åŸŸæœå°‹
                                    </h3>
                                    <button onClick={()=>setShowGlobalSearchModal(false)} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200 text-stone-500 transition">
                                        <Icons.X/>
                                    </button>
                                </div>
                                
                                <div className="p-4 bg-white border-b border-stone-100">
                                    <div className="flex gap-2">
                                        <div className="relative flex-1 group">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-500 transition-colors">
                                                <Icons.Search />
                                            </div>
                                            <input 
                                                className="w-full pl-10 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-100 focus:border-emerald-500 outline-none transition-all text-stone-700" 
                                                value={searchQuery} 
                                                onChange={e=>setSearchQuery(e.target.value)} 
                                                onKeyDown={e => e.key === 'Enter' && performGlobalSearch()}
                                                placeholder="è¼¸å…¥é—œéµå­—..." 
                                                autoFocus
                                            />
                                        </div>
                                        <button 
                                            onClick={performGlobalSearch} 
                                            className="bg-emerald-600 hover:bg-emerald-700 text-white px-5 rounded-xl font-medium transition-all shadow-md hover:shadow-lg active:scale-95 flex items-center justify-center"
                                            title="æœå°‹"
                                        >
                                            <Icons.Search className="w-5 h-5" />
                                        </button>
                                    </div>
                                    <div className="mt-3 flex justify-center gap-3 text-[10px] text-stone-400 font-medium">
                                        <span className="bg-stone-100 px-2 py-1 rounded-md">ç©ºæ ¼ = AND</span>
                                        <span className="bg-stone-100 px-2 py-1 rounded-md">OR</span>
                                        <span className="bg-stone-100 px-2 py-1 rounded-md">-é—œéµå­— = NOT</span>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto bg-stone-50/30 p-2">
                                    {globalSearchResults.length === 0 && searchQuery && (
                                        <div className="flex flex-col items-center justify-center py-12 text-stone-400">
                                            <div className="text-4xl mb-3 opacity-50">ðŸ”</div>
                                            <div className="text-sm">æ‰¾ä¸åˆ°ç¬¦åˆã€Œ{searchQuery}ã€çš„çµæžœ</div>
                                        </div>
                                    )}
                                    {globalSearchResults.length === 0 && !searchQuery && (
                                        <div className="flex flex-col items-center justify-center py-12 text-stone-300">
                                            <div className="text-4xl mb-3 opacity-30">âŒ¨ï¸</div>
                                            <div className="text-sm">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹</div>
                                        </div>
                                    )}
                                    <div className="space-y-2">
                                        {globalSearchResults.map(f => (
                                            <div 
                                                key={f.id} 
                                                className="bg-white border border-stone-100 p-3 rounded-xl cursor-pointer hover:border-emerald-300 hover:shadow-md transition-all group" 
                                                onClick={()=>{ loadFileFromDB(f); setShowGlobalSearchModal(false); }}
                                            >
                                                <div className="flex justify-between items-start mb-1">
                                                    <div className="font-bold text-stone-700 group-hover:text-emerald-700 transition-colors">{f.title}</div>
                                                    <div className="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full font-bold">
                                                        åŒ¹é…åº¦: {f.score}
                                                    </div>
                                                </div>
                                                <div className="text-xs text-stone-400 flex items-center gap-2">
                                                    <span className="bg-stone-100 px-1.5 rounded text-[10px]">{f.category || 'æœªåˆ†é¡ž'}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
