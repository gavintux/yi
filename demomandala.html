<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mandala Garden</title>
    <link rel="icon" href="https://duk.tw/3eXGrY.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'slide-in-left': 'slideInLeft 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideInLeft: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Utils -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #fcfaf9; height: 100dvh; width: 100vw; overflow: hidden; color: #44403c; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .grid-border { border-color: #d6d3d1; }
        .dash-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .dash-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(87, 105, 85, 0.1); }
        .garden-title { font-family: 'Noto Serif TC', serif; }
        
        .export-mode .export-hidden { display: none !important; }
        .export-mode .export-full-text { white-space: normal !important; overflow: visible !important; display: block !important; -webkit-line-clamp: unset !important; line-clamp: unset !important; height: auto !important; font-size: 0.7rem !important; line-height: 1.1 !important; }
        .export-mode .grid-cell-content { padding: 2px !important; }

        /* Navigation Styles */
        .nav-cell { cursor: pointer; position: relative; }
        .nav-cell:hover { background-color: rgba(16, 185, 129, 0.1) !important; }
        .nav-cell::after { content: "‚Üó"; position: absolute; top: 2px; left: 2px; font-size: 10px; color: #059669; opacity: 0.6; transition: all 0.2s; font-weight: bold; }
        .nav-cell.return-cell::after { content: "‚Ü©"; }
        .nav-cell:hover::after { transform: scale(1.2); opacity: 1; }
        
        .edit-btn-overlay { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; cursor: pointer; z-index: 30; opacity: 0; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .group:hover .edit-btn-overlay { opacity: 1; }
        .edit-btn-overlay:hover { background: #10b981; color: white; border-color: #10b981; }

        .content-icon { width: 16px; height: 16px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; background: rgba(255,255,255,0.8); border: 1px solid #d1d5db; color: #4b5563; cursor: pointer; transition: all 0.2s; }
        .content-icon:hover { background: #10b981; color: white; border-color: #10b981; transform: scale(1.1); }

        .md-content a { color: #059669; text-decoration: underline; pointer-events: auto; }
        .md-content p { margin-bottom: 0.2em; }
        .md-content ul { padding-left: 1rem; list-style: disc; }
        .md-content ol { padding-left: 1rem; list-style: decimal; }
        
        /* Custom scrollbar for emoji list and sidebar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const USER_CONFIG = {
            seo: { title: "Mandala Garden", logoImage: "https://firebasestorage.googleapis.com/v0/b/linkcphoto.firebasestorage.app/o/photos%2Flinkc-w0.png?alt=media&token=63c9b589-aa78-480a-bed2-1c83634f4b9f", logoLink: "https://gavintux.github.io/yi/" },
            firebase: { apiKey: "AIzaSyDmPdUMPzloG7f_9qBpeUGIvG0iyebgyXI",
                        authDomain: "fir-7bf67.firebaseapp.com",
                        projectId: "fir-7bf67",
                        storageBucket: "fir-7bf67.firebasestorage.app",
                        messagingSenderId: "23185940342",
                        appId: "1:23185940342:web:ac7b9919f39ae9858a6457",
                        measurementId: "G-W9DJ13E9CH"
                     },          
            system: { collectionName: 'mandala_charts', defaultGridSize: 3, defaultViewStyle: 'standard' }
        };

        try { firebase.initializeApp(USER_CONFIG.firebase); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Utils
        const getContrastColor = (hex) => {
            if (!hex || !hex.startsWith('#')) return '#44403c'; 
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#44403c' : '#ffffff';
        };

        const safeMarkdown = (text) => { try { return typeof marked !== 'undefined' ? marked.parse(text) : text; } catch { return text; } };
        const safeMarkdownInline = (text) => { try { return typeof marked !== 'undefined' ? marked.parseInline(text) : text; } catch { return text; } };
        const encodeShareData = (d) => btoa(unescape(encodeURIComponent(JSON.stringify(d))));
        const decodeShareData = (s) => JSON.parse(decodeURIComponent(escape(atob(s))));
        const compressImage = (file) => new Promise((res) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const w = 300; c.width=w; c.height=i.height*(w/i.width); c.getContext('2d').drawImage(i,0,0,w,c.height); res(c.toDataURL('image/jpeg', 0.7)); } } });
        const extractTags = (text) => (text?.match(/#[\w\u4e00-\u9fa5]+/g) || []).map(x => x.substring(1));
        const parseCategories = (s) => (!s ? ['Êú™ÂàÜÈ°û'] : s.split(/[,Ôºå\s]+/).filter(c=>c.trim().length>0));
        
        const getUserName = (user) => {
            if (!user || !user.email) return "Guest";
            const name = user.email.split('@')[0];
            return name.charAt(0).toUpperCase() + name.slice(1);
        };

        const EMOJI_CATEGORIES = {
            "Ë°®ÊÉÖ": ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üëè', 'üëã', 'üëç', 'üëé', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'ü§û', '‚úåÔ∏è', 'ü§ü', 'ü§ò', 'üëå', 'ü§è', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', '‚úã', 'ü§ö', 'üñêÔ∏è', 'üññ', 'üôè', 'üí™', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è'],
            "Ëá™ÁÑ∂": ['üåø', 'üå∏', 'üåº', 'üçÑ', 'üå±', 'üçÉ', 'üåª', 'üåµ', 'üå∫', 'üçÇ', 'üåπ', 'üå∑', 'üíê', 'ü™¥', 'üå≤', 'üå≥', 'üå¥', 'ü™µ', 'ü™®', 'üåæ', 'üéã', 'üçÅ', 'üçá', 'üçà', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçë', 'üçí', 'üçì', 'ü´ê', 'ü•ù', 'üçÖ', 'ü´í', 'ü••', 'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ', 'üå∂Ô∏è', 'ü´ë', 'ü•í', 'ü•¨', 'ü•¶', 'üßÑ', 'üßÖ', 'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üêª‚Äç‚ùÑÔ∏è', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üêΩ', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'ü™±', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü™∞', 'ü™≤', 'ü™≥', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'ü¶≠', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'ü¶£', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'ü¶¨', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêà‚Äç‚¨õ', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶´', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î', 'üêæ', 'üêâ', 'üê≤', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå•Ô∏è', '‚òÅÔ∏è', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üå¨Ô∏è', 'üí®', 'üíß', 'üí¶', '‚òî', '‚òÇÔ∏è', 'üåä', 'üå´Ô∏è', 'üåç', 'üåé', 'üåè', 'üåë', 'üåí', 'üåì', 'üåî', 'üåï', 'üåñ', 'üåó', 'üåò', 'üåô', 'üåö', 'üåõ', 'üåú', 'üåû', '‚≠ê', 'üåü', 'üå†', 'üåå', 'ü™ê', 'üí´', '‚òÑÔ∏è', 'üî•', 'üåã'],
            "Áâ©‰ª∂": ['üí°', 'üî¶', 'üèÆ', 'ü™î', 'üìî', 'üìï', 'üìñ', 'üìó', 'üìò', 'üìô', 'üìö', 'üìì', 'üìí', 'üìÉ', 'üìú', 'üìÑ', 'üì∞', 'üóûÔ∏è', 'üìë', 'üîñ', 'üè∑Ô∏è', 'üí∞', 'ü™ô', 'üí¥', 'üíµ', 'üí∂', 'üí∑', 'üí∏', 'üí≥', 'üßæ', 'üíπ', '‚úâÔ∏è', 'üìß', 'üì®', 'üì©', 'üì§', 'üì•', 'üì¶', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üìÆ', 'üó≥Ô∏è', '‚úèÔ∏è', '‚úíÔ∏è', 'üñãÔ∏è', 'üñäÔ∏è', 'üñåÔ∏è', 'üñçÔ∏è', 'üìù', 'üíº', 'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üìÖ', 'üìÜ', 'üóíÔ∏è', 'üóìÔ∏è', 'üìá', 'üìà', 'üìâ', 'üìä', 'üìã', 'üìå', 'üìç', 'üìé', 'üñáÔ∏è', 'üìè', 'üìê', '‚úÇÔ∏è', 'üóÉÔ∏è', 'üóÑÔ∏è', 'üóëÔ∏è', 'üîí', 'üîì', 'üîè', 'üîê', 'üîë', 'üóùÔ∏è', 'üî®', 'ü™ì', '‚õèÔ∏è', '‚öíÔ∏è', 'üõ†Ô∏è', 'üó°Ô∏è', '‚öîÔ∏è', 'üî´', 'ü™É', 'üèπ', 'üõ°Ô∏è', 'ü™ö', 'üîß', 'ü™õ', 'üî©', '‚öôÔ∏è', 'üóúÔ∏è', '‚öñÔ∏è', 'ü¶Ø', 'üîó', '‚õìÔ∏è', 'ü™ù', 'üß∞', 'üß≤', 'ü™ú', '‚öóÔ∏è', 'üß™', 'üß´', 'üß¨', 'üî¨', 'üî≠', 'üì°', 'üíâ', 'ü©∏', 'üíä', 'ü©π', 'ü©∫', 'üö™', 'õõó', 'ü™û', 'ü™ü', 'üõèÔ∏è', 'üõãÔ∏è', 'ü™ë', 'üöΩ', 'ü™†', 'üöø', 'üõÅ', 'üßº', 'ü™•', 'ü™í', 'üßΩ', 'ü™£', 'üß¥', 'üõéÔ∏è', 'üß∏', 'ü™Ü', 'üñºÔ∏è', 'üõçÔ∏è', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'ü™Ñ', 'ü™Ö', 'üéä', 'üéâ', 'üéé', 'üéê', 'üßß', '‚åö', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üïπÔ∏è', 'üóúÔ∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', '', 'üéõÔ∏è', 'üß≠', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'õõó', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'ü¶º', 'ü¶Ω', 'üõ∫', 'üõπ', 'üõº', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°', 'üö†', 'üöü', 'üöÉ', 'üöã', 'üöû', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá', 'üöä', 'üöâ', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'íí∫', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üöÅ', 'üõ∂', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', 'üöß', '‚õΩ', 'üöè', 'üö¶', 'üö•', 'üõë'],
            "Á¨¶Ëôü": ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'õõó', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', '‚öß', 'üöª', 'üöÆ', 'üé¶', 'üì∂', '‚ÑπÔ∏è', 'üî°', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚èèÔ∏è', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÅ', 'îÄÄ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ', 'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', '‚ôæÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üîö', 'üîô', 'üîõ', 'üîù', 'üîú', '„Ä∞Ô∏è', '‚û∞', '‚ûø', '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™', 'üü§', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥', 'î£†', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', '‚¨õ', '‚¨ú', 'üü´', 'üîà', 'üîá', 'üîâ', 'üîä', 'üîî', 'î££', 'üì£', 'üì¢', 'üí¨', 'üí≠', 'üóØÔ∏è']
        };
        
        const Icons = {
            Folder: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>,
            Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path></svg>,
            Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>,
            Share: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>,
            SignOut: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>,
            Pencil: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>,
            Home: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>,
            Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>,
            Export: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>,
            Restore: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>,
            DeleteForever: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
            Clipboard: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>,
            Link: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>,
            Photo: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>,
            X: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>,
            Tag: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>,
            Eye: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            ChevronLeft: () => <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg>,
            ChevronRight: () => <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg>
        };

        const { useState, useEffect, useMemo, useRef } = React;
        
        // Component to handle note display and overflow detection
        const CellNote = ({ note, onClick }) => {
            const textRef = useRef(null);
            const [isOverflowing, setIsOverflowing] = useState(false);

            useEffect(() => {
                if (textRef.current) {
                    const el = textRef.current;
                    setIsOverflowing(el.scrollHeight > el.clientHeight);
                }
            }, [note]);

            return (
                <div className="relative w-full flex-1 overflow-hidden min-h-0 group/note">
                     <div ref={textRef} className="text-[10px] opacity-80 md-content w-full text-left h-full overflow-hidden break-words" dangerouslySetInnerHTML={{__html: safeMarkdown(note||'')}} />
                     {isOverflowing && (
                         <div 
                            onClick={(e) => { e.stopPropagation(); onClick(); }}
                            className="absolute bottom-0 right-0 bg-white/95 backdrop-blur-sm p-0.5 px-1 rounded-tl-lg shadow-sm cursor-pointer text-emerald-600 hover:bg-emerald-100 hover:text-emerald-800 transition-all z-10 flex items-center justify-center border-t border-l border-stone-100"
                            title="È°ØÁ§∫ÂÆåÊï¥ÂÖßÂÆπ"
                         >
                            <Icons.Eye />
                         </div>
                     )}
                </div>
            )
        };

        function App() {
            // States
            const [user, setUser] = useState(null);
            const [viewMode, setViewMode] = useState('browser');
            const [authMode, setAuthMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [loading, setLoading] = useState(true);
            const [isUploading, setIsUploading] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [showAllTags, setShowAllTags] = useState(false);
            const [emojiTab, setEmojiTab] = useState('Ë°®ÊÉÖ');
            const [isEmojiPickerOpen, setIsEmojiPickerOpen] = useState(false); 

            // Data
            const [fileList, setFileList] = useState([]);
            const [currentDocId, setCurrentDocId] = useState(null);
            const [docMetadata, setDocMetadata] = useState({ title: 'Êú™ÂëΩÂêç', category: '‰∏ÄËà¨' });
            const [data, setData] = useState({});
            const [gridSize, setGridSize] = useState(3);
            const [viewStyle, setViewStyle] = useState('standard');
            const [activeCategory, setActiveCategory] = useState('All');
            const [zoomedGridIndex, setZoomedGridIndex] = useState(null); 
            const [isSharedView, setIsSharedView] = useState(false);

            // Modals
            const [selectedCell, setSelectedCell] = useState(null);
            const [viewOnlyCell, setViewOnlyCell] = useState(null); // New state for read-only view
            const [showSaveAsModal, setShowSaveAsModal] = useState(false);
            const [modalMode, setModalMode] = useState('new');
            const [showImportModal, setShowImportModal] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false);
            const [showGlobalSearchModal, setShowGlobalSearchModal] = useState(false);
            const [showMetadataModal, setShowMetadataModal] = useState(false);
            const [previewImages, setPreviewImages] = useState(null); // Changed to array or null
            const [previewIndex, setPreviewIndex] = useState(0);
            const [editActiveField, setEditActiveField] = useState('title');
            
            // Other
            const [searchQuery, setSearchQuery] = useState("");
            const [globalSearchResults, setGlobalSearchResults] = useState([]);
            const [importCode, setImportCode] = useState("");
            const [saveStatus, setSaveStatus] = useState('saved');
            const [activeTags, setActiveTags] = useState([]);

            const fileInputRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'linkc-mandala-app-v1';

            // Counts & Tags Calculation
            const activeFileCount = fileList.filter(f => !f.deleted).length;
            const trashFileCount = fileList.filter(f => f.deleted).length;

            const tagStats = useMemo(() => {
                const stats = {};
                fileList.forEach(f => {
                    if (f.deleted) return;
                    const fileTags = new Set();
                    if (f.category) {
                        f.category.split(/[,Ôºå\s]+/).forEach(c => {
                            if (c.trim() && c.trim() !== 'Êú™ÂàÜÈ°û') fileTags.add(c.trim());
                        });
                    }
                    if (f.cells) {
                        Object.values(f.cells).forEach(cell => {
                            const content = (cell.title || '') + ' ' + (cell.note || '');
                            const extracted = extractTags(content);
                            extracted.forEach(t => fileTags.add(t));
                        });
                    }
                    fileTags.forEach(t => {
                        stats[t] = (stats[t] || 0) + 1;
                    });
                });
                return Object.entries(stats).map(([name, count]) => ({ name, count })).sort((a,b) => b.count - a.count);
            }, [fileList]);

            // Filtered File List
            const filteredFileList = useMemo(() => {
                return fileList.filter(f => {
                    if (activeCategory === 'Trash') return f.deleted;
                    if (f.deleted) return false;
                    if (activeCategory === 'All') return true;
                    
                    const fileTags = new Set();
                    if (f.category) f.category.split(/[,Ôºå\s]+/).forEach(c => c.trim() && fileTags.add(c.trim()));
                    if (f.cells) {
                        Object.values(f.cells).forEach(cell => {
                            extractTags((cell.title || '') + ' ' + (cell.note || '')).forEach(t => fileTags.add(t));
                        });
                    }
                    return fileTags.has(activeCategory);
                });
            }, [fileList, activeCategory]);


            // --- Effects ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (user && viewMode === 'browser') {
                    fetchFileList(user);
                }
            }, [user, viewMode]);

            useEffect(() => {
                if(!user || !currentDocId || !db || viewMode !== 'editor' || isSharedView) return;
                const timer = setTimeout(async () => {
                    setSaveStatus('saving');
                    try {
                        const path = `artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}`;
                        await db.doc(`${path}/${currentDocId}`).update({
                            cells: data, gridSize, title: docMetadata.title, category: docMetadata.category,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setSaveStatus('saved');
                    } catch(e){ setSaveStatus('error'); }
                }, 2000);
                return () => clearTimeout(timer);
            }, [data, gridSize, docMetadata, user, currentDocId, viewMode]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const importData = params.get('import'); 
                if (importData) {
                    setLoading(true);
                    try {
                        const decoded = decodeShareData(importData);
                        if (decoded) {
                            setData(decoded.cells || {});
                            setGridSize(decoded.gridSize || 3);
                            setDocMetadata({ title: decoded.title, category: decoded.category });
                            setCurrentDocId(null);
                            setIsSharedView(true);
                            setViewMode('editor');
                        }
                    } catch(e) { alert("ÈÄ£ÁµêÂ§±Êïà"); }
                    setLoading(false);
                }
            }, []);

            // --- Handlers ---
            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true); setAuthError('');
                try {
                    if (authMode === 'login') await auth.signInWithEmailAndPassword(email, password);
                    else await auth.createUserWithEmailAndPassword(email, password);
                } catch(err) { setAuthError(err.message); }
                setLoading(false);
            };

            const fetchFileList = async (u = user) => {
                if(!u) return;
                try {
                    const snap = await db.collection(`artifacts/${appId}/users/${u.uid}/${USER_CONFIG.system.collectionName}`).get();
                    const files = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    files.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                    setFileList(files);
                } catch(e) { console.error(e); }
            };

            const loadFileFromDB = (file) => {
                if (file.deleted) { alert("Ë´ãÂÖàÂæûÂûÉÂúæÁ≠íÈÇÑÂéü"); return; }
                setData(file.cells || {});
                setGridSize(file.gridSize || 3);
                setCurrentDocId(file.id);
                setDocMetadata({ title: file.title, category: file.category });
                setZoomedGridIndex(null);
                setViewMode('editor');
            };

            const createNewFile = async (t, c, initialCells = {}, initialGridSize = 3) => {
                if(!user) return; setLoading(true);
                try {
                    const doc = await db.collection(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}`).add({
                        title: t, category: c, cells: initialCells, gridSize: initialGridSize, deleted: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setData(initialCells); 
                    setGridSize(initialGridSize); 
                    setCurrentDocId(doc.id); 
                    setDocMetadata({ title: t, category: c });
                    setSaveStatus('saved'); 
                    setIsSharedView(false); 
                    setZoomedGridIndex(null);
                    setShowSaveAsModal(false); 
                    setViewMode('editor');
                } catch(e) { alert("Error"); }
                setLoading(false);
            };

            const handleSaveAction = () => {
                const t = document.getElementById('save-title').value;
                const c = document.getElementById('save-cat').value;
                if(!t) return;
                
                if (modalMode === 'new') {
                    createNewFile(t, c);
                } else {
                    createNewFile(t, c, data, gridSize);
                }
            };

            const moveToTrash = async (fileId) => {
                if (!confirm("Á¢∫ÂÆöÁßªËá≥ÂûÉÂúæÁ≠íÔºü")) return;
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).update({
                        deleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const restoreFromTrash = async (fileId) => {
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).update({
                        deleted: false
                    });
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const deleteForever = async (fileId) => {
                if (!confirm("Á¢∫ÂÆöÊ∞∏‰πÖÂà™Èô§Ôºü")) return;
                try {
                    await db.doc(`artifacts/${appId}/users/${user.uid}/${USER_CONFIG.system.collectionName}/${fileId}`).delete();
                    fetchFileList(user);
                } catch(e) { alert("Error"); }
            };

            const updateCell = (gIdx, cIdx, field, val) => {
                const k = `${gIdx}-${cIdx}`;
                const prev = data[k] || {};
                let newData = { ...data, [k]: { ...prev, [field]: val } };
                
                if (gridSize === 9 && (field === 'title' || field === 'color')) {
                    if (gIdx === 4 && cIdx !== 4) {
                        const targetK = `${cIdx}-4`;
                        newData[targetK] = { ...(data[targetK]||{}), [field]: val };
                    }
                    else if (gIdx !== 4 && cIdx === 4) {
                        const targetK = `4-${gIdx}`;
                        newData[targetK] = { ...(data[targetK]||{}), [field]: val };
                    }
                }
                setData(newData);
            };

            const clearCell = (gIdx, cIdx) => {
                if(!confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§Ê≠§Ê†ºÂÖßÂÆπÂóéÔºü")) return;
                const k = `${gIdx}-${cIdx}`;
                const newData = { ...data };
                delete newData[k];
                if (gridSize === 9) {
                    if (gIdx === 4 && cIdx !== 4) delete newData[`${cIdx}-4`];
                    else if (gIdx !== 4 && cIdx === 4) delete newData[`4-${gIdx}`];
                }
                setData(newData);
            };

            const handleImageUpload = async (file) => {
                if (!file) return;
                setIsUploading(true);
                try {
                    const url = await compressImage(file);
                    const key = `${selectedCell.gIdx}-${selectedCell.cIdx}`;
                    const currentImages = (data[key] || {}).images || [];
                    updateCell(selectedCell.gIdx, selectedCell.cIdx, 'images', [...currentImages, url]);
                } catch (e) {
                    alert("ÂúñÁâá‰∏äÂÇ≥Â§±Êïó");
                }
                setIsUploading(false);
            };

            const removeImage = (indexToRemove) => {
                const key = `${selectedCell.gIdx}-${selectedCell.cIdx}`;
                const currentImages = (data[key] || {}).images || [];
                const newImages = currentImages.filter((_, idx) => idx !== indexToRemove);
                updateCell(selectedCell.gIdx, selectedCell.cIdx, 'images', newImages);
            };
            
            const handleCellClick = (gIdx, cIdx, cellData) => {
                if (gridSize === 9) {
                     if (zoomedGridIndex === null && gIdx === 4 && cIdx !== 4) { setZoomedGridIndex(cIdx); return; }
                     if (zoomedGridIndex !== null && cIdx === 4) { setZoomedGridIndex(null); return; }
                } 
                if (gridSize === 3) {
                     if ((zoomedGridIndex === null || zoomedGridIndex === 4) && cIdx !== 4) { setZoomedGridIndex(cIdx); return; }
                     if (zoomedGridIndex !== null && zoomedGridIndex !== 4 && cIdx === 4) { setZoomedGridIndex(4); return; }
                }
                setEditActiveField('title'); 
                setSelectedCell({ gIdx: (gridSize===3 && zoomedGridIndex!==null) ? zoomedGridIndex : gIdx, cIdx, data: cellData });
                setIsEmojiPickerOpen(false); 
            };

            const getNavClass = (gIdx, cIdx) => {
                if (gridSize === 9) {
                    if (zoomedGridIndex === null && gIdx === 4 && cIdx !== 4) return 'nav-cell';
                    if (zoomedGridIndex !== null && cIdx === 4) return 'nav-cell return-cell';
                }
                if (gridSize === 3) {
                    if ((zoomedGridIndex === null || zoomedGridIndex === 4) && cIdx !== 4) return 'nav-cell';
                    if (zoomedGridIndex !== null && zoomedGridIndex !== 4 && cIdx === 4) return 'nav-cell return-cell';
                }
                return '';
            };

            const checkSearchMatch = (text, query) => {
                if (!query) return true;
                if (!text && text !== 0) return false;
                const target = String(text).toLowerCase();
                const orGroups = query.split(/\s+OR\s+/i);
                return orGroups.some(group => {
                    const terms = group.trim().split(/\s+/);
                    return terms.every(term => {
                        if (term.startsWith('-')) {
                            const cleanTerm = term.substring(1).toLowerCase();
                            return cleanTerm && !target.includes(cleanTerm);
                        }
                        return target.includes(term.toLowerCase());
                    });
                });
            };

            const performGlobalSearch = () => {
                if (!searchQuery) { setGlobalSearchResults([]); return; }
                const results = [];
                fileList.forEach(file => {
                    if (file.deleted) return;
                    let matchCount = 0;
                    if (checkSearchMatch(file.title, searchQuery)) matchCount += 10;
                    if (checkSearchMatch(file.category, searchQuery)) matchCount += 5;
                    if (file.cells) {
                        Object.values(file.cells).forEach(cell => {
                            const content = `${cell.title || ''} ${cell.note || ''}`;
                            if (checkSearchMatch(content, searchQuery)) matchCount++;
                        });
                    }
                    if (matchCount > 0) results.push({ ...file, score: matchCount });
                });
                results.sort((a,b) => b.score - a.score);
                setGlobalSearchResults(results);
                setShowGlobalSearchModal(true);
            };

            const handleImportCodeSubmit = () => {
                if(!importCode) return;
                try {
                    const parsed = JSON.parse(importCode);
                    if (confirm("Âç≥Â∞áÂåØÂÖ•ÊõºÈôÄÁæÖ‰∏¶Ëá™ÂãïÂÑ≤Â≠òÁÇ∫Êñ∞Ê™îÊ°à„ÄÇ\n(Á¢∫ÂÆöÂåØÂÖ•?)")) {
                        createNewFile(
                            parsed.title ? `${parsed.title} (ÂåØÂÖ•)` : 'ÂåØÂÖ•ÁöÑÂàÜ‰∫´',
                            parsed.category || '‰∏ÄËà¨',
                            parsed.cells || {},
                            parsed.gridSize || 3
                        );
                        setShowImportModal(false);
                        setImportCode("");
                    }
                } catch(e) {
                    alert("‰ª£Á¢ºÊ†ºÂºèÈåØË™§");
                }
            };

            const handleExportFile = () => {
                const shareObj = { title: docMetadata.title, category: docMetadata.category, gridSize: gridSize, cells: data, isShareFile: true };
                const blob = new Blob([JSON.stringify(shareObj)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Mandala_Share_${docMetadata.title}.json`;
                a.click();
                setShowShareModal(false);
            };

            const handleCopyCode = () => {
                const shareObj = { title: docMetadata.title, category: docMetadata.category, gridSize: gridSize, cells: data };
                const json = JSON.stringify(shareObj);
                const textArea = document.createElement("textarea");
                textArea.value = json;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                alert("‰ª£Á¢ºÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ");
                setShowShareModal(false);
            };

            const handleExportJPG = async () => {
                setLoading(true);
                try {
                    const element = document.getElementById('mandala-grid-container');
                    if (!element) throw new Error("Êâæ‰∏çÂà∞Ë°®Ê†ºÂÖÉ‰ª∂");
                    
                    const exportContainer = element.cloneNode(true);
                    exportContainer.style.width = '1200px'; 
                    exportContainer.style.height = 'auto';
                    exportContainer.style.maxHeight = 'none';
                    exportContainer.style.overflow = 'visible';
                    
                    // Use a safer off-screen method for cross-browser/desktop compatibility
                    exportContainer.style.position = 'fixed';
                    exportContainer.style.left = '0';
                    exportContainer.style.top = '0';
                    exportContainer.style.zIndex = '-9999';
                    exportContainer.classList.add('export-mode');
                    
                    const header = document.createElement('div');
                    header.style.textAlign = 'center';
                    header.style.marginBottom = '20px';
                    header.innerHTML = `<h1 class="garden-title" style="font-size:32px; color:#44403c; margin-bottom:5px;">${docMetadata.title}</h1><p style="font-size:14px; color:#78716c;">${docMetadata.category} | Linkc Mandala</p>`;
                    exportContainer.insertBefore(header, exportContainer.firstChild);
                    
                    document.body.appendChild(exportContainer);
                    
                    // Critical: Wait for DOM to render images/fonts in the cloned node
                    await new Promise(resolve => setTimeout(resolve, 800));

                    const canvas = await html2canvas(exportContainer, { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#fcfaf9',
                        logging: false
                    });

                    const link = document.createElement('a');
                    link.download = `${docMetadata.title}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    
                    document.body.removeChild(exportContainer);
                } catch (e) { 
                    console.error("Export Error:", e);
                    alert("ÂúñÁâáÂåØÂá∫Â§±Êïó: " + e.message); 
                    // Clean up if error occurs
                    const existingContainer = document.querySelector('.export-mode');
                    if (existingContainer) document.body.removeChild(existingContainer);
                }
                setLoading(false);
                setShowExportModal(false);
            };

            const handleExportMD = () => {
                const now = new Date().toISOString().split('T')[0];
                const tagList = parseCategories(docMetadata.category);
                const tagsString = `[${tagList.join(', ')}]`;
                let md = `---\ncreated: ${now}\ncategories: Mandala\ntags: ${tagsString}\n---\n\n# ${docMetadata.title}\n\n`;
                
                const size = gridSize;
                const rows = size === 9 ? 9 : 3;
                const cols = size === 9 ? 9 : 3;
                md += `| ${Array(cols).fill(' ').join(' | ')} |\n`;
                md += `| ${Array(cols).fill('---').join(' | ')} |\n`;
                for (let r = 0; r < rows; r++) {
                    let rowContent = [];
                    for (let c = 0; c < cols; c++) {
                        let gIdx, cIdx;
                        if (size === 3) { gIdx = 4; cIdx = r * 3 + c; }
                        else {
                            const gridRow = Math.floor(r / 3);
                            const gridCol = Math.floor(c / 3);
                            gIdx = gridRow * 3 + gridCol;
                            const cellRow = r % 3;
                            const cellCol = c % 3;
                            cIdx = cellRow * 3 + cellCol;
                        }
                        const key = `${gIdx}-${cIdx}`;
                        const cell = data[key] || {};
                        rowContent.push((cell.title || '').replace(/\n/g, ' '));
                    }
                    md += `| ${rowContent.join(' | ')} |\n`;
                }
                md += `\n\n`;

                Object.keys(data).sort().forEach(key => {
                    const cell = data[key];
                    if (cell.title) {
                        md += `## [${key}] ${cell.title}\n`;
                        if(cell.note) md += `${cell.note}\n\n`;
                    }
                });
                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${docMetadata.title}.md`;
                a.click();
                setShowExportModal(false);
            };

            const handleExportPDF = async () => {
                setLoading(true);
                try {
                    const element = document.getElementById('mandala-grid-container');
                    if (!element) throw new Error("Êâæ‰∏çÂà∞Ë°®Ê†ºÂÖÉ‰ª∂");

                    const exportContainer = element.cloneNode(true);
                    exportContainer.style.width = '1000px'; 
                    exportContainer.style.height = 'auto';
                    exportContainer.style.maxHeight = 'none';
                    exportContainer.style.overflow = 'visible';

                    exportContainer.style.position = 'fixed';
                    exportContainer.style.left = '0';
                    exportContainer.style.top = '0';
                    exportContainer.style.zIndex = '-9999';
                    exportContainer.classList.add('export-mode');
                    
                    const header = document.createElement('div');
                    header.style.textAlign = 'center';
                    header.style.marginBottom = '20px';
                    header.innerHTML = `<h1 class="garden-title" style="font-size:32px; color:#44403c; margin-bottom:5px;">${docMetadata.title}</h1>`;
                    exportContainer.insertBefore(header, exportContainer.firstChild);
                    
                    document.body.appendChild(exportContainer);
                    
                    // Critical: Wait for DOM to render images/fonts in the cloned node
                    await new Promise(resolve => setTimeout(resolve, 800));

                    const canvas = await html2canvas(exportContainer, { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff' 
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const margin = 10;
                    const maxImgWidth = pageWidth - (margin * 2);
                    const imgHeight = (canvas.height * maxImgWidth) / canvas.width;
                    pdf.addImage(imgData, 'JPEG', margin, margin, maxImgWidth, imgHeight);
                    pdf.save(`${docMetadata.title}.pdf`);
                    
                    document.body.removeChild(exportContainer);
                } catch (e) { 
                    console.error("PDF Export Error:", e);
                    alert("PDF ÂåØÂá∫Â§±Êïó: " + e.message); 
                    const existingContainer = document.querySelector('.export-mode');
                    if (existingContainer) document.body.removeChild(existingContainer);
                }
                setLoading(false);
                setShowExportModal(false);
            };

            const handleExportXLS = () => {
                let tableHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body>`;
                tableHTML += `<h2>${docMetadata.title}</h2>`;
                tableHTML += `<table border="1" style="border-collapse: collapse; table-layout: fixed;">`;
                
                const size = gridSize;
                const rows = size === 9 ? 9 : 3;
                const cols = size === 9 ? 9 : 3;

                // Loop rows
                for (let r = 0; r < rows; r++) {
                    let rowTitleHTML = `<tr style="height: 40px;">`;
                    let rowNoteHTML = `<tr style="height: 80px;">`;

                    for (let c = 0; c < cols; c++) {
                        let gIdx, cIdx;
                        if (size === 3) {
                            gIdx = 4; 
                            cIdx = r * 3 + c;
                        } else {
                            const gridRow = Math.floor(r / 3);
                            const gridCol = Math.floor(c / 3);
                            gIdx = gridRow * 3 + gridCol;
                            const cellRow = r % 3;
                            const cellCol = c % 3;
                            cIdx = cellRow * 3 + cellCol;
                        }
                        
                        const key = `${gIdx}-${cIdx}`;
                        const cell = data[key] || {};
                        const bg = cell.color ? cell.color : '#ffffff';
                        
                        const text = cell.title ? `<strong>${cell.title}</strong>` : '&nbsp;';
                        rowTitleHTML += `<td style="background-color:${bg}; vertical-align:middle; text-align:center; padding:5px; width:150px; border: 1px solid #000; border-bottom: none; font-size:12pt; mso-number-format:'\@';">${text}</td>`;
                        
                        const note = cell.note ? `<span style="color:#555;">${cell.note}</span>` : '&nbsp;';
                        rowNoteHTML += `<td style="background-color:${bg}; vertical-align:top; padding:5px; width:150px; border: 1px solid #000; border-top: none; font-size:10pt; word-wrap: break-word; mso-number-format:'\@';">${note}</td>`;
                    }
                    
                    rowTitleHTML += `</tr>`;
                    rowNoteHTML += `</tr>`;
                    
                    tableHTML += rowTitleHTML + rowNoteHTML;
                }
                tableHTML += `</table></body></html>`;

                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${docMetadata.title}.xls`;
                a.click();
                setShowExportModal(false);
            };

            const handleFileMenu = (e) => {
                const action = e.target.value;
                e.target.value = "";
                if (action === "new") {
                    if (confirm("Ê∏ÖÁ©∫‰∏¶ÈñãÊñ∞Ê™îÊ°àÔºü")) {
                        setData({}); setCurrentDocId(null); setDocMetadata({title:'Êú™ÂëΩÂêç', category:'‰∏ÄËà¨'});
                        setIsSharedView(false); setZoomedGridIndex(null);
                    }
                } else if (action === "save") {
                    if (isSharedView) { alert("ÂàÜ‰∫´Ê™îË´ãÂè¶Â≠ò"); setModalMode('save_as'); setShowSaveAsModal(true); } 
                    else { currentDocId ? alert("Â∑≤Ëá™ÂãïÂÑ≤Â≠ò") : (()=>{setModalMode('save_as'); setShowSaveAsModal(true);})() }
                } else if (action === "save_as") {
                    setModalMode('save_as');
                    setShowSaveAsModal(true);
                } else if (action === "back") {
                    if (isSharedView) window.history.replaceState({}, document.title, window.location.pathname);
                    setViewMode('browser'); setIsSharedView(false); setZoomedGridIndex(null);
                } else if (action === "import") {
                    fileInputRef.current?.click(); 
                } else if (action === "export_drive") {
                    setShowExportModal(true); 
                } else if (action === "share") {
                    setShowShareModal(true);
                }
            };

            const handleLoadLocal = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const parsed = JSON.parse(ev.target.result);
                        if (confirm("Âç≥Â∞áÂåØÂÖ•ÊõºÈôÄÁæÖ‰∏¶Ëá™ÂãïÂÑ≤Â≠òÁÇ∫Êñ∞Ê™îÊ°à„ÄÇ\n(Á¢∫ÂÆöÂåØÂÖ•?)")) {
                            createNewFile(
                                parsed.title ? `${parsed.title} (ÂåØÂÖ•)` : 'ÂåØÂÖ•ÁöÑÂàÜ‰∫´',
                                parsed.category || '‰∏ÄËà¨',
                                parsed.cells || {},
                                parsed.gridSize || 3
                            );
                        }
                    } catch(e) { alert("Ê†ºÂºèÈåØË™§"); }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };
            
            const handleEmojiClick = (emoji) => {
                const key = `${selectedCell.gIdx}-${selectedCell.cIdx}`;
                const currentVal = (data[key] || {})[editActiveField] || '';
                updateCell(selectedCell.gIdx, selectedCell.cIdx, editActiveField, currentVal + emoji);
            };
            
            const openImagePreview = (images, index) => {
                if (!images || images.length === 0) return;
                setPreviewImages(images);
                setPreviewIndex(index || 0);
            };
            
            const nextPreviewImage = (e) => {
                e.stopPropagation();
                if (!previewImages) return;
                setPreviewIndex((prev) => (prev + 1) % previewImages.length);
            };
            
            const prevPreviewImage = (e) => {
                e.stopPropagation();
                if (!previewImages) return;
                setPreviewIndex((prev) => (prev - 1 + previewImages.length) % previewImages.length);
            };

            // -- Views --
            const renderCell = (gIdx, cIdx) => {
                const targetGrid = (gridSize === 3 && zoomedGridIndex !== null) ? zoomedGridIndex : gIdx;
                const cellData = data[`${targetGrid}-${cIdx}`] || {};
                const navClass = getNavClass(targetGrid, cIdx);
                
                const defaultBg = ((targetGrid===4 && cIdx===4)?'#ecfdf5':(targetGrid===4?'#fdfcdc':(cIdx===4?'#fdfcdc':'#ffffff')));
                const finalBg = cellData.color || defaultBg;
                const textColor = getContrastColor(finalBg); 

                return (
                    <div className={`relative border border-stone-300 p-1 flex flex-col h-full overflow-hidden group ${navClass}`}
                         style={{backgroundColor: finalBg, color: textColor}}
                         onClick={() => handleCellClick(targetGrid, cIdx, cellData)}>
                        <div className="flex-1 overflow-hidden flex flex-col justify-start items-center w-full min-h-0">
                            <div className="font-bold text-xs md:text-sm leading-tight mb-1 text-center w-full" dangerouslySetInnerHTML={{__html: safeMarkdownInline(cellData.title||'')}} />
                            {viewStyle === 'standard' && (
                                <CellNote 
                                    note={cellData.note} 
                                    onClick={() => setViewOnlyCell({ gIdx: targetGrid, cIdx, data: cellData })} 
                                />
                            )}
                        </div>
                        {navClass && <div className="edit-btn-overlay" onClick={(e)=>{ e.stopPropagation(); setSelectedCell({ gIdx: targetGrid, cIdx, data: cellData }); }}><Icons.Pencil/></div>}
                        
                        <div className="absolute bottom-1 left-1 flex gap-1 z-20">
                            {cellData.link && (
                                <div className="content-icon bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-600"
                                     onClick={(e)=>{ e.stopPropagation(); window.open(cellData.link, '_blank'); }}>
                                    <Icons.Link/>
                                </div>
                            )}
                            {cellData.images && cellData.images.length > 0 && (
                                <div className="content-icon bg-emerald-50 text-emerald-600 border-emerald-200 hover:bg-emerald-600"
                                     onClick={(e)=>{ e.stopPropagation(); openImagePreview(cellData.images, 0); }}>
                                    <Icons.Photo/>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderGrid = () => {
                if (gridSize === 9 && zoomedGridIndex === null) {
                    return (
                        <div className="grid grid-cols-3 grid-rows-3 gap-px bg-stone-200 w-full h-full mx-auto aspect-square">
                            {Array.from({length:9}).map((_, g) => (
                                <div key={g} className={`grid grid-cols-3 grid-rows-3 gap-px bg-white ${g===4?'border-2 border-emerald-400 z-10':''}`}>
                                    {Array.from({length:9}).map((_, c) => renderCell(g, c))}
                                </div>
                            ))}
                        </div>
                    );
                } else {
                    const activeGrid = zoomedGridIndex !== null ? zoomedGridIndex : 4;
                    return (
                        <div className="flex flex-col h-full items-center justify-center">
                             <div className="w-full max-w-xl mb-2 flex items-center text-xs text-stone-500 gap-2 px-2">
                                <span className="cursor-pointer hover:text-emerald-600" onClick={()=>setZoomedGridIndex(gridSize===9?null:4)}><Icons.Folder/> {gridSize===9?'ÂÖ®ÊôØ':'‰∏ªÁï´Èù¢'}</span>
                                <span>/</span>
                                <span className="font-bold text-stone-700">{activeGrid === 4 ? 'Ê†∏ÂøÉ‰∏ªÈ°å' : `ÂçÄÂüü ${activeGrid}`}</span>
                             </div>
                             <div className="grid grid-cols-3 grid-rows-3 gap-1 bg-stone-300 border-4 border-stone-300 w-full max-w-xl aspect-square shadow-xl">
                                {Array.from({length: 9}).map((_, c) => renderCell(activeGrid, c))}
                            </div>
                        </div>
                    );
                }
            };

            // -- Sidebar Component --
            const SidebarContent = () => (
                <>
                    <div className="mb-6 px-2 text-center shrink-0">
                        <div className="text-lg font-medium text-stone-500 font-serif leading-none">{getUserName(user)}'s</div>
                        <div className="text-xl font-bold text-stone-800 garden-title mt-1">Mandala Garden</div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto -mx-4 px-4 space-y-1"> 
                        <button 
                            onClick={() => { setShowGlobalSearchModal(true); setIsSidebarOpen(false); }} 
                            className="w-full text-left p-2 rounded flex items-center gap-2 hover:bg-stone-50 text-stone-600 mb-2 border border-stone-100"
                        >
                            <Icons.Search/> <span>ÂÖ®ÂüüÊêúÂ∞ã...</span>
                        </button>

                        <button onClick={()=>{ setActiveCategory('All'); setIsSidebarOpen(false); }} className={`w-full text-left p-2 rounded ${activeCategory==='All'?'bg-emerald-50':''}`}><Icons.Folder/> ÂÖ®ÈÉ®Ê™îÊ°à ({activeFileCount})</button>
                        <button onClick={()=>{ setActiveCategory('Trash'); setIsSidebarOpen(false); }} className={`w-full text-left p-2 rounded ${activeCategory==='Trash'?'bg-rose-50':''}`}><Icons.Trash/> ÂûÉÂúæÁ≠í ({trashFileCount})</button>
                        
                        <div className="border-t my-2 pt-2">
                            <div className="px-2 text-xs font-bold text-stone-400 mb-2 flex justify-between items-center">
                                <span>Ê®ôÁ±§ÂàÜÈ°û</span>
                                <span className="text-[10px] bg-stone-100 px-1 rounded">{tagStats.length}</span>
                            </div>
                            <div className="space-y-1 pb-2"> 
                                {tagStats.length === 0 && <div className="px-2 text-xs text-stone-300">Â∞öÁÑ°Ê®ôÁ±§ (‰ΩøÁî® #tag)</div>}
                                {tagStats.slice(0, showAllTags ? undefined : 8).map(tag => (
                                    <button key={tag.name} onClick={()=>{ setActiveCategory(tag.name); setIsSidebarOpen(false); }} className={`w-full text-left p-2 rounded flex justify-between items-center text-sm ${activeCategory===tag.name?'bg-emerald-50 text-emerald-700':''}`}>
                                        <span className="flex items-center gap-2 truncate"><Icons.Tag/> {tag.name}</span>
                                        <span className="text-xs bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{tag.count}</span>
                                    </button>
                                ))}
                                {tagStats.length > 8 && (
                                    <button onClick={()=>setShowAllTags(!showAllTags)} className="text-xs text-stone-400 w-full text-left px-2 py-1 hover:text-stone-600">
                                        {showAllTags ? 'Êî∂Ëµ∑Ê®ôÁ±§' : `È°ØÁ§∫Êõ¥Â§ö (${tagStats.length - 8})`}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="border-t my-2 pt-2 mt-auto shrink-0">
                        <button onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); setIsSidebarOpen(false); }} className="w-full text-left p-2"><Icons.Plus/> Êñ∞Â¢ûÊ™îÊ°à</button>
                        <button onClick={()=>{ setShowImportModal(true); setIsSidebarOpen(false); }} className="w-full text-left p-2"><Icons.Share/> ÂåØÂÖ•Ê™îÊ°à</button>
                        <button onClick={()=>window.open(USER_CONFIG.seo.logoLink, '_blank')} className="w-full text-left p-2"><Icons.Home/> ÂÄã‰∫∫È¶ñÈ†Å</button>
                        <button onClick={()=>auth.signOut()} className="w-full text-left p-2"><Icons.SignOut/> ÁôªÂá∫</button>
                    </div>
                </>
            );

            // -- Main --
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-100 p-4">
                        <div className="text-emerald-600 font-bold text-lg animate-pulse flex flex-col items-center">
                            <div className="mb-2 text-2xl">üåø</div>
                            <div>Loading Mandala Garden...</div>
                        </div>
                    </div>
                );
            }

            if (!user && !isSharedView) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-100 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                            <div className="mb-6">
                                <h1 className="text-3xl font-bold text-stone-800 garden-title mb-1">Mandala Garden</h1>
                                <p className="text-stone-500 text-sm">ÊÇ®ÁöÑÊÄùÁ∂≠Ëä±Âúí</p>
                            </div>
                            <form onSubmit={handleAuth} className="space-y-4 text-left">
                                <input className="w-full p-3 border rounded" type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} required />
                                <input className="w-full p-3 border rounded" type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} required />
                                {authError && <div className="text-red-500 text-xs">{authError}</div>}
                                <button className="w-full p-3 bg-emerald-600 text-white rounded font-bold">{authMode==='login'?'ÁôªÂÖ•':'Ë®ªÂÜä'}</button>
                            </form>
                            <button onClick={()=>setAuthMode(authMode==='login'?'register':'login')} className="w-full mt-4 text-sm text-stone-500 underline">{authMode==='login'?'Ê≤íÊúâÂ∏≥ËôüÔºüË®ªÂÜä':'Â∑≤ÊúâÂ∏≥ËôüÔºüÁôªÂÖ•'}</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full w-full overflow-hidden text-stone-800 flex flex-col">
                    
                    {viewMode === 'browser' ? (
                        <div className="flex h-full bg-[#fcfaf9]">
                            {isSidebarOpen && (
                                <div className="fixed inset-0 z-50 flex md:hidden">
                                    <div className="fixed inset-0 bg-black/50" onClick={() => setIsSidebarOpen(false)}></div>
                                    <div className="relative w-72 bg-white h-full shadow-xl flex flex-col p-4 animate-slide-in-left">
                                        <div className="absolute top-4 right-4"><button onClick={() => setIsSidebarOpen(false)} className="text-stone-400"><Icons.X/></button></div>
                                        <SidebarContent />
                                    </div>
                                </div>
                            )}

                            <aside className="w-64 bg-white border-r hidden md:flex flex-col p-4">
                                <SidebarContent />
                            </aside>
                            
                            <main className="flex-1 flex flex-col">
                                <header className="h-14 border-b bg-white flex items-center px-4 justify-between sticky top-0 z-20">
                                    <div className="flex items-center gap-3">
                                        <button className="md:hidden text-stone-600" onClick={() => setIsSidebarOpen(true)}><Icons.Menu/></button>
                                        <h2 className="font-bold text-lg flex items-center gap-2">
                                            {activeCategory === 'All' ? 'ÂÖ®ÈÉ®Ê™îÊ°à' : (activeCategory === 'Trash' ? 'ÂûÉÂúæÁ≠í' : `# ${activeCategory}`)}
                                        </h2>
                                    </div>
                                    <button className="md:hidden bg-emerald-100 text-emerald-700 p-2 rounded-full" onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); }}><Icons.Plus/></button>
                                    <button className="hidden md:block" onClick={()=>{ setModalMode('new'); setShowSaveAsModal(true); }}><Icons.Plus/></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 content-start">
                                    {filteredFileList.length === 0 && <div className="col-span-full text-center text-stone-400 mt-10">Ê≤íÊúâÊâæÂà∞Ê™îÊ°à</div>}
                                    {filteredFileList.map(f => (
                                        <div key={f.id} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer h-32 flex flex-col justify-between" onClick={()=>loadFileFromDB(f)}>
                                            <div className="font-bold truncate">{f.title}</div>
                                            <div className="text-xs text-stone-400 flex justify-between">
                                                <span className="truncate max-w-[60%]">{f.category}</span>
                                                {activeCategory==='Trash' && (
                                                    <div className="flex gap-2">
                                                        <button onClick={(e)=>{e.stopPropagation(); restoreFromTrash(f.id); }} className="text-emerald-600"><Icons.Restore/></button>
                                                        <button onClick={(e)=>{e.stopPropagation(); deleteForever(f.id); }} className="text-rose-600"><Icons.DeleteForever/></button>
                                                    </div>
                                                )}
                                                {activeCategory!=='Trash' && (
                                                    <button onClick={(e)=>{e.stopPropagation(); moveToTrash(f.id); }} className="text-stone-300 hover:text-rose-500"><Icons.Trash/></button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </main>
                        </div>
                    ) : (
                        <div className="flex flex-col h-full bg-[#fcfaf9]">
                            <div className="h-14 bg-white border-b flex items-center justify-between px-2 md:px-4 shrink-0 gap-2">
                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                    <button onClick={()=>{setViewMode('browser'); setZoomedGridIndex(null);}} className="text-stone-500 p-1">‚Üê</button>
                                    <input className="font-bold text-stone-800 border-none outline-none bg-transparent w-full min-w-0" value={docMetadata.title} onChange={e=>setDocMetadata({...docMetadata, title:e.target.value})} />
                                    <button onClick={()=>setShowMetadataModal(true)} className="p-1 rounded hover:bg-stone-100 text-stone-500" title="Á∑®ËºØÊ®ôÁ±§"><Icons.Tag/></button>
                                </div>
                                <div className="flex gap-2 items-center shrink-0">
                                    <button className="hidden sm:block" onClick={()=>setShowExportModal(true)}><Icons.Export/></button>
                                    <button className="hidden sm:block" onClick={()=>setShowShareModal(true)}><Icons.Share/></button>
                                    <div className="flex border rounded overflow-hidden text-[10px] md:text-xs">
                                        <button onClick={()=>setGridSize(3)} className={`px-2 py-1 ${gridSize===3?'bg-emerald-100':''}`}>3x3</button>
                                        <button onClick={()=>setGridSize(9)} className={`px-2 py-1 ${gridSize===9?'bg-emerald-100':''}`}>9x9</button>
                                    </div>
                                    <select className="border rounded text-xs p-1 max-w-[80px]" onChange={handleFileMenu}>
                                        <option value="">ÈÅ∏ÂñÆ</option>
                                        <option value="save">ÂÑ≤Â≠ò</option>
                                        <option value="save_as">Âè¶Â≠ò</option>
                                        <option value="new">ÈñãÊñ∞</option>
                                        <option className="sm:hidden" value="share">ÂàÜ‰∫´</option>
                                        <option className="sm:hidden" value="export_drive">ÂåØÂá∫</option>
                                        <option value="import">ÂåØÂÖ•</option>
                                        <option value="back">ÂàóË°®</option>
                                    </select>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleLoadLocal} />
                                </div>
                            </div>
                            <div className="flex-1 overflow-hidden relative" id="mandala-grid-container">
                                {renderGrid()}
                            </div>
                        </div>
                    )}

                    {/* Modals */}
                    {previewImages && (
                        <div className="fixed inset-0 bg-black/95 flex items-center justify-center z-[60]" onClick={()=>setPreviewImages(null)}>
                            <div className="relative w-full h-full flex items-center justify-center">
                                {previewImages.length > 1 && (
                                    <>
                                        <button 
                                            className="absolute left-4 z-10 text-white/50 hover:text-white transition" 
                                            onClick={prevPreviewImage}
                                        >
                                            <Icons.ChevronLeft />
                                        </button>
                                        <button 
                                            className="absolute right-4 z-10 text-white/50 hover:text-white transition" 
                                            onClick={nextPreviewImage}
                                        >
                                            <Icons.ChevronRight />
                                        </button>
                                    </>
                                )}
                                <img src={previewImages[previewIndex]} className="max-w-full max-h-full object-contain p-4" onClick={(e)=>e.stopPropagation()} />
                                <div className="absolute bottom-4 text-white/70 text-sm bg-black/50 px-3 py-1 rounded-full">
                                    {previewIndex + 1} / {previewImages.length}
                                </div>
                                <button className="absolute top-4 right-4 text-white text-4xl leading-none" onClick={()=>setPreviewImages(null)}>√ó</button>
                            </div>
                        </div>
                    )}

                    {viewOnlyCell && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4" onClick={() => setViewOnlyCell(null)}>
                            <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl flex flex-col max-h-[80vh] animate-slide-up" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b flex justify-between items-center bg-stone-50 rounded-t-xl">
                                    <h3 className="font-bold text-lg text-stone-800">ÂÆåÊï¥ÂÇôË®ª</h3>
                                    <button onClick={() => setViewOnlyCell(null)} className="text-stone-400 hover:text-stone-600"><Icons.X/></button>
                                </div>
                                <div className="p-6 overflow-y-auto">
                                     <h4 className="font-bold text-xl mb-4 text-emerald-800 border-b pb-2">{viewOnlyCell.data.title || 'ÁÑ°Ê®ôÈ°å'}</h4>
                                     <div className="prose prose-stone prose-sm max-w-none md-content" dangerouslySetInnerHTML={{__html: safeMarkdown(viewOnlyCell.data.note || 'ÁÑ°ÂÖßÂÆπ')}} />
                                </div>
                                 <div className="p-4 border-t bg-stone-50 flex justify-end rounded-b-xl">
                                    <button onClick={() => setViewOnlyCell(null)} className="px-4 py-2 bg-stone-200 hover:bg-stone-300 rounded text-stone-700 font-medium">ÈóúÈñâ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedCell && (
                        <div className="fixed inset-0 bg-black/50 flex items-end md:items-center justify-center z-50" onClick={()=>setSelectedCell(null)}>
                            <div className="bg-white w-full h-[90dvh] md:h-auto md:max-h-[85vh] md:w-full md:max-w-md rounded-t-xl md:rounded-xl overflow-hidden shadow-2xl flex flex-col transition-transform duration-300 animate-slide-up md:animate-none" onClick={e=>e.stopPropagation()}>
                                <div className="p-3 bg-emerald-600 text-white font-bold flex justify-between items-center shrink-0">
                                    <span className="text-sm md:text-base">Á∑®ËºØÂÖßÂÆπ {selectedCell.gIdx}-{selectedCell.cIdx}</span>
                                    <button onClick={()=>setSelectedCell(null)} className="text-white/80 hover:text-white px-2">‚úï</button>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1 flex flex-col gap-4">
                                    <div className="space-y-1">
                                        <label className="text-xs text-stone-500 font-bold">Ê®ôÈ°å</label>
                                        <input 
                                            className={`w-full border p-2 rounded text-stone-800 font-bold focus:ring-2 focus:ring-emerald-500 outline-none ${editActiveField==='title'?'border-emerald-500':''}`} 
                                            placeholder="Ëº∏ÂÖ•Ê®ôÈ°å..." 
                                            value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).title || ''} 
                                            onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'title', e.target.value)}
                                            onFocus={()=>setEditActiveField('title')}
                                        />
                                    </div>
                                    <div className="space-y-1"> {/* Removed flex-1 to fix squashing */}
                                        <label className="text-xs text-stone-500 font-bold">ÂÇôË®ª</label>
                                        <textarea 
                                            className={`w-full border p-2 rounded h-32 text-stone-800 focus:ring-2 focus:ring-emerald-500 outline-none resize-none ${editActiveField==='note'?'border-emerald-500':''}`} 
                                            placeholder="Ëº∏ÂÖ•ÂÇôË®ª..." 
                                            value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).note || ''} 
                                            onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'note', e.target.value)}
                                            onFocus={()=>setEditActiveField('note')}
                                        ></textarea>
                                    </div>
                                    <div className="border rounded-lg bg-stone-50/50 overflow-hidden transition-all duration-300 shrink-0">
                                        <button 
                                            className="w-full flex justify-between items-center p-2 hover:bg-stone-100 transition-colors outline-none"
                                            onClick={() => setIsEmojiPickerOpen(!isEmojiPickerOpen)}
                                        >
                                            <div className="flex items-center gap-2">
                                                <span className="text-stone-400 text-[10px] transform transition-transform duration-200" style={{ transform: isEmojiPickerOpen ? 'rotate(90deg)' : 'rotate(0deg)' }}>‚ñ∂</span>
                                                <span className="text-xs font-bold text-stone-500 flex items-center gap-1">üòÄ ÊèíÂÖ• Emoji</span>
                                            </div>
                                            <span className="text-[10px] text-stone-400 bg-white px-2 py-0.5 rounded border">Ëá≥: {editActiveField === 'title' ? 'Ê®ôÈ°å' : 'ÂÇôË®ª'}</span>
                                        </button>
                                        {isEmojiPickerOpen && (
                                            <div className="p-2 pt-0 border-t border-stone-100">
                                                <div className="flex gap-1 overflow-x-auto py-2 scrollbar-hide">
                                                    {Object.keys(EMOJI_CATEGORIES).map(cat => (
                                                        <button 
                                                            key={cat}
                                                            type="button"
                                                            onClick={(e) => { e.preventDefault(); e.stopPropagation(); setEmojiTab(cat); }}
                                                            className={`px-3 py-1 text-xs rounded-full whitespace-nowrap transition-colors ${emojiTab === cat ? 'bg-emerald-100 text-emerald-700 font-bold' : 'bg-white text-stone-500 hover:bg-stone-100'}`}
                                                        >
                                                            {cat}
                                                        </button>
                                                    ))}
                                                </div>
                                                <div className="grid grid-cols-8 gap-1 h-32 overflow-y-auto p-1 bg-white rounded border border-stone-100">
                                                    {EMOJI_CATEGORIES[emojiTab].map(emoji => (
                                                        <button 
                                                            key={emoji} 
                                                            type="button"
                                                            onClick={() => handleEmojiClick(emoji)} 
                                                            className="aspect-square flex items-center justify-center text-lg hover:bg-emerald-50 rounded transition hover:scale-110 active:scale-95"
                                                        >
                                                            {emoji}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-xs text-stone-500 font-bold">ÈÄ£Áµê</label>
                                            <input className="w-full border p-2 rounded text-sm text-stone-600 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="https://..." value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).link || ''} onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'link', e.target.value)} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs text-stone-500 font-bold">ËÉåÊôØÈ°èËâ≤</label>
                                            <div className="flex items-center border p-1 rounded h-[38px]">
                                                <input type="color" className="w-full h-full cursor-pointer bg-transparent border-none" value={(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).color?.startsWith('#') ? (data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).color : '#ffffff'} onChange={e=>updateCell(selectedCell.gIdx, selectedCell.cIdx, 'color', e.target.value)} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs text-stone-500 font-bold">ÂúñÁâá</label>
                                        <div className="border p-2 rounded bg-stone-50 flex flex-col gap-2">
                                            <div className="flex items-center justify-between">
                                                {isUploading ? (
                                                    <span className="text-emerald-600 text-sm animate-pulse">‰∏äÂÇ≥‰∏≠...</span>
                                                ) : (
                                                    <input type="file" className="text-sm text-stone-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200" onChange={e => handleImageUpload(e.target.files[0])} />
                                                )}
                                                {(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).images?.length > 0 && (
                                                    <span className="text-xs text-stone-500 bg-white px-2 py-1 rounded border">ÂÖ± {(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).images.length} Âºµ</span>
                                                )}
                                            </div>
                                            
                                            {/* Thumbnail List */}
                                            {(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).images?.length > 0 && (
                                                <div className="flex gap-2 overflow-x-auto pb-1 pt-1 border-t border-stone-200 mt-1">
                                                    {(data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).images.map((img, idx) => (
                                                        <div key={idx} className="relative flex-shrink-0 w-12 h-12 border rounded bg-white group/thumb">
                                                            <img src={img} className="w-full h-full object-cover rounded-sm cursor-pointer" onClick={()=>openImagePreview((data[`${selectedCell.gIdx}-${selectedCell.cIdx}`] || {}).images, idx)} />
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); removeImage(idx); }}
                                                                className="absolute -top-1.5 -right-1.5 bg-red-500 text-white w-4 h-4 rounded-full flex items-center justify-center text-[10px] shadow-sm hover:bg-red-600"
                                                                title="Âà™Èô§"
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className="p-3 border-t bg-stone-50 flex justify-between items-center shrink-0">
                                    <button 
                                        onClick={()=>clearCell(selectedCell.gIdx, selectedCell.cIdx)}
                                        className="text-red-500 text-sm hover:bg-red-50 px-3 py-1.5 rounded transition font-medium"
                                    >
                                        Ê∏ÖÈô§ÂÖßÂÆπ
                                    </button>
                                    <button 
                                        onClick={()=>setSelectedCell(null)}
                                        className="bg-white border border-stone-300 text-stone-600 px-4 py-1.5 rounded text-sm hover:bg-stone-100 transition shadow-sm font-medium"
                                    >
                                        ÈóúÈñâ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSaveAsModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80">
                                <h3 className="font-bold mb-4">{modalMode === 'new' ? 'Âª∫Á´ãÊñ∞Ê™îÊ°à' : 'Âè¶Â≠òÊñ∞Ê™î'}</h3>
                                <input id="save-title" className="w-full border p-2 rounded mb-2" defaultValue={docMetadata.title} placeholder="Ê®ôÈ°å" />
                                <input id="save-cat" className="w-full border p-2 rounded mb-4" defaultValue={docMetadata.category} placeholder="ÂàÜÈ°û" />
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setShowSaveAsModal(false)} className="px-4 py-2">ÂèñÊ∂à</button>
                                    <button onClick={handleSaveAction} className="px-4 py-2 bg-emerald-600 text-white rounded">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showMetadataModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80">
                                <h3 className="font-bold mb-4">Á∑®ËºØÊ™îÊ°àË≥áË®ä</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs text-stone-500 mb-1">Ê®ôÈ°å</label>
                                        <input className="w-full border p-2 rounded" value={docMetadata.title} onChange={e=>setDocMetadata({...docMetadata, title:e.target.value})} placeholder="Ê™îÊ°àÊ®ôÈ°å" />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-stone-500 mb-1">ÂàÜÈ°ûÊ®ôÁ±§</label>
                                        <input className="w-full border p-2 rounded" value={docMetadata.category} onChange={e=>setDocMetadata({...docMetadata, category:e.target.value})} placeholder="‰æãÂ¶Ç: Â∑•‰Ωú, ÈùàÊÑü" />
                                    </div>
                                </div>
                                <div className="flex justify-end mt-6">
                                    <button onClick={()=>setShowMetadataModal(false)} className="px-4 py-2 bg-emerald-600 text-white rounded">ÂÆåÊàê</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-96">
                                <h3 className="font-bold mb-4">ÂåØÂÖ•</h3>
                                <textarea className="w-full border p-2 h-32 text-xs mb-2" value={importCode} onChange={e=>setImportCode(e.target.value)} placeholder="Ë≤º‰∏ä‰ª£Á¢º..."></textarea>
                                <button onClick={handleImportCodeSubmit} className="w-full bg-stone-800 text-white py-2 rounded">ÂåØÂÖ•‰∏¶Â≠òÊ™î</button>
                                <button onClick={()=>setShowImportModal(false)} className="w-full mt-2 text-stone-500">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    )}

                    {showShareModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-80 text-center">
                                <h3 className="font-bold mb-4">ÂàÜ‰∫´</h3>
                                <button onClick={handleCopyCode} className="w-full border p-2 rounded mb-2">Ë§áË£Ω‰ª£Á¢º</button>
                                <button onClick={handleExportFile} className="w-full border p-2 rounded mb-2">‰∏ãËºâ JSON</button>
                                <button onClick={()=>setShowShareModal(false)} className="text-stone-500 mt-2">ÈóúÈñâ</button>
                            </div>
                        </div>
                    )}
                    
                     {showExportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl w-64 space-y-2 text-center">
                                <h3 className="font-bold mb-4">ÂåØÂá∫</h3>
                                <button onClick={handleExportXLS} className="w-full border p-2 rounded">Excel</button>
                                <button onClick={handleExportJPG} className="w-full border p-2 rounded">JPG</button>
                                <button onClick={handleExportPDF} className="w-full border p-2 rounded">PDF</button>
                                <button onClick={handleExportMD} className="w-full border p-2 rounded">Markdown</button>
                                <button onClick={()=>setShowExportModal(false)} className="text-stone-500 mt-2">ÈóúÈñâ</button>
                            </div>
                        </div>
                    )}

                    {showGlobalSearchModal && (
                         <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity duration-300">
                            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[70vh] overflow-hidden transform transition-all scale-100">
                                <div className="p-4 border-b flex justify-between items-center bg-stone-50/80">
                                    <h3 className="font-bold text-stone-700 flex items-center gap-2 text-lg">
                                        <span className="text-emerald-600"><Icons.Search/></span> ÂÖ®ÂüüÊêúÂ∞ã
                                    </h3>
                                    <button onClick={()=>setShowGlobalSearchModal(false)} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200 text-stone-500 transition">
                                        <Icons.X/>
                                    </button>
                                </div>
                                
                                <div className="p-4 bg-white border-b border-stone-100">
                                    <div className="flex gap-2">
                                        <div className="relative flex-1 group">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-stone-400 group-focus-within:text-emerald-500 transition-colors">
                                                <Icons.Search />
                                            </div>
                                            <input 
                                                className="w-full pl-10 pr-4 py-3 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-emerald-100 focus:border-emerald-500 outline-none transition-all text-stone-700" 
                                                value={searchQuery} 
                                                onChange={e=>setSearchQuery(e.target.value)} 
                                                onKeyDown={e => e.key === 'Enter' && performGlobalSearch()}
                                                placeholder="Ëº∏ÂÖ•ÈóúÈçµÂ≠ó..." 
                                                autoFocus
                                            />
                                        </div>
                                        <button 
                                            onClick={performGlobalSearch} 
                                            className="bg-emerald-600 hover:bg-emerald-700 text-white px-5 rounded-xl font-medium transition-all shadow-md hover:shadow-lg active:scale-95 flex items-center justify-center"
                                            title="ÊêúÂ∞ã"
                                        >
                                            <Icons.Search className="w-5 h-5" />
                                        </button>
                                    </div>
                                    <div className="mt-3 flex justify-center gap-3 text-[10px] text-stone-400 font-medium">
                                        <span className="bg-stone-100 px-2 py-1 rounded-md">Á©∫Ê†º = AND</span>
                                        <span className="bg-stone-100 px-2 py-1 rounded-md">OR</span>
                                        <span className="bg-stone-100 px-2 py-1 rounded-md">-ÈóúÈçµÂ≠ó = NOT</span>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto bg-stone-50/30 p-2">
                                    {globalSearchResults.length === 0 && searchQuery && (
                                        <div className="flex flex-col items-center justify-center py-12 text-stone-400">
                                            <div className="text-4xl mb-3 opacity-50">üîç</div>
                                            <div className="text-sm">Êâæ‰∏çÂà∞Á¨¶Âêà„Äå{searchQuery}„ÄçÁöÑÁµêÊûú</div>
                                        </div>
                                    )}
                                    {globalSearchResults.length === 0 && !searchQuery && (
                                        <div className="flex flex-col items-center justify-center py-12 text-stone-300">
                                            <div className="text-4xl mb-3 opacity-30">‚å®Ô∏è</div>
                                            <div className="text-sm">Ë´ãËº∏ÂÖ•ÈóúÈçµÂ≠óÈñãÂßãÊêúÂ∞ã</div>
                                        </div>
                                    )}
                                    <div className="space-y-2">
                                        {globalSearchResults.map(f => (
                                            <div 
                                                key={f.id} 
                                                className="bg-white border border-stone-100 p-3 rounded-xl cursor-pointer hover:border-emerald-300 hover:shadow-md transition-all group" 
                                                onClick={()=>{ loadFileFromDB(f); setShowGlobalSearchModal(false); }}
                                            >
                                                <div className="flex justify-between items-start mb-1">
                                                    <div className="font-bold text-stone-700 group-hover:text-emerald-700 transition-colors">{f.title}</div>
                                                    <div className="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full font-bold">
                                                        ÂåπÈÖçÂ∫¶: {f.score}
                                                    </div>
                                                </div>
                                                <div className="text-xs text-stone-400 flex items-center gap-2">
                                                    <span className="bg-stone-100 px-1.5 rounded text-[10px]">{f.category || 'Êú™ÂàÜÈ°û'}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
