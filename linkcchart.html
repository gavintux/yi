<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linkc Chart Hub</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. CSS -->
    <style>
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f5f5f4; /* stone-100 */ color: #44403c; /* stone-700 */ }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: #059669; font-weight: bold; }
        .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; color: #44403c; }
        
        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e7e5e4; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }

        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">正在載入 Linkc Chart Hub...</div>
    </div>

    <!-- 4. React App -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Leaf, Search, Upload, Download, Tag, X, 
            Image as ImageIcon, Maximize2, Share2, Facebook, 
            Copy, Check, Lock, Unlock, Edit, Trash2, LogOut, 
            Cloud, RefreshCw, AlertTriangle, Info, Link as LinkIcon, FileUp, 
            Calendar, FileText, BarChart2, Hash, ExternalLink, PlusCircle, FileCode,
            BookOpen, Users, Video, Mic, Globe, MessageCircle, FileBox
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // -----------------------------------------------------------------------------
        // 設定區 (Firebase Config) - 已填入您的設定
        // -----------------------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyDwXsplXePeD1wU1GG4BwQBR6iSMd3_5nY",
            authDomain: "linkcphoto.firebaseapp.com",
            projectId: "linkcphoto",
            storageBucket: "linkcphoto.firebasestorage.app",
            messagingSenderId: "841541302440",
            appId: "1:841541302440:web:a2b3dfef70a32bb345ea9d",
            measurementId: "G-902H2EHVFF"
        };

        const isConfigConfigured = !firebaseConfig.apiKey.includes("您的API_KEY");

        let app, auth, db, storage;
        if (isConfigConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase 初始化失敗", e);
            }
        }

        // 使用不同的 Collection 以區隔照片
        const COLLECTION_NAME = 'linkc_charts_v1';

        // -----------------------------------------------------------------------------
        // Helper Functions
        // -----------------------------------------------------------------------------

        const copyToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('複製失敗', err);
            }
            document.body.removeChild(textArea);
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            // 支援 YYYY-MM-DD 或 ISO 格式，如果是 ISO 轉為 YYYY-MM-DD HH:MM
            return dateStr.replace('T', ' ').substring(0, 16);
        };

        const getSourceIcon = (source) => {
            switch(source) {
                case '網路': return <Globe size={12}/>;
                case '書籍': return <BookOpen size={12}/>;
                case '自己': return <Leaf size={12}/>;
                case '演講': return <Mic size={12}/>;
                case '聊天': return <MessageCircle size={12}/>;
                case '影片': return <Video size={12}/>;
                default: return <Info size={12}/>;
            }
        };

        // -----------------------------------------------------------------------------
        // UI Components
        // -----------------------------------------------------------------------------

        const ConfigError = () => (
            <div className="error-container bg-stone-50">
                <div className="error-box border-stone-200">
                    <AlertTriangle className="mx-auto h-12 w-12 text-yellow-600 mb-4" />
                    <h3 className="error-title text-stone-800">尚未設定 Firebase</h3>
                    <p className="text-stone-600 mb-4">請編輯 index.html 並填入您的 Firebase Config。</p>
                </div>
            </div>
        );

        const AuthError = ({ message }) => (
            <div className="error-container bg-stone-50">
                <div className="error-box border-red-100">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-600 mb-4" />
                    <h3 className="error-title">連線失敗</h3>
                    <p className="text-stone-800 font-mono text-xs bg-red-50 p-2 rounded mb-4 break-all">{message}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded">重新整理</button>
                </div>
            </div>
        );

        const Header = ({ setView, isAdmin, onLoginClick, onLogout }) => (
            <header className="bg-emerald-900 shadow-md sticky top-0 z-40 text-stone-50">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('gallery')}>
                        <div className="p-2 bg-emerald-800 rounded-lg group-hover:bg-emerald-700 transition-colors">
                            <Leaf size={24} className="text-emerald-100" />
                        </div>
                        <div>
                            <h1 className="text-xl font-bold tracking-wide">Linkc <span className="font-light text-emerald-200">Chart Hub</span></h1>
                            <p className="text-[10px] text-emerald-300 uppercase tracking-widest hidden sm:block">Knowledge Visualization</p>
                        </div>
                        {isAdmin && <span className="text-[10px] bg-red-500 text-white px-2 py-0.5 rounded-full font-bold ml-2">ADMIN</span>}
                    </div>
                    
                    <div className="flex items-center gap-3">
                        {isAdmin ? (
                            <button onClick={onLogout} className="p-2 text-emerald-300 hover:text-white transition-colors" title="登出"><LogOut size={20} /></button>
                        ) : (
                            <button onClick={onLoginClick} className="p-2 text-emerald-300 hover:text-white transition-colors" title="管理員登入"><Lock size={20} /></button>
                        )}
                        <button onClick={() => setView('upload')} className="flex items-center gap-2 bg-stone-100 text-emerald-900 px-4 py-2 rounded-full font-medium hover:bg-white transition-all shadow-sm">
                            <Upload size={18} /><span className="hidden sm:inline">新增圖表</span>
                        </button>
                    </div>
                </div>
            </header>
        );

        // 分享與引用計數器
        const ShareActions = ({ chart, onUpdateUsage }) => {
            const handleCopyLink = (e) => {
                e.stopPropagation();
                copyToClipboard(chart.url);
                onUpdateUsage(chart.id, (chart.usageCount || 0) + 1);
                alert("已複製圖片連結！\n\n適用於：Google 文件、簡報 (透過網址插入圖片)");
            };

            const handleObsidian = (e) => {
                e.stopPropagation();
                const altText = chart.title || 'Chart';
                const markdown = `![${altText}](${chart.url})\n*${chart.summary || ''}*`;
                copyToClipboard(markdown);
                onUpdateUsage(chart.id, (chart.usageCount || 0) + 1);
                alert("已複製 Obsidian 語法！\n\n直接貼上即可顯示圖表與摘要。");
            };

            const handleFB = (e) => {
                e.stopPropagation();
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(chart.url)}`, '_blank');
                onUpdateUsage(chart.id, (chart.usageCount || 0) + 1);
            };

            return (
                <div className="flex gap-2">
                    <button onClick={handleObsidian} className="p-2 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200 transition-colors" title="複製 Obsidian 語法"><FileCode size={18} /></button>
                    <button onClick={handleCopyLink} className="p-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" title="複製連結 (Google Docs/Slides)"><LinkIcon size={18} /></button>
                    <button onClick={handleFB} className="p-2 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition-colors" title="分享至 Facebook"><Facebook size={18} /></button>
                    <a href={chart.url} download target="_blank" rel="noreferrer" onClick={(e) => e.stopPropagation()} className="p-2 rounded-lg bg-stone-200 text-stone-700 hover:bg-stone-300 transition-colors" title="下載原圖"><Download size={18} /></a>
                </div>
            );
        };

        const ChartCard = ({ chart, onExpand, isAdmin, onEdit, onDelete, onUpdateUsage }) => {
            return (
                <div className="bg-white rounded-xl border border-stone-200 shadow-sm hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full animate-fade-in">
                    {/* Header: File Name */}
                    <div className="px-4 py-3 border-b border-stone-100 bg-stone-50/50 flex justify-between items-start">
                        <div className="flex flex-col gap-0.5">
                            <h3 className="font-bold text-stone-800 line-clamp-1" title={chart.title}>{chart.title || '未命名圖表'}</h3>
                            <div className="flex gap-2 items-center text-[10px] text-stone-500 uppercase tracking-wide">
                                <span className="bg-stone-100 px-1.5 rounded border border-stone-200">{chart.fileType || '圖表'}</span>
                                {chart.source && <span className="flex items-center gap-1"><span className="text-emerald-600">{getSourceIcon(chart.source)}</span> {chart.source}</span>}
                            </div>
                        </div>
                        {isAdmin && (
                            <div className="flex gap-1 ml-2">
                                <button onClick={(e) => {e.stopPropagation(); onEdit(chart)}} className="p-1 text-blue-500 hover:bg-blue-50 rounded"><Edit size={14}/></button>
                                <button onClick={(e) => {e.stopPropagation(); onDelete(chart.id)}} className="p-1 text-red-500 hover:bg-red-50 rounded"><Trash2 size={14}/></button>
                            </div>
                        )}
                    </div>

                    {/* Image Preview */}
                    <div className="relative aspect-[4/3] bg-stone-100 cursor-zoom-in group overflow-hidden" onClick={() => onExpand(chart)}>
                        <img src={chart.url} alt={chart.title} className="w-full h-full object-contain p-2 transition-transform duration-500 group-hover:scale-105" loading="lazy" />
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center">
                            <Maximize2 className="text-white opacity-0 group-hover:opacity-100 drop-shadow-md" size={32} />
                        </div>
                    </div>

                    {/* Content */}
                    <div className="p-4 flex flex-col flex-grow gap-3">
                        {/* Summary */}
                        {chart.summary && (
                            <div className="text-sm text-stone-600 bg-stone-50 p-2 rounded border-l-2 border-emerald-500 italic">
                                "{chart.summary}"
                            </div>
                        )}

                        {/* Tags */}
                        <div className="flex flex-wrap gap-1.5">
                            {chart.tags && chart.tags.map(tag => (
                                <span key={tag} className="text-xs px-2 py-1 bg-emerald-50 text-emerald-700 rounded-full border border-emerald-100">#{tag}</span>
                            ))}
                        </div>

                        <div className="mt-auto pt-3 border-t border-stone-100 grid grid-cols-2 gap-4 text-xs text-stone-500">
                            <div>
                                <div className="flex items-center gap-1 mb-1"><Calendar size={12}/> {formatDate(chart.createdAt).split(' ')[0] || 'N/A'}</div>
                                {chart.updatedAt && chart.updatedAt !== chart.createdAt && <div className="flex items-center gap-1 text-emerald-600 font-medium"><RefreshCw size={12}/> {formatDate(chart.updatedAt)}</div>}
                            </div>
                            <div className="text-right">
                                <div className="flex items-center justify-end gap-1 font-bold text-stone-700" title="總引用次數">
                                    <BarChart2 size={12}/> {chart.usageCount || 0} 次引用
                                </div>
                            </div>
                        </div>

                        {/* Usage Log Preview */}
                        {chart.usageNotes && (
                            <div className="text-[10px] text-stone-400 truncate border-t border-dashed border-stone-200 pt-2" title={chart.usageNotes}>
                                運用於: {chart.usageNotes}
                            </div>
                        )}

                        {/* Actions */}
                        <div className="pt-2 flex justify-between items-center">
                            <ShareActions chart={chart} onUpdateUsage={onUpdateUsage} />
                        </div>
                    </div>
                </div>
            );
        };

        const Lightbox = ({ chart, onClose, isAdmin, onEdit, onDelete, onUpdateUsage }) => {
            if (!chart) return null;
            return (
                <div className="fixed inset-0 z-50 bg-stone-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-stone-400 hover:text-white p-2 z-50"><X size={32} /></button>
                    
                    <div className="relative max-w-5xl max-h-[90vh] w-full flex flex-col md:flex-row bg-white rounded-lg overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                        {/* Image Side */}
                        <div className="flex-1 bg-stone-100 flex items-center justify-center p-4 overflow-hidden relative">
                            <img src={chart.url} className="max-w-full max-h-[50vh] md:max-h-[85vh] object-contain" />
                        </div>

                        {/* Info Side */}
                        <div className="w-full md:w-96 bg-white p-6 flex flex-col gap-4 border-l border-stone-200 overflow-y-auto">
                            <div>
                                <h2 className="text-xl font-bold text-stone-800 mb-1">{chart.title}</h2>
                                <div className="flex gap-2 mb-2 text-xs">
                                    <span className="bg-stone-100 px-2 py-1 rounded text-stone-600 border border-stone-200">{chart.fileType}</span>
                                    <span className="bg-emerald-50 px-2 py-1 rounded text-emerald-700 border border-emerald-100 flex items-center gap-1">{getSourceIcon(chart.source)} {chart.source}</span>
                                </div>
                                <div className="text-xs text-stone-400 flex flex-col gap-1">
                                    <div className="flex items-center gap-1"><Calendar size={12}/> 創建: {formatDate(chart.createdAt)}</div>
                                    {chart.updatedAt && <div className="flex items-center gap-1 text-emerald-600"><RefreshCw size={12}/> 修訂: {formatDate(chart.updatedAt)}</div>}
                                </div>
                            </div>

                            <div className="bg-stone-50 p-3 rounded-lg border border-stone-100">
                                <h4 className="text-xs font-bold text-stone-500 uppercase mb-2">圖表摘要</h4>
                                <p className="text-sm text-stone-700 leading-relaxed">{chart.summary || "無摘要"}</p>
                            </div>

                            <div>
                                <h4 className="text-xs font-bold text-stone-500 uppercase mb-2">標籤</h4>
                                <div className="flex flex-wrap gap-1">
                                    {chart.tags && chart.tags.map(t => <span key={t} className="text-xs px-2 py-1 bg-emerald-100 text-emerald-800 rounded">#{t}</span>)}
                                </div>
                            </div>

                            <div className="border-t border-stone-100 pt-4">
                                <h4 className="text-xs font-bold text-stone-500 uppercase mb-2">引用紀錄</h4>
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-2xl font-bold text-emerald-600">{chart.usageCount || 0}</span>
                                    <span className="text-xs text-stone-400">次被使用</span>
                                </div>
                                <div className="text-xs text-stone-600 bg-stone-50 p-3 rounded border border-stone-100">
                                    <span className="font-bold text-stone-400 block mb-1">運用位置紀錄：</span>
                                    {chart.usageNotes || "尚未記錄"}
                                </div>
                            </div>

                            <div className="mt-auto pt-4 flex flex-col gap-2">
                                <div className="flex justify-between items-center bg-emerald-50 p-3 rounded-lg">
                                    <span className="text-xs font-bold text-emerald-800">分享 / 引用</span>
                                    <ShareActions chart={chart} onUpdateUsage={onUpdateUsage} />
                                </div>
                                {isAdmin && (
                                    <button onClick={() => { onEdit(chart); onClose(); }} className="w-full py-2 border border-stone-300 text-stone-600 rounded hover:bg-stone-50 text-sm">編輯圖表資訊</button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ChartForm = ({ onSave, onCancel, initialData, isSaving }) => {
            const isEditMode = !!initialData;
            const [formData, setFormData] = useState(initialData || { 
                title: '', 
                fileType: '統計圖表',
                source: '自己',
                summary: '', 
                tags: '', 
                url: '',
                usageNotes: '',
                usageCount: 0
            });
            const [status, setStatus] = useState('');
            const [uploadFile, setUploadFile] = useState(null);

            useEffect(() => { if (initialData && Array.isArray(initialData.tags)) { setFormData(prev => ({ ...prev, tags: initialData.tags.join(', ') })); } }, [initialData]);
            
            const handleChange = (field, value) => { setFormData(prev => ({ ...prev, [field]: value })); };
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadFile(file);
                    setFormData(prev => ({ ...prev, url: URL.createObjectURL(file), title: prev.title || file.name.split('.')[0] }));
                }
            };

            const handleSubmit = async (e) => { 
                e.preventDefault();
                setStatus('uploading');
                let finalUrl = formData.url;

                try {
                    if (uploadFile) {
                        const filename = `charts/${Date.now()}_${uploadFile.name}`;
                        const storageRef = ref(storage, filename);
                        await uploadBytes(storageRef, uploadFile);
                        finalUrl = await getDownloadURL(storageRef);
                    } else if (!formData.url) {
                        alert("請選擇圖片檔案或輸入連結");
                        setStatus('');
                        return;
                    }

                    const processedData = { 
                        ...formData, 
                        url: finalUrl,
                        tags: formData.tags.toString().split(',').map(t => t.trim()).filter(t => t),
                        usageCount: Number(formData.usageCount)
                    }; 
                    onSave(processedData); 

                } catch (err) {
                    console.error("Error", err);
                    alert("上傳失敗: " + err.message);
                    setStatus('');
                }
            };

            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 animate-fade-in border border-stone-200">
                    <div className="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
                        <h2 className="text-2xl font-bold text-emerald-800 flex items-center gap-2">
                            {isEditMode ? <Edit /> : <Upload />} 
                            {isEditMode ? '編輯圖表資訊' : '新增圖表'}
                        </h2>
                        <button onClick={onCancel} className="text-stone-400 hover:text-stone-600"><X size={24} /></button>
                    </div>
                    
                    {status === 'uploading' && (
                        <div className="mb-4 bg-emerald-50 text-emerald-700 p-4 rounded-lg flex items-center gap-2 animate-pulse">
                            <RefreshCw className="spinner" size={20} />
                            <span>正在處理圖表資料，請稍候...</span>
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-6">
                        {/* File Upload */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-1">
                                <label className="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed rounded-lg cursor-pointer hover:bg-stone-50 transition-colors border-emerald-300 bg-emerald-50/30 overflow-hidden relative">
                                    {formData.url ? (
                                        <img src={formData.url} className="h-full w-full object-contain p-2" />
                                    ) : (
                                        <>
                                            <FileUp className="w-8 h-8 text-emerald-500 mb-2" />
                                            <span className="text-sm font-medium text-emerald-600">點擊上傳圖表</span>
                                        </>
                                    )}
                                    <input type="file" accept="image/*" onChange={handleFileChange} className="hidden" disabled={status === 'uploading'} />
                                </label>
                            </div>
                            
                            <div className="md:col-span-2 space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-stone-700 mb-1">檔案名稱 (File Name)</label>
                                    <input type="text" required placeholder="例如：2023 年度營收趨勢圖" className="block w-full border-stone-300 rounded-lg p-2.5 border focus:ring-emerald-500 focus:border-emerald-500" value={formData.title} onChange={(e) => handleChange('title', e.target.value)} />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold text-stone-700 mb-1">檔案種類</label>
                                        <select className="block w-full border-stone-300 rounded-lg p-2.5 border focus:ring-emerald-500 focus:border-emerald-500 bg-white" value={formData.fileType} onChange={(e) => handleChange('fileType', e.target.value)}>
                                            <option value="統計圖表">統計圖表</option>
                                            <option value="心智圖">心智圖</option>
                                            <option value="流程圖">流程圖</option>
                                            <option value="概念圖">概念圖</option>
                                            <option value="資訊圖表">資訊圖表</option>
                                            <option value="手稿/筆記">手稿/筆記</option>
                                            <option value="截圖">截圖</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-stone-700 mb-1">資料來源</label>
                                        <select className="block w-full border-stone-300 rounded-lg p-2.5 border focus:ring-emerald-500 focus:border-emerald-500 bg-white" value={formData.source} onChange={(e) => handleChange('source', e.target.value)}>
                                            <option value="自己">自己 (Self)</option>
                                            <option value="網路">網路 (Internet)</option>
                                            <option value="書籍">書籍 (Book)</option>
                                            <option value="演講">演講 (Speech)</option>
                                            <option value="聊天">聊天 (Chat)</option>
                                            <option value="影片">影片 (Video)</option>
                                            <option value="其他">其他 (Other)</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-stone-700 mb-1">標籤 (Tags)</label>
                                    <input type="text" placeholder="財務, 趨勢, 2023 (以逗號分隔)" className="block w-full border-stone-300 rounded-lg p-2.5 border focus:ring-emerald-500 focus:border-emerald-500" value={formData.tags} onChange={(e) => handleChange('tags', e.target.value)} />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-stone-700 mb-1">圖表摘要 (Summary)</label>
                            <textarea rows="3" placeholder="簡述此圖表的重點、數據來源或結論..." className="block w-full border-stone-300 rounded-lg p-2.5 border resize-none focus:ring-emerald-500 focus:border-emerald-500" value={formData.summary} onChange={(e) => handleChange('summary', e.target.value)} />
                        </div>

                        <div className="bg-stone-50 p-4 rounded-lg border border-stone-200">
                            <h4 className="text-sm font-bold text-stone-500 uppercase mb-3 flex items-center gap-2"><BarChart2 size={14}/> 引用紀錄管理</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-stone-500 mb-1">目前引用次數</label>
                                    <input type="number" className="block w-full border-stone-300 rounded-md p-2 border text-sm" value={formData.usageCount} onChange={(e) => handleChange('usageCount', e.target.value)} />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-xs font-bold text-stone-500 mb-1">被運用的地方 (筆記)</label>
                                    <input type="text" placeholder="例如：Q3 檢討簡報 p.12, Obsidian 專案筆記..." className="block w-full border-stone-300 rounded-md p-2 border text-sm" value={formData.usageNotes} onChange={(e) => handleChange('usageNotes', e.target.value)} />
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 pt-4 border-t border-stone-100">
                            <button type="button" onClick={onCancel} disabled={isSaving || status === 'uploading'} className="px-6 py-2 border border-stone-300 rounded-lg text-sm font-medium text-stone-700 hover:bg-stone-50 disabled:opacity-50">取消</button>
                            <button type="submit" disabled={isSaving || status === 'uploading'} className="px-6 py-2 bg-emerald-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-emerald-700 shadow-md flex items-center gap-2 disabled:opacity-50">
                                {(isSaving || status === 'uploading') && <RefreshCw className="animate-spin" size={16} />} 
                                {isEditMode ? '儲存變更' : '上傳圖表'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const AdminLogin = ({ onLogin, onCancel }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (password === '590123') onLogin(); else setPassword(''); };
            return (
                <div className="fixed inset-0 z-50 bg-stone-800/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full border border-emerald-100">
                        <div className="text-center mb-6">
                            <div className="mx-auto bg-emerald-100 w-12 h-12 rounded-full flex items-center justify-center mb-4"><Lock className="text-emerald-600" /></div>
                            <h3 className="text-lg font-bold text-stone-800">管理員登入</h3>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="password" placeholder="密碼" className="w-full text-center tracking-widest border border-stone-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" value={password} onChange={(e) => setPassword(e.target.value)} autoFocus />
                            <div className="flex gap-3"><button type="button" onClick={onCancel} className="flex-1 py-2 text-stone-500 hover:bg-stone-100 rounded-lg transition-colors">取消</button><button type="submit" className="flex-1 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">解鎖</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('gallery');
            const [charts, setCharts] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTag, setActiveTag] = useState(null);
            
            const [selectedChart, setSelectedChart] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [editingChart, setEditingChart] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);

            useEffect(() => {
                if (!isConfigConfigured) return; 
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (err) { console.error(err); } };
                initAuth();
                onAuthStateChanged(auth, (user) => { setCurrentUser(user); });
            }, []);

            useEffect(() => {
                if (!currentUser || !db) return;
                const q = query(collection(db, COLLECTION_NAME), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snapshot) => { setCharts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            }, [currentUser]);

            const handleSave = async (data) => {
                if (!currentUser) return;
                setIsSaving(true);
                try {
                    const collectionRef = collection(db, COLLECTION_NAME);
                    const timestamp = new Date().toISOString();
                    if (editingChart) {
                        await updateDoc(doc(collectionRef, data.id), { ...data, updatedAt: timestamp });
                        setEditingChart(null);
                    } else {
                        await addDoc(collectionRef, { ...data, createdAt: timestamp, updatedAt: timestamp });
                    }
                    setView('gallery');
                } catch (e) { alert("儲存失敗: " + e.message); } finally { setIsSaving(false); }
            };

            const handleDelete = async (id) => {
                if (!currentUser) return;
                if(window.confirm('確定要永久刪除此圖表？')) {
                    try { await deleteDoc(doc(db, COLLECTION_NAME, id)); } catch(e) { alert("刪除失敗"); }
                }
            };

            const handleUpdateUsage = async (id, newCount, note) => {
                 if (!currentUser) return;
                 try {
                     const chartRef = doc(db, COLLECTION_NAME, id);
                     await updateDoc(chartRef, { usageCount: newCount });
                 } catch(e) { console.error(e); }
            };

            const startEdit = (chart) => { setEditingChart(chart); setView('upload'); if (selectedChart) setSelectedChart(null); };

            if (!isConfigConfigured) return <ConfigError />;

            const allTags = [...new Set(charts.flatMap(p => p.tags))];
            const filteredCharts = charts.filter(chart => {
                if (activeTag && !(chart.tags || []).includes(activeTag)) return false;
                if (!searchQuery.trim()) return true;
                return JSON.stringify(chart).toLowerCase().includes(searchQuery.toLowerCase());
            });

            return (
                <div className="min-h-screen bg-stone-100 font-sans text-stone-800 pb-12">
                    <Header setView={(v) => { setView(v); setEditingChart(null); }} isAdmin={isAdmin} onLoginClick={() => setShowLogin(true)} onLogout={() => { setIsAdmin(false); alert("已登出"); }} />
                    
                    {showLogin && <AdminLogin onLogin={() => { setIsAdmin(true); setShowLogin(false); }} onCancel={() => setShowLogin(false)} />}
                    {selectedChart && <Lightbox chart={selectedChart} onClose={() => setSelectedChart(null)} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDelete} onUpdateUsage={handleUpdateUsage} />}

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {view === 'gallery' ? (
                            <>
                                <div className="flex flex-col md:flex-row gap-4 mb-8">
                                    <div className="relative flex-grow">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Search className="h-5 w-5 text-stone-400" /></div>
                                        <input type="text" placeholder="搜尋圖表名稱、摘要或標籤..." className="block w-full pl-10 pr-3 py-3 border border-stone-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm transition-all" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                    </div>
                                    <div className="flex flex-wrap gap-2 items-center">
                                        <span className="text-sm font-bold text-stone-400 mr-2 flex items-center gap-1"><Tag size={14} /> 標籤:</span>
                                        <button onClick={() => setActiveTag(null)} className={`px-3 py-1 rounded-full text-sm transition-colors ${!activeTag ? 'bg-emerald-700 text-white' : 'bg-white text-stone-600 hover:bg-stone-200'}`}>全部</button>
                                        {allTags.map(tag => (
                                            <button key={tag} onClick={() => setActiveTag(tag === activeTag ? null : tag)} className={`px-3 py-1 rounded-full text-sm transition-colors ${tag === activeTag ? 'bg-emerald-600 text-white' : 'bg-white text-stone-600 border border-stone-200 hover:bg-emerald-50 hover:border-emerald-200'}`}>{tag}</button>
                                        ))}
                                    </div>
                                </div>

                                {filteredCharts.length > 0 ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {filteredCharts.map(chart => (
                                            <ChartCard key={chart.id} chart={chart} onExpand={setSelectedChart} isAdmin={isAdmin} onEdit={startEdit} onDelete={handleDelete} onUpdateUsage={handleUpdateUsage} />
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-24 bg-white rounded-xl border border-dashed border-stone-300">
                                        <div className="mx-auto h-16 w-16 bg-stone-100 rounded-full flex items-center justify-center mb-4"><BarChart2 className="text-stone-300" size={32} /></div>
                                        <h3 className="text-lg font-medium text-stone-900">尚無圖表資料</h3>
                                        <p className="text-stone-500 mb-6">開始建立您的第一個圖表知識庫吧！</p>
                                        <button onClick={() => setView('upload')} className="text-emerald-600 hover:text-emerald-800 font-bold flex items-center justify-center gap-1"><PlusCircle size={18}/> 新增圖表</button>
                                    </div>
                                )}
                            </>
                        ) : (
                            <ChartForm onSave={handleSave} onCancel={() => { setView('gallery'); setEditingChart(null); }} initialData={editingChart} isSaving={isSaving} />
                        )}
                    </main>
                    <footer className="border-t border-stone-200 mt-12 py-8 text-center text-stone-400 text-sm">
                        <p>© {new Date().getFullYear()} Linkc Chart Hub.</p>
                    </footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
